"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[295],{47992:(e,t,a)=>{a.d(t,{d:()=>c});var r=a(52423),s=(a(68404),a(88102)),n=a(68522),i=a(16755),o=a(99500),l=a(45916);function c(e){let{title:t,children:a,collapsedInfo:r}=e;const[c,d]=(0,s.Z)(!1),p=(0,i.wW)(u);return(0,l.jsxs)(n.Stack,{gap:0,direction:"column",children:[(0,l.jsxs)("div",{className:p.header,onClick:d,title:"Click to edit options",children:[(0,l.jsx)("div",{className:p.toggle,children:(0,l.jsx)(o.J,{name:c?"angle-down":"angle-right"})}),(0,l.jsx)("h6",{className:p.title,children:t}),!c&&(0,l.jsx)("div",{className:p.description,children:r.map(((e,t)=>(0,l.jsx)("span",{children:e},t)))})]}),c&&(0,l.jsx)("div",{className:p.body,children:a})]})}const u=e=>({switchLabel:(0,r.css)({color:e.colors.text.secondary,cursor:"pointer",fontSize:e.typography.bodySmall.fontSize,"&:hover":{color:e.colors.text.primary}}),header:(0,r.css)({display:"flex",cursor:"pointer",alignItems:"baseline",color:e.colors.text.primary,"&:hover":{background:e.colors.emphasize(e.colors.background.primary,.03)}}),title:(0,r.css)({flexGrow:1,overflow:"hidden",fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium,margin:0}),description:(0,r.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,paddingLeft:e.spacing(2),gap:e.spacing(2),display:"flex"}),body:(0,r.css)({display:"flex",paddingTop:e.spacing(2),gap:e.spacing(2),flexWrap:"wrap"}),toggle:(0,r.css)({color:e.colors.text.secondary,marginRight:`${e.spacing(1)}`})})},88999:(e,t,a)=>{a.r(t),a.d(t,{plugin:()=>Tt});var r,s=a(23214),n=a(68404),i=a(45916);var o=a(52423),l=a(25981),c=a(65737),u=a(31181),d=a(34117),p=a(46889),h=a(37625),g=a(19050),m=a(22995),v=a(66946),f=a(16755),y=a(90533),b=a(82897);const x={};let j;!function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.INTERNAL=1]="INTERNAL",e[e.SERVER=2]="SERVER",e[e.CLIENT=3]="CLIENT",e[e.PRODUCER=4]="PRODUCER",e[e.CONSUMER=5]="CONSUMER"}(j||(j={}));var T=a(68522),_=a(13910),S=a(47992),w=a(53786),C=a(85526),N=a(37537),E=a(16313),O=a(4534),D=a(3363),q=a(98356),k=a(2101),I=a(94514),Q=a(39409),P=a(73273),R=a(28173),$=a(85699),A=a(88246),L=a(13960),M=a(27843),U=a(18474),W=a(2633),F=a(93570),V=a(40225),B=a(42833),G=a(15642);function z(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class K extends s.iL{constructor(e,t){var a;super(),a=this,z(this,"datasource",void 0),z(this,"tags",void 0),z(this,"request",(async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=await a.datasource.metadataRequest(e,t);return null==r?void 0:r.data})),z(this,"start",(async()=>(this.startTask||(this.startTask=this.fetchTags().then((()=>[]))),this.startTask))),z(this,"getTags",(()=>this.tags)),z(this,"provideCompletionItems",(async e=>{let{text:t,value:a}=e;if(!a)return{suggestions:[]};const r=a.endText.getText();return"="===r[r.indexOf(t)-1]||"="===t?this.getTagValueCompletionItems(a):this.getTagsCompletionItems()})),z(this,"getTagsCompletionItems",(()=>{const{tags:e}=this,t=[];return null!=e&&e.length&&t.push({label:"Tag",items:e.map((e=>({label:e})))}),{suggestions:t}})),this.datasource=e,Object.assign(this,t)}async fetchTags(){const e=await this.request("/api/search/tags",[]);this.tags=e.tagNames}async getTagValueCompletionItems(e){var t;const a=e.endText.getText().split(" ");let r=null!==(t=a[a.length-1])&&void 0!==t?t:"";r=r.split("=")[0];const s=await this.request(`/api/search/tag/${r}/values`,[]),n=[];return s&&s.tagValues&&n.push({label:"Tag Values",items:s.tagValues.map((e=>({label:e,insertText:`"${e}"`})))}),{suggestions:n}}async getOptions(e){const t=await this.request(`/api/search/tag/${e}/values`);let a=[];return t&&t.tagValues&&(a=t.tagValues.map((e=>({value:e,label:e})))),a}}var Z=a(95434);function Y(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class J extends U.CK{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,W.J)();super(e),Y(this,"tracesToLogs",void 0),Y(this,"serviceMap",void 0),Y(this,"search",void 0),Y(this,"nodeGraph",void 0),Y(this,"lokiSearch",void 0),Y(this,"traceQuery",void 0),Y(this,"uploadedJson",null),Y(this,"spanBar",void 0),Y(this,"languageProvider",void 0),Y(this,"getLokiSearchDS",(()=>{var e,t,a,r;const s=!1!==(null===(e=this.tracesToLogs)||void 0===e?void 0:e.lokiSearch)&&void 0===this.lokiSearch?null===(t=this.tracesToLogs)||void 0===t?void 0:t.datasourceUid:void 0;return null!==(a=null===(r=this.lokiSearch)||void 0===r?void 0:r.datasourceUid)&&void 0!==a?a:s})),this.instanceSettings=e,this.templateSrv=t,this.tracesToLogs=e.jsonData.tracesToLogs,this.serviceMap=e.jsonData.serviceMap,this.search=e.jsonData.search,this.nodeGraph=e.jsonData.nodeGraph,this.lokiSearch=e.jsonData.lokiSearch,this.traceQuery=e.jsonData.traceQuery,this.languageProvider=new K(this)}query(e){var t,a,r,s,n,i,o;const l=[],d=e.targets.filter((e=>!e.hide)),p=(0,b.groupBy)(d,(e=>e.queryType||"traceId"));if(p.clear)return(0,w.of)({data:[],state:R.Gu.Done});const h=this.getLokiSearchDS();if(h&&(null===(t=p.search)||void 0===t?void 0:t.length)>0){var g,m,v;(0,u.ff)("grafana_traces_loki_search_queried",{datasourceType:"tempo",app:null!==(g=e.app)&&void 0!==g?g:"",linkedQueryExpr:null!==(m=null===(v=p.search[0].linkedQuery)||void 0===v?void 0:v.expr)&&void 0!==m?m:""});const t=(0,B.ak)();l.push((0,C.D)(t.get(h)).pipe((0,q.z)((t=>{var a;const r=Object.assign({},e,{targets:p.search.map((e=>e.linkedQuery))}),s=(null===(a=t.instanceSettings.jsonData.derivedFields)||void 0===a?void 0:a.filter((e=>e.datasourceUid===this.uid&&e.matcherRegex)).map((e=>e.matcherRegex)))||[];return s&&0!==s.length?t.query(r).pipe((0,k.U)((e=>e.error?e:(0,Z.RY)(e,this.uid,this.name,s)))):(0,N._)((()=>new Error("No Loki datasource configured for search. Set up Derived Fields for traces in a Loki datasource settings and link it to this Tempo datasource.")))}))))}if(null!==(a=p.nativeSearch)&&void 0!==a&&a.length)try{var f,y,x,j,T;(0,u.ff)("grafana_traces_search_queried",{datasourceType:"tempo",app:null!==(f=e.app)&&void 0!==f?f:"",serviceName:null!==(y=p.nativeSearch[0].serviceName)&&void 0!==y?y:"",spanName:null!==(x=p.nativeSearch[0].spanName)&&void 0!==x?x:"",resultLimit:null!==(j=p.nativeSearch[0].limit)&&void 0!==j?j:"",search:null!==(T=p.nativeSearch[0].search)&&void 0!==T?T:""});const t={startTime:e.range.from.unix(),endTime:e.range.to.unix()},a=this.applyVariables(p.nativeSearch[0],e.scopedVars),r=this.buildSearchQuery(a,t);l.push(this._request("/api/search",r).pipe((0,k.U)((e=>({data:[(0,Z.n4)(e.data.traces,this.instanceSettings)]}))),(0,I.K)((e=>(0,w.of)({error:{message:e.data.message},data:[]})))))}catch(e){return(0,w.of)({error:{message:e instanceof Error?e.message:"Unknown error occurred"},data:[]})}if(null!==(r=p.traceql)&&void 0!==r&&r.length)try{var _;(0,u.ff)("grafana_traces_traceql_queried",{datasourceType:"tempo",app:null!==(_=e.app)&&void 0!==_?_:""}),l.push(this._request("/api/search",{q:p.traceql[0].query,limit:e.targets[0].limit,start:e.range.from.unix(),end:e.range.to.unix()}).pipe((0,k.U)((e=>({data:(0,Z.xA)(e.data.traces,this.instanceSettings)}))),(0,I.K)((e=>(0,w.of)({error:{message:e.data.message},data:[]})))))}catch(e){return(0,w.of)({error:{message:e instanceof Error?e.message:"Unknown error occurred"},data:[]})}if(null!==(s=p.upload)&&void 0!==s&&s.length)if(this.uploadedJson){var S;(0,u.ff)("grafana_traces_json_file_uploaded",{datasourceType:"tempo",app:null!==(S=e.app)&&void 0!==S?S:""});const t=JSON.parse(this.uploadedJson),a=t.batches,r=Array.isArray(t)&&t.some((e=>{var t;return"nodeGraph"===(null==e||null===(t=e.meta)||void 0===t?void 0:t.preferredVisualisationType)}));var O;if(a)l.push((0,w.of)((0,Z.IM)(t.batches,null===(O=this.nodeGraph)||void 0===O?void 0:O.enabled)));else r?l.push((0,w.of)({data:t,state:R.Gu.Done})):l.push((0,w.of)({error:{message:"Unable to parse uploaded data."},data:[]}))}else l.push((0,w.of)({data:[],state:R.Gu.Done}));if(null!==(n=this.serviceMap)&&void 0!==n&&n.datasourceUid&&(null===(i=p.serviceMap)||void 0===i?void 0:i.length)>0){var D,$;(0,u.ff)("grafana_traces_service_graph_queried",{datasourceType:"tempo",app:null!==(D=e.app)&&void 0!==D?D:"",serviceMapQuery:null!==($=p.serviceMap[0].serviceMapQuery)&&void 0!==$?$:""});const t=this.serviceMap.datasourceUid,a=this.uid;c.v.featureToggles.tempoApmTable?l.push(X(e,t,a).pipe((0,Q.b)((r=>function(e,t,a){const r=re(e);return r.targets=oe([se(G.rB,G.T1,e)]),H(r,a).pipe((0,P.q)(),(0,k.U)((e=>{var a,r;const s=e.find((e=>!!e.error));if(s)throw new Error(s.error.message);return{data:[null!==(a=null===(r=e[0])||void 0===r?void 0:r.data)&&void 0!==a?a:[],t.data[0],t.data[1]],state:R.Gu.Done}})))}(e,r,t).pipe((0,Q.b)((r=>function(e,t,a,r){var s,n,i;let o=[],l="",c=[];const u=null!==(s=null===(n=t.data[0][0])||void 0===n||null===(i=n.fields[1])||void 0===i?void 0:i.values.toArray())&&void 0!==s?s:[];u.length>0&&(l=se(G.$C,'span_name=~"'+u.join("|")+'"',e),o.push(l),u.map((t=>{const a=se(G.vO,'span_name=~"'+t+'"',e);c.push(a),o.push(a)})));const d=re(e);return d.targets=oe(o),H(d,a).pipe((0,P.q)(),(0,k.U)((s=>{const n=s.find((e=>!!e.error));if(n)throw new Error(n.error.message);const i=function(e,t,a,r,s,n,i){var o,l,c,u;let d={fields:[]};const p=null===(o=t.data[0])||void 0===o?void 0:o.filter((t=>t.refId===se(G.rB,G.T1,e))),h=a.data.filter((e=>e.refId===r)),g=a.data.filter((e=>s.includes(e.refId)));p.length>0&&(null===(l=p[0].fields)||void 0===l?void 0:l.length)>2&&(d.fields.push(Object.assign({},p[0].fields[1],{name:"Name",config:{filterable:!1}})),d.fields.push(Object.assign({},p[0].fields[2],{name:"Rate",config:{links:[ee("Rate",ne(se(G.rB,'span_name="${__data.fields[0]}"',e)),n,!1)],decimals:2}})),d.fields.push(Object.assign({},p[0].fields[2],{name:" ",labels:null,config:{color:{mode:"continuous-BlPu"},custom:{displayMode:"lcd-gauge"},decimals:3}})));if(h.length>0&&(null===(c=h[0].fields)||void 0===c?void 0:c.length)>2){var m,v,f,y;const t=null!==(m=null===(v=h[0].fields[1])||void 0===v?void 0:v.values.toArray())&&void 0!==m?m:[],a=null!==(f=null===(y=h[0].fields[2])||void 0===y?void 0:y.values.toArray())&&void 0!==f?f:[];let r={};t.map(((e,t)=>{r[e]={value:a[t]}}));const s=ie(Object.assign({},p),r);d.fields.push(Object.assign({},h[0].fields[2],{name:"Error Rate",values:s,config:{links:[ee("Error Rate",ne(se(G.$C,'span_name="${__data.fields[0]}"',e)),n,!1)],decimals:2}})),d.fields.push(Object.assign({},h[0].fields[2],{name:"  ",values:s,labels:null,config:{color:{mode:"continuous-RdYlGr"},custom:{displayMode:"lcd-gauge"},decimals:3}}))}if(g.length>0&&(null===(u=g[0].fields)||void 0===u?void 0:u.length)>1){let t={};g.map((e=>{var a,r;const s=null!==(a=e.refId)&&void 0!==a&&a.includes('span_name=~"')?'span_name=~"':'span_name="',n=null===(r=e.refId)||void 0===r?void 0:r.split(s)[1].split('"}')[0];t[n]={value:e.fields[1].values.toArray()[0]}})),d.fields.push(Object.assign({},g[0].fields[1],{name:"Duration (p90)",values:ie(Object.assign({},p),t),config:{links:[ee("Duration",ne(se(G.vO,'span_name="${__data.fields[0]}"',e)),n,!1)],unit:"s"}}))}d.fields.length>0&&d.fields[0].values&&d.fields.push({name:"Links",type:M.fS.string,values:d.fields[0].values.map((()=>"Tempo")),config:{links:[ae("Tempo","","${__data.fields[0]}",i)]}});return d}(e,t,s[0],l,c,a,r);return 0===i.fields.length?{data:[t.data[1],t.data[2]],state:R.Gu.Done}:{data:[i,t.data[1],t.data[2]],state:R.Gu.Done}})))}(e,r,t,a)))))))):l.push(X(e,t,a))}var A,L;(null===(o=p.traceId)||void 0===o?void 0:o.length)>0&&((0,u.ff)("grafana_traces_traceID_queried",{datasourceType:"tempo",app:null!==(A=e.app)&&void 0!==A?A:"",query:null!==(L=p.traceId[0].query)&&void 0!==L?L:""}),l.push(this.handleTraceIdQuery(e,p.traceId)));return(0,E.T)(...l)}applyTemplateVariables(e,t){return this.applyVariables(e,t)}interpolateVariablesInQueries(e,t){return e&&0!==e.length?e.map((e=>Object.assign({},e,{datasource:this.getRef()},this.applyVariables(e,t)))):[]}applyVariables(e,t){var a,r,s,n,i,o;const l=Object.assign({},e);var c,u;e.linkedQuery&&(l.linkedQuery=Object.assign({},e.linkedQuery,{expr:this.templateSrv.replace(null!==(c=null===(u=e.linkedQuery)||void 0===u?void 0:u.expr)&&void 0!==c?c:"",t)}));return Object.assign({},l,{query:this.templateSrv.replace(null!==(a=e.query)&&void 0!==a?a:"",t),serviceName:this.templateSrv.replace(null!==(r=e.serviceName)&&void 0!==r?r:"",t),spanName:this.templateSrv.replace(null!==(s=e.spanName)&&void 0!==s?s:"",t),search:this.templateSrv.replace(null!==(n=e.search)&&void 0!==n?n:"",t),minDuration:this.templateSrv.replace(null!==(i=e.minDuration)&&void 0!==i?i:"",t),maxDuration:this.templateSrv.replace(null!==(o=e.maxDuration)&&void 0!==o?o:"",t)})}handleTraceIdQuery(e,t){const a=t.filter((e=>e.query)).map((e=>Object.assign({},e,{query:e.query.trim()})));if(!a.length)return O.E;const r=this.traceIdQueryRequest(e,a);return super.query(r).pipe((0,k.U)((e=>{var t;return e.error?e:(0,Z.Jk)(e,null===(t=this.nodeGraph)||void 0===t?void 0:t.enabled)})))}traceIdQueryRequest(e,t){var a;const r=Object.assign({},e,{targets:t});var s,n;null!==(a=this.traceQuery)&&void 0!==a&&a.timeShiftEnabled?r.range=e.range&&Object.assign({},e.range,{from:e.range.from.subtract($.intervalToMs((null===(s=this.traceQuery)||void 0===s?void 0:s.spanStartTimeShift)||"30m"),"milliseconds"),to:e.range.to.add($.intervalToMs((null===(n=this.traceQuery)||void 0===n?void 0:n.spanEndTimeShift)||"30m"),"milliseconds")}):r.range={from:(0,A.CQ)(0),to:(0,A.CQ)(0),raw:{from:(0,A.CQ)(0),to:(0,A.CQ)(0)}};return r}async metadataRequest(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return await(0,D.n)(this._request(e,t,{method:"GET",hideFromInspector:!0}))}_request(e,t,a){const r=t?(0,V.tW)(t):"",s=`${this.instanceSettings.url}${e}${r.length?`?${r}`:""}`,n=Object.assign({},a,{url:s});return(0,F.i)().fetch(n)}async testDatasource(){const e={headers:{},method:"GET",url:`${this.instanceSettings.url}/api/echo`},t=await(0,D.n)((0,F.i)().fetch(e));if(null!=t&&t.ok)return{status:"success",message:"Data source is working"}}getQueryDisplayText(e){if("nativeSearch"===e.queryType){let t=[];for(const a of["serviceName","spanName","search","minDuration","maxDuration","limit"])e.hasOwnProperty(a)&&e[a]&&t.push(`${(0,b.startCase)(a)}: ${e[a]}`);return t.join(", ")}return e.query}buildSearchQuery(e,t){var a;let r=null!==(a=e.search)&&void 0!==a?a:"",s=(0,b.pick)(e,["minDuration","maxDuration","limit"]);if(s=(0,b.pickBy)(s,b.identity),e.serviceName&&(r+=` service.name="${e.serviceName}"`),e.spanName&&(r+=` name="${e.spanName}"`),s.limit||(s.limit=20),s.minDuration){var n;if(s.minDuration=this.templateSrv.replace(null!==(n=s.minDuration)&&void 0!==n?n:""),!(0,L.IA)(s.minDuration))throw new Error("Please enter a valid min duration.");s.minDuration=s.minDuration.replace(/\s/g,"")}if(s.maxDuration){var i;if(s.maxDuration=this.templateSrv.replace(null!==(i=s.maxDuration)&&void 0!==i?i:""),!(0,L.IA)(s.maxDuration))throw new Error("Please enter a valid max duration.");s.maxDuration=s.maxDuration.replace(/\s/g,"")}if(!Number.isInteger(s.limit)||s.limit<=0)throw new Error("Please enter a valid limit.");let o=Object.assign({tags:r},s);return t&&(o.start=t.startTime,o.end=t.endTime),o}}function H(e,t){return(0,C.D)((0,B.ak)().get(t)).pipe((0,q.z)((t=>t.query(e))))}function X(e,t,a){return H(re(e),t).pipe((0,P.q)(),(0,k.U)((r=>{const s=r.find((e=>!!e.error));if(s)throw new Error(s.error.message);const{nodes:n,edges:i}=(0,G.BC)(r,e.range);return n.refId=e.targets[0].refId,i.refId=e.targets[0].refId,n.fields[0].config=te(t,a,"__data.fields.id","__data.fields[0]"),i.fields[0].config=te(t,a,"__data.fields.target","__data.fields.target","__data.fields.source"),{data:[n,i],state:R.Gu.Done}})))}function ee(e,t,a,r){var s,n;return{url:"",title:e,internal:{query:{expr:t,range:!r,exemplar:!r,instant:r},datasourceUid:a,datasourceName:null!==(s=null===(n=(0,B.ak)().getDataSourceSettingsByUid(a))||void 0===n?void 0:n.name)&&void 0!==s?s:""}}}function te(e,t,a,r,s){return s=s?`client="\${${s}}",`:"",{links:[ee("Request rate",`sum by (client, server)(rate(${G.Yt}{${s}server="\${${a}}"}[$__rate_interval]))`,e,!1),ee("Request histogram",`histogram_quantile(0.9, sum(rate(${G.NZ}{${s}server="\${${a}}"}[$__rate_interval])) by (le, client, server))`,e,!1),ee("Failed request rate",`sum by (client, server)(rate(${G.yf}{${s}server="\${${a}}"}[$__rate_interval]))`,e,!1),ae("View traces",`\${${r}}`,"",t)]}}function ae(e,t,a,r){var s,n;let i={queryType:"nativeSearch"};return""!==t&&(i.serviceName=t),""!==a&&(i.spanName=a),{url:"",title:e,internal:{query:i,datasourceUid:r,datasourceName:null!==(s=null===(n=(0,B.ak)().getDataSourceSettingsByUid(r))||void 0===n?void 0:n.name)&&void 0!==s?s:""}}}function re(e){return Object.assign({},e,{targets:G.t3.map((t=>({format:"table",refId:t,expr:`rate(${t}${e.targets[0].serviceMapQuery||""}[$__range])`,instant:!0})))})}function se(e,t,a){var r,s,n;let i=null!==(r=null===(s=a.targets[0])||void 0===s||null===(n=s.serviceMapQuery)||void 0===n?void 0:n.replace("{","").replace("}",""))&&void 0!==r?r:"";i=i.replace("client","service").replace("server","service");const o=i.includes("span_name")?e.params.concat(i):e.params.concat(i).concat(t).filter((e=>e));return e.expr.replace("{}","{"+o.join(",")+"}")}function ne(e){return(e=e.replace("topk(5, ","").replace(" by (span_name))","")).replace("__range","__rate_interval")}function ie(e,t){var a,r,s;const n=null!==(a=null===(r=e[0])||void 0===r||null===(s=r.fields[1])||void 0===s?void 0:s.values.toArray())&&void 0!==a?a:[];let i=[];for(let e=0;e<n.length;e++)Object.keys(t).includes(n[e])?i.push(t[n[e]].value):i.push("0");return i}function oe(e){return e.map((e=>({refId:e,expr:e,instant:!0})))}const le=n.memo((e=>{let{onChange:t,query:a}=e;a.hasOwnProperty("limit")||(a.limit=20);return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(T.EditorRow,{children:(0,i.jsx)(S.d,{title:"Options",collapsedInfo:[`Limit: ${a.limit||20}`],children:(0,i.jsx)(T.EditorField,{label:"Limit",tooltip:"Maximum number of traces to return.",children:(0,i.jsx)(_.H,{className:"width-4",placeholder:"auto",type:"number",min:1,defaultValue:a.limit||20,onCommitChange:e=>{t(Object.assign({},a,{limit:parseInt(e.currentTarget.value,10)}))},value:a.limit})})})})})}));le.displayName="TempoQueryBuilderOptions";var ce=a(31787),ue=a(47900),de=a(11035),pe=a(63454);function he(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class ge{constructor(e){he(this,"languageProvider",void 0),he(this,"triggerCharacters",["{",".","[","(","=","~"," ",'"']),he(this,"monaco",void 0),he(this,"editor",void 0),he(this,"tags",{}),he(this,"cachedValues",{}),this.languageProvider=e.languageProvider}provideCompletionItems(e,t){var a;if(!this.monaco||!this.editor)throw new Error("provideCompletionItems called before CompletionProvider was initialized");if((null===(a=this.editor.getModel())||void 0===a?void 0:a.id)!==e.id)return{suggestions:[]};const{range:r,offset:s}=function(e,t,a){const r=t.getWordAtPosition(a),s=null!=r?e.Range.lift({startLineNumber:a.lineNumber,endLineNumber:a.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):e.Range.fromPositions(a),n={column:a.column,lineNumber:a.lineNumber};return{offset:t.getOffsetAt(n),range:s}}(this.monaco,e,t),n=this.getSituation(e.getValue(),s);return this.getCompletions(n).then((t=>{const a=t.length.toString().length,n=t.map(((t,n)=>{const i={kind:me(t.type,this.monaco),label:t.label,insertText:t.insertText,sortText:n.toString().padStart(a,"0"),range:r};return function(e,t,a,r,s){if("TAG_NAME"===t){const t=a.getValue().substring(0,r).match(/(span\.|resource\.|\.)?([\w./-]*)$/);if(t){const a=t[1],n=t[2];n&&(a||"."===e.insertText[0]||(e.insertText="."+e.insertText),e.range=s.Range.lift(Object.assign({},e.range,{startColumn:r-n.length+1})))}}}(i,t.type,e,s,this.monaco),i}));return{suggestions:n}}))}setTags(e){e.forEach((e=>this.tags[e]=new Set))}overrideTagName(e){return"status"===e?"status.code":e}async getTagValues(e){let t=[];return this.cachedValues.hasOwnProperty(e)?t=this.cachedValues[e]:(t=await this.languageProvider.getOptions(e),this.cachedValues[e]=t),t}async getCompletions(e){if(!Object.keys(this.tags).length)return[];switch(e.type){case"UNKNOWN":return[];case"EMPTY":return this.getScopesCompletions("{ ").concat(this.getIntrinsicsCompletions("{ ")).concat(this.getTagsCompletions("{ ."));case"SPANSET_EMPTY":return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions("."));case"SPANSET_ONLY_DOT":case"SPANSET_IN_NAME_SCOPE":return this.getTagsCompletions();case"SPANSET_IN_NAME":return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions());case"SPANSET_AFTER_NAME":return ge.operators.map((e=>({label:e,insertText:e,type:"OPERATOR"})));case"SPANSET_IN_VALUE":const t=this.overrideTagName(e.tagName),a=["status"],r=await this.getTagValues(t),s=[],n=t=>e.betweenQuotes||a.includes(e.tagName)?t.label:`"${t.label}"`;return r.forEach((e=>{null!=e&&e.label&&s.push({label:e.label,insertText:n(e),type:"TAG_VALUE"})})),s;case"SPANSET_AFTER_VALUE":return ge.logicalOps.concat("}").map((e=>({label:e,insertText:e,type:"OPERATOR"})));default:throw new Error(`Unexpected situation ${e}`)}}getTagsCompletions(e){return Object.keys(this.tags).sort(((e,t)=>e.localeCompare(t,void 0,{sensitivity:"accent"}))).map((t=>({label:t,insertText:(e||"")+t,type:"TAG_NAME"})))}getIntrinsicsCompletions(e){return ge.intrinsics.map((t=>({label:t,insertText:(e||"")+t,type:"KEYWORD"})))}getScopesCompletions(e){return ge.scopes.map((t=>({label:t,insertText:(e||"")+t,type:"SCOPE"})))}getSituationInSpanSet(e){const t=new RegExp("([\\s{])("+/(?<name>[\w./-]+)?/.source+"(?<space1>\\s*)("+/(?<op>[!=+\-<>]+)/.source+"(?<space2>\\s*)"+/(?<value>(?<open_quote>")([^"\n&|]+)?(?<close_quote>")?|([^"\n\s&|]+))?/.source+")?)(?<space3>\\s*)$"),a=e.match(t);if(a){var r,s,n,i,o;const e=null===(r=a.groups)||void 0===r?void 0:r.name,t=null===(s=a.groups)||void 0===s?void 0:s.op;if(!e)return{type:"SPANSET_EMPTY"};if("."===e)return{type:"SPANSET_ONLY_DOT"};const u=e.match(/^(?<pre_dot>\.)?(?<word>\w[\w./-]*\w)(?<post_dot>\.)?$/);var l,c;if(!t)return ge.scopes.filter((e=>{var t;return e===(null==u||null===(t=u.groups)||void 0===t?void 0:t.word)}))&&null!=u&&null!==(l=u.groups)&&void 0!==l&&l.post_dot?{type:"SPANSET_IN_NAME_SCOPE"}:{type:null!==(c=a.groups)&&void 0!==c&&c.space1?"SPANSET_AFTER_NAME":"SPANSET_IN_NAME"};if(null!==(n=a.groups)&&void 0!==n&&n.space3&&a.groups.open_quote===a.groups.close_quote)return{type:"SPANSET_AFTER_VALUE"};return{type:"SPANSET_IN_VALUE",tagName:ge.scopes.reduce(((e,t)=>e.replace(`${t}.`,"")),(null==u||null===(i=u.groups)||void 0===i?void 0:i.word)||""),betweenQuotes:!(null===(o=a.groups)||void 0===o||!o.open_quote)}}return{type:"EMPTY"}}getSituation(e,t){if(""===e||0===t)return{type:"EMPTY"};const a=e.substring(0,t);return a.lastIndexOf("{")>a.lastIndexOf("}")?this.getSituationInSpanSet(a):{type:"UNKNOWN"}}}function me(e,t){switch(e){case"TAG_NAME":return t.languages.CompletionItemKind.Enum;case"KEYWORD":return t.languages.CompletionItemKind.Keyword;case"OPERATOR":return t.languages.CompletionItemKind.Operator;case"TAG_VALUE":return t.languages.CompletionItemKind.EnumMember;case"SCOPE":return t.languages.CompletionItemKind.Class;default:throw new Error(`Unexpected CompletionType: ${e}`)}}he(ge,"intrinsics",["duration","name","status"]),he(ge,"scopes",["resource","span"]),he(ge,"operators",["=","-","+","<",">",">=","<=","=~"]),he(ge,"logicalOps",["&&","||"]);const ve={id:"traceql",extensions:[".traceql"],aliases:["tempo","traceql"],mimetypes:[],def:{language:{ignoreCase:!1,defaultToken:"",tokenPostfix:".traceql",keywords:["duration","name","status","parent"].concat(["resource","span"]).concat(["false","true"]),operators:["=","!=",">","<",">=","<=","=~","!~"],symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,integersuffix:/(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,floatsuffix:/[fFlL]?/,tokenizer:{root:[[/[a-z_.][\w./_-]*(?=\s*(=|!=|>|<|>=|<=|=~|!~))/,"tag"],[/[a-zA-Z_.]\w*/,{cases:{"@keywords":"type","@default":"identifier"}}],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/\d+/,"number"],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],clauses:[[/[^(,)]/,"tag"],[/\)/,"identifier","@pop"]],whitespace:[[/[ \t\r\n]+/,"white"]]}},languageConfiguration:{wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}}}};function fe(e){const{onChange:t,onRunQuery:a,placeholder:r}=e,s=function(e){const t=(0,n.useRef)(new ge({languageProvider:e.languageProvider}));(0,n.useEffect)((()=>{(async()=>{try{await e.languageProvider.start();const a=e.languageProvider.getTags();a&&t.current.setTags(a)}catch(e){e instanceof Error&&(0,pe.WI)((0,de.$l)((0,ue.t_)("Error",e)))}})()}),[e]);const a=(0,n.useRef)(null);return(0,n.useEffect)((()=>()=>{var e;null===(e=a.current)||void 0===e||e.call(a)}),[]),(e,r)=>{t.current.editor=e,t.current.monaco=r;const{dispose:s}=r.languages.registerCompletionItemProvider(be,t.current);a.current=s}}(e.datasource),o=(0,f.l4)(),l=je(o,r);return(0,i.jsx)(ce.p,{value:e.value,language:be,onBlur:t,onChange:t,containerStyles:l.queryField,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on"},onBeforeEditorMount:xe,onEditorDidMount:(e,t)=>{s(e,t),function(e,t,a){e.addAction({id:"run-query",label:"Run Query",keybindings:[t.KeyMod.Shift|t.KeyCode.Enter],contextMenuGroupId:"navigation",contextMenuOrder:1.5,run:function(){a()}})}(e,t,a),function(e,t,a){const r=[{range:new t.Range(1,1,1,1),options:{className:a.placeholder,isWholeLine:!0}}];let s=[];const n=()=>{const t=e.getModel();if(!t)return;const a=0===t.getValueLength()?r:[];s=t.deltaDecorations(s,a)};n(),e.onDidChangeModelContent(n)}(e,t,l),function(e){const t=e.getDomNode(),a=()=>{if(t){const a=Math.min(1e3,e.getContentHeight()),r=parseInt(t.style.width,10);t.style.width=`${r}px`,t.style.height=`${a}px`,e.layout({width:r,height:a})}};e.onDidContentSizeChange(a),a()}(e)}})}let ye=!1;const be="traceql";function xe(e){if(!ye){ye=!0;const{aliases:t,extensions:a,mimetypes:r,def:s}=ve;e.languages.register({id:be,aliases:t,extensions:a,mimetypes:r}),e.languages.setMonarchTokensProvider(be,s.language),e.languages.setLanguageConfiguration(be,s.languageConfiguration)}}const je=(e,t)=>({queryField:o.css`
      border-radius: ${e.shape.borderRadius()};
      border: 1px solid ${e.components.input.borderColor};
      flex: 1;
    `,placeholder:o.css`
      ::after {
        content: '${t}';
        font-family: ${e.typography.fontFamilyMonospace};
        opacity: 0.3;
      }
    `});var Te;function _e(e){const t=(0,f.wW)(Se),a=(0,b.defaults)(e.query,x);return(0,i.jsxs)(i.Fragment,{children:[Te||(Te=(0,i.jsxs)(v.W,{children:["Build complex queries using TraceQL to select a list of traces."," ",(0,i.jsx)("a",{rel:"noreferrer",target:"_blank",href:"https://github.com/grafana/tempo/blob/main/docs/design-proposals/2022-04%20TraceQL%20Concepts.md",children:"Documentation"})]})),(0,i.jsx)(fe,{placeholder:"Enter a TraceQL query (run with Shift+Enter)",value:a.query,onChange:t=>{e.onChange(Object.assign({},a,{query:t}))},datasource:e.datasource,onRunQuery:e.onRunQuery}),(0,i.jsx)("div",{className:t.optionsContainer,children:(0,i.jsx)(le,{query:a,onChange:e.onChange})})]})}const Se=()=>({optionsContainer:o.css`
    margin-top: 10px;
  `});var we=a(57706),Ce=a.n(we),Ne=a(86351),Ee=a(51320),Oe=a(55128),De=a(25285),qe=a(70917),ke=a(4645),Ie=a(2843),Qe=a(93686);const Pe="tempo",Re="e.g. 1.2s, 100ms",$e=[(0,Ee.h)(),(0,Oe.Z)({onlyIn:e=>"block"===e.object&&"code_block"===e.type,getSyntax:()=>Pe})];Ce().languages.tempo={key:{pattern:/[^\s]+(?==)/,alias:"attr-name"},operator:/[=]/,value:[{pattern:/"(.+)"/},{pattern:/[^\s]+/}]};const Ae=e=>{let{datasource:t,query:a,onChange:r,onBlur:s,onRunQuery:o}=e;const l=(0,f.wW)(Le),c=(0,n.useMemo)((()=>new K(t)),[t]),[u,h]=(0,n.useState)(!1),[g,v]=(0,n.useState)(),[y,b]=(0,n.useState)(),[x,j]=(0,n.useState)(null),[T,_]=(0,n.useState)({}),[S,w]=(0,n.useState)({serviceName:!1,spanName:!1}),C=(0,n.useCallback)((async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const a="serviceName"===e?"service.name":"name";w((t=>Object.assign({},t,{[e]:!0})));try{const r=await c.getOptions(a);return r.filter((e=>!!e.value&&(0,De.C)(e.value,t).found))}catch(e){return(0,F.kW)(e)&&404===(null==e?void 0:e.status)?j(e):e instanceof Error&&(0,pe.WI)((0,Qe.$l)((0,ue.t_)("Error",e))),[]}finally{w((t=>Object.assign({},t,{[e]:!1})))}}),[c]);(0,n.useEffect)((()=>{(async()=>{try{const[e,t]=await Promise.all([C("serviceName"),C("spanName")]);a.serviceName&&(0,W.J)().containsTemplate(a.serviceName)&&e.push((0,Ne.E)(a.serviceName)),v(e),a.spanName&&(0,W.J)().containsTemplate(a.spanName)&&t.push((0,Ne.E)(a.spanName)),b(t)}catch(e){(0,F.kW)(e)&&404===(null==e?void 0:e.status)?j(e):e instanceof Error&&(0,pe.WI)((0,Qe.$l)((0,ue.t_)("Error",e)))}})()}),[c,C,a.serviceName,a.spanName]),(0,n.useEffect)((()=>{(async()=>{try{await c.start(),h(!0)}catch(e){e instanceof Error&&(0,pe.WI)((0,Qe.$l)((0,ue.t_)("Error",e)))}})()}),[c]);const N=(0,n.useCallback)((async e=>await c.provideCompletionItems(e)),[c]),E=(0,n.useCallback)((e=>{const t=e.split(/\s+(?=([^"]*"[^"]*")*[^"]*$)/g);return t.length>1?t[t.length-1]:e}),[]),O=e=>{"Enter"===e.key&&(e.shiftKey||e.ctrlKey)&&o()},D=(0,n.useCallback)((e=>{r(Object.assign({},a,{search:e}))}),[r,a]),q=(0,W.J)();return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:l.container,children:[(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Service Name",labelWidth:14,grow:!0,children:(0,i.jsx)(qe.Ph,{inputId:"service",options:g,onOpenMenu:()=>{C("serviceName")},isLoading:S.serviceName,value:(null==g?void 0:g.find((e=>(null==e?void 0:e.value)===a.serviceName)))||a.serviceName,onChange:e=>{r(Object.assign({},a,{serviceName:null==e?void 0:e.value}))},placeholder:"Select a service",isClearable:!0,onKeyDown:O,"aria-label":"select-service-name",allowCustomValue:!0})})}),(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Span Name",labelWidth:14,grow:!0,children:(0,i.jsx)(qe.Ph,{inputId:"spanName",options:y,onOpenMenu:()=>{C("spanName")},isLoading:S.spanName,value:(null==y?void 0:y.find((e=>(null==e?void 0:e.value)===a.spanName)))||a.spanName,onChange:e=>{r(Object.assign({},a,{spanName:null==e?void 0:e.value}))},placeholder:"Select a span",isClearable:!0,onKeyDown:O,"aria-label":"select-span-name",allowCustomValue:!0})})}),(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Tags",labelWidth:14,grow:!0,tooltip:"Values should be in logfmt.",children:(0,i.jsx)(m.q,{additionalPlugins:$e,query:a.search,onTypeahead:N,onBlur:s,onChange:D,cleanText:E,placeholder:"http.status_code=200 error=true",onRunQuery:o,syntaxLoaded:u,portalOrigin:"tempo"})})}),(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Min Duration",invalid:!!T.minDuration,labelWidth:14,grow:!0,children:(0,i.jsx)(ke.I,{id:"minDuration",value:a.minDuration||"",placeholder:Re,onBlur:()=>{var e;const t=q.replace(null!==(e=a.minDuration)&&void 0!==e?e:"");a.minDuration&&!(0,L.IA)(t)?_(Object.assign({},T,{minDuration:!0})):_(Object.assign({},T,{minDuration:!1}))},onChange:e=>r(Object.assign({},a,{minDuration:e.currentTarget.value})),onKeyDown:O})})}),(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Max Duration",invalid:!!T.maxDuration,labelWidth:14,grow:!0,children:(0,i.jsx)(ke.I,{id:"maxDuration",value:a.maxDuration||"",placeholder:Re,onBlur:()=>{var e;const t=q.replace(null!==(e=a.maxDuration)&&void 0!==e?e:"");a.maxDuration&&!(0,L.IA)(t)?_(Object.assign({},T,{maxDuration:!0})):_(Object.assign({},T,{maxDuration:!1}))},onChange:e=>r(Object.assign({},a,{maxDuration:e.currentTarget.value})),onKeyDown:O})})}),(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Limit",invalid:!!T.limit,labelWidth:14,grow:!0,tooltip:"Maximum number of returned results",children:(0,i.jsx)(ke.I,{id:"limit",value:a.limit||"",placeholder:"Default: 20",type:"number",onChange:e=>{let t=e.currentTarget.value?parseInt(e.currentTarget.value,10):void 0;t&&(!Number.isInteger(t)||t<=0)?_(Object.assign({},T,{limit:!0})):_(Object.assign({},T,{limit:!1})),r(Object.assign({},a,{limit:e.currentTarget.value?parseInt(e.currentTarget.value,10):void 0}))},onKeyDown:O})})})]}),x?(0,i.jsxs)(Ie.b,{title:"Unable to connect to Tempo search",severity:"info",className:l.alert,children:["Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can configure it in the ",(0,i.jsx)("a",{href:`/datasources/edit/${t.uid}`,children:"datasource settings"}),"."]}):null]})},Le=e=>({container:o.css`
    max-width: 500px;
  `,alert:o.css`
    max-width: 75ch;
    margin-top: ${e.spacing(2)};
  `});var Me,Ue,We,Fe=a(67684),Ve=a(8910);async function Be(e){if(!e)return;const t=(0,Ve.F)();try{return await t.get(e)}catch(e){return void console.error("Failed to load data source",e)}}function Ge(e){let{graphDatasourceUid:t,query:a,onChange:r}=e;const s=(0,f.wW)(Ke),o=(0,l.Z)((()=>Be(t)),[t]),[u,h]=(0,n.useState)(void 0);if((0,n.useEffect)((()=>{!o.loading&&o.value&&async function(e){const t=await e.getTagKeys({series:["traces_service_graph_request_server_seconds_sum","traces_service_graph_request_total","traces_service_graph_request_failed_total"]});h(Boolean(t.length))}(o.value)}),[o]),o.loading)return null;const g=o.value;if(!t)return Me||(Me=(0,i.jsx)("div",{className:"text-warning",children:"Please set up a service graph datasource in the datasource settings."}));if(t&&!g)return Ue||(Ue=(0,i.jsx)("div",{className:"text-warning",children:"Service graph datasource is configured but the data source no longer exists. Please configure existing data source to use the service graph functionality."}));const m=function(e){let t,a=[];const r=/([\w_]+)(=|!=|<|>|=~|!~)"(.*?)"/g;for(;null!==(t=r.exec(e));)a.push({key:t[1],operator:t[2],value:t[3],condition:""});return a}(a.serviceMapQuery||"");return(0,i.jsxs)("div",{children:[(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Filter",labelWidth:14,grow:!0,children:(0,i.jsx)(Fe.F,{datasource:{uid:t},filters:m,getTagKeysOptions:{series:c.v.featureToggles.tempoApmTable?["traces_service_graph_request_total","traces_spanmetrics_calls_total"]:["traces_service_graph_request_total"]},addFilter:e=>{r(Object.assign({},a,{serviceMapQuery:ze([...m,e])}))},removeFilter:e=>{const t=[...m];t.splice(e,1),r(Object.assign({},a,{serviceMapQuery:ze(t)}))},changeFilter:(e,t)=>{const s=[...m];s.splice(e,1,t),r(Object.assign({},a,{serviceMapQuery:ze(s)}))}})})}),!1===u?(0,i.jsxs)(Ie.b,{title:"No service graph data found",severity:"info",className:s.alert,children:["Please ensure that service graph metrics are set up correctly according to the"," ",We||(We=(0,i.jsx)("a",{target:"_blank",rel:"noreferrer noopener",href:"https://grafana.com/docs/tempo/next/grafana-agent/service-graphs/",children:"Tempo documentation"})),"."]}):null]})}function ze(e){return`{${e.map((e=>`${e.key}${e.operator}"${e.value}"`)).join(",")}}`}const Ke=e=>({alert:o.css`
    max-width: 75ch;
    margin-top: ${e.spacing(2)};
  `});var Ze,Ye;function Je(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class He extends n.PureComponent{constructor(e){super(e),Je(this,"onChangeLinkedQuery",(e=>{const{query:t,onChange:a}=this.props;a(Object.assign({},t,{linkedQuery:Object.assign({},e,{refId:"linked"})}))})),Je(this,"onRunLinkedQuery",(()=>{this.props.onRunQuery()})),Je(this,"onClearResults",(()=>{const{onChange:e,query:t,onRunQuery:a}=this.props;e(Object.assign({},t,{queryType:"clear"})),a()}))}async componentDidMount(){this.props.query.queryType&&"clear"!==this.props.query.queryType||this.props.onChange(Object.assign({},this.props.query,{queryType:"traceId"}))}render(){var e,t;const{query:a,onChange:r,datasource:s,app:n}=this.props,l=s.getLokiSearchDS(),v=null===(e=s.serviceMap)||void 0===e?void 0:e.datasourceUid,f=[{value:"traceId",label:"TraceID"},{value:"upload",label:"JSON File"},{value:"serviceMap",label:"Service Graph"}];var y;(null!=s&&null!==(t=s.search)&&void 0!==t&&t.hide||f.unshift({value:"nativeSearch",label:"Search"}),l)&&(null!=s&&null!==(y=s.search)&&void 0!==y&&y.hide?f.unshift({value:"search",label:"Search"}):f.push({value:"search",label:"Loki Search"}));return c.v.featureToggles.traceqlEditor&&f.push({value:"traceql",label:"TraceQL"}),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Query type",children:(0,i.jsx)(h.S,{options:f,value:a.queryType,onChange:e=>{var t;(0,u.ff)("grafana_traces_query_type_changed",{datasourceType:"tempo",app:null!=n?n:"",newQueryType:e,previousQueryType:null!==(t=a.queryType)&&void 0!==t?t:""}),this.onClearResults(),r(Object.assign({},a,{queryType:e}))},size:"md"})})}),"search"===a.queryType&&(0,i.jsx)(Xe,{logsDatasourceUid:l,query:a,onRunQuery:this.onRunLinkedQuery,onChange:this.onChangeLinkedQuery}),"nativeSearch"===a.queryType&&(0,i.jsx)(Ae,{datasource:this.props.datasource,query:a,onChange:r,onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery}),"upload"===a.queryType&&(0,i.jsx)("div",{className:(0,o.css)({padding:this.props.theme.spacing(2)}),children:(0,i.jsx)(g.Yo,{options:{multiple:!1},onLoad:e=>{this.props.datasource.uploadedJson=e,this.props.onRunQuery()}})}),"traceId"===a.queryType&&(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Trace ID",labelWidth:14,grow:!0,children:(0,i.jsx)(m.q,{query:a.query,onChange:e=>{r(Object.assign({},a,{query:e,queryType:"traceId",linkedQuery:void 0}))},onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery,placeholder:"Enter a Trace ID (run with Shift+Enter)",portalOrigin:"tempo"})})}),"serviceMap"===a.queryType&&(0,i.jsx)(Ge,{graphDatasourceUid:v,query:a,onChange:r}),"traceql"===a.queryType&&(0,i.jsx)(_e,{datasource:this.props.datasource,query:a,onRunQuery:this.props.onRunQuery,onChange:r})]})}}function Xe(e){let{logsDatasourceUid:t,onChange:a,onRunQuery:r,query:s}=e;const n=(0,l.Z)((()=>Be(t)),[t]);if(n.loading)return null;const o=n.value;var c;return o?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(v.W,{children:["Tempo uses ",o.name," to find traces."]}),(0,i.jsx)(y.n,{datasource:o,onChange:a,onRunQuery:r,query:null!==(c=s.linkedQuery)&&void 0!==c?c:{refId:"linked"},history:[]})]}):t?t&&!o?Ye||(Ye=(0,i.jsx)("div",{className:"text-warning",children:"Loki search datasource is configured but the data source no longer exists. Please configure existing data source to use the search."})):null:Ze||(Ze=(0,i.jsx)("div",{className:"text-warning",children:"Please set up a Loki search datasource in the datasource settings."}))}const et=(0,f.HE)(He);var tt,at=a(58582),rt=a(97602),st=a(6288),nt=a(11753),it=a(23218),ot=a(70332),lt=a(94570),ct=a(8006);function ut(e){var t,a,r,s;let{options:n,onOptionsChange:l}=e;const c=(0,f.wW)(dt),u=!1!==(null===(t=n.jsonData.tracesToLogs)||void 0===t?void 0:t.lokiSearch)?null===(a=n.jsonData.tracesToLogs)||void 0===a?void 0:a.datasourceUid:void 0;return u&&void 0===n.jsonData.lokiSearch&&(0,ot.tp)({onOptionsChange:l,options:n},"lokiSearch",{datasourceUid:u}),(0,i.jsxs)("div",{className:(0,o.css)({width:"100%"}),children:[tt||(tt=(0,i.jsx)("h3",{className:"page-heading",children:"Loki Search"})),(0,i.jsx)("div",{className:c.infoText,children:"Select a Loki datasource to search for traces. Derived fields must be configured in the Loki data source."}),(0,i.jsxs)(d.Z,{className:c.row,children:[(0,i.jsx)(p._,{tooltip:"The Loki data source with the service graph data",label:"Data source",labelWidth:26,children:(0,i.jsx)(lt.q,{inputId:"loki-search-data-source-picker",pluginId:"loki",current:null===(r=n.jsonData.lokiSearch)||void 0===r?void 0:r.datasourceUid,noDefault:!0,width:40,onChange:e=>(0,ot.tp)({onOptionsChange:l,options:n},"lokiSearch",{datasourceUid:e.uid})})}),null!==(s=n.jsonData.lokiSearch)&&void 0!==s&&s.datasourceUid?(0,i.jsx)(ct.zx,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,ot.tp)({onOptionsChange:l,options:n},"lokiSearch",{datasourceUid:void 0})},children:"Clear"}):null]})]})}const dt=e=>({infoText:o.css`
    label: infoText;
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `,row:o.css`
    label: row;
    align-items: baseline;
  `});var pt,ht=a(70800);function gt(e){var t,a,r,s,n;let{options:o,onOptionsChange:l}=e;const c=(0,f.wW)(mt);return(0,i.jsxs)("div",{className:c.container,children:[pt||(pt=(0,i.jsx)("h3",{className:"page-heading",children:"TraceID Query"})),(0,i.jsx)(p._,{label:"Use time range in query",tooltip:"The time range is ignored by default when querying by TraceID but can be used when there are performance issues or timeouts since it will narrow down the search to the defined range. Default is disabled.",labelWidth:26,children:(0,i.jsx)(ht.x,{id:"enable-time-shift",value:(null===(t=o.jsonData.traceQuery)||void 0===t?void 0:t.timeShiftEnabled)||!1,onChange:e=>{(0,ot.tp)({onOptionsChange:l,options:o},"traceQuery",Object.assign({},o.jsonData.traceQuery,{timeShiftEnabled:e.currentTarget.checked}))}})}),(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Time shift for start of search",labelWidth:26,disabled:!(null!==(a=o.jsonData.traceQuery)&&void 0!==a&&a.timeShiftEnabled),grow:!0,tooltip:"Shifts the start of the time range when searching by TraceID. This is needed as searching for traces can return traces that do not fully fall into the search time range, so we recommend using higher time shifts for longer traces. Default 30m (Time units can be used here, for example: 5s, 1m, 3h)",children:(0,i.jsx)(ke.I,{type:"text",placeholder:"30m",width:40,onChange:e=>(0,ot.tp)({onOptionsChange:l,options:o},"traceQuery",Object.assign({},o.jsonData.traceQuery,{spanStartTimeShift:e.currentTarget.value})),value:(null===(r=o.jsonData.traceQuery)||void 0===r?void 0:r.spanStartTimeShift)||""})})}),(0,i.jsx)(d.Z,{children:(0,i.jsx)(p._,{label:"Time shift for end of search",labelWidth:26,disabled:!(null!==(s=o.jsonData.traceQuery)&&void 0!==s&&s.timeShiftEnabled),grow:!0,tooltip:"Shifts the end of the time range when searching by TraceID. This is needed as searching for traces can return traces that do not fully fall into the search time range, so we recommend using higher time shifts for longer traces. Default 30m (Time units can be used here, for example: 5s, 1m, 3h)",children:(0,i.jsx)(ke.I,{type:"text",placeholder:"30m",width:40,onChange:e=>(0,ot.tp)({onOptionsChange:l,options:o},"traceQuery",Object.assign({},o.jsonData.traceQuery,{spanEndTimeShift:e.currentTarget.value})),value:(null===(n=o.jsonData.traceQuery)||void 0===n?void 0:n.spanEndTimeShift)||""})})})]})}const mt=()=>({container:o.css`
    label: container;
    width: 100%;
  `,row:o.css`
    label: row;
    align-items: baseline;
  `});var vt;function ft(e){var t;let{options:a,onOptionsChange:r}=e;const s=(0,f.wW)(yt);return(0,i.jsxs)("div",{className:s.container,children:[vt||(vt=(0,i.jsx)("h3",{className:"page-heading",children:"Search"})),(0,i.jsx)(d.Z,{className:s.row,children:(0,i.jsx)(p._,{tooltip:"Removes the Search tab from the Tempo query editor.",label:"Hide search",labelWidth:26,children:(0,i.jsx)(ht.x,{id:"hideSearch",value:null===(t=a.jsonData.search)||void 0===t?void 0:t.hide,onChange:e=>(0,ot.tp)({onOptionsChange:r,options:a},"search",Object.assign({},a.jsonData.search,{hide:e.currentTarget.checked}))})})})]})}const yt=()=>({container:o.css`
    label: container;
    width: 100%;
  `,row:o.css`
    label: row;
    align-items: baseline;
  `});var bt;function xt(e){var t,a;let{options:r,onOptionsChange:s}=e;const n=(0,f.wW)(jt);return(0,i.jsxs)("div",{className:(0,o.css)({width:"100%"}),children:[bt||(bt=(0,i.jsx)("h3",{className:"page-heading",children:"Service Graph"})),(0,i.jsx)("div",{className:n.infoText,children:"To allow querying service graph data you have to select a Prometheus instance where the data is stored."}),(0,i.jsxs)(d.Z,{className:n.row,children:[(0,i.jsx)(p._,{tooltip:"The Prometheus data source with the service graph data",label:"Data source",labelWidth:26,children:(0,i.jsx)(lt.q,{inputId:"service-graph-data-source-picker",pluginId:"prometheus",current:null===(t=r.jsonData.serviceMap)||void 0===t?void 0:t.datasourceUid,noDefault:!0,width:40,onChange:e=>(0,ot.tp)({onOptionsChange:s,options:r},"serviceMap",{datasourceUid:e.uid})})}),null!==(a=r.jsonData.serviceMap)&&void 0!==a&&a.datasourceUid?(0,i.jsx)(ct.zx,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,ot.tp)({onOptionsChange:s,options:r},"serviceMap",{datasourceUid:void 0})},children:"Clear"}):null]})]})}const jt=e=>({infoText:o.css`
    label: infoText;
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `,row:o.css`
    label: row;
    align-items: baseline;
  `}),Tt=new s.hf(J).setQueryEditor(et).setConfigEditor((e=>{let{options:t,onOptionsChange:a}=e;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(at.E,{defaultUrl:"http://tempo",dataSourceConfig:t,showAccessOptions:!1,onChange:a}),(0,i.jsx)("div",{className:"gf-form-group",children:(0,i.jsx)(nt.Z,{options:t,onOptionsChange:a})}),c.v.featureToggles.traceToMetrics?(0,i.jsx)("div",{className:"gf-form-group",children:(0,i.jsx)(it.F,{options:t,onOptionsChange:a})}):null,(0,i.jsx)("div",{className:"gf-form-group",children:(0,i.jsx)(xt,{options:t,onOptionsChange:a})}),(0,i.jsx)("div",{className:"gf-form-group",children:(0,i.jsx)(ft,{options:t,onOptionsChange:a})}),(0,i.jsx)("div",{className:"gf-form-group",children:(0,i.jsx)(st.n,{options:t,onOptionsChange:a})}),(0,i.jsx)("div",{className:"gf-form-group",children:(0,i.jsx)(ut,{options:t,onOptionsChange:a})}),(0,i.jsx)("div",{className:"gf-form-group",children:(0,i.jsx)(gt,{options:t,onOptionsChange:a})}),(0,i.jsx)("div",{className:"gf-form-group",children:(0,i.jsx)(rt.e6,{options:t,onOptionsChange:a})})]})})).setQueryEditorHelp((function(){return r||(r=(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{id:"tempo-cheat-sheet",children:"Tempo Cheat Sheet"}),(0,i.jsx)("p",{children:"Tempo is a trace id lookup store. Enter a trace id in the above field and hit “Run Query” to retrieve your trace. Tempo is generally paired with other datasources such as Loki or Prometheus to find traces."}),(0,i.jsxs)("p",{children:["Here are some"," ",(0,i.jsx)("a",{href:"https://grafana.com/docs/tempo/latest/guides/instrumentation/",target:"blank",children:"instrumentation examples"})," ","to get you started with trace discovery through logs and metrics (exemplars)."]})]}))}))}}]);
//# sourceMappingURL=tempoPlugin.ca65164e21145c67b5e3.js.map