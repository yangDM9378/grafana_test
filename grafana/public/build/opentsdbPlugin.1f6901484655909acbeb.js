"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3168],{54485:(e,t,s)=>{s.r(t),s.d(t,{plugin:()=>Le});var a,r=s(23214),i=s(68404),n=s(58582),o=s(65231),l=s(5333),c=s(52370),u=s(45916);const{Select:d,Input:g}=o.vw6,m=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],p=[{label:"second",value:1},{label:"millisecond",value:2}],h=e=>{var t,s,r;const{onChange:i,value:n}=e,o=(0,c.L)();return(0,u.jsxs)(u.Fragment,{children:[a||(a=(0,u.jsx)("h5",{children:"OpenTSDB settings"})),(0,u.jsxs)("div",{className:"gf-form",children:[(0,u.jsx)(l.c,{width:7,htmlFor:`select-version-${o}`,children:"Version"}),(0,u.jsx)(d,{inputId:`select-version-${o}`,options:m,value:null!==(t=m.find((e=>e.value===n.jsonData.tsdbVersion)))&&void 0!==t?t:m[0],onChange:f("tsdbVersion",n,i)})]}),(0,u.jsxs)("div",{className:"gf-form",children:[(0,u.jsx)(l.c,{width:7,htmlFor:`select-resolution-${o}`,children:"Resolution"}),(0,u.jsx)(d,{inputId:`select-resolution-${o}`,options:p,value:null!==(s=p.find((e=>e.value===n.jsonData.tsdbResolution)))&&void 0!==s?s:p[0],onChange:f("tsdbResolution",n,i)})]}),(0,u.jsxs)("div",{className:"gf-form",children:[(0,u.jsx)(l.c,{width:7,htmlFor:`lookup-input-${o}`,children:"Lookup limit"}),(0,u.jsx)(g,{id:`lookup-input-${o}`,type:"number",value:null!==(r=n.jsonData.lookupLimit)&&void 0!==r?r:1e3,onChange:v("lookupLimit",n,i)})]})]})},f=(e,t,s)=>a=>{s(Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:a.value})}))},v=(e,t,s)=>a=>{s(Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:a.currentTarget.value})}))};var x=s(52423),j=s(76093),y=s(16755),b=s(86351),w=s(4645),C=s(70917),N=s(66946),T=s(70800);const k=(0,x.css)({paddingRight:"4px"});var S,O,V,R,P;function q(e){var t,s;let{query:a,onChange:r,onRunQuery:i,aggregators:n,fillPolicies:o,tsdbVersion:c}=e;const d=n.map((e=>(0,b.E)(e))),g=o.map((e=>(0,b.E)(e)));return(0,u.jsxs)("div",{className:"gf-form-inline","data-testid":_.section,children:[(0,u.jsxs)("div",{className:"gf-form",children:[S||(S=(0,u.jsx)(l.c,{className:"query-keyword",width:8,tooltip:(0,u.jsxs)("div",{children:["Leave interval blank for auto or for example use ",(0,u.jsx)("code",{children:"1m"})]}),children:"Down sample"})),(0,u.jsx)(w.I,{width:25,className:k,"data-testid":_.interval,placeholder:"interval",value:null!==(t=a.downsampleInterval)&&void 0!==t?t:"",onChange:e=>{const t=e.currentTarget.value;r(Object.assign({},a,{downsampleInterval:t}))},onBlur:()=>i()})]}),(0,u.jsxs)("div",{className:"gf-form",children:[O||(O=(0,u.jsx)(l.c,{width:"auto",className:"query-keyword",children:"Aggregator"})),(0,u.jsx)(C.Ph,{className:"gf-form-input",value:a.downsampleAggregator?(0,b.E)(a.downsampleAggregator):void 0,options:d,onChange:e=>{let{value:t}=e;t&&(r(Object.assign({},a,{downsampleAggregator:t})),i())}})]}),c>=2&&(0,u.jsxs)("div",{className:"gf-form",children:[V||(V=(0,u.jsx)(N.W,{className:"width-6 query-keyword",children:"Fill"})),(0,u.jsx)(C.Ph,{inputId:"opentsdb-fillpolicy-select",value:a.downsampleFillPolicy?(0,b.E)(a.downsampleFillPolicy):void 0,options:g,onChange:e=>{let{value:t}=e;t&&(r(Object.assign({},a,{downsampleFillPolicy:t})),i())}})]}),(0,u.jsxs)("div",{className:"gf-form",children:[R||(R=(0,u.jsx)(l.c,{className:"query-keyword",children:"Disable downsampling"})),(0,u.jsx)(T.x,{value:null!==(s=a.disableDownsampling)&&void 0!==s&&s,onChange:()=>{var e;const t=null!==(e=a.disableDownsampling)&&void 0!==e&&e;r(Object.assign({},a,{disableDownsampling:!t})),i()}})]}),P||(P=(0,u.jsx)("div",{className:"gf-form gf-form--grow",children:(0,u.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}))]})}const _={section:"opentsdb-downsample",interval:"downsample-interval"};var D,L,M,E,Q,A,F,I,B,K=s(82897),U=s(8006),J=s(99500);function z(e){let{query:t,onChange:s,onRunQuery:a,suggestTagKeys:r,filterTypes:n,suggestTagValues:o}=e;const c=(0,y.wW)(U.gN),[d,g]=(0,i.useState)(),[m,p]=(0,i.useState)(),[h,f]=(0,i.useState)(),[v,x]=(0,i.useState)(),[j,w]=(0,i.useState)(!1),[k,S]=(0,i.useState)("iliteral_or"),[O,V]=(0,i.useState)(""),[R,P]=(0,i.useState)(""),[q,_]=(0,i.useState)(!1),[z,$]=(0,i.useState)(""),W=n.map((e=>(0,b.E)(e)));function H(){w(!j)}function X(){if(t.tags&&(0,K.size)(t.tags)>0){return void $("Please remove tags to use filters, tags and filters are mutually exclusive.")}if(!j)return void w(!0);const e={type:k,tagk:O,filter:R,groupBy:q};t.filters=t.filters?t.filters.concat([e]):[e],S("literal_or"),V(""),P(""),_(!1),s(t),a(),H()}function Y(e){var r;null===(r=t.filters)||void 0===r||r.splice(e,1),s(t),a()}const Z=(0,i.useCallback)(((e,t)=>{var s;const a=null!==(s=e.value)&&void 0!==s?s:"";return t.split(" ").reduce(((e,t)=>e&&a.toLowerCase().includes(t.toLowerCase())),!0)}),[]);return(0,u.jsxs)("div",{className:"gf-form-inline","data-testid":G.section,children:[(0,u.jsxs)("div",{className:"gf-form",children:[D||(D=(0,u.jsx)(l.c,{className:"query-keyword",width:8,tooltip:(0,u.jsx)("div",{children:"Filters does not work with tags, either of the two will work but not both."}),children:"Filters"})),t.filters&&t.filters.map(((e,t)=>(0,u.jsxs)(l.c,{width:"auto","data-testid":G.list+t,children:[e.tagk," = ",e.type,"(",e.filter,"), groupBy = ",""+e.groupBy,(0,u.jsx)("button",{type:"button",className:c,onClick:()=>function(e,t){Y(t),V(e.tagk),P(e.filter),S(e.type),_(e.groupBy),X()}(e,t),children:L||(L=(0,u.jsx)(J.J,{name:"pen"}))}),(0,u.jsx)("button",{type:"button",className:c,onClick:()=>Y(t),"data-testid":G.remove,children:M||(M=(0,u.jsx)(J.J,{name:"times"}))})]},t))),!j&&(0,u.jsx)("button",{className:"gf-form-label",type:"button",onClick:H,"aria-label":"Add filter",children:E||(E=(0,u.jsx)(J.J,{name:"plus"}))})]}),j&&(0,u.jsxs)("div",{className:"gf-form-inline",children:[(0,u.jsx)("div",{className:"gf-form",children:(0,u.jsx)(C.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:O?(0,b.E)(O):void 0,placeholder:"key",allowCustomValue:!0,filterOption:Z,onOpenMenu:async()=>{p(!0);const e=(await r(t)).map((e=>(0,b.E)(e)));g(e),p(!1)},isLoading:m,options:d,onChange:e=>{let{value:t}=e;t&&V(t)}})}),(0,u.jsxs)("div",{className:"gf-form",children:[Q||(Q=(0,u.jsx)(N.W,{className:"width-4 query-keyword",children:"Type"})),(0,u.jsx)(C.Ph,{inputId:"opentsdb-aggregator-select",value:k?(0,b.E)(k):void 0,options:W,onChange:e=>{let{value:t}=e;t&&S(t)}})]}),(0,u.jsx)("div",{className:"gf-form",children:(0,u.jsx)(C.Ph,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:R?(0,b.E)(R):void 0,placeholder:"filter",allowCustomValue:!0,filterOption:Z,onOpenMenu:async()=>{if(!h){x(!0);const e=await o();f(e),x(!1)}},isLoading:v,options:h,onChange:e=>{let{value:t}=e;t&&P(t)}})}),A||(A=(0,u.jsx)(l.c,{width:5,className:"query-keyword",children:"Group by"})),(0,u.jsx)(T.x,{value:q,onChange:()=>{_(!q)}}),(0,u.jsxs)("div",{className:"gf-form",children:[z&&(0,u.jsx)("div",{className:"gf-form-label",title:z,"data-testid":G.error,children:F||(F=(0,u.jsx)(J.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"}))}),(0,u.jsxs)("div",{className:"gf-form-label",children:[(0,u.jsx)("button",{type:"button",className:c,onClick:X,children:"add filter"}),(0,u.jsx)("button",{type:"button",className:c,onClick:H,children:I||(I=(0,u.jsx)(J.J,{name:"times"}))})]})]})]}),B||(B=(0,u.jsx)("div",{className:"gf-form gf-form--grow",children:(0,u.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}))]})}const G={section:"opentsdb-filter",list:"opentsdb-filter-list",error:"opentsdb-filter-error",remove:"opentsdb-filter-remove"};var $,W,H,X;function Y(e){var t;let{query:s,onChange:a,onRunQuery:r,suggestMetrics:n,aggregators:o}=e;const[c,d]=(0,i.useState)({}),g=(0,i.useCallback)(((e,t)=>{var s;const a=null!==(s=e.value)&&void 0!==s?s:"";return t.split(" ").reduce(((e,t)=>e&&a.toLowerCase().includes(t.toLowerCase())),!0)}),[]),m=o.map((e=>(0,b.E)(e)));return(0,u.jsxs)("div",{className:"gf-form-inline","data-testid":Z.section,children:[(0,u.jsxs)("div",{className:"gf-form",children:[$||($=(0,u.jsx)(l.c,{width:8,className:"query-keyword",children:"Metric"})),(0,u.jsx)(C.Ph,{width:25,inputId:"opentsdb-metric-select",className:"gf-form-input",value:s.metric?(0,b.E)(s.metric):void 0,placeholder:"Metric name",allowCustomValue:!0,filterOption:g,onOpenMenu:async()=>{if(!c.metrics){d({isLoading:!0});const e=await n();d({metrics:e,isLoading:void 0})}},isLoading:c.isLoading,options:c.metrics,onChange:e=>{let{value:t}=e;t&&(a(Object.assign({},s,{metric:t})),r())}})]}),(0,u.jsxs)("div",{className:"gf-form",children:[W||(W=(0,u.jsx)(l.c,{width:"auto",className:"query-keyword",children:"Aggregator"})),(0,u.jsx)(C.Ph,{inputId:"opentsdb-aggregator-select",className:"gf-form-input",value:s.aggregator?(0,b.E)(s.aggregator):void 0,options:m,onChange:e=>{let{value:t}=e;t&&(a(Object.assign({},s,{aggregator:t})),r())}})]}),(0,u.jsxs)("div",{className:"gf-form max-width-20",children:[H||(H=(0,u.jsx)(l.c,{className:"query-keyword",width:6,tooltip:(0,u.jsx)("div",{children:"Use patterns like $tag_tagname to replace part of the alias for a tag value"}),children:"Alias"})),(0,u.jsx)(w.I,{"data-testid":Z.alias,placeholder:"series alias",value:null!==(t=s.alias)&&void 0!==t?t:"",onChange:e=>{const t=e.currentTarget.value;a(Object.assign({},s,{alias:t}))},onBlur:()=>r()})]}),X||(X=(0,u.jsx)("div",{className:"gf-form gf-form--grow",children:(0,u.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}))]})}const Z={section:"opentsdb-metricsection",alias:"metric-alias"};var ee,te,se,ae,re,ie;function ne(e){var t,s,a,r,i;let{query:n,onChange:o,onRunQuery:c,tsdbVersion:d}=e;return(0,u.jsxs)("div",{className:"gf-form-inline","data-testid":oe.section,children:[(0,u.jsxs)("div",{className:"gf-form",children:[ee||(ee=(0,u.jsx)(l.c,{className:"query-keyword",width:8,children:"Rate"})),(0,u.jsx)(T.x,{"data-testid":oe.shouldComputeRate,value:null!==(t=n.shouldComputeRate)&&void 0!==t&&t,onChange:()=>{var e;const t=null!==(e=n.shouldComputeRate)&&void 0!==e&&e;o(Object.assign({},n,{shouldComputeRate:!t})),c()}})]}),n.shouldComputeRate&&(0,u.jsxs)("div",{className:"gf-form",children:[te||(te=(0,u.jsx)(l.c,{className:"query-keyword",width:"auto",children:"Counter"})),(0,u.jsx)(T.x,{"data-testid":oe.isCounter,value:null!==(s=n.isCounter)&&void 0!==s&&s,onChange:()=>{var e;const t=null!==(e=n.isCounter)&&void 0!==e&&e;o(Object.assign({},n,{isCounter:!t})),c()}})]}),n.shouldComputeRate&&n.isCounter&&(0,u.jsxs)("div",{className:"gf-form",children:[se||(se=(0,u.jsx)(N.W,{width:"auto",className:"query-keyword",children:"Counter max"})),(0,u.jsx)(w.I,{"data-testid":oe.counterMax,placeholder:"max value",value:null!==(a=n.counterMax)&&void 0!==a?a:"",onChange:e=>{const t=e.currentTarget.value;o(Object.assign({},n,{counterMax:t}))},onBlur:()=>c()}),ae||(ae=(0,u.jsx)(N.W,{width:"auto",className:"query-keyword",children:"Reset value"})),(0,u.jsx)(w.I,{"data-testid":oe.counterResetValue,placeholder:"reset value",value:null!==(r=n.counterResetValue)&&void 0!==r?r:"",onChange:e=>{const t=e.currentTarget.value;o(Object.assign({},n,{counterResetValue:t}))},onBlur:()=>c()})]}),d>2&&(0,u.jsxs)("div",{className:"gf-form",children:[re||(re=(0,u.jsx)(l.c,{className:"query-keyword",width:"auto",children:"Explicit tags"})),(0,u.jsx)(T.x,{"data-testid":oe.explicitTags,value:null!==(i=n.explicitTags)&&void 0!==i&&i,onChange:()=>{var e;const t=null!==(e=n.explicitTags)&&void 0!==e&&e;o(Object.assign({},n,{explicitTags:!t})),c()}})]}),ie||(ie=(0,u.jsx)("div",{className:"gf-form gf-form--grow",children:(0,u.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}))]})}const oe={section:"opentsdb-rate",shouldComputeRate:"opentsdb-shouldComputeRate",isCounter:"opentsdb-is-counter",counterMax:"opentsdb-counter-max",counterResetValue:"opentsdb-counter-reset-value",explicitTags:"opentsdb-explicit-tags"};var le,ce,ue,de,ge,me,pe;function he(e){let{query:t,onChange:s,onRunQuery:a,suggestTagKeys:r,suggestTagValues:n,tsdbVersion:o}=e;const c=(0,y.wW)(U.gN),[d,g]=(0,i.useState)(),[m,p]=(0,i.useState)(),[h,f]=(0,i.useState)(),[v,x]=(0,i.useState)(),[j,w]=(0,i.useState)(!1),[N,T]=(0,i.useState)(""),[k,S]=(0,i.useState)(""),[O,V]=(0,i.useState)("");function R(){w(!j)}function P(){if(t.filters&&(0,K.size)(t.filters)>0){V("Please remove filters to use tags, tags and filters are mutually exclusive.")}else if(j)if(t.tags&&(0,K.has)(t.tags,N)){V("Duplicate tag key '"+N+"'.")}else t.tags||(t.tags={}),t.tags[N]=k,T(""),S(""),s(t),a(),R();else w(!0)}function q(e){delete t.tags[e],s(t),a()}const _=(0,i.useCallback)(((e,t)=>{var s;const a=null!==(s=e.value)&&void 0!==s?s:"";return t.split(" ").reduce(((e,t)=>e&&a.toLowerCase().includes(t.toLowerCase())),!0)}),[]);return(0,u.jsxs)("div",{className:"gf-form-inline","data-testid":fe.section,children:[(0,u.jsxs)("div",{className:"gf-form",children:[(0,u.jsx)(l.c,{className:"query-keyword",width:8,tooltip:o>=2?le||(le=(0,u.jsx)("div",{children:"Please use filters, tags are deprecated in opentsdb 2.2"})):void 0,children:"Tags"}),t.tags&&Object.keys(t.tags).map(((e,s)=>{const a=t.tags[e];return(0,u.jsxs)(l.c,{width:"auto","data-testid":fe.list+s,children:[e,"=",a,(0,u.jsx)("button",{type:"button",className:c,onClick:()=>{return s=a,q(t=e),T(t),S(s),void P();var t,s},children:ce||(ce=(0,u.jsx)(J.J,{name:"pen"}))}),(0,u.jsx)("button",{type:"button",className:c,onClick:()=>q(e),"data-testid":fe.remove,children:ue||(ue=(0,u.jsx)(J.J,{name:"times"}))})]},s)})),!j&&(0,u.jsx)("button",{className:"gf-form-label",type:"button",onClick:R,"aria-label":"Add tag",children:de||(de=(0,u.jsx)(J.J,{name:"plus"}))})]}),j&&(0,u.jsxs)("div",{className:"gf-form-inline",children:[(0,u.jsx)("div",{className:"gf-form",children:(0,u.jsx)(C.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:N?(0,b.E)(""+N):void 0,placeholder:"key",onOpenMenu:async()=>{p(!0);const e=(await r(t)).map((e=>(0,b.E)(e)));g(e),p(!1)},isLoading:m,options:d,onChange:e=>{let{value:t}=e;t&&T(t)}})}),(0,u.jsx)("div",{className:"gf-form",children:(0,u.jsx)(C.Ph,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:k?(0,b.E)(k):void 0,placeholder:"value",allowCustomValue:!0,filterOption:_,onOpenMenu:async()=>{if(!h){x(!0);const e=await n();f(e),x(!1)}},isLoading:v,options:h,onChange:e=>{let{value:t}=e;t&&S(t)}})}),(0,u.jsxs)("div",{className:"gf-form",children:[O&&(0,u.jsx)("div",{className:"gf-form-label",title:O,"data-testid":fe.error,children:ge||(ge=(0,u.jsx)(J.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"}))}),(0,u.jsxs)("div",{className:"gf-form-label",children:[(0,u.jsx)("button",{type:"button",className:c,onClick:P,children:"add tag"}),(0,u.jsx)("button",{type:"button",className:c,onClick:R,children:me||(me=(0,u.jsx)(J.J,{name:"times"}))})]})]})]}),pe||(pe=(0,u.jsx)("div",{className:"gf-form gf-form--grow",children:(0,u.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}))]})}const fe={section:"opentsdb-tag",list:"opentsdb-tag-list",error:"opentsdb-tag-error",remove:"opentsdb-tag-remove"};function ve(e){return{container:x.css`
      display: flex;
    `,visualEditor:x.css`
      flex-grow: 1;
    `,toggleButton:x.css`
      margin-left: ${e.spacing(.5)};
    `}}const xe={editor:"opentsdb-editor"};var je,ye,be=s(46060),we=s(16313),Ce=s(53786),Ne=s(3363),Te=s(94514),ke=s(2101),Se=s(68633),Oe=s(42914),Ve=s(93570),Re=s(79328);const Pe=e=>{var t,s;const{query:a,onChange:r}=e,[n,o]=(0,i.useState)(null!==(t=a.target)&&void 0!==t?t:""),[c,d]=(0,i.useState)(null!==(s=a.isGlobal)&&void 0!==s&&s),g=(e,t)=>{r(Object.assign({},a,{[e]:t,fromAnnotations:!0}))};return(0,u.jsxs)("div",{className:"gf-form-group",children:[(0,u.jsxs)("div",{className:"gf-form",children:[je||(je=(0,u.jsx)(l.c,{width:12,children:"OpenTSDB metrics query"})),(0,u.jsx)(w.I,{value:n,onChange:e=>{var t;return o(null!==(t=e.currentTarget.value)&&void 0!==t?t:"")},onBlur:()=>g("target",n),placeholder:"events.eventname"})]}),(0,u.jsxs)("div",{className:"gf-form",children:[ye||(ye=(0,u.jsx)(l.c,{width:12,children:"Show Global Annotations?"})),(0,u.jsx)(T.x,{value:c,onChange:e=>(e=>{d(e=!e),g("isGlobal",e)})(c)})]})]})},qe=e=>{const t=e.target&&"string"!=typeof e.target?e.target:(e=>{var t,s,a;return{fromAnnotations:!0,target:null!==(t=e.target)&&void 0!==t?t:"",name:null!==(s=e.name)&&void 0!==s?s:"",isGlobal:null!==(a=e.isGlobal)&&void 0!==a&&a}})(e);return e.target=t,e};function _e(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class De extends r.MF{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Re.J)();super(e),_e(this,"type",void 0),_e(this,"url",void 0),_e(this,"name",void 0),_e(this,"withCredentials",void 0),_e(this,"basicAuth",void 0),_e(this,"tsdbVersion",void 0),_e(this,"tsdbResolution",void 0),_e(this,"lookupLimit",void 0),_e(this,"tagKeys",void 0),_e(this,"aggregatorsPromise",void 0),_e(this,"filterTypesPromise",void 0),this.templateSrv=t,this.type="opentsdb",this.url=e.url,this.name=e.name,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,e.jsonData=e.jsonData||{},this.tsdbVersion=e.jsonData.tsdbVersion||1,this.tsdbResolution=e.jsonData.tsdbResolution||1,this.lookupLimit=e.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null,this.annotations={QueryEditor:Pe,prepareAnnotation:qe}}query(e){if(e.targets.some((e=>e.fromAnnotations))){const t=[];for(const s of e.targets)s.target&&t.push(new be.y((t=>{this.annotationEvent(e,s).then((e=>t.next({data:[(0,Se.g0)(e)]}))).catch((e=>t.next({data:[(0,Se.g0)([])]}))).finally((()=>t.complete()))})));return(0,we.T)(...t)}const t=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),s=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),a=[];(0,K.each)(e.targets,(t=>{t.metric&&a.push(this.convertTargetToQuery(t,e,this.tsdbVersion))}));const r=(0,K.compact)(a);if((0,K.isEmpty)(r))return(0,Ce.of)({data:[]});const i={};return(0,K.each)(r,(e=>{e.filters&&e.filters.length>0?(0,K.each)(e.filters,(e=>{i[e.tagk]=!0})):(0,K.each)(e.tags,((e,t)=>{i[t]=!0}))})),e.targets=(0,K.filter)(e.targets,(e=>!0!==e.hide)),this.performTimeSeriesQuery(r,t,s).pipe((0,Te.K)((e=>{var t,s;throw(null==e||null===(t=e.data)||void 0===t||null===(s=t.error)||void 0===s?void 0:s.message)||"Error performing time series query."})),(0,ke.U)((t=>{const s=this.mapMetricsToTargets(t.data,e,this.tsdbVersion);return{data:(0,K.map)(t.data,((t,a)=>(-1===(a=s[a])&&(a=0),this._saveTagKeys(t),this.transformMetricData(t,i,e.targets[a],e,this.tsdbResolution))))}})))}annotationEvent(e,t){const s=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),a=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),r=[],i=[];r.push({aggregator:"sum",metric:t.target});const n=(0,K.compact)(r);return(0,Ne.n)(this.performTimeSeriesQuery(n,s,a).pipe((0,ke.U)((e=>{if(e.data[0]){let s=e.data[0].annotations;t.isGlobal&&(s=e.data[0].globalAnnotations),s&&(0,K.each)(s,(e=>{const s={text:e.description,time:1e3*Math.floor(e.startTime),annotation:t};i.push(s)}))}return i}))))}targetContainsTemplate(e){if(e.filters&&e.filters.length>0)for(let t=0;t<e.filters.length;t++)if(this.templateSrv.containsTemplate(e.filters[t].filter))return!0;if(e.tags&&Object.keys(e.tags).length>0)for(const t in e.tags)if(this.templateSrv.containsTemplate(e.tags[t]))return!0;return!1}performTimeSeriesQuery(e,t,s){let a=!1;2===this.tsdbResolution&&(a=!0);const r={start:t,queries:e,msResolution:a,globalAnnotations:!0};3===this.tsdbVersion&&(r.showQuery=!0),s&&(r.end=s);const i={method:"POST",url:this.url+"/api/query",data:r};return this._addCredentialOptions(i),(0,Ve.i)().fetch(i)}suggestTagKeys(e){var t;const s=null!==(t=e.metric)&&void 0!==t?t:"";return Promise.resolve(this.tagKeys[s]||[])}_saveTagKeys(e){const t=Object.keys(e.tags);(0,K.each)(e.aggregateTags,(e=>{t.push(e)})),this.tagKeys[e.metric]=t}_performSuggestQuery(e,t){return this._get("/api/suggest",{type:t,q:e,max:this.lookupLimit}).pipe((0,ke.U)((e=>e.data)))}_performMetricKeyValueLookup(e,t){if(!e||!t)return(0,Ce.of)([]);const s=t.split(",").map((e=>e.trim())),a=s[0];let r=a+"=*";s.length>1&&(r+=","+s.splice(1).join(","));const i=e+"{"+r+"}";return this._get("/api/search/lookup",{m:i,limit:this.lookupLimit}).pipe((0,ke.U)((e=>{e=e.data.results;const t=[];return(0,K.each)(e,(e=>{-1===t.indexOf(e.tags[a])&&t.push(e.tags[a])})),t})))}_performMetricKeyLookup(e){return e?this._get("/api/search/lookup",{m:e,limit:1e3}).pipe((0,ke.U)((e=>{e=e.data.results;const t=[];return(0,K.each)(e,(e=>{(0,K.each)(e.tags,((e,s)=>{-1===t.indexOf(s)&&t.push(s)}))})),t}))):(0,Ce.of)([])}_get(e,t){const s={method:"GET",url:this.url+e,params:t};return this._addCredentialOptions(s),(0,Ve.i)().fetch(s)}_addCredentialOptions(e){(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth})}metricFindQuery(e){if(!e)return Promise.resolve([]);let t;try{t=this.templateSrv.replace(e,{},"distributed")}catch(e){return Promise.reject(e)}const s=e=>(0,K.map)(e,(e=>({text:e}))),a=t.match(/metrics\((.*)\)/);if(a)return(0,Ne.n)(this._performSuggestQuery(a[1],"metrics").pipe((0,ke.U)(s)));const r=t.match(/tag_names\((.*)\)/);if(r)return(0,Ne.n)(this._performMetricKeyLookup(r[1]).pipe((0,ke.U)(s)));const i=t.match(/tag_values\((.*?),\s?(.*)\)/);if(i)return(0,Ne.n)(this._performMetricKeyValueLookup(i[1],i[2]).pipe((0,ke.U)(s)));const n=t.match(/suggest_tagk\((.*)\)/);if(n)return(0,Ne.n)(this._performSuggestQuery(n[1],"tagk").pipe((0,ke.U)(s)));const o=t.match(/suggest_tagv\((.*)\)/);return o?(0,Ne.n)(this._performSuggestQuery(o[1],"tagv").pipe((0,ke.U)(s))):Promise.resolve([])}testDatasource(){return(0,Ne.n)(this._performSuggestQuery("cpu","metrics").pipe((0,ke.U)((()=>({status:"success",message:"Data source is working"})))))}getAggregators(){return this.aggregatorsPromise||(this.aggregatorsPromise=(0,Ne.n)(this._get("/api/aggregators").pipe((0,ke.U)((e=>e.data&&(0,K.isArray)(e.data)?e.data.sort():[]))))),this.aggregatorsPromise}getFilterTypes(){return this.filterTypesPromise||(this.filterTypesPromise=(0,Ne.n)(this._get("/api/config/filters").pipe((0,ke.U)((e=>e.data?Object.keys(e.data).sort():[]))))),this.filterTypesPromise}transformMetricData(e,t,s,a,r){const i=this.createMetricLabel(e,s,t,a),n=[];return(0,K.each)(e.dps,((e,t)=>{2===r?n.push([e,1*t]):n.push([e,1e3*t])})),{target:i,datapoints:n}}createMetricLabel(e,t,s,a){if(t.alias){const s=(0,K.clone)(a.scopedVars||{});return(0,K.each)(e.tags,((e,t)=>{s["tag_"+t]={value:e}})),this.templateSrv.replace(t.alias,s)}let r=e.metric;const i=[];return(0,K.isEmpty)(e.tags)||(0,K.each)((0,K.toPairs)(e.tags),(e=>{(0,K.has)(s,e[0])&&i.push(e[0]+"="+e[1])})),(0,K.isEmpty)(i)||(r+="{"+i.join(", ")+"}"),r}convertTargetToQuery(e,t,s){if(!e.metric||e.hide)return null;const a={metric:this.templateSrv.replace(e.metric,t.scopedVars,"pipe"),aggregator:"avg"};if(e.aggregator&&(a.aggregator=this.templateSrv.replace(e.aggregator)),e.shouldComputeRate&&(a.rate=!0,a.rateOptions={counter:!!e.isCounter},e.counterMax&&e.counterMax.length&&(a.rateOptions.counterMax=parseInt(e.counterMax,10)),e.counterResetValue&&e.counterResetValue.length&&(a.rateOptions.resetValue=parseInt(e.counterResetValue,10)),s>=2&&(a.rateOptions.dropResets=!(a.rateOptions.counterMax||a.rateOptions.ResetValue&&0!==a.rateOptions.ResetValue))),!e.disableDownsampling){let s=this.templateSrv.replace(e.downsampleInterval||t.interval);s.match(/\.[0-9]+s/)&&(s=1e3*parseFloat(s)+"ms"),a.downsample=s+"-"+e.downsampleAggregator,e.downsampleFillPolicy&&"none"!==e.downsampleFillPolicy&&(a.downsample+="-"+e.downsampleFillPolicy)}if(e.filters&&e.filters.length>0)a.filters=(0,K.cloneDeep)(e.filters),a.filters&&this.interpolateVariablesInFilters(a,t);else if(a.tags=(0,K.cloneDeep)(e.tags),a.tags)for(const e in a.tags)a.tags[e]=this.templateSrv.replace(a.tags[e],t.scopedVars,"pipe");return e.explicitTags&&(a.explicitTags=!0),a}interpolateVariablesInFilters(e,t){var s;e.filters=null===(s=e.filters)||void 0===s?void 0:s.map((e=>(e.tagk=this.templateSrv.replace(e.tagk,t.scopedVars,"pipe"),e.filter=this.templateSrv.replace(e.filter,t.scopedVars,"pipe"),e)))}mapMetricsToTargets(e,t,s){let a,r;return(0,K.map)(e,(e=>3===s?e.query.index:(0,K.findIndex)(t.targets,(s=>s.filters&&s.filters.length>0?s.metric===e.metric:s.metric===e.metric&&(0,K.every)(s.tags,((s,i)=>(a=this.templateSrv.replace(s,t.scopedVars,"pipe"),r=a.split("|"),(0,K.includes)(r,e.tags[i])||"*"===a)))))))}interpolateVariablesInQueries(e,t){return e.length?e.map((e=>Object.assign({},e,{metric:this.templateSrv.replace(e.metric,t)}))):e}convertToTSDBTime(e,t,s){return"now"===e?null:(e=Oe.parse(e,t,s)).valueOf()}}const Le=new r.hf(De).setQueryEditor((function(e){let{datasource:t,onRunQuery:s,onChange:a,query:r,range:n,queries:o}=e;const l=(0,y.wW)(ve),[c,d]=(0,i.useState)(["avg","sum","min","max","dev","zimsum","mimmin","mimmax"]),[g,m]=(0,i.useState)(["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"]),p=t.tsdbVersion;async function h(){return t.metricFindQuery("suggest_tagv()").then(v)}async function f(e){return t.suggestTagKeys(e)}function v(e){return e.map((e=>({value:j.QX.escapeHtml(e.text),description:e.text})))}return r.aggregator||(r.aggregator="sum"),r.downsampleAggregator||(r.downsampleAggregator="avg"),r.downsampleFillPolicy||(r.downsampleFillPolicy="none"),t.getAggregators().then((e=>{0!==e.length&&d(e)})),t.getFilterTypes().then((e=>{0!==e.length&&m(e)})),(0,u.jsx)("div",{className:l.container,"data-testid":xe.editor,children:(0,u.jsxs)("div",{className:l.visualEditor,children:[(0,u.jsx)(Y,{query:r,onChange:a,onRunQuery:s,suggestMetrics:async function(){return t.metricFindQuery("metrics()").then(v)},aggregators:c}),(0,u.jsx)(q,{query:r,onChange:a,onRunQuery:s,aggregators:c,fillPolicies:["none","nan","null","zero"],tsdbVersion:p}),p>=2&&(0,u.jsx)(z,{query:r,onChange:a,onRunQuery:s,filterTypes:g,suggestTagValues:h,suggestTagKeys:f}),(0,u.jsx)(he,{query:r,onChange:a,onRunQuery:s,suggestTagValues:h,suggestTagKeys:f,tsdbVersion:p}),(0,u.jsx)(ne,{query:r,onChange:a,onRunQuery:s,tsdbVersion:p})]})})})).setConfigEditor((e=>{const{options:t,onOptionsChange:s}=e;return(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(n.E,{defaultUrl:"http://localhost:4242",dataSourceConfig:t,onChange:s}),(0,u.jsx)(h,{value:t,onChange:s})]})}))}}]);
//# sourceMappingURL=opentsdbPlugin.1f6901484655909acbeb.js.map