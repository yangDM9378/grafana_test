/*! For license information please see AlertingRuleForm.9c329db2f29b211f0ebf.js.LICENSE.txt */
"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5372],{7328:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Vo});var r,i=n(68404),o=n(66015),s=n(72767),a=n(64850),l=n(52423),c=n(2843),u=n(16755),d=n(8006),p=n(45916);function f(e){let{title:t,children:n}=e;return(0,p.jsxs)(c.b,{className:(0,u.wW)(h).warning,severity:"warning",title:t,children:[(0,p.jsx)("p",{children:n}),r||(r=(0,p.jsx)(d.Qj,{href:"alerting/list",children:"To rule list"}))]})}const h=e=>({warning:l.css`
    margin: ${e.spacing(4)};
  `});var m=n(38953),g=n(19200),v=n(59052),x=n(16144),b=n(93250),y=n(54761),j=n(81691),w=n(22222),C=n(2024),I=n(47900),k=n(19512),A=n(40833),S=n(76938),N=n(64834),R=n(10373),T=n(5302),O=n(8980),$=n(55357),q=n(65678),E=n(4645),F=n(35258),L=n(70917),M=n(57938),U=n(62124),D=n(84380),_=n(6432),W=n(28173),Q=n(8910),P=n(53786),G=n(2101),z=n(94514),V=n(44962),Z=n(6003),B=n(99511),Y=n(12717),H=n(93570),J=n(75386);var K=n(43271);function X(e,t,n){return(0,Z.x)({whileLoading:ee(n),source:(0,H.i)().fetch({method:"POST",url:`/api/v1/rule/test/${t}`,data:e}).pipe((0,G.U)((e=>{let{data:t}=e;return ee(n,{state:W.Gu.Done,series:t.instances.map(B.vP)})})),(0,z.K)((e=>(0,P.of)(ee(n,{state:W.Gu.Error,error:(0,J.P)(e)})))),(0,V.B)())})}function ee(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return{ruleType:e,data:Object.assign({state:W.Gu.Loading,series:[],timeRange:(0,Y.JK)()},t)}}var te,ne,re=n(85976),ie=n(89050),oe=n(31919),se=n(76308),ae=n(27864);function le(e){const{preview:t}=e,n=(0,u.wW)(ce),r={defaults:{},overrides:[{matcher:{id:oe.mi.byName,options:"Info"},properties:[{id:"custom.displayMode",value:ae.h2.JSONView}]}]};if(!t)return null;const{data:i,ruleType:o}=t;return i.state===W.Gu.Loading?(0,p.jsx)("div",{className:n.container,children:te||(te=(0,p.jsx)("span",{children:"Loading preview..."}))}):i.state===W.Gu.Error?(0,p.jsx)("div",{className:n.container,children:i.error?(0,T.kk)(i.error):"Failed to preview alert rule"}):(0,p.jsxs)("div",{className:n.container,children:[(0,p.jsxs)("span",{children:["Preview based on the result of running the query, for this moment."," ",o===R.$.grafana?"Configuration for `no data` and `error handling` is not applied.":null]}),(0,p.jsx)("div",{className:n.table,children:(0,p.jsx)(ie.Z,{children:e=>{let{width:t,height:n}=e;return(0,p.jsx)("div",{style:{width:`${t}px`,height:`${n}px`},children:(0,p.jsx)(se.$,{title:"",width:t,height:n,pluginId:"table",data:i,fieldConfig:r})})}})})]})}function ce(e){return{container:l.css`
      margin: ${e.spacing(2)} 0;
    `,table:l.css`
      flex: 1 1 auto;
      height: 135px;
      margin-top: ${e.spacing(2)};
      border: 1px solid ${e.colors.border.medium};
      border-radius: ${e.shape.borderRadius(1)};
    `}}const ue=["type","dataSourceName","condition","queries","expression"];function de(){const e=(0,u.wW)(fe),[t,n]=pe(),{watch:r}=(0,v.Gc)(),[i,o,s]=r(["type","condition","queries"]),{allDataSourcesAvailable:a}=(0,re.S)(s);if(i===R.$.cloudRecording||i===R.$.cloudAlerting)return null;const l=Boolean(o)&&a;return(0,p.jsxs)("div",{className:e.container,children:[(0,p.jsxs)(y.Lh,{children:[a&&(0,p.jsx)(d.zx,{disabled:!l,type:"button",variant:"primary",onClick:n,children:"Preview alerts"}),!a&&(ne||(ne=(0,p.jsx)(c.b,{title:"Preview is not available",severity:"warning",children:"Cannot display the query preview. Some of the data sources used in the queries are not available."})))]}),(0,p.jsx)(le,{preview:t})]})}function pe(){const[e,t]=(0,i.useState)(),{getValues:n}=(0,v.Gc)(),r=(0,U.Z)(),o=(0,i.useCallback)((()=>{const e=function(e){const[t,n,r,i,o]=e,s=(0,Q.F)().getInstanceSettings(n);if(!s)throw new Error(`Cannot find data source settings for ${n}`);switch(t){case R.$.cloudAlerting:return{dataSourceUid:s.uid,dataSourceName:n,expr:o};case R.$.grafana:return{grafana_condition:{condition:r,data:i,now:(0,_.lf)(Date.now())}};default:throw new Error(`Alert type ${t} not supported by preview.`)}}(n(ue));(function(e){if(function(e){return"expr"in e}(e))return X(e,e.dataSourceUid,R.$.cloudAlerting);if(function(e){return"grafana_condition"in e}(e))return X(e,K.GC,R.$.grafana);throw new Error("unsupported preview rule request")})(e).pipe((0,D.o)((e=>!function(e){switch(e.data.state){case W.Gu.Done:case W.Gu.Error:return!0;default:return!1}}(e)),!0)).subscribe((e=>{r()&&t(e)}))}),[n,r]);return[e,o]}function fe(e){return{container:l.css`
      margin-top: ${e.spacing(2)};
      max-width: ${e.breakpoints.values.xxl}px;
    `}}var he,me=n(50073);const ge=["onChange","ref"];const ve=()=>{var e,t;const n=(0,u.wW)(xe),{register:r,control:i,watch:o,formState:{errors:s}}=(0,v.Gc)();return o("type")===R.$.cloudRecording?null:(0,p.jsxs)(me.z,{stepNo:2,title:"Alert evaluation behavior",children:[(0,p.jsx)(q.g,{label:"For",description:"Expression has to be true for this long for the alert to be fired.",children:(0,p.jsxs)("div",{className:n.flexRow,children:[(0,p.jsx)(q.g,{invalid:!(null===(e=s.forTime)||void 0===e||!e.message),error:null===(t=s.forTime)||void 0===t?void 0:t.message,className:n.inlineField,children:(0,p.jsx)(E.I,Object.assign({},r("forTime",{pattern:{value:/^\d+$/,message:"Must be a positive integer."}}),{width:8}))}),(0,p.jsx)(F.g,{name:"forTimeUnit",render:e=>{let{field:{onChange:t}}=e,r=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e.field,ge);return(0,p.jsx)(L.Ph,Object.assign({},r,{options:M.qr,onChange:e=>t(null==e?void 0:e.value),width:15,className:n.timeUnit}))},control:i})]})}),he||(he=(0,p.jsx)(de,{}))]})},xe=e=>({inlineField:l.css`
    margin-bottom: 0;
  `,flexRow:l.css`
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: flex-start;
  `,timeUnit:l.css`
    margin-left: ${e.spacing(.5)};
  `});var be=n(9085),ye=n.n(be),je=n(68522),we=n(83744),Ce=n(21888),Ie=n(99500),ke=n(59196),Ae=n(31062),Se=n(87602),Ne=n(72026),Re=n(46782),Te=n(50243),Oe=n(38252),$e=n(52394),qe=n(82897),Ee=n(58635),Fe=n(9708);const Le=(0,Ee.Z)((function(e){const t=new Fe.kJ,n=e.map((e=>e.refId));return t.createNodes(n),e.forEach((e=>{var n;const r=e.refId;((0,Oe.j)(e.model)&&"math"===e.model.type?function(e){const t=new RegExp(/\$\{(?<var>[a-zA-Z0-9_ ]+?)\}/gm),n=new RegExp(/\$(?<var>[a-zA-Z0-9_]+)/gm),r=Array.from(e.matchAll(t)).map((e=>{var t;return null===(t=e.groups)||void 0===t?void 0:t.var})),i=Array.from(e.matchAll(n)).map((e=>{var t;return null===(t=e.groups)||void 0===t?void 0:t.var}));return(0,qe.compact)((0,qe.uniq)([...r,...i]))}(null!==(n=e.model.expression)&&void 0!==n?n:""):[e.model.expression]).forEach((e=>{r&&e&&!(r===e)&&t.link(e,r)}))})),t}),((e,t)=>Ue(e[0])===Ue(t[0])));const Me=(0,qe.memoize)((function(e,t){const n=t.getNode(e);let r=[];return function e(t){const n=t.inputEdges;n.length>0?n.forEach((t=>{t.inputNode&&e(t.inputNode)})):null==r||r.push(t)}(n),r.map((e=>e.name))}),((e,t)=>e+function(e){return Object.keys(e.nodes).map((t=>{const n=e.nodes[t];let r=n.outputEdges.map((e=>{var t;return null===(t=e.outputNode)||void 0===t?void 0:t.name})).join(", "),i=n.inputEdges.map((e=>{var t;return null===(t=e.inputNode)||void 0===t?void 0:t.name})).join(", ");return`${n.name}:${r}:${i}`})).join(" ")}(t)));function Ue(e){return e.map((e=>{var t;const n=(0,Oe.j)(e.model)?e.model.type:e.queryType;return e.refId+(null!==(t=e.model.expression)&&void 0!==t?t:"")+n})).join()}function De(e,t,n){return e.map((e=>{if(t===n)return e;if(!(0,Oe.j)(e.model))return e;const r="math"===e.model.type,i="reduce"===e.model.type,o="resample"===e.model.type,s="classic_conditions"===e.model.type,a="threshold"===e.model.type;var l;if(r)return Object.assign({},e,{model:Object.assign({},e.model,{expression:_e(null!==(l=e.model.expression)&&void 0!==l?l:"",t,n)})});if(o||i||a){const r=e.model.expression===t;return Object.assign({},e,{model:Object.assign({},e.model,{expression:r?n:e.model.expression})})}if(s){var c;const r=null===(c=e.model.conditions)||void 0===c?void 0:c.map((e=>Object.assign({},e,{query:Object.assign({},e.query,{params:e.query.params.map((e=>e===t?n:e))})})));return Object.assign({},e,{model:Object.assign({},e.model,{conditions:r})})}return e}))}function _e(e,t,n){const r=new RegExp("(\\$"+t+"\\b)|(\\${"+t+"})","gm"),i="${"+n+"}";return e.replace(r,i)}function We(e,t){return void 0!==e.find((e=>e.refId===t))}function Qe(e){return!(e.includes("/")||e.includes("\\"))||'Cannot contain "/" or "\\" characters'}function Pe(e){if(0===e.length)return;let t;return(0,Ne.hZ)(e)&&(t=new Error("You cannot use time series data as an alert condition, consider adding a reduce expression.")),t}function Ge(e){return e.evaluator.type===Te.$.IsWithinRange||e.evaluator.type===Te.$.IsOutsideRange}const ze=["onChange","ref"],Ve=["ref"];function Ze(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}const Be=e=>{var t,n,r,o,s;let{rulesSourceName:l}=e;const{control:c,watch:d,formState:{errors:f},setValue:h}=(0,v.Gc)(),m=(0,u.wW)(Ye),g=(0,S._)((e=>e.rulerRules)),x=(0,a.I0)();(0,i.useEffect)((()=>{x((0,N.UR)({rulesSourceName:l}))}),[l,x]);const b=null===(t=g[l])||void 0===t?void 0:t.result,y=d("namespace"),j=(0,i.useMemo)((()=>b?Object.keys(b).map((e=>({label:e,value:e}))):[]),[b]),w=(0,i.useMemo)((()=>{var e;return y&&(null==b||null===(e=b[y])||void 0===e?void 0:e.map((e=>({label:e.name,value:e.name}))))||[]}),[y,b]);return(0,p.jsxs)("div",{className:m.flexRow,children:[(0,p.jsx)(q.g,{"data-testid":"namespace-picker",label:"Namespace",error:null===(n=f.namespace)||void 0===n?void 0:n.message,invalid:!(null===(r=f.namespace)||void 0===r||!r.message),children:(0,p.jsx)(F.g,{render:e=>{let{field:{onChange:t}}=e,n=Ze(e.field,ze);return(0,p.jsx)(L.LT,Object.assign({},n,{allowCustomValue:!0,className:m.input,onChange:e=>{h("group",""),t(e.value)},options:j,width:42}))},name:"namespace",control:c,rules:{required:{value:!0,message:"Required."},validate:{pathSeparator:Qe}}})}),(0,p.jsx)(q.g,{"data-testid":"group-picker",label:"Group",error:null===(o=f.group)||void 0===o?void 0:o.message,invalid:!(null===(s=f.group)||void 0===s||!s.message),children:(0,p.jsx)(F.g,{render:e=>{let{}=e,t=Ze(e.field,Ve);return(0,p.jsx)(L.LT,Object.assign({},t,{allowCustomValue:!0,options:w,width:42,onChange:e=>{var t;h("group",null!==(t=e.value)&&void 0!==t?t:"")},className:m.input}))},name:"group",control:c,rules:{required:{value:!0,message:"Required."},validate:{pathSeparator:Qe}}})})]})},Ye=e=>({flexRow:l.css`
    display: flex;
    flex-direction: row;
    justify-content: flex-start;

    & > * + * {
      margin-left: ${e.spacing(3)};
    }
  `,input:l.css`
    width: 330px !important;
  `});var He=n(33257);const Je=()=>{const e=(0,u.wW)(et);return(0,p.jsxs)(je.Stack,{gap:.5,children:[(0,p.jsx)("div",{className:e.slashNotAllowed,children:"Folders with '/' character are not allowed."}),(0,p.jsx)(Ce.u,{placement:"top",content:"Link to the Github issue",theme:"info",children:(0,p.jsx)(Ie.J,{name:"info-circle",size:"xs",className:e.infoIcon,onClick:()=>window.open("https://github.com/grafana/grafana/issues/42947","_blank")})})]})},Ke=e=>-1!==e.indexOf("/");function Xe(e){const{value:t}=e,n={warningCondition:e=>Ke(e),warningComponent:Je},r={disallowValues:!0,isAllowedValue:e=>!Ke(e)};return(0,p.jsx)(He.Es,Object.assign({showRoot:!1,rootName:"",allowEmpty:!0,initialTitle:null==t?void 0:t.title,initialFolderId:null==t?void 0:t.id,accessControlMetadata:!0},e,{permissionLevel:a.bf.View,customAdd:r,folderWarning:n}))}const et=e=>({slashNotAllowed:l.css`
    color: ${e.colors.warning.main};
    font-size: 12px;
    margin-bottom: 2px;
  `,infoIcon:l.css`
    color: ${e.colors.warning.main};
    font-size: 12px;
    margin-bottom: 2px;
    cursor: pointer;
  `}),tt=["ref"];var nt,rt;const it={message:"Recording rule name must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.",value:/^[a-zA-Z_:][a-zA-Z0-9_:]*$/},ot=e=>{var t,n,r,i,o,s;let{initialFolder:l}=e;const{register:c,watch:d,formState:{errors:f}}=(0,v.Gc)(),h=(0,u.wW)(at),m=d("type"),g=d("dataSourceName"),x=d("type"),b=st(l);return(0,p.jsxs)(me.z,{stepNo:x===R.$.cloudRecording?2:3,title:x===R.$.cloudRecording?"Add details for your recording rule":"Add details for your alert",description:x===R.$.cloudRecording?"Add labels to help you better manage your rules":"Write a summary and add labels to help you better manage your alerts",children:[(0,p.jsx)(q.g,{className:h.formInput,label:"Rule name",error:null==f||null===(t=f.name)||void 0===t?void 0:t.message,invalid:!(null===(n=f.name)||void 0===n||!n.message),children:(0,p.jsx)(E.I,Object.assign({id:"name"},c("name",{required:{value:!0,message:"Must enter an alert name"},pattern:m===R.$.cloudRecording?it:void 0,validate:{pathSeparator:e=>m!==R.$.grafana||Qe(e)}})))}),(m===R.$.cloudRecording||m===R.$.cloudAlerting)&&g&&(0,p.jsx)(Be,{rulesSourceName:g}),m===R.$.grafana&&(0,p.jsxs)("div",{className:ye()([h.flexRow,h.alignBaseline]),children:[(0,p.jsx)(q.g,{label:nt||(nt=(0,p.jsx)(we._,{htmlFor:"folder",description:"Select a folder to store your rule.",children:(0,p.jsxs)(je.Stack,{gap:.5,children:["Folder",(0,p.jsx)(Ce.u,{placement:"top",content:(0,p.jsx)("div",{children:"Each folder has unique folder permission. When you store multiple rules in a folder, the folder access permissions get assigned to the rules."}),children:(0,p.jsx)(Ie.J,{name:"info-circle",size:"xs"})})]})})),className:h.formInput,error:null===(r=f.folder)||void 0===r?void 0:r.message,invalid:!(null===(i=f.folder)||void 0===i||!i.message),"data-testid":"folder-picker",children:(0,p.jsx)(F.g,{render:e=>{let{}=e,t=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e.field,tt);return(0,p.jsx)(Xe,Object.assign({inputId:"folder"},t,{enableCreateNew:ke.Vt.hasPermission(a.bW.FoldersCreate),enableReset:!0,filter:b,dissalowSlashes:!0}))},name:"folder",rules:{required:{value:!0,message:"Please select a folder"},validate:{pathSeparator:e=>Qe(e.title)}}})}),(0,p.jsx)(q.g,{label:"Group","data-testid":"group-picker",description:"Rules within the same group are evaluated after the same time interval.",className:h.formInput,error:null===(o=f.group)||void 0===o?void 0:o.message,invalid:!(null===(s=f.group)||void 0===s||!s.message),children:(0,p.jsx)(E.I,Object.assign({id:"group"},c("group",{required:{value:!0,message:"Must enter a group name"},validate:{pathSeparator:e=>Qe(e)}})))})]}),x!==R.$.cloudRecording&&(rt||(rt=(0,p.jsx)(Ae.Z,{})))]})},st=e=>{const t=(0,i.useCallback)((t=>{const n=ke.Vt.hasEditPermissionInFolders,r=ke.Vt.hasAccessInMetadata(a.bW.AlertingRuleCreate,t,n),i=e&&t.folderId===e.id&&ke.Vt.hasAccessInMetadata(a.bW.AlertingRuleUpdate,t,n);return r||i}),[e]);return(0,i.useCallback)((e=>e.filter(t).filter((e=>{var t;return!Ke(null!==(t=e.title)&&void 0!==t?t:"")}))),[t])},at=e=>({alignBaseline:l.css`
    align-items: baseline;
    margin-bottom: ${e.spacing(3)};
  `,formInput:l.css`
    width: 275px;

    & + & {
      margin-left: ${e.spacing(3)};
    }
  `,flexRow:l.css`
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: end;
  `});var lt,ct,ut=n(51928),dt=n(1129),pt=n(32889),ft=n(87006);const ht=()=>{var e;const[t,n]=(0,i.useState)(!1),r=(0,u.wW)(mt),o=(0,u.l4)(),{watch:s}=(0,v.Gc)(),a=null!==(e=s("dataSourceName"))&&void 0!==e?e:K.GC;return(0,p.jsxs)(me.z,{stepNo:4,title:"Notifications",description:"Grafana handles the notifications for alerts by assigning labels to alerts. These labels connect alerts to contact points and silence alert instances that have matching labels.",children:[(0,p.jsx)("div",{children:(0,p.jsx)("div",{className:r.hideButton,onClick:()=>n(!t),children:(t?"Show":"Hide")+" flow chart"})}),(0,p.jsxs)("div",{className:r.contentWrapper,children:[!t&&(0,p.jsx)("img",{className:r.flowChart,src:`public/img/alerting/notification_policy_${o.name.toLowerCase()}.svg`,alt:"notification policy flow chart"}),(0,p.jsxs)("div",{style:{display:"flex",flexDirection:"column"},children:[(0,p.jsx)(ft.Z,{dataSourceName:a}),(0,p.jsxs)(dt.Z,{className:r.card,children:[lt||(lt=(0,p.jsx)(dt.Z.Heading,{children:"Root route â€“ default for all alerts"})),ct||(ct=(0,p.jsxs)(dt.Z.Description,{children:["Without custom labels, your alert will be routed through the root route. To view and edit the root route, go to ",(0,p.jsx)(pt.r,{href:"/alerting/routes",children:"notification policies"})," or contact your admin in case you are using non-Grafana alert management."]}))]})]})]})]})},mt=e=>({contentWrapper:l.css`
    display: flex;
    align-items: center;
  `,hideButton:l.css`
    color: ${e.colors.text.secondary};
    cursor: pointer;
    margin-bottom: ${e.spacing(1)};
  `,card:l.css`
    max-width: 500px;
  `,flowChart:l.css`
    margin-right: ${e.spacing(3)};
  `});function gt(e){return null==e}var vt={isNothing:gt,isObject:function(e){return"object"==typeof e&&null!==e},toArray:function(e){return Array.isArray(e)?e:gt(e)?[]:[e]},repeat:function(e,t){var n,r="";for(n=0;n<t;n+=1)r+=e;return r},isNegativeZero:function(e){return 0===e&&Number.NEGATIVE_INFINITY===1/e},extend:function(e,t){var n,r,i,o;if(t)for(n=0,r=(o=Object.keys(t)).length;n<r;n+=1)e[i=o[n]]=t[i];return e}};function xt(e,t){var n="",r=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(n+='in "'+e.mark.name+'" '),n+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!t&&e.mark.snippet&&(n+="\n\n"+e.mark.snippet),r+" "+n):r}function bt(e,t){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=t,this.message=xt(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack||""}bt.prototype=Object.create(Error.prototype),bt.prototype.constructor=bt,bt.prototype.toString=function(e){return this.name+": "+xt(this,e)};var yt=bt;function jt(e,t,n,r,i){var o="",s="",a=Math.floor(i/2)-1;return r-t>a&&(t=r-a+(o=" ... ").length),n-r>a&&(n=r+a-(s=" ...").length),{str:o+e.slice(t,n).replace(/\t/g,"â†’")+s,pos:r-t+o.length}}function wt(e,t){return vt.repeat(" ",t-e.length)+e}var Ct=function(e,t){if(t=Object.create(t||null),!e.buffer)return null;t.maxLength||(t.maxLength=79),"number"!=typeof t.indent&&(t.indent=1),"number"!=typeof t.linesBefore&&(t.linesBefore=3),"number"!=typeof t.linesAfter&&(t.linesAfter=2);for(var n,r=/\r?\n|\r|\0/g,i=[0],o=[],s=-1;n=r.exec(e.buffer);)o.push(n.index),i.push(n.index+n[0].length),e.position<=n.index&&s<0&&(s=i.length-2);s<0&&(s=i.length-1);var a,l,c="",u=Math.min(e.line+t.linesAfter,o.length).toString().length,d=t.maxLength-(t.indent+u+3);for(a=1;a<=t.linesBefore&&!(s-a<0);a++)l=jt(e.buffer,i[s-a],o[s-a],e.position-(i[s]-i[s-a]),d),c=vt.repeat(" ",t.indent)+wt((e.line-a+1).toString(),u)+" | "+l.str+"\n"+c;for(l=jt(e.buffer,i[s],o[s],e.position,d),c+=vt.repeat(" ",t.indent)+wt((e.line+1).toString(),u)+" | "+l.str+"\n",c+=vt.repeat("-",t.indent+u+3+l.pos)+"^\n",a=1;a<=t.linesAfter&&!(s+a>=o.length);a++)l=jt(e.buffer,i[s+a],o[s+a],e.position-(i[s]-i[s+a]),d),c+=vt.repeat(" ",t.indent)+wt((e.line+a+1).toString(),u)+" | "+l.str+"\n";return c.replace(/\n$/,"")},It=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],kt=["scalar","sequence","mapping"];var At=function(e,t){if(t=t||{},Object.keys(t).forEach((function(t){if(-1===It.indexOf(t))throw new yt('Unknown option "'+t+'" is met in definition of "'+e+'" YAML type.')})),this.options=t,this.tag=e,this.kind=t.kind||null,this.resolve=t.resolve||function(){return!0},this.construct=t.construct||function(e){return e},this.instanceOf=t.instanceOf||null,this.predicate=t.predicate||null,this.represent=t.represent||null,this.representName=t.representName||null,this.defaultStyle=t.defaultStyle||null,this.multi=t.multi||!1,this.styleAliases=function(e){var t={};return null!==e&&Object.keys(e).forEach((function(n){e[n].forEach((function(e){t[String(e)]=n}))})),t}(t.styleAliases||null),-1===kt.indexOf(this.kind))throw new yt('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')};function St(e,t){var n=[];return e[t].forEach((function(e){var t=n.length;n.forEach((function(n,r){n.tag===e.tag&&n.kind===e.kind&&n.multi===e.multi&&(t=r)})),n[t]=e})),n}function Nt(e){return this.extend(e)}Nt.prototype.extend=function(e){var t=[],n=[];if(e instanceof At)n.push(e);else if(Array.isArray(e))n=n.concat(e);else{if(!e||!Array.isArray(e.implicit)&&!Array.isArray(e.explicit))throw new yt("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(n=n.concat(e.explicit))}t.forEach((function(e){if(!(e instanceof At))throw new yt("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(e.loadKind&&"scalar"!==e.loadKind)throw new yt("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(e.multi)throw new yt("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")})),n.forEach((function(e){if(!(e instanceof At))throw new yt("Specified list of YAML types (or a single Type object) contains a non-Type object.")}));var r=Object.create(Nt.prototype);return r.implicit=(this.implicit||[]).concat(t),r.explicit=(this.explicit||[]).concat(n),r.compiledImplicit=St(r,"implicit"),r.compiledExplicit=St(r,"explicit"),r.compiledTypeMap=function(){var e,t,n={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function r(e){e.multi?(n.multi[e.kind].push(e),n.multi.fallback.push(e)):n[e.kind][e.tag]=n.fallback[e.tag]=e}for(e=0,t=arguments.length;e<t;e+=1)arguments[e].forEach(r);return n}(r.compiledImplicit,r.compiledExplicit),r};var Rt=Nt,Tt=new At("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return null!==e?e:""}}),Ot=new At("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return null!==e?e:[]}}),$t=new At("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return null!==e?e:{}}}),qt=new Rt({explicit:[Tt,Ot,$t]});var Et=new At("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(e){if(null===e)return!0;var t=e.length;return 1===t&&"~"===e||4===t&&("null"===e||"Null"===e||"NULL"===e)},construct:function(){return null},predicate:function(e){return null===e},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});var Ft=new At("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t=e.length;return 4===t&&("true"===e||"True"===e||"TRUE"===e)||5===t&&("false"===e||"False"===e||"FALSE"===e)},construct:function(e){return"true"===e||"True"===e||"TRUE"===e},predicate:function(e){return"[object Boolean]"===Object.prototype.toString.call(e)},represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});function Lt(e){return 48<=e&&e<=55}function Mt(e){return 48<=e&&e<=57}var Ut=new At("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,n,r=e.length,i=0,o=!1;if(!r)return!1;if("-"!==(t=e[i])&&"+"!==t||(t=e[++i]),"0"===t){if(i+1===r)return!0;if("b"===(t=e[++i])){for(i++;i<r;i++)if("_"!==(t=e[i])){if("0"!==t&&"1"!==t)return!1;o=!0}return o&&"_"!==t}if("x"===t){for(i++;i<r;i++)if("_"!==(t=e[i])){if(!(48<=(n=e.charCodeAt(i))&&n<=57||65<=n&&n<=70||97<=n&&n<=102))return!1;o=!0}return o&&"_"!==t}if("o"===t){for(i++;i<r;i++)if("_"!==(t=e[i])){if(!Lt(e.charCodeAt(i)))return!1;o=!0}return o&&"_"!==t}}if("_"===t)return!1;for(;i<r;i++)if("_"!==(t=e[i])){if(!Mt(e.charCodeAt(i)))return!1;o=!0}return!(!o||"_"===t)},construct:function(e){var t,n=e,r=1;if(-1!==n.indexOf("_")&&(n=n.replace(/_/g,"")),"-"!==(t=n[0])&&"+"!==t||("-"===t&&(r=-1),t=(n=n.slice(1))[0]),"0"===n)return 0;if("0"===t){if("b"===n[1])return r*parseInt(n.slice(2),2);if("x"===n[1])return r*parseInt(n.slice(2),16);if("o"===n[1])return r*parseInt(n.slice(2),8)}return r*parseInt(n,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&e%1==0&&!vt.isNegativeZero(e)},represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),Dt=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");var _t=/^[-+]?[0-9]+e/;var Wt=new At("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(e){return null!==e&&!(!Dt.test(e)||"_"===e[e.length-1])},construct:function(e){var t,n;return n="-"===(t=e.replace(/_/g,"").toLowerCase())[0]?-1:1,"+-".indexOf(t[0])>=0&&(t=t.slice(1)),".inf"===t?1===n?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:".nan"===t?NaN:n*parseFloat(t,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&(e%1!=0||vt.isNegativeZero(e))},represent:function(e,t){var n;if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(vt.isNegativeZero(e))return"-0.0";return n=e.toString(10),_t.test(n)?n.replace("e",".e"):n},defaultStyle:"lowercase"}),Qt=qt.extend({implicit:[Et,Ft,Ut,Wt]}),Pt=Qt,Gt=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),zt=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");var Vt=new At("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(e){return null!==e&&(null!==Gt.exec(e)||null!==zt.exec(e))},construct:function(e){var t,n,r,i,o,s,a,l,c=0,u=null;if(null===(t=Gt.exec(e))&&(t=zt.exec(e)),null===t)throw new Error("Date resolve error");if(n=+t[1],r=+t[2]-1,i=+t[3],!t[4])return new Date(Date.UTC(n,r,i));if(o=+t[4],s=+t[5],a=+t[6],t[7]){for(c=t[7].slice(0,3);c.length<3;)c+="0";c=+c}return t[9]&&(u=6e4*(60*+t[10]+ +(t[11]||0)),"-"===t[9]&&(u=-u)),l=new Date(Date.UTC(n,r,i,o,s,a,c)),u&&l.setTime(l.getTime()-u),l},instanceOf:Date,represent:function(e){return e.toISOString()}});var Zt=new At("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(e){return"<<"===e||null===e}}),Bt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\n\r";var Yt=new At("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,n,r=0,i=e.length,o=Bt;for(n=0;n<i;n++)if(!((t=o.indexOf(e.charAt(n)))>64)){if(t<0)return!1;r+=6}return r%8==0},construct:function(e){var t,n,r=e.replace(/[\r\n=]/g,""),i=r.length,o=Bt,s=0,a=[];for(t=0;t<i;t++)t%4==0&&t&&(a.push(s>>16&255),a.push(s>>8&255),a.push(255&s)),s=s<<6|o.indexOf(r.charAt(t));return 0===(n=i%4*6)?(a.push(s>>16&255),a.push(s>>8&255),a.push(255&s)):18===n?(a.push(s>>10&255),a.push(s>>2&255)):12===n&&a.push(s>>4&255),new Uint8Array(a)},predicate:function(e){return"[object Uint8Array]"===Object.prototype.toString.call(e)},represent:function(e){var t,n,r="",i=0,o=e.length,s=Bt;for(t=0;t<o;t++)t%3==0&&t&&(r+=s[i>>18&63],r+=s[i>>12&63],r+=s[i>>6&63],r+=s[63&i]),i=(i<<8)+e[t];return 0===(n=o%3)?(r+=s[i>>18&63],r+=s[i>>12&63],r+=s[i>>6&63],r+=s[63&i]):2===n?(r+=s[i>>10&63],r+=s[i>>4&63],r+=s[i<<2&63],r+=s[64]):1===n&&(r+=s[i>>2&63],r+=s[i<<4&63],r+=s[64],r+=s[64]),r}}),Ht=Object.prototype.hasOwnProperty,Jt=Object.prototype.toString;var Kt=new At("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,n,r,i,o,s=[],a=e;for(t=0,n=a.length;t<n;t+=1){if(r=a[t],o=!1,"[object Object]"!==Jt.call(r))return!1;for(i in r)if(Ht.call(r,i)){if(o)return!1;o=!0}if(!o)return!1;if(-1!==s.indexOf(i))return!1;s.push(i)}return!0},construct:function(e){return null!==e?e:[]}}),Xt=Object.prototype.toString;var en=new At("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,n,r,i,o,s=e;for(o=new Array(s.length),t=0,n=s.length;t<n;t+=1){if(r=s[t],"[object Object]"!==Xt.call(r))return!1;if(1!==(i=Object.keys(r)).length)return!1;o[t]=[i[0],r[i[0]]]}return!0},construct:function(e){if(null===e)return[];var t,n,r,i,o,s=e;for(o=new Array(s.length),t=0,n=s.length;t<n;t+=1)r=s[t],i=Object.keys(r),o[t]=[i[0],r[i[0]]];return o}}),tn=Object.prototype.hasOwnProperty;var nn=new At("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(e){if(null===e)return!0;var t,n=e;for(t in n)if(tn.call(n,t)&&null!==n[t])return!1;return!0},construct:function(e){return null!==e?e:{}}}),rn=Pt.extend({implicit:[Vt,Zt],explicit:[Yt,Kt,en,nn]}),on=Object.prototype.hasOwnProperty,sn=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,an=/[\x85\u2028\u2029]/,ln=/[,\[\]\{\}]/,cn=/^(?:!|!!|![a-z\-]+!)$/i,un=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function dn(e){return Object.prototype.toString.call(e)}function pn(e){return 10===e||13===e}function fn(e){return 9===e||32===e}function hn(e){return 9===e||32===e||10===e||13===e}function mn(e){return 44===e||91===e||93===e||123===e||125===e}function gn(e){var t;return 48<=e&&e<=57?e-48:97<=(t=32|e)&&t<=102?t-97+10:-1}function vn(e){return 48===e?"\0":97===e?"":98===e?"\b":116===e||9===e?"\t":110===e?"\n":118===e?"\v":102===e?"\f":114===e?"\r":101===e?"":32===e?" ":34===e?'"':47===e?"/":92===e?"\\":78===e?"Â…":95===e?"Â ":76===e?"\u2028":80===e?"\u2029":""}function xn(e){return e<=65535?String.fromCharCode(e):String.fromCharCode(55296+(e-65536>>10),56320+(e-65536&1023))}for(var bn=new Array(256),yn=new Array(256),jn=0;jn<256;jn++)bn[jn]=vn(jn)?1:0,yn[jn]=vn(jn);function wn(e,t){this.input=e,this.filename=t.filename||null,this.schema=t.schema||rn,this.onWarning=t.onWarning||null,this.legacy=t.legacy||!1,this.json=t.json||!1,this.listener=t.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=e.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function Cn(e,t){var n={name:e.filename,buffer:e.input.slice(0,-1),position:e.position,line:e.line,column:e.position-e.lineStart};return n.snippet=Ct(n),new yt(t,n)}function In(e,t){throw Cn(e,t)}function kn(e,t){e.onWarning&&e.onWarning.call(null,Cn(e,t))}var An={YAML:function(e,t,n){var r,i,o;null!==e.version&&In(e,"duplication of %YAML directive"),1!==n.length&&In(e,"YAML directive accepts exactly one argument"),null===(r=/^([0-9]+)\.([0-9]+)$/.exec(n[0]))&&In(e,"ill-formed argument of the YAML directive"),i=parseInt(r[1],10),o=parseInt(r[2],10),1!==i&&In(e,"unacceptable YAML version of the document"),e.version=n[0],e.checkLineBreaks=o<2,1!==o&&2!==o&&kn(e,"unsupported YAML version of the document")},TAG:function(e,t,n){var r,i;2!==n.length&&In(e,"TAG directive accepts exactly two arguments"),r=n[0],i=n[1],cn.test(r)||In(e,"ill-formed tag handle (first argument) of the TAG directive"),on.call(e.tagMap,r)&&In(e,'there is a previously declared suffix for "'+r+'" tag handle'),un.test(i)||In(e,"ill-formed tag prefix (second argument) of the TAG directive");try{i=decodeURIComponent(i)}catch(t){In(e,"tag prefix is malformed: "+i)}e.tagMap[r]=i}};function Sn(e,t,n,r){var i,o,s,a;if(t<n){if(a=e.input.slice(t,n),r)for(i=0,o=a.length;i<o;i+=1)9===(s=a.charCodeAt(i))||32<=s&&s<=1114111||In(e,"expected valid JSON character");else sn.test(a)&&In(e,"the stream contains non-printable characters");e.result+=a}}function Nn(e,t,n,r){var i,o,s,a;for(vt.isObject(n)||In(e,"cannot merge mappings; the provided source object is unacceptable"),s=0,a=(i=Object.keys(n)).length;s<a;s+=1)o=i[s],on.call(t,o)||(t[o]=n[o],r[o]=!0)}function Rn(e,t,n,r,i,o,s,a,l){var c,u;if(Array.isArray(i))for(c=0,u=(i=Array.prototype.slice.call(i)).length;c<u;c+=1)Array.isArray(i[c])&&In(e,"nested arrays are not supported inside keys"),"object"==typeof i&&"[object Object]"===dn(i[c])&&(i[c]="[object Object]");if("object"==typeof i&&"[object Object]"===dn(i)&&(i="[object Object]"),i=String(i),null===t&&(t={}),"tag:yaml.org,2002:merge"===r)if(Array.isArray(o))for(c=0,u=o.length;c<u;c+=1)Nn(e,t,o[c],n);else Nn(e,t,o,n);else e.json||on.call(n,i)||!on.call(t,i)||(e.line=s||e.line,e.lineStart=a||e.lineStart,e.position=l||e.position,In(e,"duplicated mapping key")),"__proto__"===i?Object.defineProperty(t,i,{configurable:!0,enumerable:!0,writable:!0,value:o}):t[i]=o,delete n[i];return t}function Tn(e){var t;10===(t=e.input.charCodeAt(e.position))?e.position++:13===t?(e.position++,10===e.input.charCodeAt(e.position)&&e.position++):In(e,"a line break is expected"),e.line+=1,e.lineStart=e.position,e.firstTabInLine=-1}function On(e,t,n){for(var r=0,i=e.input.charCodeAt(e.position);0!==i;){for(;fn(i);)9===i&&-1===e.firstTabInLine&&(e.firstTabInLine=e.position),i=e.input.charCodeAt(++e.position);if(t&&35===i)do{i=e.input.charCodeAt(++e.position)}while(10!==i&&13!==i&&0!==i);if(!pn(i))break;for(Tn(e),i=e.input.charCodeAt(e.position),r++,e.lineIndent=0;32===i;)e.lineIndent++,i=e.input.charCodeAt(++e.position)}return-1!==n&&0!==r&&e.lineIndent<n&&kn(e,"deficient indentation"),r}function $n(e){var t,n=e.position;return!(45!==(t=e.input.charCodeAt(n))&&46!==t||t!==e.input.charCodeAt(n+1)||t!==e.input.charCodeAt(n+2)||(n+=3,0!==(t=e.input.charCodeAt(n))&&!hn(t)))}function qn(e,t){1===t?e.result+=" ":t>1&&(e.result+=vt.repeat("\n",t-1))}function En(e,t){var n,r,i=e.tag,o=e.anchor,s=[],a=!1;if(-1!==e.firstTabInLine)return!1;for(null!==e.anchor&&(e.anchorMap[e.anchor]=s),r=e.input.charCodeAt(e.position);0!==r&&(-1!==e.firstTabInLine&&(e.position=e.firstTabInLine,In(e,"tab characters must not be used in indentation")),45===r)&&hn(e.input.charCodeAt(e.position+1));)if(a=!0,e.position++,On(e,!0,-1)&&e.lineIndent<=t)s.push(null),r=e.input.charCodeAt(e.position);else if(n=e.line,Mn(e,t,3,!1,!0),s.push(e.result),On(e,!0,-1),r=e.input.charCodeAt(e.position),(e.line===n||e.lineIndent>t)&&0!==r)In(e,"bad indentation of a sequence entry");else if(e.lineIndent<t)break;return!!a&&(e.tag=i,e.anchor=o,e.kind="sequence",e.result=s,!0)}function Fn(e){var t,n,r,i,o=!1,s=!1;if(33!==(i=e.input.charCodeAt(e.position)))return!1;if(null!==e.tag&&In(e,"duplication of a tag property"),60===(i=e.input.charCodeAt(++e.position))?(o=!0,i=e.input.charCodeAt(++e.position)):33===i?(s=!0,n="!!",i=e.input.charCodeAt(++e.position)):n="!",t=e.position,o){do{i=e.input.charCodeAt(++e.position)}while(0!==i&&62!==i);e.position<e.length?(r=e.input.slice(t,e.position),i=e.input.charCodeAt(++e.position)):In(e,"unexpected end of the stream within a verbatim tag")}else{for(;0!==i&&!hn(i);)33===i&&(s?In(e,"tag suffix cannot contain exclamation marks"):(n=e.input.slice(t-1,e.position+1),cn.test(n)||In(e,"named tag handle cannot contain such characters"),s=!0,t=e.position+1)),i=e.input.charCodeAt(++e.position);r=e.input.slice(t,e.position),ln.test(r)&&In(e,"tag suffix cannot contain flow indicator characters")}r&&!un.test(r)&&In(e,"tag name cannot contain such characters: "+r);try{r=decodeURIComponent(r)}catch(t){In(e,"tag name is malformed: "+r)}return o?e.tag=r:on.call(e.tagMap,n)?e.tag=e.tagMap[n]+r:"!"===n?e.tag="!"+r:"!!"===n?e.tag="tag:yaml.org,2002:"+r:In(e,'undeclared tag handle "'+n+'"'),!0}function Ln(e){var t,n;if(38!==(n=e.input.charCodeAt(e.position)))return!1;for(null!==e.anchor&&In(e,"duplication of an anchor property"),n=e.input.charCodeAt(++e.position),t=e.position;0!==n&&!hn(n)&&!mn(n);)n=e.input.charCodeAt(++e.position);return e.position===t&&In(e,"name of an anchor node must contain at least one character"),e.anchor=e.input.slice(t,e.position),!0}function Mn(e,t,n,r,i){var o,s,a,l,c,u,d,p,f,h=1,m=!1,g=!1;if(null!==e.listener&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null,o=s=a=4===n||3===n,r&&On(e,!0,-1)&&(m=!0,e.lineIndent>t?h=1:e.lineIndent===t?h=0:e.lineIndent<t&&(h=-1)),1===h)for(;Fn(e)||Ln(e);)On(e,!0,-1)?(m=!0,a=o,e.lineIndent>t?h=1:e.lineIndent===t?h=0:e.lineIndent<t&&(h=-1)):a=!1;if(a&&(a=m||i),1!==h&&4!==n||(p=1===n||2===n?t:t+1,f=e.position-e.lineStart,1===h?a&&(En(e,f)||function(e,t,n){var r,i,o,s,a,l,c,u=e.tag,d=e.anchor,p={},f=Object.create(null),h=null,m=null,g=null,v=!1,x=!1;if(-1!==e.firstTabInLine)return!1;for(null!==e.anchor&&(e.anchorMap[e.anchor]=p),c=e.input.charCodeAt(e.position);0!==c;){if(v||-1===e.firstTabInLine||(e.position=e.firstTabInLine,In(e,"tab characters must not be used in indentation")),r=e.input.charCodeAt(e.position+1),o=e.line,63!==c&&58!==c||!hn(r)){if(s=e.line,a=e.lineStart,l=e.position,!Mn(e,n,2,!1,!0))break;if(e.line===o){for(c=e.input.charCodeAt(e.position);fn(c);)c=e.input.charCodeAt(++e.position);if(58===c)hn(c=e.input.charCodeAt(++e.position))||In(e,"a whitespace character is expected after the key-value separator within a block mapping"),v&&(Rn(e,p,f,h,m,null,s,a,l),h=m=g=null),x=!0,v=!1,i=!1,h=e.tag,m=e.result;else{if(!x)return e.tag=u,e.anchor=d,!0;In(e,"can not read an implicit mapping pair; a colon is missed")}}else{if(!x)return e.tag=u,e.anchor=d,!0;In(e,"can not read a block mapping entry; a multiline key may not be an implicit key")}}else 63===c?(v&&(Rn(e,p,f,h,m,null,s,a,l),h=m=g=null),x=!0,v=!0,i=!0):v?(v=!1,i=!0):In(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),e.position+=1,c=r;if((e.line===o||e.lineIndent>t)&&(v&&(s=e.line,a=e.lineStart,l=e.position),Mn(e,t,4,!0,i)&&(v?m=e.result:g=e.result),v||(Rn(e,p,f,h,m,g,s,a,l),h=m=g=null),On(e,!0,-1),c=e.input.charCodeAt(e.position)),(e.line===o||e.lineIndent>t)&&0!==c)In(e,"bad indentation of a mapping entry");else if(e.lineIndent<t)break}return v&&Rn(e,p,f,h,m,null,s,a,l),x&&(e.tag=u,e.anchor=d,e.kind="mapping",e.result=p),x}(e,f,p))||function(e,t){var n,r,i,o,s,a,l,c,u,d,p,f,h=!0,m=e.tag,g=e.anchor,v=Object.create(null);if(91===(f=e.input.charCodeAt(e.position)))s=93,c=!1,o=[];else{if(123!==f)return!1;s=125,c=!0,o={}}for(null!==e.anchor&&(e.anchorMap[e.anchor]=o),f=e.input.charCodeAt(++e.position);0!==f;){if(On(e,!0,t),(f=e.input.charCodeAt(e.position))===s)return e.position++,e.tag=m,e.anchor=g,e.kind=c?"mapping":"sequence",e.result=o,!0;h?44===f&&In(e,"expected the node content, but found ','"):In(e,"missed comma between flow collection entries"),p=null,a=l=!1,63===f&&hn(e.input.charCodeAt(e.position+1))&&(a=l=!0,e.position++,On(e,!0,t)),n=e.line,r=e.lineStart,i=e.position,Mn(e,t,1,!1,!0),d=e.tag,u=e.result,On(e,!0,t),f=e.input.charCodeAt(e.position),!l&&e.line!==n||58!==f||(a=!0,f=e.input.charCodeAt(++e.position),On(e,!0,t),Mn(e,t,1,!1,!0),p=e.result),c?Rn(e,o,v,d,u,p,n,r,i):a?o.push(Rn(e,null,v,d,u,p,n,r,i)):o.push(u),On(e,!0,t),44===(f=e.input.charCodeAt(e.position))?(h=!0,f=e.input.charCodeAt(++e.position)):h=!1}In(e,"unexpected end of the stream within a flow collection")}(e,p)?g=!0:(s&&function(e,t){var n,r,i,o,s,a=1,l=!1,c=!1,u=t,d=0,p=!1;if(124===(o=e.input.charCodeAt(e.position)))r=!1;else{if(62!==o)return!1;r=!0}for(e.kind="scalar",e.result="";0!==o;)if(43===(o=e.input.charCodeAt(++e.position))||45===o)1===a?a=43===o?3:2:In(e,"repeat of a chomping mode identifier");else{if(!((i=48<=(s=o)&&s<=57?s-48:-1)>=0))break;0===i?In(e,"bad explicit indentation width of a block scalar; it cannot be less than one"):c?In(e,"repeat of an indentation width identifier"):(u=t+i-1,c=!0)}if(fn(o)){do{o=e.input.charCodeAt(++e.position)}while(fn(o));if(35===o)do{o=e.input.charCodeAt(++e.position)}while(!pn(o)&&0!==o)}for(;0!==o;){for(Tn(e),e.lineIndent=0,o=e.input.charCodeAt(e.position);(!c||e.lineIndent<u)&&32===o;)e.lineIndent++,o=e.input.charCodeAt(++e.position);if(!c&&e.lineIndent>u&&(u=e.lineIndent),pn(o))d++;else{if(e.lineIndent<u){3===a?e.result+=vt.repeat("\n",l?1+d:d):1===a&&l&&(e.result+="\n");break}for(r?fn(o)?(p=!0,e.result+=vt.repeat("\n",l?1+d:d)):p?(p=!1,e.result+=vt.repeat("\n",d+1)):0===d?l&&(e.result+=" "):e.result+=vt.repeat("\n",d):e.result+=vt.repeat("\n",l?1+d:d),l=!0,c=!0,d=0,n=e.position;!pn(o)&&0!==o;)o=e.input.charCodeAt(++e.position);Sn(e,n,e.position,!1)}}return!0}(e,p)||function(e,t){var n,r,i;if(39!==(n=e.input.charCodeAt(e.position)))return!1;for(e.kind="scalar",e.result="",e.position++,r=i=e.position;0!==(n=e.input.charCodeAt(e.position));)if(39===n){if(Sn(e,r,e.position,!0),39!==(n=e.input.charCodeAt(++e.position)))return!0;r=e.position,e.position++,i=e.position}else pn(n)?(Sn(e,r,i,!0),qn(e,On(e,!1,t)),r=i=e.position):e.position===e.lineStart&&$n(e)?In(e,"unexpected end of the document within a single quoted scalar"):(e.position++,i=e.position);In(e,"unexpected end of the stream within a single quoted scalar")}(e,p)||function(e,t){var n,r,i,o,s,a,l;if(34!==(a=e.input.charCodeAt(e.position)))return!1;for(e.kind="scalar",e.result="",e.position++,n=r=e.position;0!==(a=e.input.charCodeAt(e.position));){if(34===a)return Sn(e,n,e.position,!0),e.position++,!0;if(92===a){if(Sn(e,n,e.position,!0),pn(a=e.input.charCodeAt(++e.position)))On(e,!1,t);else if(a<256&&bn[a])e.result+=yn[a],e.position++;else if((s=120===(l=a)?2:117===l?4:85===l?8:0)>0){for(i=s,o=0;i>0;i--)(s=gn(a=e.input.charCodeAt(++e.position)))>=0?o=(o<<4)+s:In(e,"expected hexadecimal character");e.result+=xn(o),e.position++}else In(e,"unknown escape sequence");n=r=e.position}else pn(a)?(Sn(e,n,r,!0),qn(e,On(e,!1,t)),n=r=e.position):e.position===e.lineStart&&$n(e)?In(e,"unexpected end of the document within a double quoted scalar"):(e.position++,r=e.position)}In(e,"unexpected end of the stream within a double quoted scalar")}(e,p)?g=!0:!function(e){var t,n,r;if(42!==(r=e.input.charCodeAt(e.position)))return!1;for(r=e.input.charCodeAt(++e.position),t=e.position;0!==r&&!hn(r)&&!mn(r);)r=e.input.charCodeAt(++e.position);return e.position===t&&In(e,"name of an alias node must contain at least one character"),n=e.input.slice(t,e.position),on.call(e.anchorMap,n)||In(e,'unidentified alias "'+n+'"'),e.result=e.anchorMap[n],On(e,!0,-1),!0}(e)?function(e,t,n){var r,i,o,s,a,l,c,u,d=e.kind,p=e.result;if(hn(u=e.input.charCodeAt(e.position))||mn(u)||35===u||38===u||42===u||33===u||124===u||62===u||39===u||34===u||37===u||64===u||96===u)return!1;if((63===u||45===u)&&(hn(r=e.input.charCodeAt(e.position+1))||n&&mn(r)))return!1;for(e.kind="scalar",e.result="",i=o=e.position,s=!1;0!==u;){if(58===u){if(hn(r=e.input.charCodeAt(e.position+1))||n&&mn(r))break}else if(35===u){if(hn(e.input.charCodeAt(e.position-1)))break}else{if(e.position===e.lineStart&&$n(e)||n&&mn(u))break;if(pn(u)){if(a=e.line,l=e.lineStart,c=e.lineIndent,On(e,!1,-1),e.lineIndent>=t){s=!0,u=e.input.charCodeAt(e.position);continue}e.position=o,e.line=a,e.lineStart=l,e.lineIndent=c;break}}s&&(Sn(e,i,o,!1),qn(e,e.line-a),i=o=e.position,s=!1),fn(u)||(o=e.position+1),u=e.input.charCodeAt(++e.position)}return Sn(e,i,o,!1),!!e.result||(e.kind=d,e.result=p,!1)}(e,p,1===n)&&(g=!0,null===e.tag&&(e.tag="?")):(g=!0,null===e.tag&&null===e.anchor||In(e,"alias node should not have any properties")),null!==e.anchor&&(e.anchorMap[e.anchor]=e.result)):0===h&&(g=a&&En(e,f))),null===e.tag)null!==e.anchor&&(e.anchorMap[e.anchor]=e.result);else if("?"===e.tag){for(null!==e.result&&"scalar"!==e.kind&&In(e,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+e.kind+'"'),l=0,c=e.implicitTypes.length;l<c;l+=1)if((d=e.implicitTypes[l]).resolve(e.result)){e.result=d.construct(e.result),e.tag=d.tag,null!==e.anchor&&(e.anchorMap[e.anchor]=e.result);break}}else if("!"!==e.tag){if(on.call(e.typeMap[e.kind||"fallback"],e.tag))d=e.typeMap[e.kind||"fallback"][e.tag];else for(d=null,l=0,c=(u=e.typeMap.multi[e.kind||"fallback"]).length;l<c;l+=1)if(e.tag.slice(0,u[l].tag.length)===u[l].tag){d=u[l];break}d||In(e,"unknown tag !<"+e.tag+">"),null!==e.result&&d.kind!==e.kind&&In(e,"unacceptable node kind for !<"+e.tag+'> tag; it should be "'+d.kind+'", not "'+e.kind+'"'),d.resolve(e.result,e.tag)?(e.result=d.construct(e.result,e.tag),null!==e.anchor&&(e.anchorMap[e.anchor]=e.result)):In(e,"cannot resolve a node with !<"+e.tag+"> explicit tag")}return null!==e.listener&&e.listener("close",e),null!==e.tag||null!==e.anchor||g}function Un(e){var t,n,r,i,o=e.position,s=!1;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);0!==(i=e.input.charCodeAt(e.position))&&(On(e,!0,-1),i=e.input.charCodeAt(e.position),!(e.lineIndent>0||37!==i));){for(s=!0,i=e.input.charCodeAt(++e.position),t=e.position;0!==i&&!hn(i);)i=e.input.charCodeAt(++e.position);for(r=[],(n=e.input.slice(t,e.position)).length<1&&In(e,"directive name must not be less than one character in length");0!==i;){for(;fn(i);)i=e.input.charCodeAt(++e.position);if(35===i){do{i=e.input.charCodeAt(++e.position)}while(0!==i&&!pn(i));break}if(pn(i))break;for(t=e.position;0!==i&&!hn(i);)i=e.input.charCodeAt(++e.position);r.push(e.input.slice(t,e.position))}0!==i&&Tn(e),on.call(An,n)?An[n](e,n,r):kn(e,'unknown document directive "'+n+'"')}On(e,!0,-1),0===e.lineIndent&&45===e.input.charCodeAt(e.position)&&45===e.input.charCodeAt(e.position+1)&&45===e.input.charCodeAt(e.position+2)?(e.position+=3,On(e,!0,-1)):s&&In(e,"directives end mark is expected"),Mn(e,e.lineIndent-1,4,!1,!0),On(e,!0,-1),e.checkLineBreaks&&an.test(e.input.slice(o,e.position))&&kn(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&$n(e)?46===e.input.charCodeAt(e.position)&&(e.position+=3,On(e,!0,-1)):e.position<e.length-1&&In(e,"end of the stream or a document separator is expected")}function Dn(e,t){t=t||{},0!==(e=String(e)).length&&(10!==e.charCodeAt(e.length-1)&&13!==e.charCodeAt(e.length-1)&&(e+="\n"),65279===e.charCodeAt(0)&&(e=e.slice(1)));var n=new wn(e,t),r=e.indexOf("\0");for(-1!==r&&(n.position=r,In(n,"null byte is not allowed in input")),n.input+="\0";32===n.input.charCodeAt(n.position);)n.lineIndent+=1,n.position+=1;for(;n.position<n.length-1;)Un(n);return n.documents}var _n={loadAll:function(e,t,n){null!==t&&"object"==typeof t&&void 0===n&&(n=t,t=null);var r=Dn(e,n);if("function"!=typeof t)return r;for(var i=0,o=r.length;i<o;i+=1)t(r[i])},load:function(e,t){var n=Dn(e,t);if(0!==n.length){if(1===n.length)return n[0];throw new yt("expected a single document in the stream, but found more")}}},Wn=Object.prototype.toString,Qn=Object.prototype.hasOwnProperty,Pn=65279,Gn={0:"\\0",7:"\\a",8:"\\b",9:"\\t",10:"\\n",11:"\\v",12:"\\f",13:"\\r",27:"\\e",34:'\\"',92:"\\\\",133:"\\N",160:"\\_",8232:"\\L",8233:"\\P"},zn=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],Vn=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function Zn(e){var t,n,r;if(t=e.toString(16).toUpperCase(),e<=255)n="x",r=2;else if(e<=65535)n="u",r=4;else{if(!(e<=4294967295))throw new yt("code point within a string may not be greater than 0xFFFFFFFF");n="U",r=8}return"\\"+n+vt.repeat("0",r-t.length)+t}function Bn(e){this.schema=e.schema||rn,this.indent=Math.max(1,e.indent||2),this.noArrayIndent=e.noArrayIndent||!1,this.skipInvalid=e.skipInvalid||!1,this.flowLevel=vt.isNothing(e.flowLevel)?-1:e.flowLevel,this.styleMap=function(e,t){var n,r,i,o,s,a,l;if(null===t)return{};for(n={},i=0,o=(r=Object.keys(t)).length;i<o;i+=1)s=r[i],a=String(t[s]),"!!"===s.slice(0,2)&&(s="tag:yaml.org,2002:"+s.slice(2)),(l=e.compiledTypeMap.fallback[s])&&Qn.call(l.styleAliases,a)&&(a=l.styleAliases[a]),n[s]=a;return n}(this.schema,e.styles||null),this.sortKeys=e.sortKeys||!1,this.lineWidth=e.lineWidth||80,this.noRefs=e.noRefs||!1,this.noCompatMode=e.noCompatMode||!1,this.condenseFlow=e.condenseFlow||!1,this.quotingType='"'===e.quotingType?2:1,this.forceQuotes=e.forceQuotes||!1,this.replacer="function"==typeof e.replacer?e.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function Yn(e,t){for(var n,r=vt.repeat(" ",t),i=0,o=-1,s="",a=e.length;i<a;)-1===(o=e.indexOf("\n",i))?(n=e.slice(i),i=a):(n=e.slice(i,o+1),i=o+1),n.length&&"\n"!==n&&(s+=r),s+=n;return s}function Hn(e,t){return"\n"+vt.repeat(" ",e.indent*t)}function Jn(e){return 32===e||9===e}function Kn(e){return 32<=e&&e<=126||161<=e&&e<=55295&&8232!==e&&8233!==e||57344<=e&&e<=65533&&e!==Pn||65536<=e&&e<=1114111}function Xn(e){return Kn(e)&&e!==Pn&&13!==e&&10!==e}function er(e,t,n){var r=Xn(e),i=r&&!Jn(e);return(n?r:r&&44!==e&&91!==e&&93!==e&&123!==e&&125!==e)&&35!==e&&!(58===t&&!i)||Xn(t)&&!Jn(t)&&35===e||58===t&&i}function tr(e,t){var n,r=e.charCodeAt(t);return r>=55296&&r<=56319&&t+1<e.length&&(n=e.charCodeAt(t+1))>=56320&&n<=57343?1024*(r-55296)+n-56320+65536:r}function nr(e){return/^\n* /.test(e)}function rr(e,t,n,r,i,o,s,a){var l,c,u=0,d=null,p=!1,f=!1,h=-1!==r,m=-1,g=Kn(c=tr(e,0))&&c!==Pn&&!Jn(c)&&45!==c&&63!==c&&58!==c&&44!==c&&91!==c&&93!==c&&123!==c&&125!==c&&35!==c&&38!==c&&42!==c&&33!==c&&124!==c&&61!==c&&62!==c&&39!==c&&34!==c&&37!==c&&64!==c&&96!==c&&function(e){return!Jn(e)&&58!==e}(tr(e,e.length-1));if(t||s)for(l=0;l<e.length;u>=65536?l+=2:l++){if(!Kn(u=tr(e,l)))return 5;g=g&&er(u,d,a),d=u}else{for(l=0;l<e.length;u>=65536?l+=2:l++){if(10===(u=tr(e,l)))p=!0,h&&(f=f||l-m-1>r&&" "!==e[m+1],m=l);else if(!Kn(u))return 5;g=g&&er(u,d,a),d=u}f=f||h&&l-m-1>r&&" "!==e[m+1]}return p||f?n>9&&nr(e)?5:s?2===o?5:2:f?4:3:!g||s||i(e)?2===o?5:2:1}function ir(e,t,n,r,i){e.dump=function(){if(0===t.length)return 2===e.quotingType?'""':"''";if(!e.noCompatMode&&(-1!==zn.indexOf(t)||Vn.test(t)))return 2===e.quotingType?'"'+t+'"':"'"+t+"'";var o=e.indent*Math.max(1,n),s=-1===e.lineWidth?-1:Math.max(Math.min(e.lineWidth,40),e.lineWidth-o),a=r||e.flowLevel>-1&&n>=e.flowLevel;switch(rr(t,a,e.indent,s,(function(t){return function(e,t){var n,r;for(n=0,r=e.implicitTypes.length;n<r;n+=1)if(e.implicitTypes[n].resolve(t))return!0;return!1}(e,t)}),e.quotingType,e.forceQuotes&&!r,i)){case 1:return t;case 2:return"'"+t.replace(/'/g,"''")+"'";case 3:return"|"+or(t,e.indent)+sr(Yn(t,o));case 4:return">"+or(t,e.indent)+sr(Yn(function(e,t){var n,r,i=/(\n+)([^\n]*)/g,o=(a=e.indexOf("\n"),a=-1!==a?a:e.length,i.lastIndex=a,ar(e.slice(0,a),t)),s="\n"===e[0]||" "===e[0];var a;for(;r=i.exec(e);){var l=r[1],c=r[2];n=" "===c[0],o+=l+(s||n||""===c?"":"\n")+ar(c,t),s=n}return o}(t,s),o));case 5:return'"'+function(e){for(var t,n="",r=0,i=0;i<e.length;r>=65536?i+=2:i++)r=tr(e,i),!(t=Gn[r])&&Kn(r)?(n+=e[i],r>=65536&&(n+=e[i+1])):n+=t||Zn(r);return n}(t)+'"';default:throw new yt("impossible error: invalid scalar style")}}()}function or(e,t){var n=nr(e)?String(t):"",r="\n"===e[e.length-1];return n+(r&&("\n"===e[e.length-2]||"\n"===e)?"+":r?"":"-")+"\n"}function sr(e){return"\n"===e[e.length-1]?e.slice(0,-1):e}function ar(e,t){if(""===e||" "===e[0])return e;for(var n,r,i=/ [^ ]/g,o=0,s=0,a=0,l="";n=i.exec(e);)(a=n.index)-o>t&&(r=s>o?s:a,l+="\n"+e.slice(o,r),o=r+1),s=a;return l+="\n",e.length-o>t&&s>o?l+=e.slice(o,s)+"\n"+e.slice(s+1):l+=e.slice(o),l.slice(1)}function lr(e,t,n,r){var i,o,s,a="",l=e.tag;for(i=0,o=n.length;i<o;i+=1)s=n[i],e.replacer&&(s=e.replacer.call(n,String(i),s)),(ur(e,t+1,s,!0,!0,!1,!0)||void 0===s&&ur(e,t+1,null,!0,!0,!1,!0))&&(r&&""===a||(a+=Hn(e,t)),e.dump&&10===e.dump.charCodeAt(0)?a+="-":a+="- ",a+=e.dump);e.tag=l,e.dump=a||"[]"}function cr(e,t,n){var r,i,o,s,a,l;for(o=0,s=(i=n?e.explicitTypes:e.implicitTypes).length;o<s;o+=1)if(((a=i[o]).instanceOf||a.predicate)&&(!a.instanceOf||"object"==typeof t&&t instanceof a.instanceOf)&&(!a.predicate||a.predicate(t))){if(n?a.multi&&a.representName?e.tag=a.representName(t):e.tag=a.tag:e.tag="?",a.represent){if(l=e.styleMap[a.tag]||a.defaultStyle,"[object Function]"===Wn.call(a.represent))r=a.represent(t,l);else{if(!Qn.call(a.represent,l))throw new yt("!<"+a.tag+'> tag resolver accepts not "'+l+'" style');r=a.represent[l](t,l)}e.dump=r}return!0}return!1}function ur(e,t,n,r,i,o,s){e.tag=null,e.dump=n,cr(e,n,!1)||cr(e,n,!0);var a,l=Wn.call(e.dump),c=r;r&&(r=e.flowLevel<0||e.flowLevel>t);var u,d,p="[object Object]"===l||"[object Array]"===l;if(p&&(d=-1!==(u=e.duplicates.indexOf(n))),(null!==e.tag&&"?"!==e.tag||d||2!==e.indent&&t>0)&&(i=!1),d&&e.usedDuplicates[u])e.dump="*ref_"+u;else{if(p&&d&&!e.usedDuplicates[u]&&(e.usedDuplicates[u]=!0),"[object Object]"===l)r&&0!==Object.keys(e.dump).length?(!function(e,t,n,r){var i,o,s,a,l,c,u="",d=e.tag,p=Object.keys(n);if(!0===e.sortKeys)p.sort();else if("function"==typeof e.sortKeys)p.sort(e.sortKeys);else if(e.sortKeys)throw new yt("sortKeys must be a boolean or a function");for(i=0,o=p.length;i<o;i+=1)c="",r&&""===u||(c+=Hn(e,t)),a=n[s=p[i]],e.replacer&&(a=e.replacer.call(n,s,a)),ur(e,t+1,s,!0,!0,!0)&&((l=null!==e.tag&&"?"!==e.tag||e.dump&&e.dump.length>1024)&&(e.dump&&10===e.dump.charCodeAt(0)?c+="?":c+="? "),c+=e.dump,l&&(c+=Hn(e,t)),ur(e,t+1,a,!0,l)&&(e.dump&&10===e.dump.charCodeAt(0)?c+=":":c+=": ",u+=c+=e.dump));e.tag=d,e.dump=u||"{}"}(e,t,e.dump,i),d&&(e.dump="&ref_"+u+e.dump)):(!function(e,t,n){var r,i,o,s,a,l="",c=e.tag,u=Object.keys(n);for(r=0,i=u.length;r<i;r+=1)a="",""!==l&&(a+=", "),e.condenseFlow&&(a+='"'),s=n[o=u[r]],e.replacer&&(s=e.replacer.call(n,o,s)),ur(e,t,o,!1,!1)&&(e.dump.length>1024&&(a+="? "),a+=e.dump+(e.condenseFlow?'"':"")+":"+(e.condenseFlow?"":" "),ur(e,t,s,!1,!1)&&(l+=a+=e.dump));e.tag=c,e.dump="{"+l+"}"}(e,t,e.dump),d&&(e.dump="&ref_"+u+" "+e.dump));else if("[object Array]"===l)r&&0!==e.dump.length?(e.noArrayIndent&&!s&&t>0?lr(e,t-1,e.dump,i):lr(e,t,e.dump,i),d&&(e.dump="&ref_"+u+e.dump)):(!function(e,t,n){var r,i,o,s="",a=e.tag;for(r=0,i=n.length;r<i;r+=1)o=n[r],e.replacer&&(o=e.replacer.call(n,String(r),o)),(ur(e,t,o,!1,!1)||void 0===o&&ur(e,t,null,!1,!1))&&(""!==s&&(s+=","+(e.condenseFlow?"":" ")),s+=e.dump);e.tag=a,e.dump="["+s+"]"}(e,t,e.dump),d&&(e.dump="&ref_"+u+" "+e.dump));else{if("[object String]"!==l){if("[object Undefined]"===l)return!1;if(e.skipInvalid)return!1;throw new yt("unacceptable kind of an object to dump "+l)}"?"!==e.tag&&ir(e,e.dump,t,o,c)}null!==e.tag&&"?"!==e.tag&&(a=encodeURI("!"===e.tag[0]?e.tag.slice(1):e.tag).replace(/!/g,"%21"),a="!"===e.tag[0]?"!"+a:"tag:yaml.org,2002:"===a.slice(0,18)?"!!"+a.slice(18):"!<"+a+">",e.dump=a+" "+e.dump)}return!0}function dr(e,t){var n,r,i=[],o=[];for(pr(e,i,o),n=0,r=o.length;n<r;n+=1)t.duplicates.push(i[o[n]]);t.usedDuplicates=new Array(r)}function pr(e,t,n){var r,i,o;if(null!==e&&"object"==typeof e)if(-1!==(i=t.indexOf(e)))-1===n.indexOf(i)&&n.push(i);else if(t.push(e),Array.isArray(e))for(i=0,o=e.length;i<o;i+=1)pr(e[i],t,n);else for(i=0,o=(r=Object.keys(e)).length;i<o;i+=1)pr(e[r[i]],t,n)}function fr(e,t){return function(){throw new Error("Function yaml."+e+" is removed in js-yaml 4. Use yaml."+t+" instead, which is now safe by default.")}}var hr=_n.load,mr={dump:function(e,t){var n=new Bn(t=t||{});n.noRefs||dr(e,n);var r=e;return n.replacer&&(r=n.replacer.call({"":r},"",r)),ur(n,0,r,!0,!0)?n.dump+"\n":""}}.dump;fr("safeLoad","load"),fr("safeLoadAll","loadAll"),fr("safeDump","dump");var gr,vr,xr=n(16093),br=n(10453),yr=n(87152),jr=n(31787),wr=n(80458);const Cr=[{label:"Yaml",value:"yaml"}],Ir=e=>{let{onClose:t}=e;const[n,r]=(0,i.useState)("yaml"),{setValue:o}=(0,v.Gc)(),s=(0,u.wW)(Rr);return(0,p.jsx)(xr.d,{title:"Inspect Alert rule",subtitle:(0,p.jsx)("div",{className:s.subtitle,children:(0,p.jsx)(kr,{setActiveTab:r,activeTab:n})}),onClose:t,children:"yaml"===n&&(0,p.jsx)(Ar,{onSubmit:e=>{for(const t in e)o(t,e[t]);t()}})})},kr=e=>{let{activeTab:t,setActiveTab:n}=e;return(0,p.jsx)(br.J,{children:Cr.map(((e,r)=>(0,p.jsx)(yr.O,{label:e.label,value:e.value,onChangeTab:()=>n(e.value),active:t===e.value},`${e.value}-${r}`)))})},Ar=e=>{let{onSubmit:t}=e;const n=(0,u.wW)(Nr),{getValues:r}=(0,v.Gc)(),o=(0,O.yh)(r()),[s,a]=(0,i.useState)(mr(o));return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)("div",{className:n.applyButton,children:[(0,p.jsx)(d.zx,{type:"button",onClick:()=>{const e=hr(s),n=r(),i=function(e){if((0,wr.cG)(e))return(0,O.WL)(e);if((0,wr.yF)(e))return(0,O.lN)(e);return{}}(e);t(Object.assign({},n,i))},children:"Apply"}),gr||(gr=(0,p.jsx)(Ce.u,{content:(0,p.jsx)(Sr,{}),theme:"info",placement:"left-start",interactive:!0,children:(0,p.jsx)(Ie.J,{name:"exclamation-triangle",size:"xl"})}))]}),(0,p.jsx)("div",{className:n.content,children:(0,p.jsx)(ie.Z,{disableWidth:!0,children:e=>{let{height:t}=e;return(0,p.jsx)(jr.p,{width:"100%",height:t,language:"yaml",value:s,onBlur:a,monacoOptions:{minimap:{enabled:!1}}})}})})]})};function Sr(){return vr||(vr=(0,p.jsxs)("div",{children:["The YAML content in the editor only contains alert rule configuration ",(0,p.jsx)("br",{}),"To configure Prometheus, you need to provide the rest of the"," ",(0,p.jsx)("a",{href:"https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/",target:"_blank",rel:"noreferrer",children:"configuration file content."})]}))}const Nr=e=>({content:l.css`
    flex-grow: 1;
    height: 100%;
    padding-bottom: 16px;
    margin-bottom: ${e.spacing(2)};
  `,applyButton:l.css`
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    flex-grow: 0;
    margin-bottom: ${e.spacing(2)};
  `}),Rr=()=>({subtitle:l.css`
    display: flex;
    align-items: center;
    justify-content: space-between;
  `});var Tr=n(25004),Or=n(65737),$r=n(28774),qr=n(39498),Er=n(54316),Fr=n(76961);var Lr,Mr,Ur,Dr=n(18304),_r=n(22587);function Wr(e){let{preview:t}=e;const n=(0,u.wW)(Qr),r=function(e){var t,n;let{fields:r}=e;const i=r.filter((e=>!["State","Info"].includes(e.name))),o=r.findIndex((e=>"State"===e.name)),s=r.findIndex((e=>"Info"===e.name)),a=i.map((e=>r.indexOf(e))),l=null!==(t=null===(n=r[o])||void 0===n?void 0:n.values.length)&&void 0!==t?t:0,c=[];for(let e=0;e<l;e++){var u,d,p,f;const t=a.map((t=>[r[t].name,r[t].values.get(e)])),n=null===(u=r[o])||void 0===u||null===(d=u.values)||void 0===d?void 0:d.get(e),i=null===(p=r[s])||void 0===p||null===(f=p.values)||void 0===f?void 0:f.get(e);(0,_r.Yb)(n)&&c.push({state:n,info:i,labels:Object.fromEntries(t)})}return{instances:c}}(t);return(0,p.jsxs)("table",{className:n.table,children:[Lr||(Lr=(0,p.jsxs)("caption",{children:[(0,p.jsx)("div",{children:"Alerts preview"}),(0,p.jsx)("span",{children:"Preview based on the result of running the query for this moment."})]})),Mr||(Mr=(0,p.jsx)("thead",{children:(0,p.jsxs)("tr",{children:[(0,p.jsx)("th",{children:"State"}),(0,p.jsx)("th",{children:"Labels"}),(0,p.jsx)("th",{children:"Info"})]})})),(0,p.jsx)("tbody",{children:r.instances.map(((e,t)=>{let{state:r,info:i,labels:o}=e;const s=function(e){return Object.entries(e).map((e=>{let[t,n]=e;return`${t}=${n}`})).sort()}(o);return(0,p.jsxs)("tr",{children:[(0,p.jsx)("td",{children:(0,p.jsx)(Dr.l,{state:r})}),(0,p.jsx)("td",{children:(0,p.jsx)(Fr.P,{tags:s,className:n.tagList})}),(0,p.jsx)("td",{children:i&&(0,p.jsx)(Ce.u,{content:i,children:Ur||(Ur=(0,p.jsx)(Ie.J,{name:"info-circle"}))})})]},t)}))})]})}const Qr=e=>({table:l.css`
    width: 100%;
    margin: ${e.spacing(2,0)};

    caption {
      caption-side: top;
      color: ${e.colors.text.primary};

      & > span {
        font-size: ${e.typography.bodySmall.fontSize};
        color: ${e.colors.text.secondary};
      }
    }

    td,
    th {
      padding: ${e.spacing(1,1)};
    }

    td + td,
    th + th {
      padding-left: ${e.spacing(3)};
    }

    thead th {
      &:nth-child(1) {
        width: 80px;
      }

      &:nth-child(2) {
        width: auto;
      }

      &:nth-child(3) {
        width: 40px;
      }
    }

    td:nth-child(3) {
      text-align: center;
    }

    tbody tr:nth-child(2n + 1) {
      background-color: ${e.colors.background.secondary};
    }
  `,tagList:l.css`
    justify-content: flex-start;
  `}),Pr=e=>{var t,n,r,s;let{value:a,onChange:l,dataSourceName:f}=e;const h=(0,u.wW)(Gr),{mapToValue:m,mapToQuery:g}=function(e){return(0,i.useMemo)((()=>{const t=(0,Q.F)().getInstanceSettings(e);switch(null==t?void 0:t.type){case"loki":case"prometheus":return{mapToValue:e=>e.expr,mapToQuery:(e,t)=>Object.assign({},e,{expr:t})};default:throw new Error(`${e} is not supported as an expression editor`)}}),[e])}(f),v=g({refId:"A",hide:!1},a),{error:x,loading:b,value:y}=(0,o.Z)((()=>(0,Q.F)().get(f)),[f]),j=(0,i.useCallback)((e=>{l(m(e))}),[l,m]),[w,C]=pe();if(b||(null==y?void 0:y.name)!==f)return null;const I=(0,Q.F)().getInstanceSettings(f);if(x||!y||null==y||null===(t=y.components)||void 0===t||!t.QueryEditor||!I){const e=(null==x?void 0:x.message)||"Data source plugin does not export any Query Editor component";return(0,p.jsxs)("div",{children:["Could not load query editor due to: ",e]})}const k=(null==w?void 0:w.data.state)===W.Gu.Done,A=null==y||null===(n=y.components)||void 0===n?void 0:n.QueryEditor,S=null==w||null===(r=w.data)||void 0===r||null===(s=r.series)||void 0===s?void 0:s.find((e=>"evaluation results"===e.name)),N=S&&S.fields.some((e=>e.values.length>0));return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(qr.n,{instanceSettings:I,children:(0,p.jsx)(A,{query:v,queries:[v],app:Er.zj.CloudAlerting,onChange:j,onRunQuery:qe.noop,datasource:y})}),(0,p.jsxs)("div",{className:h.preview,children:[(0,p.jsx)(d.zx,{type:"button",onClick:async()=>{C()},disabled:(null==w?void 0:w.data.state)===W.Gu.Loading,children:"Preview alerts"}),k&&!N&&(0,p.jsx)(c.b,{title:"Alerts preview",severity:"info",className:h.previewAlert,children:"There are no firing alerts for your query."}),N&&(0,p.jsx)(Wr,{preview:S})]})]})},Gr=e=>({preview:l.css`
    padding: ${e.spacing(2,0)};
    max-width: ${e.breakpoints.values.xl}px;
  `,previewAlert:l.css`
    margin: ${e.spacing(1,0)};
  `});var zr=n(13910),Vr=n(23734),Zr=n(45570),Br=n(30296),Yr=n(55136),Hr=n(15055),Jr=n(73410),Kr=n(75928);const Xr=()=>(0,p.jsx)("span",{className:l.css`
      flex: 1;
    `});var ei,ti=n(64313);const ni=e=>{let{enabled:t=!1,error:n,warning:r,onSetCondition:i}=e;const o=(0,u.wW)(ri);return t&&n?(0,p.jsx)(ti.C,{color:"red",icon:"exclamation-circle",text:"Alert condition",tooltip:n.message}):t&&r?(0,p.jsx)(ti.C,{color:"orange",icon:"exclamation-triangle",text:"Alert condition",tooltip:r.message}):!t||n||r?t?null:(0,p.jsx)("div",{className:o.actionLink,onClick:()=>i(),children:"Make this the alert condition"}):ei||(ei=(0,p.jsx)(ti.C,{color:"green",icon:"check",text:"Alert condition"}))},ri=e=>({actionLink:l.css`
    color: ${e.colors.text.link};
    cursor: pointer;

    &:hover {
      text-decoration: underline;
    }
  `});var ii=n(95369);const oi=e=>{var t;const n=null===(t=e.fields[0])||void 0===t?void 0:t.values.get(0);return Number.isFinite(n)?(0,ii.O)(n,5):n},si=e=>Object.entries(e).map((e=>{let[t,n]=e;return t+"="+n})).join(", ");var ai,li,ci,ui;const di=e=>{var t;let{queries:n=[],query:r,data:o,error:s,warning:a,isAlertCondition:c,onSetCondition:d,onUpdateRefId:f,onRemoveExpression:h,onUpdateExpressionType:m,onChangeQuery:g}=e;const v=(0,u.wW)(gi),x=null==r?void 0:r.type,b=o&&Object.values(o).some((e=>Boolean(e)&&e.state===W.Gu.Loading)),y=Array.isArray(null==o?void 0:o.series)&&!b,j=null!==(t=null==o?void 0:o.series)&&void 0!==t?t:[],w=y&&(e=>e.every((e=>e.fields.every((e=>e.values.toArray().every((e=>null==e)))))))(j),C=!w&&(0,Ne.hZ)(j),I=null!=c&&c,k=c&&y,A={[_r.x_.Firing]:j.filter((e=>oi(e)>=1)),[_r.x_.Inactive]:j.filter((e=>oi(e)<1))},S=(0,i.useCallback)((e=>{const t=n.filter((t=>e.refId!==t.refId)).map((e=>({value:e.refId,label:e.refId})));switch(e.type){case $e.Us.math:return(0,p.jsx)(Br.Z,{onChange:g,query:e,labelWidth:"auto",onRunQuery:()=>{}});case $e.Us.reduce:return(0,p.jsx)(Yr.v,{onChange:g,refIds:t,labelWidth:"auto",query:e});case $e.Us.resample:return(0,p.jsx)(Hr.p,{onChange:g,query:e,labelWidth:"auto",refIds:t});case $e.Us.classic:return(0,p.jsx)(Zr.I,{onChange:g,query:e,refIds:t});case $e.Us.threshold:return(0,p.jsx)(Jr.M,{onChange:g,query:e,labelWidth:"auto",refIds:t});default:return(0,p.jsxs)(p.Fragment,{children:["Expression not supported: ",e.type]})}}),[g,n]);return(0,p.jsx)("div",{className:(0,l.cx)(v.expression.wrapper,I&&v.expression.alertCondition),children:(0,p.jsxs)("div",{className:v.expression.stack,children:[(0,p.jsx)(fi,{refId:r.refId,queryType:x,onRemoveExpression:()=>h(r.refId),onUpdateRefId:e=>f(r.refId,e),onUpdateExpressionType:e=>m(r.refId,e)}),(0,p.jsx)("div",{className:v.expression.body,children:S(r)}),y&&(0,p.jsxs)("div",{className:v.expression.results,children:[!w&&C&&(0,p.jsx)("div",{children:j.map(((e,t)=>(0,p.jsx)(mi,{frame:e,index:t,isAlertCondition:c},(0,qe.uniqueId)())))}),!w&&!C&&j.map(((e,t)=>(0,p.jsx)(hi,{frame:e,index:t,isAlertCondition:I},(0,qe.uniqueId)()))),w&&(0,p.jsx)("div",{className:(0,l.cx)(v.expression.noData,v.mutedText),children:"No data"})]}),(0,p.jsx)("div",{className:v.footer,children:(0,p.jsxs)(je.Stack,{direction:"row",alignItems:"center",children:[(0,p.jsx)(ni,{onSetCondition:()=>d(r.refId),enabled:I,error:s,warning:a}),ai||(ai=(0,p.jsx)(Xr,{})),k&&(0,p.jsx)(pi,{firing:A[_r.x_.Firing].length,normal:A[_r.x_.Inactive].length})]})})]})})},pi=e=>{let{firing:t,normal:n}=e;const{mutedText:r}=(0,u.wW)(gi);return(0,p.jsx)("span",{className:r,children:`${t} firing, ${n} normal`})},fi=e=>{let{refId:t,queryType:n,onUpdateRefId:r,onUpdateExpressionType:o,onRemoveExpression:s}=e;const a=(0,u.wW)(gi),[l,c]=(0,i.useState)(!1),d=!1!==l,f=d&&"refId"===l,h=d&&"expressionType"===l,m=$e._M.find((e=>e.value===n));return(0,p.jsx)("header",{className:a.header.wrapper,children:(0,p.jsxs)(je.Stack,{direction:"row",gap:.5,alignItems:"center",children:[(0,p.jsxs)(je.Stack,{direction:"row",gap:1,alignItems:"center",wrap:!1,children:[!f&&(0,p.jsx)("div",{className:a.editable,onClick:()=>c("refId"),children:(0,p.jsx)("div",{className:a.expression.refId,children:t})}),f&&(0,p.jsx)(zr.H,{autoFocus:!0,defaultValue:t,minWidth:5,onChange:e=>{r(e.currentTarget.value),c(!1)},onFocus:e=>e.target.select(),onBlur:e=>{r(e.currentTarget.value),c(!1)}}),!h&&(0,p.jsxs)("div",{className:a.editable,onClick:()=>c("expressionType"),children:[(0,p.jsx)("div",{className:a.mutedText,children:(0,qe.capitalize)(n)}),(0,p.jsx)(Ie.J,{size:"xs",name:"pen",className:a.mutedIcon,onClick:()=>c("expressionType")})]}),h&&(0,p.jsx)(L.Ph,{isOpen:!0,autoFocus:!0,onChange:e=>{var t;o(null!==(t=e.value)&&void 0!==t?t:$e.Us.classic),c(!1)},onBlur:()=>{c(!1)},options:$e._M,value:m,width:25})]}),li||(li=(0,p.jsx)(Xr,{})),(0,p.jsx)(Vr.h,{type:"button",name:"trash-alt",variant:"secondary",className:a.mutedIcon,onClick:s})]})})},hi=e=>{let{frame:t,index:n,isAlertCondition:r}=e;const i=(0,u.wW)(gi),o=(e=>{var t,n,r;return null!==(t=e.name)&&void 0!==t?t:si(null!==(n=null===(r=e.fields[0])||void 0===r?void 0:r.labels)&&void 0!==n?n:{})})(t)||"Series "+n,s=oi(t),a=r&&0!==s,c=r&&0===s;return(0,p.jsx)("div",{className:i.expression.resultsRow,children:(0,p.jsxs)(je.Stack,{direction:"row",gap:1,alignItems:"center",children:[(0,p.jsx)("span",{className:(0,l.cx)(i.mutedText,i.expression.resultLabel),title:o,children:o}),(0,p.jsx)("div",{className:i.expression.resultValue,children:s}),a&&(0,p.jsx)(Dr.l,{state:_r.x_.Firing,size:"sm"}),c&&(0,p.jsx)(Dr.l,{state:_r.x_.Inactive,size:"sm"})]})})},mi=e=>{var t;let{frame:n,index:r}=e;const i=(0,u.wW)(gi),o=n.fields[1].labels?si(null!==(t=n.fields[1].labels)&&void 0!==t?t:{}):"Series "+r,s=n.fields[0].values.toArray(),a=e=>n.fields[0].values.get(e),c=e=>n.fields[1].values.get(e);return(0,p.jsx)("div",{className:i.expression.resultsRow,children:(0,p.jsxs)(je.Stack,{direction:"row",gap:1,alignItems:"center",children:[(0,p.jsx)("span",{className:(0,l.cx)(i.mutedText,i.expression.resultLabel),title:o,children:o}),(0,p.jsx)("div",{className:i.expression.resultValue,children:(0,p.jsx)(Kr.z,{placement:"right",wrapperClassName:i.timeseriesTableWrapper,content:(0,p.jsxs)("table",{className:i.timeseriesTable,children:[ci||(ci=(0,p.jsx)("thead",{children:(0,p.jsxs)("tr",{children:[(0,p.jsx)("th",{children:"Timestamp"}),(0,p.jsx)("th",{children:"Value"})]})})),(0,p.jsx)("tbody",{children:s.map(((e,t)=>(0,p.jsxs)("tr",{children:[(0,p.jsx)("td",{className:i.mutedText,children:(0,_.dq)(a(t))}),(0,p.jsx)("td",{className:i.expression.resultValue,children:c(t)})]},t)))})]}),children:ui||(ui=(0,p.jsx)("span",{children:"Time series data"}))})})]})})},gi=e=>({expression:{wrapper:l.css`
      display: flex;
      border: solid 1px ${e.colors.border.medium};

      border-radius: ${e.shape.borderRadius()};
      max-width: 640px;
    `,stack:l.css`
      display: flex;
      flex-direction: column;
      flex-wrap: nowrap;
      gap: 0;
      min-width: 0; // this one is important to prevent text overflow
    `,alertCondition:l.css``,body:l.css`
      padding: ${e.spacing(1)};
      flex: 1;
    `,refId:l.css`
      font-weight: ${e.typography.fontWeightBold};
      color: ${e.colors.primary.text};
    `,results:l.css`
      border-top: solid 1px ${e.colors.border.medium};
    `,noResults:l.css`
      display: flex;
      align-items: center;
      justify-content: center;
    `,resultsRow:l.css`
      padding: ${e.spacing(.75)} ${e.spacing(1)};

      &:nth-child(odd) {
        background-color: ${e.colors.background.secondary};
      }

      &:hover {
        background-color: ${e.colors.background.canvas};
      }
    `,resultValue:l.css`
      color: ${e.colors.text.maxContrast};
      text-align: right;
    `,resultLabel:l.css`
      flex: 1;
    `,noData:l.css`
      display: flex;
      align-items: center;
      justify-content: center;
      padding: ${e.spacing()};
    `},mutedText:l.css`
    color: ${e.colors.text.secondary};
    font-size: 0.9em;

    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  `,header:{wrapper:l.css`
      background: ${e.colors.background.secondary};
      padding: ${e.spacing(.5)} ${e.spacing(1)};
      border-bottom: solid 1px ${e.colors.border.medium};
    `},footer:l.css`
    background: ${e.colors.background.secondary};
    padding: ${e.spacing(1)};
    border-top: solid 1px ${e.colors.border.medium};
  `,draggableIcon:l.css`
    cursor: grab;
  `,mutedIcon:l.css`
    color: ${e.colors.text.secondary};
  `,editable:l.css`
    padding: ${e.spacing(.5)} ${e.spacing(1)};
    border: solid 1px ${e.colors.border.weak};
    border-radius: ${e.shape.borderRadius()};

    display: flex;
    flex-direction: row;
    align-items: center;
    gap: ${e.spacing(1)};

    cursor: pointer;
  `,timeseriesTableWrapper:l.css`
    max-height: 500px;
    max-width: 300px;

    overflow-y: scroll;

    padding: 0 !important; // not sure why but style override doesn't work otherwise :( (Gilles)
  `,timeseriesTable:l.css`
    table-layout: auto;

    width: 100%;
    height: 100%;

    td,
    th {
      padding: ${e.spacing(1)};
    }

    td {
      background: ${e.colors.background.primary};
    }

    th {
      background: ${e.colors.background.secondary};
    }

    tr {
      border-bottom: 1px solid ${e.colors.border.medium};

      &:last-of-type {
        border-bottom: none;
      }
    }
  `}),vi=e=>{let{condition:t,onSetCondition:n,queries:r,panelData:o,onUpdateRefId:s,onRemoveExpression:a,onUpdateExpressionType:l,onUpdateQueryExpression:c}=e;const u=(0,i.useMemo)((()=>r.reduce(((e,t)=>(0,Oe.j)(t.model)?e.concat(t.model):e),[])),[r]);return(0,p.jsx)(je.Stack,{direction:"row",alignItems:"stretch",children:u.map((e=>{const i=o[e.refId],u=t===e.refId,d=u&&i?Pe(i.series):void 0,f=u&&i?function(e){var t,n,r,i;const o=null===(i=(null!==(t=null===(n=e[0])||void 0===n||null===(r=n.meta)||void 0===r?void 0:r.notices)&&void 0!==t?t:[]).find((e=>"warning"===e.severity)))||void 0===i?void 0:i.text;return o?new Error(o):void 0}(i.series):void 0;return(0,p.jsx)(di,{isAlertCondition:u,data:i,error:d,warning:f,queries:r,query:e,onSetCondition:n,onRemoveExpression:a,onUpdateRefId:s,onUpdateExpressionType:l,onChangeQuery:c},e.refId)}))})};var xi=n(19677),bi=n(17690),yi=n(42833),ji=n(7567),wi=n(279),Ci=n(74846),Ii=n(27783),ki=n(2247);var Ai=n(50848);const Si=e=>{let{data:t,currentPanel:n,changePanel:r,thresholds:o,thresholdsType:s=ae.i3.Line}=e;const[a,l]=(0,i.useState)({frameIndex:0,showHeader:!0}),c=function(e,t,n){const r=(0,u.l4)();if(t===Ci.GC||t===Ci.Kd||function(e){return!(e&&e.series[0]&&e.series[0].fields[0]&&e.series[0].fields[0].values)}(e))return 200;const i=e.series[n].fields[0].values.length,o=5*r.spacing.gridSize,s=i*o+o;return s>=200?200:s}(t,n,a.frameIndex),d=(0,u.wW)(Ni(c)),[f,h]=(0,i.useState)(function(e,t){if(!e)return{defaults:{},overrides:[]};return{defaults:{thresholds:e,unit:Ri(t),custom:{thresholdsStyle:{mode:ae.i3.Line}}},overrides:[]}}(o,t));(0,i.useEffect)((()=>{h((e=>Object.assign({},e,{defaults:Object.assign({},e.defaults,{thresholds:o,unit:Ri(t),custom:Object.assign({},e.defaults.custom,{thresholdsStyle:{mode:s}})})})))}),[o,h,t,s]);const m=(0,i.useMemo)((()=>({eventBus:ki.Z,canEditThresholds:!1,showThresholds:!0})),[]);return a&&t?(0,p.jsxs)("div",{className:d.wrapper,children:[(0,p.jsx)("div",{className:d.buttonGroup,children:(0,p.jsx)(Ai.j,{onChange:r,value:n})}),(0,p.jsx)(ie.Z,{children:e=>{let{width:r}=e;return 0===r?null:(0,p.jsx)("div",{style:{height:`${c}px`,width:`${r}px`},children:(0,p.jsx)(Ii._w,{value:m,children:(0,p.jsx)(se.$,{height:c,width:r,data:t,pluginId:n,title:"title",onOptionsChange:l,options:a,fieldConfig:f})})})}})]}):null},Ni=e=>t=>({wrapper:l.css`
    padding: 0 ${t.spacing(2)};
    height: ${e+4*t.spacing.gridSize}px;
  `,buttonGroup:l.css`
    display: flex;
    justify-content: flex-end;
  `});function Ri(e){var t,n;return null===(t=e.series[0])||void 0===t||null===(n=t.fields.find((e=>"number"===e.type)))||void 0===n?void 0:n.config.unit}const Ti=e=>{var t,n;let{data:r,error:o,dsSettings:s,index:a,onChangeDataSource:l,onChangeQuery:c,onChangeTimeRange:d,onRunQueries:f,onRemoveQuery:h,onDuplicateQuery:m,query:g,queries:v,thresholds:x,thresholdsType:b,onChangeThreshold:y,condition:j,onSetCondition:w}=e;const C=(0,u.wW)($i),I=(0,Oe.j)(g.model),[k,A]=(0,i.useState)(I?Ci.Fe:Ci.GC);function S(){const e=(0,u.wW)($i);return(0,p.jsx)("div",{className:e.dsTooltip,children:(0,p.jsx)(Ce.u,{content:(0,p.jsx)(p.Fragment,{children:"Not finding the data source you want? Some data sources are not supported for alerting. Click on the icon for more information."}),children:(0,p.jsx)(Ie.J,{name:"info-circle",onClick:()=>window.open(" https://grafana.com/docs/grafana/latest/alerting/fundamentals/data-source-alerting/","_blank")})})})}function N(e){let{query:n,error:r,index:i}=e;return(0,Oe.j)(n.model)?null:(0,p.jsxs)(je.Stack,{direction:"row",alignItems:"center",gap:1,children:[t||(t=(0,p.jsx)(S,{})),d&&(0,p.jsx)(ji.x,{timeRange:null!==(o=n.relativeTimeRange)&&void 0!==o?o:(0,Y.Rr)(),onChange:e=>d(e,i)}),(0,p.jsx)(ni,{onSetCondition:()=>w(n.refId),enabled:j===n.refId,error:r})]});var o}return(0,p.jsx)("div",{className:C.wrapper,children:(0,p.jsx)(wi.x,{alerting:!0,dataSource:s,onChangeDataSource:I?void 0:e=>l(e,a),id:g.refId,index:a,data:r,query:(0,qe.cloneDeep)(g.model),onChange:e=>c(e,a),onRemoveQuery:h,onAddQuery:()=>m((0,qe.cloneDeep)(g)),onRunQuery:f,queries:v,renderHeaderExtras:()=>n||(n=(0,p.jsx)(N,{query:g,index:a,error:o})),app:Er.zj.UnifiedAlerting,visualization:r.state!==W.Gu.NotStarted?(0,p.jsx)(Si,{data:r,changePanel:A,currentPanel:k,thresholds:x,thresholdsType:b,onThresholdsChange:y?e=>y(e,a):void 0}):null,hideDisableQuery:!0},g.refId)})},Oi=e=>{let{children:t}=e;const n=(0,u.wW)($i);return(0,p.jsx)("div",{className:n.wrapper,children:t})},$i=e=>({wrapper:l.css`
    label: AlertingQueryWrapper;
    margin-bottom: ${e.spacing(1)};
    border: 1px solid ${e.colors.border.medium};
    border-radius: ${e.shape.borderRadius(1)};
  `,dsTooltip:l.css`
    display: flex;
    align-items: center;
    &:hover {
      opacity: 0.85;
      cursor: pointer;
    }
  `});var qi,Ei,Fi;function Li(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Mi extends i.PureComponent{constructor(e){super(e),Li(this,"onRemoveQuery",(e=>{const{queries:t,onQueriesChange:n}=this.props;n(t.filter((t=>t.refId!==e.refId)))})),Li(this,"onChangeTimeRange",((e,t)=>{const{queries:n,onQueriesChange:r}=this.props;r(n.map(((n,r)=>r!==t?n:Object.assign({},n,{relativeTimeRange:e}))))})),Li(this,"onChangeDataSource",((e,t)=>{const{queries:n,onQueriesChange:r}=this.props,i=n.map(((n,r)=>{if(r!==t)return n;const i=this.getDataSourceSettings(n);return e.type===(null==i?void 0:i.type)?function(e,t){return Object.assign({},e,{model:Object.assign({},(0,qe.omit)(e.model,"datasource"),{datasource:{type:t.type,uid:t.uid}}),datasourceUid:t.uid})}(n,e):function(e,t){return{refId:e.refId,relativeTimeRange:e.relativeTimeRange,queryType:"",datasourceUid:t.uid,model:{refId:e.refId,hide:!1,datasource:{type:t.type,uid:t.uid}}}}(n,e)}));r(i)})),Li(this,"onChangeQuery",((e,t)=>{const{queries:n,onQueriesChange:r}=this.props;r(n.map(((n,r)=>{var i;return r!==t?n:Object.assign({},n,{refId:e.refId,queryType:null!==(i=n.model.queryType)&&void 0!==i?i:"",model:Object.assign({},n.model,e,{datasource:e.datasource})})})))})),Li(this,"onDragEnd",(e=>{const{queries:t,onQueriesChange:n}=this.props;if(!e||!e.destination)return;const r=e.source.index,i=e.destination.index;if(r===i)return;const o=Array.from(t),[s]=o.splice(r,1);o.splice(i,0,s),n(o)})),Li(this,"getDataSourceSettings",(e=>(0,Q.F)().getInstanceSettings(e.datasourceUid)))}render(){const{queries:e,expressions:t}=this.props,n=function(e){const t={},n=[$e.Us.threshold,$e.Us.classic];for(const o of e){if(!(0,Oe.j)(o.model))continue;if(!n.includes(o.model.type))continue;if(!Array.isArray(o.model.conditions))continue;const s=o.model.conditions.some(Ge);o.model.conditions.forEach(((n,a)=>{var l;const c=n.evaluator.params,u=null!==(l=n.query.params[0])&&void 0!==l?l:o.model.expression,d=Ge(n);try{const o=Le(e),a=Me(u,o),l=e.filter((e=>a.includes(e.refId)));l.forEach((e=>{const o=e.refId,a=!(0,Oe.j)(null==e?void 0:e.model),l=Boolean(a&&o);o&&!t[o]&&(t[o]={config:{mode:Se.H.Absolute,steps:[]},mode:ae.i3.Line}),o&&l&&!d&&!s?r(o,c[0]):o&&l&&d&&(i(o,c,n.evaluator.type),t[o].mode=ae.i3.LineAndArea)}))}catch(e){return void console.error("Failed to parse thresholds",e)}}))}function r(e,n){t[e].config.steps.push({value:-1/0,color:"transparent"},{value:n,color:Re.vc.theme2.colors.error.main})}function i(e,n,r){r===Te.$.IsWithinRange&&t[e].config.steps.push({value:-1/0,color:"transparent"},{value:n[0],color:Re.vc.theme2.colors.error.main},{value:n[1],color:Re.vc.theme2.colors.error.main},{value:n[1],color:"transparent"}),r===Te.$.IsOutsideRange&&t[e].config.steps.push({value:-1/0,color:Re.vc.theme2.colors.error.main},{value:n[0],color:Re.vc.theme2.colors.error.main},{value:n[0],color:"transparent"},{value:n[1],color:Re.vc.theme2.colors.error.main}),t[e].config.steps.sort(((e,t)=>e.value-t.value))}return t}([...e,...t]);return(0,p.jsx)(xi.Z5,{onDragEnd:this.onDragEnd,children:(0,p.jsx)(xi.bK,{droppableId:"alerting-queries",direction:"vertical",children:t=>(0,p.jsxs)("div",Object.assign({ref:t.innerRef},t.droppableProps,{children:[e.map(((t,r)=>{var i,o,s,a;const l=null!==(i=null===(o=this.props.data)||void 0===o?void 0:o[t.refId])&&void 0!==i?i:{series:[],state:W.Gu.NotStarted},c=this.getDataSourceSettings(t),u=this.props.condition===t.refId?Pe(l.series):void 0;return c?(0,p.jsx)(Ti,{index:r,dsSettings:c,data:l,error:u,query:t,onChangeQuery:this.onChangeQuery,onRemoveQuery:this.onRemoveQuery,queries:e,onChangeDataSource:this.onChangeDataSource,onDuplicateQuery:this.props.onDuplicateQuery,onChangeTimeRange:this.onChangeTimeRange,thresholds:null===(s=n[t.refId])||void 0===s?void 0:s.config,thresholdsType:null===(a=n[t.refId])||void 0===a?void 0:a.mode,onRunQueries:this.props.onRunQueries,condition:this.props.condition,onSetCondition:this.props.onSetCondition},t.refId):(0,p.jsx)(Ui,{index:r,model:t.model,onUpdateDatasource:()=>{const e=(0,yi.ak)().getInstanceSettings(null);e&&this.onChangeDataSource(e,r)},onRemoveQuery:()=>{this.onRemoveQuery(t)}},`${t.refId}-${r}`)})),t.placeholder]}))})})}}const Ui=e=>{let{index:t,onUpdateDatasource:n,onRemoveQuery:r,model:o}=e;const s=o.refId,[a,l]=(0,i.useState)(!1);return(0,p.jsx)(Oi,{children:(0,p.jsxs)(bi.t,{title:s,draggable:!0,index:t,id:s,isOpen:!0,children:[(0,p.jsxs)(dt.Z,{children:[qi||(qi=(0,p.jsx)(dt.Z.Heading,{children:"This datasource has been removed"})),Ei||(Ei=(0,p.jsx)(dt.Z.Description,{children:"The datasource for this query was not found, it was either removed or is not installed correctly."})),Fi||(Fi=(0,p.jsx)(dt.Z.Figure,{children:(0,p.jsx)(Ie.J,{name:"question-circle"})})),(0,p.jsxs)(dt.Z.Actions,{children:[(0,p.jsx)(d.zx,{variant:"secondary",onClick:()=>{n()},children:"Update datasource"},"update"),(0,p.jsx)(d.zx,{variant:"destructive",onClick:r,children:"Remove query"},"remove")]}),(0,p.jsx)(dt.Z.SecondaryActions,{children:(0,p.jsx)(d.zx,{onClick:()=>{l((e=>!e))},icon:a?"angle-up":"angle-down",fill:"text",size:"sm",children:"Show details"},"details")})]}),a&&(0,p.jsx)("div",{children:(0,p.jsx)("pre",{children:(0,p.jsx)("code",{children:JSON.stringify(o,null,2)})})})]})})},Di=e=>{let{queries:t,expressions:n,panelData:r,onRunQueries:i,onChangeQueries:o,onDuplicateQuery:s,condition:a,onSetCondition:l}=e;const c=(0,u.wW)(_i);return(0,p.jsx)("div",{className:c.container,children:(0,p.jsx)(Mi,{data:r,queries:t,expressions:n,onRunQueries:i,onQueriesChange:o,onDuplicateQuery:s,condition:a,onSetCondition:l})})},_i=e=>({container:l.css`
    background-color: ${e.colors.background.primary};
    height: 100%;
    max-width: ${e.breakpoints.values.xxl}px;
  `});var Wi=n(94570),Qi=n(63454);function Pi(){const e=(0,S._)((e=>e.dataSources));return Object.values(e).map((e=>e.result)).filter((e=>Boolean(null==e?void 0:e.rulerConfig))).map((e=>(0,K.c$)(e.name))).filter((e=>Boolean(e)))}const Gi=["value"];function zi(e){let{value:t}=e,n=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,Gi);const r=Pi(),{loading:s=!0}=(0,o.Z)((()=>(0,Qi.WI)((0,N.dV)())),[Qi.WI]),a=(0,i.useCallback)((e=>!!r.find((t=>{let{id:n}=t;return n===e.id}))),[r]);return(0,p.jsx)(Wi.q,Object.assign({disabled:s,isLoading:s,noDefault:!0,alerting:!0,filter:a,current:t},n))}const Vi=e=>{const{name:t,description:n,image:r,selected:i=!1,value:o,onClick:s,disabled:a=!1}=e,c=(0,u.wW)(Zi),d=(0,l.cx)({[c.wrapper]:!0,[c.disabled]:a});return(0,p.jsxs)(dt.Z,{className:d,isSelected:i,onClick:()=>s(o),disabled:a,children:[(0,p.jsx)(dt.Z.Figure,{children:(0,p.jsx)("img",{src:r,alt:""})}),(0,p.jsx)(dt.Z.Heading,{children:t}),(0,p.jsx)(dt.Z.Description,{children:n})]})},Zi=e=>({wrapper:l.css`
    width: 380px;
    cursor: pointer;
    user-select: none;
  `,disabled:l.css`
    opacity: 0.5;
  `});var Bi;const Yi=e=>{let{selected:t=!1,disabled:n,onClick:r}=e;return(0,p.jsx)(Vi,{name:"Grafana managed alert",description:Bi||(Bi=(0,p.jsxs)("span",{children:["Supports multiple data sources of any kind.",(0,p.jsx)("br",{}),"Transform data with expressions."]})),image:"public/img/grafana_icon.svg",selected:t,disabled:n,value:R.$.grafana,onClick:r})},Hi=e=>{let{children:t,visible:n=!1}=e;return n?(0,p.jsx)(Ce.u,{content:"You do not appear to have any compatible datasources.",placement:"top",children:(0,p.jsx)("div",{children:t})}):(0,p.jsx)(p.Fragment,{children:t})};var Ji;const Ki=e=>{let{selected:t=!1,disabled:n=!1,onClick:r}=e;return(0,p.jsx)(Hi,{visible:n,children:(0,p.jsx)(Vi,{name:"Mimir or Loki alert",description:Ji||(Ji=(0,p.jsxs)("span",{children:["Use a Mimir, Loki or Cortex datasource.",(0,p.jsx)("br",{}),"Expressions are not supported."]})),image:"public/img/alerting/mimir_logo.svg",selected:t,disabled:n,value:R.$.cloudAlerting,onClick:r})})};var Xi;const eo=e=>{let{selected:t=!1,disabled:n=!1,onClick:r}=e;return(0,p.jsx)(Hi,{visible:n,children:(0,p.jsx)(Vi,{name:"Mimir or Loki recording rule",description:Xi||(Xi=(0,p.jsxs)("span",{children:["Precompute expressions.",(0,p.jsx)("br",{}),"Should be combined with an alert rule."]})),image:"public/img/alerting/mimir_logo_recording.svg",selected:t,disabled:n,value:R.$.cloudRecording,onClick:r})})},to=e=>{let{selected:t,onChange:n,enabledTypes:r}=e;const o=Pi(),s=!(0,qe.isEmpty)(o);(0,i.useEffect)((()=>{(0,Qi.WI)((0,N.dV)())}),[]);const a=(0,u.wW)(no);return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)(je.Stack,{direction:"row",gap:2,children:[r.includes(R.$.grafana)&&(0,p.jsx)(Yi,{selected:t===R.$.grafana,onClick:n}),r.includes(R.$.cloudAlerting)&&(0,p.jsx)(Ki,{selected:t===R.$.cloudAlerting,onClick:n,disabled:!s}),r.includes(R.$.cloudRecording)&&(0,p.jsx)(eo,{selected:t===R.$.cloudRecording,onClick:n,disabled:!s})]}),r.includes(R.$.grafana)&&(0,p.jsx)("small",{className:a.meta,children:"Select â€œGrafana managedâ€ unless you have a Mimir, Loki or Cortex data source with the Ruler API enabled."})]})},no=e=>({meta:l.css`
    color: ${e.colors.text.disabled};
  `}),ro=["onChange","ref"];const io=e=>{var t,n,r,i;let{editingExistingRule:o}=e;const{enabledRuleTypes:s,defaultRuleType:l}=function(){const e=ke.Vt.hasAccess(a.bW.AlertingRuleCreate,ke.Vt.hasEditPermissionInFolders),t=ke.Vt.hasAccess(a.bW.AlertingRuleExternalWrite,ke.Vt.isEditor),n=e?R.$.grafana:R.$.cloudAlerting,r=[];e&&r.push(R.$.grafana);t&&r.push(R.$.cloudAlerting,R.$.cloudRecording);return{enabledRuleTypes:r,defaultRuleType:n}}(),{control:c,formState:{errors:d},getValues:f,setValue:h,watch:m}=(0,v.Gc)(),g=(0,u.wW)(oo),x=m("type");return(0,p.jsxs)(p.Fragment,{children:[!o&&(0,p.jsx)(q.g,{error:null===(t=d.type)||void 0===t?void 0:t.message,invalid:!(null===(n=d.type)||void 0===n||!n.message),"data-testid":"alert-type-picker",children:(0,p.jsx)(F.g,{render:e=>{var t;let{field:{onChange:n}}=e;return(0,p.jsx)(to,{"aria-label":"Rule type",selected:null!==(t=f("type"))&&void 0!==t?t:l,onChange:n,enabledTypes:s})},name:"type",control:c,rules:{required:{value:!0,message:"Please select alert type"}}})}),(0,p.jsx)("div",{className:g.flexRow,children:(x===R.$.cloudRecording||x===R.$.cloudAlerting)&&(0,p.jsx)(q.g,{className:g.formInput,label:"Select data source",error:null===(r=d.dataSourceName)||void 0===r?void 0:r.message,invalid:!(null===(i=d.dataSourceName)||void 0===i||!i.message),"data-testid":"datasource-picker",children:(0,p.jsx)(F.g,{render:e=>{let{field:{onChange:t}}=e,n=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e.field,ro);return(0,p.jsx)(zi,Object.assign({},n,{onChange:e=>{var n;h("location",void 0),t(null!==(n=null==e?void 0:e.name)&&void 0!==n?n:null)}}))},name:"dataSourceName",control:c,rules:{required:{value:!0,message:"Please select a data source"}}})})})]})};const oo=e=>({formInput:l.css`
    width: 330px;
    & + & {
      margin-left: ${e.spacing(3)};
    }
  `,flexRow:l.css`
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: flex-end;
  `});var so=n(23067),ao=n(52253),lo=n(91018);const co=(e,t)=>{if((e=>{try{return JSON.stringify(e),!1}catch(e){return!0}})(e))return null;if(t.datasourceUid!==lo.Yq)return t;{const n=e.find((e=>e.refId===t.model.expression));return n?co(e,n):null}};var uo=n(65169);const po=(e,t)=>{const n=e.find((e=>e.refId===t));return n&&co(e,n)},fo=(0,so.PH)("duplicateQuery"),ho=(0,so.PH)("addNewDataQuery"),mo=(0,so.PH)("setDataQueries"),go=(0,so.PH)("addNewExpression"),vo=(0,so.PH)("removeExpression"),xo=(0,so.PH)("updateExpression"),bo=(0,so.PH)("updateExpressionRefId"),yo=(0,so.PH)("rewireExpressions"),jo=(0,so.PH)("updateExpressionType"),wo=(0,so.PH)("updateExpressionTimeRange"),Co=(0,so.Lq)({queries:[]},(e=>{e.addCase(fo,((e,t)=>{let{payload:n}=t;e.queries=Io(e.queries,n)})).addCase(ho,(e=>{const t=(0,K.P)();t&&(e.queries=Io(e.queries,{datasourceUid:t.uid,model:{refId:"",datasource:{type:t.type,uid:t.uid}}}))})).addCase(mo,((e,t)=>{let{payload:n}=t;const r=e.queries.filter((e=>(0,Oe.j)(e.model)));e.queries=[...n,...r]})),e.addCase(go,(e=>{e.queries=Io(e.queries,{datasourceUid:lo.Yq,model:lo.mV.newQuery({type:$e.Us.math,conditions:[Object.assign({},uo.R,{query:{params:[]}})],expression:""})})})).addCase(vo,((e,t)=>{let{payload:n}=t;e.queries=e.queries.filter((e=>e.refId!==n))})).addCase(xo,((e,t)=>{let{payload:n}=t;e.queries=e.queries.map((t=>{const r=po(e.queries,n.expression),i=r?r.relativeTimeRange:(0,Y.Rr)();return t.refId===n.refId&&(t.model=n,n.type===$e.Us.resample&&(t.relativeTimeRange=i)),t}))})).addCase(wo,(e=>{const t=e.queries.map((t=>{if(t.datasourceUid===lo.Yq){const n=po(e.queries,t.model.expression),r=n?n.relativeTimeRange:(0,Y.Rr)();t.relativeTimeRange=r}return t}));e.queries=t})).addCase(bo,((e,t)=>{let{payload:n}=t;const{newRefId:r,oldRefId:i}=n;if(We(e.queries,r))return;const o=De(e.queries,i,r);e.queries=o.map((e=>e.refId===i?Object.assign({},e,{refId:r,model:Object.assign({},e.model,{refId:r})}):e))})).addCase(yo,((e,t)=>{let{payload:n}=t;e.queries=De(e.queries,n.oldRefId,n.newRefId)})).addCase(jo,((e,t)=>{e.queries=e.queries.map((e=>e.refId===t.payload.refId?Object.assign({},e,{model:Object.assign({},lo.mV.newQuery({type:t.payload.type,conditions:[Object.assign({},uo.R,{query:{params:[]}})],expression:""}),{refId:t.payload.refId})}):e))}))})),Io=(e,t)=>{var n;const r=(0,ao.Hs)(e),i=Object.assign({},t,{refId:r,queryType:"",model:Object.assign({},t.model,{hide:!1,refId:r}),relativeTimeRange:null!==(n=t.relativeTimeRange)&&void 0!==n?n:ko(t.model)});return[...e,i]},ko=e=>{if(!(0,Oe.j)(e))return(0,Y.Rr)()};var Ao;const So=["ref"];const No=e=>{var t,n;let{editingExistingRule:r}=e;const o=(0,i.useRef)(new $r.v),{setValue:s,getValues:a,watch:l,formState:{errors:u},control:f}=(0,v.Gc)(),[h,m]=(0,i.useState)({}),g={queries:a("queries"),panelData:{}},[{queries:x},b]=(0,i.useReducer)(Co,g),[y,j,w]=l(["type","condition","dataSourceName"]),C=y===R.$.grafana,I=y===R.$.cloudAlerting,k=(y===R.$.cloudRecording||I)&&w,A=(0,i.useCallback)((()=>{o.current.cancel()}),[]),S=(0,i.useCallback)((()=>{o.current.run(a("queries"))}),[a]);(0,i.useEffect)((()=>{s("queries",x,{shouldValidate:!1})}),[x,S,s]),(0,i.useEffect)((()=>{const e=o.current;return o.current.get().subscribe((e=>{m(e)})),()=>e.destroy()}),[]);const N=void 0===(0,K.P)(),T=(0,i.useMemo)((()=>Object.values(h).some((e=>e.state===W.Gu.Loading))),[h]),O=(0,i.useMemo)((()=>x.filter((e=>!(0,Oe.j)(e.model)))),[x]),$=(0,i.useMemo)((()=>x.filter((e=>(0,Oe.j)(e.model)))),[x]),E=0===x.length,L=(0,i.useCallback)(((e,t)=>{We(x,t)||(b(bo({oldRefId:e,newRefId:t})),j===e&&s("condition",t))}),[j,x,s]),M=(0,i.useCallback)((e=>{b(mo(e)),b(wo()),e.forEach(((e,t)=>{const n=x[t].refId,r=e.refId;n!==r&&b(yo({oldRefId:n,newRefId:r}))}))}),[x]),U=(0,i.useCallback)((e=>{b(fo(e))}),[]);return(0,i.useEffect)((()=>{if(!We(x,j)){var e,t;const n=null!==(e=null===(t=x.at(-1))||void 0===t?void 0:t.refId)&&void 0!==e?e:null;s("condition",n)}}),[j,x,s]),(0,p.jsxs)(me.z,{stepNo:1,title:"Set a query and alert condition",children:[(0,p.jsx)(io,{editingExistingRule:r}),k&&(0,p.jsx)(q.g,{error:null===(t=u.expression)||void 0===t?void 0:t.message,invalid:!(null===(n=u.expression)||void 0===n||!n.message),children:(0,p.jsx)(F.g,{name:"expression",render:e=>{let{}=e,t=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e.field,So);return(0,p.jsx)(Pr,Object.assign({},t,{dataSourceName:w}))},control:f,rules:{required:{value:!0,message:"A valid expression is required"}}})}),C&&(0,p.jsxs)(je.Stack,{direction:"column",children:[(0,p.jsx)(Di,{queries:O,expressions:$,onRunQueries:S,onChangeQueries:M,onDuplicateQuery:U,panelData:h,condition:j,onSetCondition:e=>{s("condition",e)}}),(0,p.jsx)(vi,{queries:x,panelData:h,condition:j,onSetCondition:e=>{s("condition",e)},onRemoveExpression:e=>{b(vo(e))},onUpdateRefId:L,onUpdateExpressionType:(e,t)=>{b(jo({refId:e,type:t}))},onUpdateQueryExpression:e=>{b(xo(e))}}),(0,p.jsxs)(je.Stack,{direction:"row",children:[(0,p.jsx)(Ce.u,{content:"You appear to have no compatible data sources",show:N,children:(0,p.jsx)(d.zx,{type:"button",icon:"plus",onClick:()=>{b(ho())},variant:"secondary","aria-label":Tr.wl.components.QueryTab.addQuery,disabled:N,children:"Add query"})}),Or.v.expressionsEnabled&&(0,p.jsx)(d.zx,{type:"button",icon:"plus",onClick:()=>{b(go())},variant:"secondary",children:"Add expression"}),T&&(0,p.jsx)(d.zx,{icon:"fa fa-spinner",type:"button",variant:"destructive",onClick:A,children:"Cancel"}),!T&&(0,p.jsx)(d.zx,{icon:"sync",type:"button",onClick:()=>S(),disabled:E,children:"Preview"})]}),E&&(Ao||(Ao=(0,p.jsx)(c.b,{title:"No queries or expressions have been configured",severity:"warning",children:"Create at least one query or expression to be alerted on"})))]})]})};var Ro,To,Oo;const $o=e=>{var t;let{existing:n}=e;const r=(0,u.wW)(Eo),o=(0,a.I0)(),s=(0,I.iG)(),[l]=(0,k.K)(),[c,f]=(0,i.useState)(!1),h=null!==(t=l.returnTo)&&void 0!==t?t:"/alerting/list",[m,q]=(0,i.useState)(!1),E=(0,i.useMemo)((()=>n?(0,O.DQ)(n):Object.assign({},(0,O.uZ)(),{queries:(0,O.s0)(),condition:"C"},l.defaults?JSON.parse(l.defaults):{},{type:R.$.grafana})),[n,l]),F=(0,v.cI)({mode:"onSubmit",defaultValues:E,shouldFocusError:!0}),{handleSubmit:L,watch:M}=F,U=M("type"),D=M("dataSourceName"),_=Boolean(U&&(U===R.$.grafana||!!D)),W=(0,S._)((e=>e.ruleForm.saveRule))||T.oq;(0,g.x)((e=>e.unifiedAlerting.ruleForm.saveRule=T.oq));const Q=(e,t)=>{var r,i,s,a;o((0,N.wy)({values:Object.assign({},E,e,{annotations:null!==(r=null===(i=e.annotations)||void 0===i?void 0:i.map((e=>{let{key:t,value:n}=e;return{key:t.trim(),value:n.trim()}})).filter((e=>{let{key:t,value:n}=e;return!!t&&!!n})))&&void 0!==r?r:[],labels:null!==(s=null===(a=e.labels)||void 0===a?void 0:a.map((e=>{let{key:t,value:n}=e;return{key:t.trim(),value:n.trim()}})).filter((e=>{let{key:t}=e;return!!t})))&&void 0!==s?s:[]}),existing:n,redirectOnSave:t?h:void 0}))},P=()=>{s.error("There are errors in the form. Please correct them and try again!")};return(0,p.jsxs)(v.RV,Object.assign({},F,{children:[(0,p.jsxs)("form",{onSubmit:e=>e.preventDefault(),className:r.form,children:[(0,p.jsxs)(y.Lh,{height:"auto",justify:"flex-end",children:[(0,p.jsx)(x.Link,{to:h,children:(0,p.jsx)(d.zx,{variant:"secondary",disabled:W.loading,type:"button",fill:"outline",onClick:()=>(0,b.PN)(A.z7.cancelSavingAlertRule),children:"Cancel"})}),n?(0,p.jsx)(d.zx,{variant:"destructive",type:"button",onClick:()=>q(!0),children:"Delete"}):null,qo(M)&&(0,p.jsx)(d.zx,{variant:"secondary",type:"button",onClick:()=>f(!0),disabled:W.loading,children:"Edit yaml"}),(0,p.jsxs)(d.zx,{variant:"primary",type:"button",onClick:L((e=>Q(e,!1)),P),disabled:W.loading,children:[W.loading&&(0,p.jsx)(j.$,{className:r.buttonSpinner,inline:!0}),"Save"]}),(0,p.jsxs)(d.zx,{variant:"primary",type:"button",onClick:L((e=>Q(e,!0)),P),disabled:W.loading,children:[W.loading&&(0,p.jsx)(j.$,{className:r.buttonSpinner,inline:!0}),"Save and exit"]})]}),(0,p.jsx)("div",{className:r.contentOuter,children:(0,p.jsx)(w.$,{autoHeightMin:"100%",hideHorizontalTrack:!0,children:(0,p.jsxs)("div",{className:r.contentInner,children:[(0,p.jsx)(No,{editingExistingRule:!!n}),_&&(0,p.jsxs)(p.Fragment,{children:[U===R.$.grafana?Ro||(Ro=(0,p.jsx)(ut.wO,{})):To||(To=(0,p.jsx)(ve,{})),(0,p.jsx)(ot,{initialFolder:E.folder}),Oo||(Oo=(0,p.jsx)(ht,{}))]})]})})})]}),m?(0,p.jsx)(C.s,{isOpen:!0,title:"Delete rule",body:"Deleting this rule will permanently remove it. Are you sure you want to delete this rule?",confirmText:"Yes, delete",icon:"exclamation-triangle",onConfirm:()=>{if(n){const e=$.Zk(n.ruleSourceName,n.namespace,n.group.name,n.rule);o((0,N.hS)(e,{navigateTo:"/alerting/list"}))}},onDismiss:()=>q(!1)}):null,c?(0,p.jsx)(Ir,{onClose:()=>f(!1)}):null]}))},qo=e=>{const[t,n]=e(["type","dataSourceName"]);return(t===R.$.cloudAlerting||t===R.$.cloudRecording)&&""!==n},Eo=e=>({buttonSpinner:l.css`
      margin-right: ${e.spacing(1)};
    `,form:l.css`
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    `,contentInner:l.css`
      flex: 1;
      padding: ${e.spacing(2)};
    `,contentOuter:l.css`
      background: ${e.colors.background.primary};
      border: 1px solid ${e.colors.border.weak};
      border-radius: ${e.shape.borderRadius()};
      overflow: hidden;
      flex: 1;
      margin-top: ${e.spacing(1)};
    `,flexRow:l.css`
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
    `});var Fo,Lo,Mo,Uo=n(12134);function Do(e){let{identifier:t}=e;(0,g.x)((e=>e.unifiedAlerting.ruleForm.existingRule=T.oq));const{loading:n,result:r,error:o,dispatched:s}=(0,S._)((e=>e.ruleForm.existingRule)),l=(0,a.I0)(),{isEditable:u,loading:d}=(0,Uo.M)($.s0(t),null==r?void 0:r.rule),h=n||d;return(0,i.useEffect)((()=>{s||l((0,N.on)(t))}),[s,l,t]),h||void 0===u?Fo||(Fo=(0,p.jsx)(m.u,{text:"Loading rule..."})):o?(0,p.jsx)(c.b,{severity:"error",title:"Failed to load rule",children:o.message}):r?!1===u?Mo||(Mo=(0,p.jsx)(f,{title:"Cannot edit rule",children:"Sorry! You do not have permission to edit this rule."})):(0,p.jsx)($o,{existing:r}):Lo||(Lo=(0,p.jsx)(f,{title:"Rule not found",children:"Sorry! This rule does not exist."}))}var _o,Wo,Qo,Po=n(73615),Go=n(30149);const zo={icon:"bell",id:"alert-rule-view",breadcrumbs:[{title:"Alert rules",url:"alerting/list"}]},Vo=(0,s.Pf)((e=>{var t;let{match:n}=e;const r=(0,a.I0)(),{id:s}=n.params,l=$.OA(s,!0),{loading:c=!0}=(0,o.Z)((async()=>{l&&await r((0,N.nw)({rulesSourceName:l.ruleSourceName}))}),[r]),{canCreateGrafanaRules:u,canCreateCloudRules:d,canEditRules:h}=(0,Go.B)(),m=(0,i.useCallback)((()=>{if(!c)return l||u||d?l&&!h(l.ruleSourceName)?Wo||(Wo=(0,p.jsx)(f,{title:"Cannot edit rules",children:"Sorry! You are not allowed to edit rules."})):l?t||(t=(0,p.jsx)(Do,{identifier:l},s)):Qo||(Qo=(0,p.jsx)($o,{})):_o||(_o=(0,p.jsx)(f,{title:"Cannot create rules",children:"Sorry! You are not allowed to create rules."}))}),[d,u,h,s,l,c]);return(0,p.jsx)(Po.J,{isLoading:c,pageId:"alert-list",pageNav:(g=l?"edit":"add","edit"===g?Object.assign({},zo,{id:"alert-rule-edit",text:"Edit rule"}):"add"===g?Object.assign({},zo,{id:"alert-rule-add",text:"Add rule"}):void 0),children:m()});var g}),{style:"page"})},50848:(e,t,n)=>{n.d(t,{j:()=>l});var r=n(68404),i=n(65737),o=n(37625),s=n(74846),a=n(45916);function l(e){const{value:t,onChange:n,size:l="md"}=e,c=(0,r.useMemo)((()=>Object.values(i.v.panels).reduce(((e,t)=>(function(e){switch(e){case s.GC:case s.Fe:case s.Kd:return!0;default:return!1}}(t.id)&&e.push({value:t.id,label:t.name,imgUrl:t.info.logos.small}),e)),[])),[]);return(0,a.jsx)(o.S,{options:c,value:t,onChange:n,size:l})}},85976:(e,t,n)=>{n.d(t,{S:()=>s});var r=n(68404),i=n(8910),o=n(18474);function s(e){return{allDataSourcesAvailable:(0,r.useMemo)((()=>e.filter((e=>!(0,o.Pr)(e.datasourceUid))).every((e=>{const t=(0,i.F)().getInstanceSettings(e.datasourceUid);return Boolean(t)}))),[e])}}},65673:(e,t,n)=>{n.d(t,{W:()=>l});var r=n(68404),i=n(64850),o=n(64834),s=n(5302),a=n(76938);function l(e){const t=(0,i.I0)(),n=(0,a._)((e=>e.folders));if((0,r.useEffect)((()=>{e&&t((0,o.sw)(e))}),[t,e]),e){const t=n[e]||s.oq;return{folder:t.result,loading:t.loading}}return{loading:!1}}},12134:(e,t,n)=>{n.d(t,{M:()=>l});var r=n(59196),i=n(96535),o=n(80458),s=n(65673),a=n(76938);function l(e,t){var n,l,c;const u=(0,a._)((e=>e.dataSources)),d=t&&(0,o.Pc)(t)?t.grafana_alert.namespace_uid:void 0,p=(0,i.Bz)(e),{folder:f,loading:h}=(0,s.W)(d);if(!t)return{isEditable:!1,isRemovable:!1,loading:!1};if((0,o.Pc)(t)){if(!d)throw new Error(`Rule ${t.grafana_alert.title} does not have a folder uid, cannot determine if it is editable.`);if(!f)return{isEditable:!1,isRemovable:!1,loading:h};const e=f.canSave;return{isEditable:r.Vt.hasAccessInMetadata(p.update,f,e),isRemovable:r.Vt.hasAccessInMetadata(p.delete,f,e),loading:h}}const m=Boolean(null===(n=u[e])||void 0===n||null===(l=n.result)||void 0===l?void 0:l.rulerConfig);return{isEditable:r.Vt.hasAccess(p.update,r.Vt.isEditor)&&m,isRemovable:r.Vt.hasAccess(p.delete,r.Vt.isEditor)&&m,loading:null===(c=u[e])||void 0===c?void 0:c.loading}}},28774:(e,t,n)=>{n.d(t,{v:()=>R});var r=n(16527),i=n(53786),o=n(94514),s=n(44962),a=n(2101),l=n(44288),c=n(28173),u=n(6003),d=n(85699),p=n(12717),f=n(99511),h=n(8910),m=n(75386),g=n(42200),v=n(38252),x=n(95160),b=n(15203),y=n(8343),j=n(52394);const w={from:21600,to:0},C=(e,t)=>{switch(e.type){case j.Us.classic:return I(e);case j.Us.math:return A(e,t);case j.Us.resample:case j.Us.reduce:case j.Us.threshold:return S(e)}},I=e=>{var t;return null===(t=e.conditions)||void 0===t?void 0:t.map((e=>e.query.params[0]))},k=(e,t)=>{let n=[],r=[w.to];for(const i of e){const e=t.find((e=>e.refId===i));e&&e.relativeTimeRange&&(n.push(e.relativeTimeRange.from),r.push(e.relativeTimeRange.to))}return{from:n,to:r}},A=(e,t)=>t.filter((t=>{var n;return"query"===t.queryType&&(null===(n=e.expression)||void 0===n?void 0:n.includes(t.refId))})).map((e=>e.refId)),S=e=>e.expression?[e.expression]:void 0;function N(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class R{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,g.i)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,h.F)();N(this,"subject",void 0),N(this,"subscription",void 0),N(this,"lastResult",void 0),this.backendSrv=e,this.dataSourceSrv=t,this.subject=new r.t(1),this.lastResult={}}get(){return this.subject.asObservable()}async run(e){if(0===e.length){const t=O(e,c.Gu.Done);return this.subject.next(t)}for(const t of e)if(!(0,v.j)(t.model)){const n=await this.dataSourceSrv.get(t.datasourceUid);if(n.filterQuery&&!n.filterQuery(t.model)){const t=O(e,c.Gu.Done);return this.subject.next(t)}}this.subscription=T(this.backendSrv,e).subscribe({next:e=>{const t=F(e,((e,t)=>{const n=this.lastResult[e],r=(0,y.zR)(t,n);return(0,b.C)(r,n)}));this.lastResult=t,this.subject.next(this.lastResult)},error:e=>{this.lastResult=E(this.lastResult,e),this.subject.next(this.lastResult)}})}cancel(){if(!this.subscription)return;this.subscription.unsubscribe();let e=!1;const t=F(this.lastResult,((t,n)=>(n.state===c.Gu.Loading&&(e=!0),Object.assign({},n,{state:c.Gu.Done}))));e&&this.subject.next(t)}destroy(){this.subject&&this.subject.complete(),this.cancel()}}const T=(e,t)=>{const n=O(t,c.Gu.Loading),r={data:{data:t},url:"/api/v1/eval",method:"POST",requestId:(0,l.Z)()};return(0,u.x)({whileLoading:n,source:e.fetch(r).pipe(q(n),(0,o.K)((e=>(0,i.of)(E(n,e)))),(0,x.V)(e,r.requestId),(0,s.B)())})},O=(e,t)=>e.reduce(((n,r)=>(n[r.refId]={state:t,series:[],timeRange:$(r,e)},n)),{}),$=(e,t)=>{if((0,v.j)(e.model)){const n=((e,t)=>{const n=C(e,t);if(!n)return w;const{from:r,to:i}=k(n,t);return r.length||i.length?{from:Math.max(...r),to:Math.min(...i)}:w})(e.model,t);return d.relativeToTimeRange(n)}return e.relativeTimeRange?d.relativeToTimeRange(e.relativeTimeRange):(console.warn(`Query with refId: ${e.refId} did not have any relative time range, using default.`),(0,p.JK)())},q=e=>(0,a.U)((t=>{const{data:n}=t,r={};for(const[t,i]of Object.entries(n.results))r[t]={timeRange:e[t].timeRange,state:c.Gu.Done,series:i.frames.map(f.vP)};return r})),E=(e,t)=>{const n=(0,m.P)(t);return F(e,((e,t)=>Object.assign({},t,{state:c.Gu.Error,error:n})))},F=(e,t)=>{const n={};for(const[r,i]of Object.entries(e))n[r]=t(r,i);return n}},30149:(e,t,n)=>{n.d(t,{B:()=>o});var r=n(68404),i=n(96535);function o(){return(0,r.useMemo)((()=>(0,i.Rv)()),[])}},38252:(e,t,n)=>{n.d(t,{j:()=>o});var r=n(18474),i=n(52394);const o=e=>{if(!e)return!1;if((0,r.Pr)(e.datasource))return!0;const t=e;return"string"==typeof t.type&&Object.values(i.Us).includes(t.type)}}}]);
//# sourceMappingURL=AlertingRuleForm.9c329db2f29b211f0ebf.js.map