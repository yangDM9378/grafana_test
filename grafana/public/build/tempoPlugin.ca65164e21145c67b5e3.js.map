{"version":3,"file":"tempoPlugin.ca65164e21145c67b5e3.js","mappings":"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","sources":["webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/QueryOptionGroup.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/types.ts","webpack://grafana/./public/app/plugins/datasource/tempo/language_provider.ts","webpack://grafana/./public/app/plugins/datasource/tempo/datasource.ts","webpack://grafana/./public/app/plugins/datasource/tempo/traceql/TempoQueryBuilderOptions.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/traceql/autocomplete.ts","webpack://grafana/./public/app/plugins/datasource/tempo/traceql/traceql.ts","webpack://grafana/./public/app/plugins/datasource/tempo/traceql/TraceQLEditor.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/traceql/QueryEditor.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/syntax.ts","webpack://grafana/./public/app/plugins/datasource/tempo/QueryEditor/NativeSearch.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/QueryEditor/utils.ts","webpack://grafana/./public/app/plugins/datasource/tempo/QueryEditor/ServiceGraphSection.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/QueryEditor/QueryField.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/configuration/LokiSearchSettings.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/configuration/QuerySettings.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/configuration/SearchSettings.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/configuration/ServiceGraphSettings.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/module.ts","webpack://grafana/./public/app/plugins/datasource/tempo/configuration/ConfigEditor.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/CheatSheet.tsx"],"sourcesContent":["import { css } from '@emotion/css';\nimport React from 'react';\nimport { useToggle } from 'react-use';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Stack } from '@grafana/experimental';\nimport { Icon, useStyles2 } from '@grafana/ui';\n\nexport interface Props {\n  title: string;\n  collapsedInfo: string[];\n  children: React.ReactNode;\n}\n\nexport function QueryOptionGroup({ title, children, collapsedInfo }: Props) {\n  const [isOpen, toggleOpen] = useToggle(false);\n  const styles = useStyles2(getStyles);\n\n  return (\n    <Stack gap={0} direction=\"column\">\n      <div className={styles.header} onClick={toggleOpen} title=\"Click to edit options\">\n        <div className={styles.toggle}>\n          <Icon name={isOpen ? 'angle-down' : 'angle-right'} />\n        </div>\n        <h6 className={styles.title}>{title}</h6>\n        {!isOpen && (\n          <div className={styles.description}>\n            {collapsedInfo.map((x, i) => (\n              <span key={i}>{x}</span>\n            ))}\n          </div>\n        )}\n      </div>\n      {isOpen && <div className={styles.body}>{children}</div>}\n    </Stack>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    switchLabel: css({\n      color: theme.colors.text.secondary,\n      cursor: 'pointer',\n      fontSize: theme.typography.bodySmall.fontSize,\n      '&:hover': {\n        color: theme.colors.text.primary,\n      },\n    }),\n    header: css({\n      display: 'flex',\n      cursor: 'pointer',\n      alignItems: 'baseline',\n      color: theme.colors.text.primary,\n      '&:hover': {\n        background: theme.colors.emphasize(theme.colors.background.primary, 0.03),\n      },\n    }),\n    title: css({\n      flexGrow: 1,\n      overflow: 'hidden',\n      fontSize: theme.typography.bodySmall.fontSize,\n      fontWeight: theme.typography.fontWeightMedium,\n      margin: 0,\n    }),\n    description: css({\n      color: theme.colors.text.secondary,\n      fontSize: theme.typography.bodySmall.fontSize,\n      paddingLeft: theme.spacing(2),\n      gap: theme.spacing(2),\n      display: 'flex',\n    }),\n    body: css({\n      display: 'flex',\n      paddingTop: theme.spacing(2),\n      gap: theme.spacing(2),\n      flexWrap: 'wrap',\n    }),\n    toggle: css({\n      color: theme.colors.text.secondary,\n      marginRight: `${theme.spacing(1)}`,\n    }),\n  };\n};\n","import { DataQuery } from '@grafana/data';\nimport { DataSourceJsonData, KeyValue } from '@grafana/data/src';\nimport { NodeGraphOptions } from 'app/core/components/NodeGraphSettings';\nimport { TraceToLogsOptions } from 'app/core/components/TraceToLogs/TraceToLogsSettings';\n\nimport { LokiQuery } from '../loki/types';\n\nexport interface SearchQueryParams {\n  minDuration?: string;\n  maxDuration?: string;\n  limit?: number;\n  tags?: string;\n  start?: number;\n  end?: number;\n}\n\nexport interface TempoJsonData extends DataSourceJsonData {\n  tracesToLogs?: TraceToLogsOptions;\n  serviceMap?: {\n    datasourceUid?: string;\n  };\n  search?: {\n    hide?: boolean;\n  };\n  nodeGraph?: NodeGraphOptions;\n  lokiSearch?: {\n    datasourceUid?: string;\n  };\n  spanBar?: {\n    tag: string;\n  };\n  traceQuery?: {\n    timeShiftEnabled?: boolean;\n    spanStartTimeShift?: string;\n    spanEndTimeShift?: string;\n  };\n}\n\n// search = Loki search, nativeSearch = Tempo search for backwards compatibility\nexport type TempoQueryType = 'traceql' | 'search' | 'traceId' | 'serviceMap' | 'upload' | 'nativeSearch' | 'clear';\n\nexport interface TempoQuery extends DataQuery {\n  query: string;\n  // Query to find list of traces, e.g., via Loki\n  linkedQuery?: LokiQuery;\n  search?: string;\n  queryType: TempoQueryType;\n  serviceName?: string;\n  spanName?: string;\n  minDuration?: string;\n  maxDuration?: string;\n  limit?: number;\n  serviceMapQuery?: string;\n}\n\nexport interface MyDataSourceOptions extends DataSourceJsonData {}\n\nexport const defaultQuery: Partial<TempoQuery> = {};\n\nexport type TraceSearchMetadata = {\n  traceID: string;\n  rootServiceName: string;\n  rootTraceName: string;\n  startTimeUnixNano?: string;\n  durationMs?: number;\n  spanSet?: { spans: Span[] };\n};\n\nexport type SearchMetrics = {\n  inspectedTraces?: number;\n  inspectedBytes?: number;\n  inspectedBlocks?: number;\n  skippedBlocks?: number;\n  skippedTraces?: number;\n  totalBlockBytes?: number;\n  spanSets?: Spanset[];\n};\n\nexport enum SpanKind {\n  UNSPECIFIED,\n  INTERNAL,\n  SERVER,\n  CLIENT,\n  PRODUCER,\n  CONSUMER,\n}\n\nexport type Span = {\n  durationNanos: string;\n  traceId?: string;\n  spanID: string;\n  traceState?: string;\n  parentSpanId?: string;\n  name?: string;\n  kind?: SpanKind;\n  startTimeUnixNano: string;\n  endTimeUnixNano?: string;\n  attributes?: Array<{\n    key: string;\n    value: { stringValue?: string; intValue?: string; boolValue?: boolean; doubleValue?: string };\n  }>;\n  dropped_attributes_count?: number;\n};\n\nexport type Spanset = {\n  attributes: KeyValue[];\n  spans: Span[];\n};\n\nexport type SearchResponse = {\n  traces: TraceSearchMetadata[];\n  metrics: SearchMetrics;\n};\n","import { Value } from 'slate';\n\nimport { LanguageProvider, SelectableValue } from '@grafana/data';\nimport { CompletionItemGroup, TypeaheadInput, TypeaheadOutput } from '@grafana/ui';\n\nimport { TempoDatasource } from './datasource';\n\nexport default class TempoLanguageProvider extends LanguageProvider {\n  datasource: TempoDatasource;\n  tags?: string[];\n  constructor(datasource: TempoDatasource, initialValues?: any) {\n    super();\n\n    this.datasource = datasource;\n    Object.assign(this, initialValues);\n  }\n\n  request = async (url: string, params = {}) => {\n    const res = await this.datasource.metadataRequest(url, params);\n    return res?.data;\n  };\n\n  start = async () => {\n    if (!this.startTask) {\n      this.startTask = this.fetchTags().then(() => {\n        return [];\n      });\n    }\n\n    return this.startTask;\n  };\n\n  async fetchTags() {\n    const response = await this.request('/api/search/tags', []);\n    this.tags = response.tagNames;\n  }\n\n  getTags = () => {\n    return this.tags;\n  };\n\n  provideCompletionItems = async ({ text, value }: TypeaheadInput): Promise<TypeaheadOutput> => {\n    const emptyResult: TypeaheadOutput = { suggestions: [] };\n\n    if (!value) {\n      return emptyResult;\n    }\n\n    const query = value.endText.getText();\n    const isValue = query[query.indexOf(text) - 1] === '=';\n    if (isValue || text === '=') {\n      return this.getTagValueCompletionItems(value);\n    }\n    return this.getTagsCompletionItems();\n  };\n\n  getTagsCompletionItems = (): TypeaheadOutput => {\n    const { tags } = this;\n    const suggestions: CompletionItemGroup[] = [];\n\n    if (tags?.length) {\n      suggestions.push({\n        label: `Tag`,\n        items: tags.map((tag) => ({ label: tag })),\n      });\n    }\n\n    return { suggestions };\n  };\n\n  async getTagValueCompletionItems(value: Value) {\n    const tags = value.endText.getText().split(' ');\n\n    let tagName = tags[tags.length - 1] ?? '';\n    tagName = tagName.split('=')[0];\n\n    const response = await this.request(`/api/search/tag/${tagName}/values`, []);\n\n    const suggestions: CompletionItemGroup[] = [];\n\n    if (response && response.tagValues) {\n      suggestions.push({\n        label: `Tag Values`,\n        items: response.tagValues.map((tagValue: string) => ({ label: tagValue, insertText: `\"${tagValue}\"` })),\n      });\n    }\n    return { suggestions };\n  }\n\n  async getOptions(tag: string): Promise<Array<SelectableValue<string>>> {\n    const response = await this.request(`/api/search/tag/${tag}/values`);\n    let options: Array<SelectableValue<string>> = [];\n\n    if (response && response.tagValues) {\n      options = response.tagValues.map((v: string) => ({\n        value: v,\n        label: v,\n      }));\n    }\n\n    return options;\n  }\n}\n","import { identity, pick, pickBy, groupBy, startCase } from 'lodash';\nimport { EMPTY, from, lastValueFrom, merge, Observable, of, throwError } from 'rxjs';\nimport { catchError, concatMap, map, mergeMap, toArray } from 'rxjs/operators';\n\nimport {\n  DataQueryRequest,\n  DataQueryResponse,\n  DataQueryResponseData,\n  DataSourceApi,\n  DataSourceInstanceSettings,\n  dateTime,\n  FieldType,\n  isValidGoDuration,\n  LoadingState,\n  rangeUtil,\n  ScopedVars,\n} from '@grafana/data';\nimport {\n  config,\n  BackendSrvRequest,\n  DataSourceWithBackend,\n  getBackendSrv,\n  reportInteraction,\n  TemplateSrv,\n  getTemplateSrv,\n} from '@grafana/runtime';\nimport { SpanBarOptions } from '@jaegertracing/jaeger-ui-components';\nimport { NodeGraphOptions } from 'app/core/components/NodeGraphSettings';\nimport { TraceToLogsOptions } from 'app/core/components/TraceToLogs/TraceToLogsSettings';\nimport { serializeParams } from 'app/core/utils/fetch';\nimport { getDatasourceSrv } from 'app/features/plugins/datasource_srv';\n\nimport { LokiOptions } from '../loki/types';\nimport { PrometheusDatasource } from '../prometheus/datasource';\nimport { PromQuery } from '../prometheus/types';\n\nimport {\n  failedMetric,\n  histogramMetric,\n  mapPromMetricsToServiceMap,\n  serviceMapMetrics,\n  totalsMetric,\n  rateMetric,\n  durationMetric,\n  errorRateMetric,\n  defaultTableFilter,\n} from './graphTransform';\nimport TempoLanguageProvider from './language_provider';\nimport {\n  transformTrace,\n  transformTraceList,\n  transformFromOTLP as transformFromOTEL,\n  createTableFrameFromSearch,\n  createTableFrameFromTraceQlQuery,\n} from './resultTransformer';\nimport { SearchQueryParams, TempoQuery, TempoJsonData } from './types';\n\nexport const DEFAULT_LIMIT = 20;\n\nexport class TempoDatasource extends DataSourceWithBackend<TempoQuery, TempoJsonData> {\n  tracesToLogs?: TraceToLogsOptions;\n  serviceMap?: {\n    datasourceUid?: string;\n  };\n  search?: {\n    hide?: boolean;\n  };\n  nodeGraph?: NodeGraphOptions;\n  lokiSearch?: {\n    datasourceUid?: string;\n  };\n  traceQuery?: {\n    timeShiftEnabled?: boolean;\n    spanStartTimeShift?: string;\n    spanEndTimeShift?: string;\n  };\n  uploadedJson?: string | ArrayBuffer | null = null;\n  spanBar?: SpanBarOptions;\n  languageProvider: TempoLanguageProvider;\n\n  constructor(\n    private instanceSettings: DataSourceInstanceSettings<TempoJsonData>,\n    private readonly templateSrv: TemplateSrv = getTemplateSrv()\n  ) {\n    super(instanceSettings);\n    this.tracesToLogs = instanceSettings.jsonData.tracesToLogs;\n    this.serviceMap = instanceSettings.jsonData.serviceMap;\n    this.search = instanceSettings.jsonData.search;\n    this.nodeGraph = instanceSettings.jsonData.nodeGraph;\n    this.lokiSearch = instanceSettings.jsonData.lokiSearch;\n    this.traceQuery = instanceSettings.jsonData.traceQuery;\n    this.languageProvider = new TempoLanguageProvider(this);\n  }\n\n  query(options: DataQueryRequest<TempoQuery>): Observable<DataQueryResponse> {\n    const subQueries: Array<Observable<DataQueryResponse>> = [];\n    const filteredTargets = options.targets.filter((target) => !target.hide);\n    const targets: { [type: string]: TempoQuery[] } = groupBy(filteredTargets, (t) => t.queryType || 'traceId');\n\n    if (targets.clear) {\n      return of({ data: [], state: LoadingState.Done });\n    }\n\n    const logsDatasourceUid = this.getLokiSearchDS();\n\n    // Run search queries on linked datasource\n    if (logsDatasourceUid && targets.search?.length > 0) {\n      reportInteraction('grafana_traces_loki_search_queried', {\n        datasourceType: 'tempo',\n        app: options.app ?? '',\n        linkedQueryExpr: targets.search[0].linkedQuery?.expr ?? '',\n      });\n\n      const dsSrv = getDatasourceSrv();\n      subQueries.push(\n        from(dsSrv.get(logsDatasourceUid)).pipe(\n          mergeMap((linkedDatasource: DataSourceApi) => {\n            // Wrap linked query into a data request based on original request\n            const linkedRequest: DataQueryRequest = { ...options, targets: targets.search.map((t) => t.linkedQuery!) };\n            // Find trace matchers in derived fields of the linked datasource that's identical to this datasource\n            const settings: DataSourceInstanceSettings<LokiOptions> = (linkedDatasource as any).instanceSettings;\n            const traceLinkMatcher: string[] =\n              settings.jsonData.derivedFields\n                ?.filter((field) => field.datasourceUid === this.uid && field.matcherRegex)\n                .map((field) => field.matcherRegex) || [];\n\n            if (!traceLinkMatcher || traceLinkMatcher.length === 0) {\n              return throwError(\n                () =>\n                  new Error(\n                    'No Loki datasource configured for search. Set up Derived Fields for traces in a Loki datasource settings and link it to this Tempo datasource.'\n                  )\n              );\n            } else {\n              return (linkedDatasource.query(linkedRequest) as Observable<DataQueryResponse>).pipe(\n                map((response) =>\n                  response.error ? response : transformTraceList(response, this.uid, this.name, traceLinkMatcher)\n                )\n              );\n            }\n          })\n        )\n      );\n    }\n\n    if (targets.nativeSearch?.length) {\n      try {\n        reportInteraction('grafana_traces_search_queried', {\n          datasourceType: 'tempo',\n          app: options.app ?? '',\n          serviceName: targets.nativeSearch[0].serviceName ?? '',\n          spanName: targets.nativeSearch[0].spanName ?? '',\n          resultLimit: targets.nativeSearch[0].limit ?? '',\n          search: targets.nativeSearch[0].search ?? '',\n        });\n\n        const timeRange = { startTime: options.range.from.unix(), endTime: options.range.to.unix() };\n        const query = this.applyVariables(targets.nativeSearch[0], options.scopedVars);\n        const searchQuery = this.buildSearchQuery(query, timeRange);\n        subQueries.push(\n          this._request('/api/search', searchQuery).pipe(\n            map((response) => {\n              return {\n                data: [createTableFrameFromSearch(response.data.traces, this.instanceSettings)],\n              };\n            }),\n            catchError((error) => {\n              return of({ error: { message: error.data.message }, data: [] });\n            })\n          )\n        );\n      } catch (error) {\n        return of({ error: { message: error instanceof Error ? error.message : 'Unknown error occurred' }, data: [] });\n      }\n    }\n    if (targets.traceql?.length) {\n      try {\n        reportInteraction('grafana_traces_traceql_queried', {\n          datasourceType: 'tempo',\n          app: options.app ?? '',\n        });\n\n        subQueries.push(\n          this._request('/api/search', {\n            q: targets.traceql[0].query,\n            limit: options.targets[0].limit,\n            start: options.range.from.unix(),\n            end: options.range.to.unix(),\n          }).pipe(\n            map((response) => {\n              return {\n                data: createTableFrameFromTraceQlQuery(response.data.traces, this.instanceSettings),\n              };\n            }),\n            catchError((error) => {\n              return of({ error: { message: error.data.message }, data: [] });\n            })\n          )\n        );\n      } catch (error) {\n        return of({ error: { message: error instanceof Error ? error.message : 'Unknown error occurred' }, data: [] });\n      }\n    }\n\n    if (targets.upload?.length) {\n      if (this.uploadedJson) {\n        reportInteraction('grafana_traces_json_file_uploaded', {\n          datasourceType: 'tempo',\n          app: options.app ?? '',\n        });\n\n        const jsonData = JSON.parse(this.uploadedJson as string);\n        const isTraceData = jsonData.batches;\n        const isServiceGraphData =\n          Array.isArray(jsonData) && jsonData.some((df) => df?.meta?.preferredVisualisationType === 'nodeGraph');\n\n        if (isTraceData) {\n          subQueries.push(of(transformFromOTEL(jsonData.batches, this.nodeGraph?.enabled)));\n        } else if (isServiceGraphData) {\n          subQueries.push(of({ data: jsonData, state: LoadingState.Done }));\n        } else {\n          subQueries.push(of({ error: { message: 'Unable to parse uploaded data.' }, data: [] }));\n        }\n      } else {\n        subQueries.push(of({ data: [], state: LoadingState.Done }));\n      }\n    }\n\n    if (this.serviceMap?.datasourceUid && targets.serviceMap?.length > 0) {\n      reportInteraction('grafana_traces_service_graph_queried', {\n        datasourceType: 'tempo',\n        app: options.app ?? '',\n        serviceMapQuery: targets.serviceMap[0].serviceMapQuery ?? '',\n      });\n\n      const dsId = this.serviceMap.datasourceUid;\n      const tempoDsUid = this.uid;\n      if (config.featureToggles.tempoApmTable) {\n        subQueries.push(\n          serviceMapQuery(options, dsId, tempoDsUid).pipe(\n            concatMap((result) =>\n              rateQuery(options, result, dsId).pipe(\n                concatMap((result) => errorAndDurationQuery(options, result, dsId, tempoDsUid))\n              )\n            )\n          )\n        );\n      } else {\n        subQueries.push(serviceMapQuery(options, dsId, tempoDsUid));\n      }\n    }\n\n    if (targets.traceId?.length > 0) {\n      reportInteraction('grafana_traces_traceID_queried', {\n        datasourceType: 'tempo',\n        app: options.app ?? '',\n        query: targets.traceId[0].query ?? '',\n      });\n\n      subQueries.push(this.handleTraceIdQuery(options, targets.traceId));\n    }\n\n    return merge(...subQueries);\n  }\n\n  applyTemplateVariables(query: TempoQuery, scopedVars: ScopedVars): Record<string, any> {\n    return this.applyVariables(query, scopedVars);\n  }\n\n  interpolateVariablesInQueries(queries: TempoQuery[], scopedVars: ScopedVars): TempoQuery[] {\n    if (!queries || queries.length === 0) {\n      return [];\n    }\n\n    return queries.map((query) => {\n      return {\n        ...query,\n        datasource: this.getRef(),\n        ...this.applyVariables(query, scopedVars),\n      };\n    });\n  }\n\n  applyVariables(query: TempoQuery, scopedVars: ScopedVars) {\n    const expandedQuery = { ...query };\n\n    if (query.linkedQuery) {\n      expandedQuery.linkedQuery = {\n        ...query.linkedQuery,\n        expr: this.templateSrv.replace(query.linkedQuery?.expr ?? '', scopedVars),\n      };\n    }\n\n    return {\n      ...expandedQuery,\n      query: this.templateSrv.replace(query.query ?? '', scopedVars),\n      serviceName: this.templateSrv.replace(query.serviceName ?? '', scopedVars),\n      spanName: this.templateSrv.replace(query.spanName ?? '', scopedVars),\n      search: this.templateSrv.replace(query.search ?? '', scopedVars),\n      minDuration: this.templateSrv.replace(query.minDuration ?? '', scopedVars),\n      maxDuration: this.templateSrv.replace(query.maxDuration ?? '', scopedVars),\n    };\n  }\n\n  /**\n   * Handles the simplest of the queries where we have just a trace id and return trace data for it.\n   * @param options\n   * @param targets\n   * @private\n   */\n  handleTraceIdQuery(options: DataQueryRequest<TempoQuery>, targets: TempoQuery[]): Observable<DataQueryResponse> {\n    const validTargets = targets.filter((t) => t.query).map((t) => ({ ...t, query: t.query.trim() }));\n    if (!validTargets.length) {\n      return EMPTY;\n    }\n\n    const traceRequest = this.traceIdQueryRequest(options, validTargets);\n\n    return super.query(traceRequest).pipe(\n      map((response) => {\n        if (response.error) {\n          return response;\n        }\n        return transformTrace(response, this.nodeGraph?.enabled);\n      })\n    );\n  }\n\n  traceIdQueryRequest(options: DataQueryRequest<TempoQuery>, targets: TempoQuery[]): DataQueryRequest<TempoQuery> {\n    const request = {\n      ...options,\n      targets,\n    };\n\n    if (this.traceQuery?.timeShiftEnabled) {\n      request.range = options.range && {\n        ...options.range,\n        from: options.range.from.subtract(\n          rangeUtil.intervalToMs(this.traceQuery?.spanStartTimeShift || '30m'),\n          'milliseconds'\n        ),\n        to: options.range.to.add(rangeUtil.intervalToMs(this.traceQuery?.spanEndTimeShift || '30m'), 'milliseconds'),\n      };\n    } else {\n      request.range = { from: dateTime(0), to: dateTime(0), raw: { from: dateTime(0), to: dateTime(0) } };\n    }\n\n    return request;\n  }\n\n  async metadataRequest(url: string, params = {}) {\n    return await lastValueFrom(this._request(url, params, { method: 'GET', hideFromInspector: true }));\n  }\n\n  private _request(apiUrl: string, data?: any, options?: Partial<BackendSrvRequest>): Observable<Record<string, any>> {\n    const params = data ? serializeParams(data) : '';\n    const url = `${this.instanceSettings.url}${apiUrl}${params.length ? `?${params}` : ''}`;\n    const req = { ...options, url };\n\n    return getBackendSrv().fetch(req);\n  }\n\n  async testDatasource(): Promise<any> {\n    const options: BackendSrvRequest = {\n      headers: {},\n      method: 'GET',\n      url: `${this.instanceSettings.url}/api/echo`,\n    };\n    const response = await lastValueFrom(getBackendSrv().fetch<any>(options));\n\n    if (response?.ok) {\n      return { status: 'success', message: 'Data source is working' };\n    }\n  }\n\n  getQueryDisplayText(query: TempoQuery) {\n    if (query.queryType === 'nativeSearch') {\n      let result = [];\n      for (const key of ['serviceName', 'spanName', 'search', 'minDuration', 'maxDuration', 'limit']) {\n        if (query.hasOwnProperty(key) && query[key as keyof TempoQuery]) {\n          result.push(`${startCase(key)}: ${query[key as keyof TempoQuery]}`);\n        }\n      }\n      return result.join(', ');\n    }\n    return query.query;\n  }\n\n  buildSearchQuery(query: TempoQuery, timeRange?: { startTime: number; endTime?: number }): SearchQueryParams {\n    let tags = query.search ?? '';\n\n    let tempoQuery = pick(query, ['minDuration', 'maxDuration', 'limit']);\n    // Remove empty properties\n    tempoQuery = pickBy(tempoQuery, identity);\n\n    if (query.serviceName) {\n      tags += ` service.name=\"${query.serviceName}\"`;\n    }\n    if (query.spanName) {\n      tags += ` name=\"${query.spanName}\"`;\n    }\n\n    // Set default limit\n    if (!tempoQuery.limit) {\n      tempoQuery.limit = DEFAULT_LIMIT;\n    }\n\n    // Validate query inputs and remove spaces if valid\n    if (tempoQuery.minDuration) {\n      tempoQuery.minDuration = this.templateSrv.replace(tempoQuery.minDuration ?? '');\n      if (!isValidGoDuration(tempoQuery.minDuration)) {\n        throw new Error('Please enter a valid min duration.');\n      }\n      tempoQuery.minDuration = tempoQuery.minDuration.replace(/\\s/g, '');\n    }\n    if (tempoQuery.maxDuration) {\n      tempoQuery.maxDuration = this.templateSrv.replace(tempoQuery.maxDuration ?? '');\n      if (!isValidGoDuration(tempoQuery.maxDuration)) {\n        throw new Error('Please enter a valid max duration.');\n      }\n      tempoQuery.maxDuration = tempoQuery.maxDuration.replace(/\\s/g, '');\n    }\n\n    if (!Number.isInteger(tempoQuery.limit) || tempoQuery.limit <= 0) {\n      throw new Error('Please enter a valid limit.');\n    }\n\n    let searchQuery: SearchQueryParams = { tags, ...tempoQuery };\n\n    if (timeRange) {\n      searchQuery.start = timeRange.startTime;\n      searchQuery.end = timeRange.endTime;\n    }\n\n    return searchQuery;\n  }\n\n  // Get linked loki search datasource. Fall back to legacy loki search/trace to logs config\n  getLokiSearchDS = (): string | undefined => {\n    const legacyLogsDatasourceUid =\n      this.tracesToLogs?.lokiSearch !== false && this.lokiSearch === undefined\n        ? this.tracesToLogs?.datasourceUid\n        : undefined;\n    return this.lokiSearch?.datasourceUid ?? legacyLogsDatasourceUid;\n  };\n}\n\nfunction queryPrometheus(request: DataQueryRequest<PromQuery>, datasourceUid: string) {\n  return from(getDatasourceSrv().get(datasourceUid)).pipe(\n    mergeMap((ds) => {\n      return (ds as PrometheusDatasource).query(request);\n    })\n  );\n}\n\nfunction serviceMapQuery(request: DataQueryRequest<TempoQuery>, datasourceUid: string, tempoDatasourceUid: string) {\n  const serviceMapRequest = makePromServiceMapRequest(request);\n\n  return queryPrometheus(serviceMapRequest, datasourceUid).pipe(\n    // Just collect all the responses first before processing into node graph data\n    toArray(),\n    map((responses: DataQueryResponse[]) => {\n      const errorRes = responses.find((res) => !!res.error);\n      if (errorRes) {\n        throw new Error(errorRes.error!.message);\n      }\n\n      const { nodes, edges } = mapPromMetricsToServiceMap(responses, request.range);\n\n      // No handling of multiple targets assume just one. NodeGraph does not support it anyway, but still should be\n      // fixed at some point.\n      nodes.refId = request.targets[0].refId;\n      edges.refId = request.targets[0].refId;\n\n      nodes.fields[0].config = getFieldConfig(\n        datasourceUid,\n        tempoDatasourceUid,\n        '__data.fields.id',\n        '__data.fields[0]'\n      );\n      edges.fields[0].config = getFieldConfig(\n        datasourceUid,\n        tempoDatasourceUid,\n        '__data.fields.target',\n        '__data.fields.target',\n        '__data.fields.source'\n      );\n\n      return {\n        data: [nodes, edges],\n        state: LoadingState.Done,\n      };\n    })\n  );\n}\n\nfunction rateQuery(\n  request: DataQueryRequest<TempoQuery>,\n  serviceMapResponse: DataQueryResponse,\n  datasourceUid: string\n) {\n  const serviceMapRequest = makePromServiceMapRequest(request);\n  serviceMapRequest.targets = makeApmRequest([buildExpr(rateMetric, defaultTableFilter, request)]);\n\n  return queryPrometheus(serviceMapRequest, datasourceUid).pipe(\n    toArray(),\n    map((responses: DataQueryResponse[]) => {\n      const errorRes = responses.find((res) => !!res.error);\n      if (errorRes) {\n        throw new Error(errorRes.error!.message);\n      }\n      return {\n        data: [responses[0]?.data ?? [], serviceMapResponse.data[0], serviceMapResponse.data[1]],\n        state: LoadingState.Done,\n      };\n    })\n  );\n}\n\n// we need the response from the rate query to get the rate span_name(s),\n// -> which determine the errorRate/duration span_name(s) we need to query\nfunction errorAndDurationQuery(\n  request: DataQueryRequest<TempoQuery>,\n  rateResponse: DataQueryResponse,\n  datasourceUid: string,\n  tempoDatasourceUid: string\n) {\n  let apmMetrics = [];\n  let errorRateBySpanName = '';\n  let durationsBySpanName: string[] = [];\n  const spanNames = rateResponse.data[0][0]?.fields[1]?.values.toArray() ?? [];\n\n  if (spanNames.length > 0) {\n    errorRateBySpanName = buildExpr(errorRateMetric, 'span_name=~\"' + spanNames.join('|') + '\"', request);\n    apmMetrics.push(errorRateBySpanName);\n    spanNames.map((name: string) => {\n      const metric = buildExpr(durationMetric, 'span_name=~\"' + name + '\"', request);\n      durationsBySpanName.push(metric);\n      apmMetrics.push(metric);\n    });\n  }\n\n  const serviceMapRequest = makePromServiceMapRequest(request);\n  serviceMapRequest.targets = makeApmRequest(apmMetrics);\n\n  return queryPrometheus(serviceMapRequest, datasourceUid).pipe(\n    // Just collect all the responses first before processing into node graph data\n    toArray(),\n    map((errorAndDurationResponse: DataQueryResponse[]) => {\n      const errorRes = errorAndDurationResponse.find((res) => !!res.error);\n      if (errorRes) {\n        throw new Error(errorRes.error!.message);\n      }\n\n      const apmTable = getApmTable(\n        request,\n        rateResponse,\n        errorAndDurationResponse[0],\n        errorRateBySpanName,\n        durationsBySpanName,\n        datasourceUid,\n        tempoDatasourceUid\n      );\n\n      if (apmTable.fields.length === 0) {\n        return {\n          data: [rateResponse.data[1], rateResponse.data[2]],\n          state: LoadingState.Done,\n        };\n      }\n\n      return {\n        data: [apmTable, rateResponse.data[1], rateResponse.data[2]],\n        state: LoadingState.Done,\n      };\n    })\n  );\n}\n\nfunction makePromLink(title: string, expr: string, datasourceUid: string, instant: boolean) {\n  return {\n    url: '',\n    title,\n    internal: {\n      query: {\n        expr: expr,\n        range: !instant,\n        exemplar: !instant,\n        instant: instant,\n      } as PromQuery,\n      datasourceUid,\n      datasourceName: getDatasourceSrv().getDataSourceSettingsByUid(datasourceUid)?.name ?? '',\n    },\n  };\n}\n\nexport function getFieldConfig(\n  datasourceUid: string,\n  tempoDatasourceUid: string,\n  targetField: string,\n  tempoField: string,\n  sourceField?: string\n) {\n  sourceField = sourceField ? `client=\"\\${${sourceField}}\",` : '';\n  return {\n    links: [\n      makePromLink(\n        'Request rate',\n        `sum by (client, server)(rate(${totalsMetric}{${sourceField}server=\"\\${${targetField}}\"}[$__rate_interval]))`,\n        datasourceUid,\n        false\n      ),\n      makePromLink(\n        'Request histogram',\n        `histogram_quantile(0.9, sum(rate(${histogramMetric}{${sourceField}server=\"\\${${targetField}}\"}[$__rate_interval])) by (le, client, server))`,\n        datasourceUid,\n        false\n      ),\n      makePromLink(\n        'Failed request rate',\n        `sum by (client, server)(rate(${failedMetric}{${sourceField}server=\"\\${${targetField}}\"}[$__rate_interval]))`,\n        datasourceUid,\n        false\n      ),\n      makeTempoLink('View traces', `\\${${tempoField}}`, '', tempoDatasourceUid),\n    ],\n  };\n}\n\nexport function makeTempoLink(title: string, serviceName: string, spanName: string, datasourceUid: string) {\n  let query = { queryType: 'nativeSearch' } as TempoQuery;\n  if (serviceName !== '') {\n    query.serviceName = serviceName;\n  }\n  if (spanName !== '') {\n    query.spanName = spanName;\n  }\n\n  return {\n    url: '',\n    title,\n    internal: {\n      query,\n      datasourceUid,\n      datasourceName: getDatasourceSrv().getDataSourceSettingsByUid(datasourceUid)?.name ?? '',\n    },\n  };\n}\n\nfunction makePromServiceMapRequest(options: DataQueryRequest<TempoQuery>): DataQueryRequest<PromQuery> {\n  return {\n    ...options,\n    targets: serviceMapMetrics.map((metric) => {\n      return {\n        format: 'table',\n        refId: metric,\n        // options.targets[0] is not correct here, but not sure what should happen if you have multiple queries for\n        // service map at the same time anyway\n        expr: `rate(${metric}${options.targets[0].serviceMapQuery || ''}[$__range])`,\n        instant: true,\n      };\n    }),\n  };\n}\n\nfunction getApmTable(\n  request: DataQueryRequest<TempoQuery>,\n  rateResponse: DataQueryResponse,\n  secondResponse: DataQueryResponse,\n  errorRateBySpanName: string,\n  durationsBySpanName: string[],\n  datasourceUid: string,\n  tempoDatasourceUid: string\n) {\n  let df: any = { fields: [] };\n  const rate = rateResponse.data[0]?.filter((x: { refId: string }) => {\n    return x.refId === buildExpr(rateMetric, defaultTableFilter, request);\n  });\n  const errorRate = secondResponse.data.filter((x) => {\n    return x.refId === errorRateBySpanName;\n  });\n  const duration = secondResponse.data.filter((x) => {\n    return durationsBySpanName.includes(x.refId);\n  });\n\n  if (rate.length > 0 && rate[0].fields?.length > 2) {\n    df.fields.push({\n      ...rate[0].fields[1],\n      name: 'Name',\n      config: {\n        filterable: false,\n      },\n    });\n\n    df.fields.push({\n      ...rate[0].fields[2],\n      name: 'Rate',\n      config: {\n        links: [\n          makePromLink(\n            'Rate',\n            buildLinkExpr(buildExpr(rateMetric, 'span_name=\"${__data.fields[0]}\"', request)),\n            datasourceUid,\n            false\n          ),\n        ],\n        decimals: 2,\n      },\n    });\n\n    df.fields.push({\n      ...rate[0].fields[2],\n      name: ' ',\n      labels: null,\n      config: {\n        color: {\n          mode: 'continuous-BlPu',\n        },\n        custom: {\n          displayMode: 'lcd-gauge',\n        },\n        decimals: 3,\n      },\n    });\n  }\n\n  if (errorRate.length > 0 && errorRate[0].fields?.length > 2) {\n    const errorRateNames = errorRate[0].fields[1]?.values.toArray() ?? [];\n    const errorRateValues = errorRate[0].fields[2]?.values.toArray() ?? [];\n    let errorRateObj: any = {};\n    errorRateNames.map((name: string, index: number) => {\n      errorRateObj[name] = { value: errorRateValues[index] };\n    });\n\n    const values = getRateAlignedValues({ ...rate }, errorRateObj);\n\n    df.fields.push({\n      ...errorRate[0].fields[2],\n      name: 'Error Rate',\n      values: values,\n      config: {\n        links: [\n          makePromLink(\n            'Error Rate',\n            buildLinkExpr(buildExpr(errorRateMetric, 'span_name=\"${__data.fields[0]}\"', request)),\n            datasourceUid,\n            false\n          ),\n        ],\n        decimals: 2,\n      },\n    });\n\n    df.fields.push({\n      ...errorRate[0].fields[2],\n      name: '  ',\n      values: values,\n      labels: null,\n      config: {\n        color: {\n          mode: 'continuous-RdYlGr',\n        },\n        custom: {\n          displayMode: 'lcd-gauge',\n        },\n        decimals: 3,\n      },\n    });\n  }\n\n  if (duration.length > 0 && duration[0].fields?.length > 1) {\n    let durationObj: any = {};\n    duration.map((d) => {\n      const delimiter = d.refId?.includes('span_name=~\"') ? 'span_name=~\"' : 'span_name=\"';\n      const name = d.refId?.split(delimiter)[1].split('\"}')[0];\n      durationObj[name] = { value: d.fields[1].values.toArray()[0] };\n    });\n\n    df.fields.push({\n      ...duration[0].fields[1],\n      name: 'Duration (p90)',\n      values: getRateAlignedValues({ ...rate }, durationObj),\n      config: {\n        links: [\n          makePromLink(\n            'Duration',\n            buildLinkExpr(buildExpr(durationMetric, 'span_name=\"${__data.fields[0]}\"', request)),\n            datasourceUid,\n            false\n          ),\n        ],\n        unit: 's',\n      },\n    });\n  }\n\n  if (df.fields.length > 0 && df.fields[0].values) {\n    df.fields.push({\n      name: 'Links',\n      type: FieldType.string,\n      values: df.fields[0].values.map(() => {\n        return 'Tempo';\n      }),\n      config: {\n        links: [makeTempoLink('Tempo', '', `\\${__data.fields[0]}`, tempoDatasourceUid)],\n      },\n    });\n  }\n\n  return df;\n}\n\nexport function buildExpr(\n  metric: { expr: string; params: string[] },\n  extraParams: string,\n  request: DataQueryRequest<TempoQuery>\n) {\n  let serviceMapQuery = request.targets[0]?.serviceMapQuery?.replace('{', '').replace('}', '') ?? '';\n  // map serviceGraph metric tags to APM metric tags\n  serviceMapQuery = serviceMapQuery.replace('client', 'service').replace('server', 'service');\n  const metricParams = serviceMapQuery.includes('span_name')\n    ? metric.params.concat(serviceMapQuery)\n    : metric.params\n        .concat(serviceMapQuery)\n        .concat(extraParams)\n        .filter((item: string) => item);\n  return metric.expr.replace('{}', '{' + metricParams.join(',') + '}');\n}\n\nexport function buildLinkExpr(expr: string) {\n  // don't want top 5 or by span name in links\n  expr = expr.replace('topk(5, ', '').replace(' by (span_name))', '');\n  return expr.replace('__range', '__rate_interval');\n}\n\n// query result frames can come back in any order\n// here we align the table col values to the same row name (rateName) across the table\nexport function getRateAlignedValues(\n  rateResp: DataQueryResponseData[],\n  objToAlign: { [x: string]: { value: string } }\n) {\n  const rateNames = rateResp[0]?.fields[1]?.values.toArray() ?? [];\n  let values: string[] = [];\n\n  for (let i = 0; i < rateNames.length; i++) {\n    if (Object.keys(objToAlign).includes(rateNames[i])) {\n      values.push(objToAlign[rateNames[i]].value);\n    } else {\n      values.push('0');\n    }\n  }\n\n  return values;\n}\n\nexport function makeApmRequest(metrics: any[]) {\n  return metrics.map((metric) => {\n    return {\n      refId: metric,\n      expr: metric,\n      instant: true,\n    };\n  });\n}\n","import React from 'react';\n\nimport { EditorField, EditorRow } from '@grafana/experimental';\nimport { AutoSizeInput } from '@grafana/ui';\nimport { QueryOptionGroup } from 'app/plugins/datasource/prometheus/querybuilder/shared/QueryOptionGroup';\n\nimport { DEFAULT_LIMIT } from '../datasource';\nimport { TempoQuery } from '../types';\n\ninterface Props {\n  onChange: (value: TempoQuery) => void;\n  query: Partial<TempoQuery> & TempoQuery;\n}\n\nexport const TempoQueryBuilderOptions = React.memo<Props>(({ onChange, query }) => {\n  if (!query.hasOwnProperty('limit')) {\n    query.limit = DEFAULT_LIMIT;\n  }\n\n  const onLimitChange = (e: React.FormEvent<HTMLInputElement>) => {\n    onChange({ ...query, limit: parseInt(e.currentTarget.value, 10) });\n  };\n\n  return (\n    <>\n      <EditorRow>\n        <QueryOptionGroup title=\"Options\" collapsedInfo={[`Limit: ${query.limit || DEFAULT_LIMIT}`]}>\n          <EditorField label=\"Limit\" tooltip=\"Maximum number of traces to return.\">\n            <AutoSizeInput\n              className=\"width-4\"\n              placeholder=\"auto\"\n              type=\"number\"\n              min={1}\n              defaultValue={query.limit || DEFAULT_LIMIT}\n              onCommitChange={onLimitChange}\n              value={query.limit}\n            />\n          </EditorField>\n        </QueryOptionGroup>\n      </EditorRow>\n    </>\n  );\n});\n\nTempoQueryBuilderOptions.displayName = 'TempoQueryBuilderOptions';\n","import { SelectableValue } from '@grafana/data';\nimport type { Monaco, monacoTypes } from '@grafana/ui';\n\nimport TempoLanguageProvider from '../language_provider';\n\ninterface Props {\n  languageProvider: TempoLanguageProvider;\n}\n\n/**\n * Class that implements CompletionItemProvider interface and allows us to provide suggestion for the Monaco\n * autocomplete system.\n */\nexport class CompletionProvider implements monacoTypes.languages.CompletionItemProvider {\n  languageProvider: TempoLanguageProvider;\n\n  constructor(props: Props) {\n    this.languageProvider = props.languageProvider;\n  }\n\n  triggerCharacters = ['{', '.', '[', '(', '=', '~', ' ', '\"'];\n\n  static readonly intrinsics: string[] = ['duration', 'name', 'status'];\n  static readonly scopes: string[] = ['resource', 'span'];\n  static readonly operators: string[] = ['=', '-', '+', '<', '>', '>=', '<=', '=~'];\n  static readonly logicalOps: string[] = ['&&', '||'];\n\n  // We set these directly and ae required for the provider to function.\n  monaco: Monaco | undefined;\n  editor: monacoTypes.editor.IStandaloneCodeEditor | undefined;\n\n  private tags: { [tag: string]: Set<string> } = {};\n  private cachedValues: { [key: string]: Array<SelectableValue<string>> } = {};\n\n  provideCompletionItems(\n    model: monacoTypes.editor.ITextModel,\n    position: monacoTypes.Position\n  ): monacoTypes.languages.ProviderResult<monacoTypes.languages.CompletionList> {\n    // Should not happen, this should not be called before it is initialized\n    if (!(this.monaco && this.editor)) {\n      throw new Error('provideCompletionItems called before CompletionProvider was initialized');\n    }\n\n    // if the model-id does not match, then this call is from a different editor-instance,\n    // not \"our instance\", so return nothing\n    if (this.editor.getModel()?.id !== model.id) {\n      return { suggestions: [] };\n    }\n\n    const { range, offset } = getRangeAndOffset(this.monaco, model, position);\n    const situation = this.getSituation(model.getValue(), offset);\n    const completionItems = this.getCompletions(situation);\n\n    return completionItems.then((items) => {\n      // monaco by-default alphabetically orders the items.\n      // to stop it, we use a number-as-string sortkey,\n      // so that monaco keeps the order we use\n      const maxIndexDigits = items.length.toString().length;\n      const suggestions: monacoTypes.languages.CompletionItem[] = items.map((item, index) => {\n        const suggestion = {\n          kind: getMonacoCompletionItemKind(item.type, this.monaco!),\n          label: item.label,\n          insertText: item.insertText,\n          sortText: index.toString().padStart(maxIndexDigits, '0'), // to force the order we have\n          range,\n        };\n        fixSuggestion(suggestion, item.type, model, offset, this.monaco!);\n        return suggestion;\n      });\n      return { suggestions };\n    });\n  }\n\n  /**\n   * We expect the tags list data directly from the request and assign it an empty set here.\n   */\n  setTags(tags: string[]) {\n    tags.forEach((t) => (this.tags[t] = new Set<string>()));\n  }\n\n  private overrideTagName(tagName: string): string {\n    switch (tagName) {\n      case 'status':\n        return 'status.code';\n      default:\n        return tagName;\n    }\n  }\n\n  private async getTagValues(tagName: string): Promise<Array<SelectableValue<string>>> {\n    let tagValues: Array<SelectableValue<string>> = [];\n\n    if (this.cachedValues.hasOwnProperty(tagName)) {\n      tagValues = this.cachedValues[tagName];\n    } else {\n      tagValues = await this.languageProvider.getOptions(tagName);\n      this.cachedValues[tagName] = tagValues;\n    }\n    return tagValues;\n  }\n\n  /**\n   * Get suggestion based on the situation we are in like whether we should suggest tag names or values.\n   * @param situation\n   * @private\n   */\n  private async getCompletions(situation: Situation): Promise<Completion[]> {\n    if (!Object.keys(this.tags).length) {\n      return [];\n    }\n    switch (situation.type) {\n      // Not really sure what would make sense to suggest in this case so just leave it\n      case 'UNKNOWN': {\n        return [];\n      }\n      case 'EMPTY': {\n        return this.getScopesCompletions('{ ')\n          .concat(this.getIntrinsicsCompletions('{ '))\n          .concat(this.getTagsCompletions('{ .'));\n      }\n      case 'SPANSET_EMPTY':\n        return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions('.'));\n      case 'SPANSET_ONLY_DOT': {\n        return this.getTagsCompletions();\n      }\n      case 'SPANSET_IN_NAME':\n        return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions());\n      case 'SPANSET_IN_NAME_SCOPE':\n        return this.getTagsCompletions();\n      case 'SPANSET_AFTER_NAME':\n        return CompletionProvider.operators.map((key) => ({\n          label: key,\n          insertText: key,\n          type: 'OPERATOR' as CompletionType,\n        }));\n      case 'SPANSET_IN_VALUE':\n        const tagName = this.overrideTagName(situation.tagName);\n        const tagsNoQuotesAroundValue: string[] = ['status'];\n        const tagValues = await this.getTagValues(tagName);\n        const items: Completion[] = [];\n\n        const getInsertionText = (val: SelectableValue<string>): string => {\n          if (situation.betweenQuotes) {\n            return val.label!;\n          }\n          return tagsNoQuotesAroundValue.includes(situation.tagName) ? val.label! : `\"${val.label}\"`;\n        };\n\n        tagValues.forEach((val) => {\n          if (val?.label) {\n            items.push({\n              label: val.label,\n              insertText: getInsertionText(val),\n              type: 'TAG_VALUE',\n            });\n          }\n        });\n        return items;\n      case 'SPANSET_AFTER_VALUE':\n        return CompletionProvider.logicalOps.concat('}').map((key) => ({\n          label: key,\n          insertText: key,\n          type: 'OPERATOR' as CompletionType,\n        }));\n      default:\n        throw new Error(`Unexpected situation ${situation}`);\n    }\n  }\n\n  private getTagsCompletions(prepend?: string): Completion[] {\n    return Object.keys(this.tags)\n      .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'accent' }))\n      .map((key) => ({\n        label: key,\n        insertText: (prepend || '') + key,\n        type: 'TAG_NAME' as CompletionType,\n      }));\n  }\n\n  private getIntrinsicsCompletions(prepend?: string): Completion[] {\n    return CompletionProvider.intrinsics.map((key) => ({\n      label: key,\n      insertText: (prepend || '') + key,\n      type: 'KEYWORD' as CompletionType,\n    }));\n  }\n\n  private getScopesCompletions(prepend?: string): Completion[] {\n    return CompletionProvider.scopes.map((key) => ({\n      label: key,\n      insertText: (prepend || '') + key,\n      type: 'SCOPE' as CompletionType,\n    }));\n  }\n\n  private getSituationInSpanSet(textUntilCaret: string): Situation {\n    const nameRegex = /(?<name>[\\w./-]+)?/;\n    const opRegex = /(?<op>[!=+\\-<>]+)/;\n    // only allow spaces in the value if it's enclosed by quotes\n    const valueRegex = /(?<value>(?<open_quote>\")([^\"\\n&|]+)?(?<close_quote>\")?|([^\"\\n\\s&|]+))?/;\n\n    // prettier-ignore\n    const fullRegex = new RegExp(\n      '([\\\\s{])' +      // Space(s) or initial opening bracket {\n      '(' +                   // Open full set group\n      nameRegex.source +\n      '(?<space1>\\\\s*)' +     // Optional space(s) between name and operator\n      '(' +                   // Open operator + value group\n      opRegex.source +\n      '(?<space2>\\\\s*)' +     // Optional space(s) between operator and value\n      valueRegex.source +\n      ')?' +                  // Close operator + value group\n      ')' +                   // Close full set group\n      '(?<space3>\\\\s*)$'      // Optional space(s) at the end of the set\n    );\n\n    const matched = textUntilCaret.match(fullRegex);\n\n    if (matched) {\n      const nameFull = matched.groups?.name;\n      const op = matched.groups?.op;\n\n      if (!nameFull) {\n        return {\n          type: 'SPANSET_EMPTY',\n        };\n      }\n\n      if (nameFull === '.') {\n        return {\n          type: 'SPANSET_ONLY_DOT',\n        };\n      }\n\n      const nameMatched = nameFull.match(/^(?<pre_dot>\\.)?(?<word>\\w[\\w./-]*\\w)(?<post_dot>\\.)?$/);\n\n      // We already have a (potentially partial) tag name so let's check if there's an operator declared\n      // { .tag_name|\n      if (!op) {\n        // There's no operator so we check if the name is one of the known scopes\n        // { resource.|\n        if (CompletionProvider.scopes.filter((w) => w === nameMatched?.groups?.word) && nameMatched?.groups?.post_dot) {\n          return {\n            type: 'SPANSET_IN_NAME_SCOPE',\n          };\n        }\n        // It's not one of the scopes, so we now check if we're after the name (there's a space after the word) or if we still have to autocomplete the rest of the name\n        // In case there's a space we start autocompleting the operators { .http.method |\n        // Otherwise we keep showing the tags/intrinsics/scopes list { .http.met|\n        return {\n          type: matched.groups?.space1 ? 'SPANSET_AFTER_NAME' : 'SPANSET_IN_NAME',\n        };\n      }\n\n      // In case there's a space after the full [name + operator + value] group we can start autocompleting logical operators or close the spanset\n      // To avoid triggering this situation when we are writing a space inside a string we check the state of the open and close quotes\n      // { .http.method = \"GET\" |\n      if (matched.groups?.space3 && matched.groups.open_quote === matched.groups.close_quote) {\n        return {\n          type: 'SPANSET_AFTER_VALUE',\n        };\n      }\n\n      // remove the scopes from the word to get accurate autocompletes\n      // Ex: 'span.host.name' won't resolve to any autocomplete values, but removing 'span.' results in 'host.name' which can have autocomplete values\n      const noScopeWord = CompletionProvider.scopes.reduce(\n        (result, word) => result.replace(`${word}.`, ''),\n        nameMatched?.groups?.word || ''\n      );\n\n      // We already have an operator and know that the set isn't complete so let's autocomplete the possible values for the tag name\n      // { .http.method = |\n      return {\n        type: 'SPANSET_IN_VALUE',\n        tagName: noScopeWord,\n        betweenQuotes: !!matched.groups?.open_quote,\n      };\n    }\n\n    return {\n      type: 'EMPTY',\n    };\n  }\n\n  /**\n   * Figure out where is the cursor and what kind of suggestions are appropriate.\n   * @param text\n   * @param offset\n   */\n  private getSituation(text: string, offset: number): Situation {\n    if (text === '' || offset === 0) {\n      return {\n        type: 'EMPTY',\n      };\n    }\n\n    const textUntilCaret = text.substring(0, offset);\n\n    // Check if we're inside a span set\n    let isInSpanSet = textUntilCaret.lastIndexOf('{') > textUntilCaret.lastIndexOf('}');\n    if (isInSpanSet) {\n      return this.getSituationInSpanSet(textUntilCaret);\n    }\n\n    // Will happen only if user writes something that isn't really a tag selector\n    return {\n      type: 'UNKNOWN',\n    };\n  }\n}\n\n/**\n * Get item kind which is used for icon next to the suggestion.\n * @param type\n * @param monaco\n */\nfunction getMonacoCompletionItemKind(type: CompletionType, monaco: Monaco): monacoTypes.languages.CompletionItemKind {\n  switch (type) {\n    case 'TAG_NAME':\n      return monaco.languages.CompletionItemKind.Enum;\n    case 'KEYWORD':\n      return monaco.languages.CompletionItemKind.Keyword;\n    case 'OPERATOR':\n      return monaco.languages.CompletionItemKind.Operator;\n    case 'TAG_VALUE':\n      return monaco.languages.CompletionItemKind.EnumMember;\n    case 'SCOPE':\n      return monaco.languages.CompletionItemKind.Class;\n    default:\n      throw new Error(`Unexpected CompletionType: ${type}`);\n  }\n}\n\nexport type CompletionType = 'TAG_NAME' | 'TAG_VALUE' | 'KEYWORD' | 'OPERATOR' | 'SCOPE';\ntype Completion = {\n  type: CompletionType;\n  label: string;\n  insertText: string;\n};\n\nexport type Tag = {\n  name: string;\n  value: string;\n};\n\nexport type Situation =\n  | {\n      type: 'UNKNOWN';\n    }\n  | {\n      type: 'EMPTY';\n    }\n  | {\n      type: 'SPANSET_EMPTY';\n    }\n  | {\n      type: 'SPANSET_ONLY_DOT';\n    }\n  | {\n      type: 'SPANSET_AFTER_NAME';\n    }\n  | {\n      type: 'SPANSET_IN_NAME';\n    }\n  | {\n      type: 'SPANSET_IN_NAME_SCOPE';\n    }\n  | {\n      type: 'SPANSET_IN_VALUE';\n      tagName: string;\n      betweenQuotes: boolean;\n    }\n  | {\n      type: 'SPANSET_AFTER_VALUE';\n    };\n\nfunction getRangeAndOffset(monaco: Monaco, model: monacoTypes.editor.ITextModel, position: monacoTypes.Position) {\n  const word = model.getWordAtPosition(position);\n  const range =\n    word != null\n      ? monaco.Range.lift({\n          startLineNumber: position.lineNumber,\n          endLineNumber: position.lineNumber,\n          startColumn: word.startColumn,\n          endColumn: word.endColumn,\n        })\n      : monaco.Range.fromPositions(position);\n\n  // documentation says `position` will be \"adjusted\" in `getOffsetAt` so we clone it here just for sure.\n  const positionClone = {\n    column: position.column,\n    lineNumber: position.lineNumber,\n  };\n\n  const offset = model.getOffsetAt(positionClone);\n  return { offset, range };\n}\n\n/**\n * Fix the suggestions range and insert text. For the range we have to adjust because monaco by default replaces just\n * the last word which stops at dot while traceQL tags contain dots themselves and we want to replace the whole tag\n * name when suggesting. The insert text needs to be adjusted for scope (leading dot) if scope is currently missing.\n * This may be doable also when creating the suggestions but for a particular situation this seems to be easier to do\n * here.\n */\nfunction fixSuggestion(\n  suggestion: monacoTypes.languages.CompletionItem & { range: monacoTypes.IRange },\n  itemType: CompletionType,\n  model: monacoTypes.editor.ITextModel,\n  offset: number,\n  monaco: Monaco\n) {\n  if (itemType === 'TAG_NAME') {\n    const match = model\n      .getValue()\n      .substring(0, offset)\n      .match(/(span\\.|resource\\.|\\.)?([\\w./-]*)$/);\n\n    if (match) {\n      const scope = match[1];\n      const tag = match[2];\n\n      if (tag) {\n        // Add the default scope if needed.\n        if (!scope && suggestion.insertText[0] !== '.') {\n          suggestion.insertText = '.' + suggestion.insertText;\n        }\n\n        // Adjust the range, so that we will replace the whole tag.\n        suggestion.range = monaco.Range.lift({\n          ...suggestion.range,\n          startColumn: offset - tag.length + 1,\n        });\n      }\n    }\n  }\n}\n","export const languageConfiguration = {\n  // the default separators except `@$`\n  wordPattern: /(-?\\d*\\.\\d\\w*)|([^`~!#%^&*()\\-=+\\[{\\]}\\\\|;:'\",.<>\\/?\\s]+)/g,\n  brackets: [\n    ['{', '}'],\n    ['(', ')'],\n  ],\n  autoClosingPairs: [\n    { open: '{', close: '}' },\n    { open: '(', close: ')' },\n    { open: '\"', close: '\"' },\n    { open: \"'\", close: \"'\" },\n  ],\n  surroundingPairs: [\n    { open: '{', close: '}' },\n    { open: '(', close: ')' },\n    { open: '\"', close: '\"' },\n    { open: \"'\", close: \"'\" },\n  ],\n  folding: {},\n};\n\nconst operators = ['=', '!=', '>', '<', '>=', '<=', '=~', '!~'];\n\nconst intrinsics = ['duration', 'name', 'status', 'parent'];\n\nconst scopes: string[] = ['resource', 'span'];\n\nconst booleans = ['false', 'true'];\n\nconst keywords = intrinsics.concat(scopes).concat(booleans);\n\nexport const language = {\n  ignoreCase: false,\n  defaultToken: '',\n  tokenPostfix: '.traceql',\n\n  keywords,\n  operators,\n\n  // we include these common regular expressions\n  symbols: /[=><!~?:&|+\\-*\\/^%]+/,\n  escapes: /\\\\(?:[abfnrtv\\\\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,\n  digits: /\\d+(_+\\d+)*/,\n  octaldigits: /[0-7]+(_+[0-7]+)*/,\n  binarydigits: /[0-1]+(_+[0-1]+)*/,\n  hexdigits: /[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,\n  integersuffix: /(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,\n  floatsuffix: /[fFlL]?/,\n\n  tokenizer: {\n    root: [\n      // labels\n      [/[a-z_.][\\w./_-]*(?=\\s*(=|!=|>|<|>=|<=|=~|!~))/, 'tag'],\n\n      // all keywords have the same color\n      [\n        /[a-zA-Z_.]\\w*/,\n        {\n          cases: {\n            '@keywords': 'type',\n            '@default': 'identifier',\n          },\n        },\n      ],\n\n      // strings\n      [/\"([^\"\\\\]|\\\\.)*$/, 'string.invalid'], // non-teminated string\n      [/'([^'\\\\]|\\\\.)*$/, 'string.invalid'], // non-teminated string\n      [/\"/, 'string', '@string_double'],\n      [/'/, 'string', '@string_single'],\n\n      // whitespace\n      { include: '@whitespace' },\n\n      // delimiters and operators\n      [/[{}()\\[\\]]/, '@brackets'],\n      [/[<>](?!@symbols)/, '@brackets'],\n      [\n        /@symbols/,\n        {\n          cases: {\n            '@operators': 'delimiter',\n            '@default': '',\n          },\n        },\n      ],\n\n      // numbers\n      [/\\d+/, 'number'],\n      [/\\d*\\d+[eE]([\\-+]?\\d+)?(@floatsuffix)/, 'number.float'],\n      [/\\d*\\.\\d+([eE][\\-+]?\\d+)?(@floatsuffix)/, 'number.float'],\n      [/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/, 'number.hex'],\n      [/0[0-7']*[0-7](@integersuffix)/, 'number.octal'],\n      [/0[bB][0-1']*[0-1](@integersuffix)/, 'number.binary'],\n      [/\\d[\\d']*\\d(@integersuffix)/, 'number'],\n      [/\\d(@integersuffix)/, 'number'],\n    ],\n\n    string_double: [\n      [/[^\\\\\"]+/, 'string'],\n      [/@escapes/, 'string.escape'],\n      [/\\\\./, 'string.escape.invalid'],\n      [/\"/, 'string', '@pop'],\n    ],\n\n    string_single: [\n      [/[^\\\\']+/, 'string'],\n      [/@escapes/, 'string.escape'],\n      [/\\\\./, 'string.escape.invalid'],\n      [/'/, 'string', '@pop'],\n    ],\n\n    clauses: [\n      [/[^(,)]/, 'tag'],\n      [/\\)/, 'identifier', '@pop'],\n    ],\n\n    whitespace: [[/[ \\t\\r\\n]+/, 'white']],\n  },\n};\n\nexport const languageDefinition = {\n  id: 'traceql',\n  extensions: ['.traceql'],\n  aliases: ['tempo', 'traceql'],\n  mimetypes: [],\n  def: {\n    language,\n    languageConfiguration,\n  },\n};\n","import { css } from '@emotion/css';\nimport type { languages } from 'monaco-editor';\nimport React, { useEffect, useRef } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { CodeEditor, Monaco, monacoTypes, useTheme2 } from '@grafana/ui';\n\nimport { createErrorNotification } from '../../../../core/copy/appNotification';\nimport { notifyApp } from '../../../../core/reducers/appNotification';\nimport { dispatch } from '../../../../store/store';\nimport { TempoDatasource } from '../datasource';\n\nimport { CompletionProvider } from './autocomplete';\nimport { languageDefinition } from './traceql';\n\ninterface Props {\n  placeholder: string;\n  value: string;\n  onChange: (val: string) => void;\n  onRunQuery: () => void;\n  datasource: TempoDatasource;\n}\n\nexport function TraceQLEditor(props: Props) {\n  const { onChange, onRunQuery, placeholder } = props;\n  const setupAutocompleteFn = useAutocomplete(props.datasource);\n  const theme = useTheme2();\n  const styles = getStyles(theme, placeholder);\n\n  return (\n    <CodeEditor\n      value={props.value}\n      language={langId}\n      onBlur={onChange}\n      onChange={onChange}\n      containerStyles={styles.queryField}\n      monacoOptions={{\n        folding: false,\n        fontSize: 14,\n        lineNumbers: 'off',\n        overviewRulerLanes: 0,\n        renderLineHighlight: 'none',\n        scrollbar: {\n          vertical: 'hidden',\n          verticalScrollbarSize: 8, // used as \"padding-right\"\n          horizontal: 'hidden',\n          horizontalScrollbarSize: 0,\n        },\n        scrollBeyondLastLine: false,\n        wordWrap: 'on',\n      }}\n      onBeforeEditorMount={ensureTraceQL}\n      onEditorDidMount={(editor, monaco) => {\n        setupAutocompleteFn(editor, monaco);\n        setupActions(editor, monaco, onRunQuery);\n        setupPlaceholder(editor, monaco, styles);\n        setupAutoSize(editor);\n      }}\n    />\n  );\n}\n\nfunction setupPlaceholder(editor: monacoTypes.editor.IStandaloneCodeEditor, monaco: Monaco, styles: EditorStyles) {\n  const placeholderDecorators = [\n    {\n      range: new monaco.Range(1, 1, 1, 1),\n      options: {\n        className: styles.placeholder, // The placeholder text is in styles.placeholder\n        isWholeLine: true,\n      },\n    },\n  ];\n\n  let decorators: string[] = [];\n\n  const checkDecorators = (): void => {\n    const model = editor.getModel();\n\n    if (!model) {\n      return;\n    }\n\n    const newDecorators = model.getValueLength() === 0 ? placeholderDecorators : [];\n    decorators = model.deltaDecorations(decorators, newDecorators);\n  };\n\n  checkDecorators();\n  editor.onDidChangeModelContent(checkDecorators);\n}\n\nfunction setupActions(editor: monacoTypes.editor.IStandaloneCodeEditor, monaco: Monaco, onRunQuery: () => void) {\n  editor.addAction({\n    id: 'run-query',\n    label: 'Run Query',\n    keybindings: [monaco.KeyMod.Shift | monaco.KeyCode.Enter],\n    contextMenuGroupId: 'navigation',\n    contextMenuOrder: 1.5,\n    run: function () {\n      onRunQuery();\n    },\n  });\n}\n\nfunction setupAutoSize(editor: monacoTypes.editor.IStandaloneCodeEditor) {\n  const container = editor.getDomNode();\n  const updateHeight = () => {\n    if (container) {\n      const contentHeight = Math.min(1000, editor.getContentHeight());\n      const width = parseInt(container.style.width, 10);\n      container.style.width = `${width}px`;\n      container.style.height = `${contentHeight}px`;\n      editor.layout({ width, height: contentHeight });\n    }\n  };\n  editor.onDidContentSizeChange(updateHeight);\n  updateHeight();\n}\n\n/**\n * Hook that returns function that will set up monaco autocomplete for the label selector\n * @param datasource\n */\nfunction useAutocomplete(datasource: TempoDatasource) {\n  // We need the provider ref so we can pass it the label/values data later. This is because we run the call for the\n  // values here but there is additional setup needed for the provider later on. We could run the getSeries() in the\n  // returned function but that is run after the monaco is mounted so would delay the request a bit when it does not\n  // need to.\n  const providerRef = useRef<CompletionProvider>(\n    new CompletionProvider({ languageProvider: datasource.languageProvider })\n  );\n\n  useEffect(() => {\n    const fetchTags = async () => {\n      try {\n        await datasource.languageProvider.start();\n        const tags = datasource.languageProvider.getTags();\n\n        if (tags) {\n          providerRef.current.setTags(tags);\n        }\n      } catch (error) {\n        if (error instanceof Error) {\n          dispatch(notifyApp(createErrorNotification('Error', error)));\n        }\n      }\n    };\n    fetchTags();\n  }, [datasource]);\n\n  const autocompleteDisposeFun = useRef<(() => void) | null>(null);\n  useEffect(() => {\n    // when we unmount, we unregister the autocomplete-function, if it was registered\n    return () => {\n      autocompleteDisposeFun.current?.();\n    };\n  }, []);\n\n  // This should be run in monaco onEditorDidMount\n  return (editor: monacoTypes.editor.IStandaloneCodeEditor, monaco: Monaco) => {\n    providerRef.current.editor = editor;\n    providerRef.current.monaco = monaco;\n\n    const { dispose } = monaco.languages.registerCompletionItemProvider(langId, providerRef.current);\n    autocompleteDisposeFun.current = dispose;\n  };\n}\n\n// we must only run the setup code once\nlet traceqlSetupDone = false;\nconst langId = 'traceql';\n\nfunction ensureTraceQL(monaco: Monaco) {\n  if (!traceqlSetupDone) {\n    traceqlSetupDone = true;\n    const { aliases, extensions, mimetypes, def } = languageDefinition;\n    monaco.languages.register({ id: langId, aliases, extensions, mimetypes });\n    monaco.languages.setMonarchTokensProvider(langId, def.language as languages.IMonarchLanguage);\n    monaco.languages.setLanguageConfiguration(langId, def.languageConfiguration as languages.LanguageConfiguration);\n  }\n}\n\ninterface EditorStyles {\n  placeholder: string;\n  queryField: string;\n}\n\nconst getStyles = (theme: GrafanaTheme2, placeholder: string): EditorStyles => {\n  return {\n    queryField: css`\n      border-radius: ${theme.shape.borderRadius()};\n      border: 1px solid ${theme.components.input.borderColor};\n      flex: 1;\n    `,\n    placeholder: css`\n      ::after {\n        content: '${placeholder}';\n        font-family: ${theme.typography.fontFamilyMonospace};\n        opacity: 0.3;\n      }\n    `,\n  };\n};\n","import { css } from '@emotion/css';\nimport { defaults } from 'lodash';\nimport React from 'react';\n\nimport { QueryEditorProps } from '@grafana/data';\nimport { InlineLabel, useStyles2 } from '@grafana/ui';\n\nimport { TempoDatasource } from '../datasource';\nimport { defaultQuery, MyDataSourceOptions, TempoQuery } from '../types';\n\nimport { TempoQueryBuilderOptions } from './TempoQueryBuilderOptions';\nimport { TraceQLEditor } from './TraceQLEditor';\n\ntype Props = QueryEditorProps<TempoDatasource, TempoQuery, MyDataSourceOptions>;\n\nexport function QueryEditor(props: Props) {\n  const styles = useStyles2(getStyles);\n  const query = defaults(props.query, defaultQuery);\n\n  const onEditorChange = (value: string) => {\n    props.onChange({ ...query, query: value });\n  };\n\n  return (\n    <>\n      <InlineLabel>\n        Build complex queries using TraceQL to select a list of traces.{' '}\n        <a\n          rel=\"noreferrer\"\n          target=\"_blank\"\n          href=\"https://github.com/grafana/tempo/blob/main/docs/design-proposals/2022-04%20TraceQL%20Concepts.md\"\n        >\n          Documentation\n        </a>\n      </InlineLabel>\n      <TraceQLEditor\n        placeholder=\"Enter a TraceQL query (run with Shift+Enter)\"\n        value={query.query}\n        onChange={onEditorChange}\n        datasource={props.datasource}\n        onRunQuery={props.onRunQuery}\n      />\n      <div className={styles.optionsContainer}>\n        <TempoQueryBuilderOptions query={query} onChange={props.onChange} />\n      </div>\n    </>\n  );\n}\n\nconst getStyles = () => ({\n  optionsContainer: css`\n    margin-top: 10px;\n  `,\n});\n","import { Grammar } from 'prismjs';\n\nexport const tokenizer: Grammar = {\n  key: {\n    pattern: /[^\\s]+(?==)/,\n    alias: 'attr-name',\n  },\n  operator: /[=]/,\n  value: [\n    {\n      pattern: /\"(.+)\"/,\n    },\n    {\n      pattern: /[^\\s]+/,\n    },\n  ],\n};\n","import { css } from '@emotion/css';\nimport Prism from 'prismjs';\nimport React, { useCallback, useState, useEffect, useMemo } from 'react';\nimport { Node } from 'slate';\n\nimport { GrafanaTheme2, isValidGoDuration, SelectableValue, toOption } from '@grafana/data';\nimport { FetchError, getTemplateSrv, isFetchError, TemplateSrv } from '@grafana/runtime';\nimport {\n  InlineFieldRow,\n  InlineField,\n  Input,\n  QueryField,\n  SlatePrism,\n  BracesPlugin,\n  TypeaheadInput,\n  TypeaheadOutput,\n  Alert,\n  useStyles2,\n  fuzzyMatch,\n  Select,\n} from '@grafana/ui';\nimport { notifyApp } from 'app/core/actions';\nimport { createErrorNotification } from 'app/core/copy/appNotification';\nimport { dispatch } from 'app/store/store';\n\nimport { DEFAULT_LIMIT, TempoDatasource } from '../datasource';\nimport TempoLanguageProvider from '../language_provider';\nimport { tokenizer } from '../syntax';\nimport { TempoQuery } from '../types';\n\ninterface Props {\n  datasource: TempoDatasource;\n  query: TempoQuery;\n  onChange: (value: TempoQuery) => void;\n  onBlur?: () => void;\n  onRunQuery: () => void;\n}\n\nconst PRISM_LANGUAGE = 'tempo';\nconst durationPlaceholder = 'e.g. 1.2s, 100ms';\nconst plugins = [\n  BracesPlugin(),\n  SlatePrism({\n    onlyIn: (node: Node) => node.object === 'block' && node.type === 'code_block',\n    getSyntax: () => PRISM_LANGUAGE,\n  }),\n];\n\nPrism.languages[PRISM_LANGUAGE] = tokenizer;\n\nconst NativeSearch = ({ datasource, query, onChange, onBlur, onRunQuery }: Props) => {\n  const styles = useStyles2(getStyles);\n  const languageProvider = useMemo(() => new TempoLanguageProvider(datasource), [datasource]);\n  const [hasSyntaxLoaded, setHasSyntaxLoaded] = useState(false);\n  const [serviceOptions, setServiceOptions] = useState<Array<SelectableValue<string>>>();\n  const [spanOptions, setSpanOptions] = useState<Array<SelectableValue<string>>>();\n  const [error, setError] = useState<Error | FetchError | null>(null);\n  const [inputErrors, setInputErrors] = useState<{ [key: string]: boolean }>({});\n  const [isLoading, setIsLoading] = useState<{\n    serviceName: boolean;\n    spanName: boolean;\n  }>({\n    serviceName: false,\n    spanName: false,\n  });\n\n  const loadOptions = useCallback(\n    async (name: string, query = '') => {\n      const lpName = name === 'serviceName' ? 'service.name' : 'name';\n      setIsLoading((prevValue) => ({ ...prevValue, [name]: true }));\n\n      try {\n        const options = await languageProvider.getOptions(lpName);\n        const filteredOptions = options.filter((item) => (item.value ? fuzzyMatch(item.value, query).found : false));\n        return filteredOptions;\n      } catch (error) {\n        if (isFetchError(error) && error?.status === 404) {\n          setError(error);\n        } else if (error instanceof Error) {\n          dispatch(notifyApp(createErrorNotification('Error', error)));\n        }\n        return [];\n      } finally {\n        setIsLoading((prevValue) => ({ ...prevValue, [name]: false }));\n      }\n    },\n    [languageProvider]\n  );\n\n  useEffect(() => {\n    const fetchOptions = async () => {\n      try {\n        const [services, spans] = await Promise.all([loadOptions('serviceName'), loadOptions('spanName')]);\n        if (query.serviceName && getTemplateSrv().containsTemplate(query.serviceName)) {\n          services.push(toOption(query.serviceName));\n        }\n        setServiceOptions(services);\n        if (query.spanName && getTemplateSrv().containsTemplate(query.spanName)) {\n          spans.push(toOption(query.spanName));\n        }\n        setSpanOptions(spans);\n      } catch (error) {\n        // Display message if Tempo is connected but search 404's\n        if (isFetchError(error) && error?.status === 404) {\n          setError(error);\n        } else if (error instanceof Error) {\n          dispatch(notifyApp(createErrorNotification('Error', error)));\n        }\n      }\n    };\n    fetchOptions();\n  }, [languageProvider, loadOptions, query.serviceName, query.spanName]);\n\n  useEffect(() => {\n    const fetchTags = async () => {\n      try {\n        await languageProvider.start();\n        setHasSyntaxLoaded(true);\n      } catch (error) {\n        if (error instanceof Error) {\n          dispatch(notifyApp(createErrorNotification('Error', error)));\n        }\n      }\n    };\n    fetchTags();\n  }, [languageProvider]);\n\n  const onTypeahead = useCallback(\n    async (typeahead: TypeaheadInput): Promise<TypeaheadOutput> => {\n      return await languageProvider.provideCompletionItems(typeahead);\n    },\n    [languageProvider]\n  );\n\n  const cleanText = useCallback((text: string) => {\n    const splittedText = text.split(/\\s+(?=([^\"]*\"[^\"]*\")*[^\"]*$)/g);\n    if (splittedText.length > 1) {\n      return splittedText[splittedText.length - 1];\n    }\n    return text;\n  }, []);\n\n  const onKeyDown = (keyEvent: React.KeyboardEvent) => {\n    if (keyEvent.key === 'Enter' && (keyEvent.shiftKey || keyEvent.ctrlKey)) {\n      onRunQuery();\n    }\n  };\n\n  const handleOnChange = useCallback(\n    (value) => {\n      onChange({\n        ...query,\n        search: value,\n      });\n    },\n    [onChange, query]\n  );\n\n  const templateSrv: TemplateSrv = getTemplateSrv();\n\n  return (\n    <>\n      <div className={styles.container}>\n        <InlineFieldRow>\n          <InlineField label=\"Service Name\" labelWidth={14} grow>\n            <Select\n              inputId=\"service\"\n              options={serviceOptions}\n              onOpenMenu={() => {\n                loadOptions('serviceName');\n              }}\n              isLoading={isLoading.serviceName}\n              value={serviceOptions?.find((v) => v?.value === query.serviceName) || query.serviceName}\n              onChange={(v) => {\n                onChange({\n                  ...query,\n                  serviceName: v?.value,\n                });\n              }}\n              placeholder=\"Select a service\"\n              isClearable\n              onKeyDown={onKeyDown}\n              aria-label={'select-service-name'}\n              allowCustomValue={true}\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField label=\"Span Name\" labelWidth={14} grow>\n            <Select\n              inputId=\"spanName\"\n              options={spanOptions}\n              onOpenMenu={() => {\n                loadOptions('spanName');\n              }}\n              isLoading={isLoading.spanName}\n              value={spanOptions?.find((v) => v?.value === query.spanName) || query.spanName}\n              onChange={(v) => {\n                onChange({\n                  ...query,\n                  spanName: v?.value,\n                });\n              }}\n              placeholder=\"Select a span\"\n              isClearable\n              onKeyDown={onKeyDown}\n              aria-label={'select-span-name'}\n              allowCustomValue={true}\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField label=\"Tags\" labelWidth={14} grow tooltip=\"Values should be in logfmt.\">\n            <QueryField\n              additionalPlugins={plugins}\n              query={query.search}\n              onTypeahead={onTypeahead}\n              onBlur={onBlur}\n              onChange={handleOnChange}\n              cleanText={cleanText}\n              placeholder=\"http.status_code=200 error=true\"\n              onRunQuery={onRunQuery}\n              syntaxLoaded={hasSyntaxLoaded}\n              portalOrigin=\"tempo\"\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField label=\"Min Duration\" invalid={!!inputErrors.minDuration} labelWidth={14} grow>\n            <Input\n              id=\"minDuration\"\n              value={query.minDuration || ''}\n              placeholder={durationPlaceholder}\n              onBlur={() => {\n                const templatedMinDuration = templateSrv.replace(query.minDuration ?? '');\n                if (query.minDuration && !isValidGoDuration(templatedMinDuration)) {\n                  setInputErrors({ ...inputErrors, minDuration: true });\n                } else {\n                  setInputErrors({ ...inputErrors, minDuration: false });\n                }\n              }}\n              onChange={(v) =>\n                onChange({\n                  ...query,\n                  minDuration: v.currentTarget.value,\n                })\n              }\n              onKeyDown={onKeyDown}\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField label=\"Max Duration\" invalid={!!inputErrors.maxDuration} labelWidth={14} grow>\n            <Input\n              id=\"maxDuration\"\n              value={query.maxDuration || ''}\n              placeholder={durationPlaceholder}\n              onBlur={() => {\n                const templatedMaxDuration = templateSrv.replace(query.maxDuration ?? '');\n                if (query.maxDuration && !isValidGoDuration(templatedMaxDuration)) {\n                  setInputErrors({ ...inputErrors, maxDuration: true });\n                } else {\n                  setInputErrors({ ...inputErrors, maxDuration: false });\n                }\n              }}\n              onChange={(v) =>\n                onChange({\n                  ...query,\n                  maxDuration: v.currentTarget.value,\n                })\n              }\n              onKeyDown={onKeyDown}\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField\n            label=\"Limit\"\n            invalid={!!inputErrors.limit}\n            labelWidth={14}\n            grow\n            tooltip=\"Maximum number of returned results\"\n          >\n            <Input\n              id=\"limit\"\n              value={query.limit || ''}\n              placeholder={`Default: ${DEFAULT_LIMIT}`}\n              type=\"number\"\n              onChange={(v) => {\n                let limit = v.currentTarget.value ? parseInt(v.currentTarget.value, 10) : undefined;\n                if (limit && (!Number.isInteger(limit) || limit <= 0)) {\n                  setInputErrors({ ...inputErrors, limit: true });\n                } else {\n                  setInputErrors({ ...inputErrors, limit: false });\n                }\n\n                onChange({\n                  ...query,\n                  limit: v.currentTarget.value ? parseInt(v.currentTarget.value, 10) : undefined,\n                });\n              }}\n              onKeyDown={onKeyDown}\n            />\n          </InlineField>\n        </InlineFieldRow>\n      </div>\n      {error ? (\n        <Alert title=\"Unable to connect to Tempo search\" severity=\"info\" className={styles.alert}>\n          Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can\n          configure it in the <a href={`/datasources/edit/${datasource.uid}`}>datasource settings</a>.\n        </Alert>\n      ) : null}\n    </>\n  );\n};\n\nexport default NativeSearch;\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  container: css`\n    max-width: 500px;\n  `,\n  alert: css`\n    max-width: 75ch;\n    margin-top: ${theme.spacing(2)};\n  `,\n});\n","import { DataSourceApi } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\n\nexport async function getDS(uid?: string): Promise<DataSourceApi | undefined> {\n  if (!uid) {\n    return undefined;\n  }\n\n  const dsSrv = getDataSourceSrv();\n  try {\n    return await dsSrv.get(uid);\n  } catch (error) {\n    console.error('Failed to load data source', error);\n    return undefined;\n  }\n}\n","import { css } from '@emotion/css';\nimport React, { useEffect, useState } from 'react';\nimport useAsync from 'react-use/lib/useAsync';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport { Alert, InlineField, InlineFieldRow, useStyles2 } from '@grafana/ui';\n\nimport { AdHocFilter } from '../../../../features/variables/adhoc/picker/AdHocFilter';\nimport { AdHocVariableFilter } from '../../../../features/variables/types';\nimport { PrometheusDatasource } from '../../prometheus/datasource';\nimport { TempoQuery } from '../types';\n\nimport { getDS } from './utils';\n\nexport function ServiceGraphSection({\n  graphDatasourceUid,\n  query,\n  onChange,\n}: {\n  graphDatasourceUid?: string;\n  query: TempoQuery;\n  onChange: (value: TempoQuery) => void;\n}) {\n  const styles = useStyles2(getStyles);\n\n  const dsState = useAsync(() => getDS(graphDatasourceUid), [graphDatasourceUid]);\n\n  // Check if service graph metrics are being collected. If not, displays a warning\n  const [hasKeys, setHasKeys] = useState<boolean | undefined>(undefined);\n  useEffect(() => {\n    async function fn(ds: PrometheusDatasource) {\n      const keys = await ds.getTagKeys({\n        series: [\n          'traces_service_graph_request_server_seconds_sum',\n          'traces_service_graph_request_total',\n          'traces_service_graph_request_failed_total',\n        ],\n      });\n      setHasKeys(Boolean(keys.length));\n    }\n    if (!dsState.loading && dsState.value) {\n      fn(dsState.value as PrometheusDatasource);\n    }\n  }, [dsState]);\n\n  if (dsState.loading) {\n    return null;\n  }\n\n  const ds = dsState.value as PrometheusDatasource;\n\n  if (!graphDatasourceUid) {\n    return <div className=\"text-warning\">Please set up a service graph datasource in the datasource settings.</div>;\n  }\n\n  if (graphDatasourceUid && !ds) {\n    return (\n      <div className=\"text-warning\">\n        Service graph datasource is configured but the data source no longer exists. Please configure existing data\n        source to use the service graph functionality.\n      </div>\n    );\n  }\n  const filters = queryToFilter(query.serviceMapQuery || '');\n\n  return (\n    <div>\n      <InlineFieldRow>\n        <InlineField label=\"Filter\" labelWidth={14} grow>\n          <AdHocFilter\n            datasource={{ uid: graphDatasourceUid }}\n            filters={filters}\n            getTagKeysOptions={{\n              series: config.featureToggles.tempoApmTable\n                ? ['traces_service_graph_request_total', 'traces_spanmetrics_calls_total']\n                : ['traces_service_graph_request_total'],\n            }}\n            addFilter={(filter: AdHocVariableFilter) => {\n              onChange({\n                ...query,\n                serviceMapQuery: filtersToQuery([...filters, filter]),\n              });\n            }}\n            removeFilter={(index: number) => {\n              const newFilters = [...filters];\n              newFilters.splice(index, 1);\n              onChange({ ...query, serviceMapQuery: filtersToQuery(newFilters) });\n            }}\n            changeFilter={(index: number, filter: AdHocVariableFilter) => {\n              const newFilters = [...filters];\n              newFilters.splice(index, 1, filter);\n              onChange({ ...query, serviceMapQuery: filtersToQuery(newFilters) });\n            }}\n          />\n        </InlineField>\n      </InlineFieldRow>\n      {hasKeys === false ? (\n        <Alert title=\"No service graph data found\" severity=\"info\" className={styles.alert}>\n          Please ensure that service graph metrics are set up correctly according to the{' '}\n          <a\n            target=\"_blank\"\n            rel=\"noreferrer noopener\"\n            href=\"https://grafana.com/docs/tempo/next/grafana-agent/service-graphs/\"\n          >\n            Tempo documentation\n          </a>\n          .\n        </Alert>\n      ) : null}\n    </div>\n  );\n}\n\nfunction queryToFilter(query: string): AdHocVariableFilter[] {\n  let match;\n  let filters: AdHocVariableFilter[] = [];\n  const re = /([\\w_]+)(=|!=|<|>|=~|!~)\"(.*?)\"/g;\n  while ((match = re.exec(query)) !== null) {\n    filters.push({\n      key: match[1],\n      operator: match[2],\n      value: match[3],\n      condition: '',\n    });\n  }\n  return filters;\n}\n\nfunction filtersToQuery(filters: AdHocVariableFilter[]): string {\n  return `{${filters.map((f) => `${f.key}${f.operator}\"${f.value}\"`).join(',')}}`;\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  alert: css`\n    max-width: 75ch;\n    margin-top: ${theme.spacing(2)};\n  `,\n});\n","import { css } from '@emotion/css';\nimport React from 'react';\nimport useAsync from 'react-use/lib/useAsync';\n\nimport { QueryEditorProps, SelectableValue } from '@grafana/data';\nimport { config, reportInteraction } from '@grafana/runtime';\nimport {\n  FileDropzone,\n  InlineField,\n  InlineFieldRow,\n  InlineLabel,\n  QueryField,\n  RadioButtonGroup,\n  Themeable2,\n  withTheme2,\n} from '@grafana/ui';\n\nimport { LokiQueryField } from '../../loki/components/LokiQueryField';\nimport { LokiDatasource } from '../../loki/datasource';\nimport { LokiQuery } from '../../loki/types';\nimport { TempoDatasource } from '../datasource';\nimport { QueryEditor } from '../traceql/QueryEditor';\nimport { TempoQuery, TempoQueryType } from '../types';\n\nimport NativeSearch from './NativeSearch';\nimport { ServiceGraphSection } from './ServiceGraphSection';\nimport { getDS } from './utils';\n\ninterface Props extends QueryEditorProps<TempoDatasource, TempoQuery>, Themeable2 {}\n\nconst DEFAULT_QUERY_TYPE: TempoQueryType = 'traceId';\n\nclass TempoQueryFieldComponent extends React.PureComponent<Props> {\n  constructor(props: Props) {\n    super(props);\n  }\n\n  // Set the default query type when the component mounts.\n  // Also do this if queryType is 'clear' (which is the case when the user changes the query type)\n  // otherwise if the user changes the query type and refreshes the page, no query type will be selected\n  // which is inconsistent with how the UI was originally when they selected the Tempo data source.\n  async componentDidMount() {\n    if (!this.props.query.queryType || this.props.query.queryType === 'clear') {\n      this.props.onChange({\n        ...this.props.query,\n        queryType: DEFAULT_QUERY_TYPE,\n      });\n    }\n  }\n\n  onChangeLinkedQuery = (value: LokiQuery) => {\n    const { query, onChange } = this.props;\n    onChange({\n      ...query,\n      linkedQuery: { ...value, refId: 'linked' },\n    });\n  };\n\n  onRunLinkedQuery = () => {\n    this.props.onRunQuery();\n  };\n\n  onClearResults = () => {\n    // Run clear query to clear results\n    const { onChange, query, onRunQuery } = this.props;\n    onChange({\n      ...query,\n      queryType: 'clear',\n    });\n    onRunQuery();\n  };\n\n  render() {\n    const { query, onChange, datasource, app } = this.props;\n\n    const logsDatasourceUid = datasource.getLokiSearchDS();\n\n    const graphDatasourceUid = datasource.serviceMap?.datasourceUid;\n\n    const queryTypeOptions: Array<SelectableValue<TempoQueryType>> = [\n      { value: 'traceId', label: 'TraceID' },\n      { value: 'upload', label: 'JSON File' },\n      { value: 'serviceMap', label: 'Service Graph' },\n    ];\n\n    if (!datasource?.search?.hide) {\n      queryTypeOptions.unshift({ value: 'nativeSearch', label: 'Search' });\n    }\n\n    if (logsDatasourceUid) {\n      if (datasource?.search?.hide) {\n        // Place at beginning as Search if no native search\n        queryTypeOptions.unshift({ value: 'search', label: 'Search' });\n      } else {\n        // Place at end as Loki Search if native search is enabled\n        queryTypeOptions.push({ value: 'search', label: 'Loki Search' });\n      }\n    }\n\n    if (config.featureToggles.traceqlEditor) {\n      queryTypeOptions.push({ value: 'traceql', label: 'TraceQL' });\n    }\n\n    return (\n      <>\n        <InlineFieldRow>\n          <InlineField label=\"Query type\">\n            <RadioButtonGroup<TempoQueryType>\n              options={queryTypeOptions}\n              value={query.queryType}\n              onChange={(v) => {\n                reportInteraction('grafana_traces_query_type_changed', {\n                  datasourceType: 'tempo',\n                  app: app ?? '',\n                  newQueryType: v,\n                  previousQueryType: query.queryType ?? '',\n                });\n\n                this.onClearResults();\n\n                onChange({\n                  ...query,\n                  queryType: v,\n                });\n              }}\n              size=\"md\"\n            />\n          </InlineField>\n        </InlineFieldRow>\n        {query.queryType === 'search' && (\n          <SearchSection\n            logsDatasourceUid={logsDatasourceUid}\n            query={query}\n            onRunQuery={this.onRunLinkedQuery}\n            onChange={this.onChangeLinkedQuery}\n          />\n        )}\n        {query.queryType === 'nativeSearch' && (\n          <NativeSearch\n            datasource={this.props.datasource}\n            query={query}\n            onChange={onChange}\n            onBlur={this.props.onBlur}\n            onRunQuery={this.props.onRunQuery}\n          />\n        )}\n        {query.queryType === 'upload' && (\n          <div className={css({ padding: this.props.theme.spacing(2) })}>\n            <FileDropzone\n              options={{ multiple: false }}\n              onLoad={(result) => {\n                this.props.datasource.uploadedJson = result;\n                this.props.onRunQuery();\n              }}\n            />\n          </div>\n        )}\n        {query.queryType === 'traceId' && (\n          <InlineFieldRow>\n            <InlineField label=\"Trace ID\" labelWidth={14} grow>\n              <QueryField\n                query={query.query}\n                onChange={(val) => {\n                  onChange({\n                    ...query,\n                    query: val,\n                    queryType: 'traceId',\n                    linkedQuery: undefined,\n                  });\n                }}\n                onBlur={this.props.onBlur}\n                onRunQuery={this.props.onRunQuery}\n                placeholder={'Enter a Trace ID (run with Shift+Enter)'}\n                portalOrigin=\"tempo\"\n              />\n            </InlineField>\n          </InlineFieldRow>\n        )}\n        {query.queryType === 'serviceMap' && (\n          <ServiceGraphSection graphDatasourceUid={graphDatasourceUid} query={query} onChange={onChange} />\n        )}\n        {query.queryType === 'traceql' && (\n          <QueryEditor\n            datasource={this.props.datasource}\n            query={query}\n            onRunQuery={this.props.onRunQuery}\n            onChange={onChange}\n          />\n        )}\n      </>\n    );\n  }\n}\n\ninterface SearchSectionProps {\n  logsDatasourceUid?: string;\n  onChange: (value: LokiQuery) => void;\n  onRunQuery: () => void;\n  query: TempoQuery;\n}\nfunction SearchSection({ logsDatasourceUid, onChange, onRunQuery, query }: SearchSectionProps) {\n  const dsState = useAsync(() => getDS(logsDatasourceUid), [logsDatasourceUid]);\n  if (dsState.loading) {\n    return null;\n  }\n\n  const ds = dsState.value as LokiDatasource;\n\n  if (ds) {\n    return (\n      <>\n        <InlineLabel>Tempo uses {ds.name} to find traces.</InlineLabel>\n        <LokiQueryField\n          datasource={ds}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          query={query.linkedQuery ?? ({ refId: 'linked' } as any)}\n          history={[]}\n        />\n      </>\n    );\n  }\n\n  if (!logsDatasourceUid) {\n    return <div className=\"text-warning\">Please set up a Loki search datasource in the datasource settings.</div>;\n  }\n\n  if (logsDatasourceUid && !ds) {\n    return (\n      <div className=\"text-warning\">\n        Loki search datasource is configured but the data source no longer exists. Please configure existing data source\n        to use the search.\n      </div>\n    );\n  }\n\n  return null;\n}\n\nexport const TempoQueryField = withTheme2(TempoQueryFieldComponent);\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { DataSourcePluginOptionsEditorProps, GrafanaTheme2, updateDatasourcePluginJsonDataOption } from '@grafana/data';\nimport { DataSourcePicker } from '@grafana/runtime';\nimport { Button, InlineField, InlineFieldRow, useStyles2 } from '@grafana/ui';\n\nimport { TempoJsonData } from '../types';\n\ninterface Props extends DataSourcePluginOptionsEditorProps<TempoJsonData> {}\n\nexport function LokiSearchSettings({ options, onOptionsChange }: Props) {\n  const styles = useStyles2(getStyles);\n\n  // Default to the trace to logs datasource if configured and loki search was enabled\n  // but only if jsonData.lokiSearch hasn't been set\n  const legacyDatasource =\n    options.jsonData.tracesToLogs?.lokiSearch !== false ? options.jsonData.tracesToLogs?.datasourceUid : undefined;\n  if (legacyDatasource && options.jsonData.lokiSearch === undefined) {\n    updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'lokiSearch', {\n      datasourceUid: legacyDatasource,\n    });\n  }\n\n  return (\n    <div className={css({ width: '100%' })}>\n      <h3 className=\"page-heading\">Loki Search</h3>\n\n      <div className={styles.infoText}>\n        Select a Loki datasource to search for traces. Derived fields must be configured in the Loki data source.\n      </div>\n\n      <InlineFieldRow className={styles.row}>\n        <InlineField tooltip=\"The Loki data source with the service graph data\" label=\"Data source\" labelWidth={26}>\n          <DataSourcePicker\n            inputId=\"loki-search-data-source-picker\"\n            pluginId=\"loki\"\n            current={options.jsonData.lokiSearch?.datasourceUid}\n            noDefault={true}\n            width={40}\n            onChange={(ds) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'lokiSearch', {\n                datasourceUid: ds.uid,\n              })\n            }\n          />\n        </InlineField>\n        {options.jsonData.lokiSearch?.datasourceUid ? (\n          <Button\n            type={'button'}\n            variant={'secondary'}\n            size={'sm'}\n            fill={'text'}\n            onClick={() => {\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'lokiSearch', {\n                datasourceUid: undefined,\n              });\n            }}\n          >\n            Clear\n          </Button>\n        ) : null}\n      </InlineFieldRow>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  infoText: css`\n    label: infoText;\n    padding-bottom: ${theme.spacing(2)};\n    color: ${theme.colors.text.secondary};\n  `,\n\n  row: css`\n    label: row;\n    align-items: baseline;\n  `,\n});\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { DataSourcePluginOptionsEditorProps, updateDatasourcePluginJsonDataOption } from '@grafana/data';\nimport { InlineField, InlineFieldRow, InlineSwitch, Input, useStyles2 } from '@grafana/ui';\n\nimport { TempoJsonData } from '../types';\n\ninterface Props extends DataSourcePluginOptionsEditorProps<TempoJsonData> {}\n\nexport function QuerySettings({ options, onOptionsChange }: Props) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.container}>\n      <h3 className=\"page-heading\">TraceID Query</h3>\n      <InlineField\n        label=\"Use time range in query\"\n        tooltip=\"The time range is ignored by default when querying by TraceID but can be used when there are performance issues or timeouts since it will narrow down the search to the defined range. Default is disabled.\"\n        labelWidth={26}\n      >\n        <InlineSwitch\n          id=\"enable-time-shift\"\n          value={options.jsonData.traceQuery?.timeShiftEnabled || false}\n          onChange={(event) => {\n            updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'traceQuery', {\n              ...options.jsonData.traceQuery,\n              timeShiftEnabled: event.currentTarget.checked,\n            });\n          }}\n        />\n      </InlineField>\n      <InlineFieldRow>\n        <InlineField\n          label=\"Time shift for start of search\"\n          labelWidth={26}\n          disabled={!options.jsonData.traceQuery?.timeShiftEnabled}\n          grow\n          tooltip=\"Shifts the start of the time range when searching by TraceID. This is needed as searching for traces can return traces that do not fully fall into the search time range, so we recommend using higher time shifts for longer traces. Default 30m (Time units can be used here, for example: 5s, 1m, 3h)\"\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"30m\"\n            width={40}\n            onChange={(v) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'traceQuery', {\n                ...options.jsonData.traceQuery,\n                spanStartTimeShift: v.currentTarget.value,\n              })\n            }\n            value={options.jsonData.traceQuery?.spanStartTimeShift || ''}\n          />\n        </InlineField>\n      </InlineFieldRow>\n      <InlineFieldRow>\n        <InlineField\n          label=\"Time shift for end of search\"\n          labelWidth={26}\n          disabled={!options.jsonData.traceQuery?.timeShiftEnabled}\n          grow\n          tooltip=\"Shifts the end of the time range when searching by TraceID. This is needed as searching for traces can return traces that do not fully fall into the search time range, so we recommend using higher time shifts for longer traces. Default 30m (Time units can be used here, for example: 5s, 1m, 3h)\"\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"30m\"\n            width={40}\n            onChange={(v) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'traceQuery', {\n                ...options.jsonData.traceQuery,\n                spanEndTimeShift: v.currentTarget.value,\n              })\n            }\n            value={options.jsonData.traceQuery?.spanEndTimeShift || ''}\n          />\n        </InlineField>\n      </InlineFieldRow>\n    </div>\n  );\n}\n\nconst getStyles = () => ({\n  container: css`\n    label: container;\n    width: 100%;\n  `,\n  row: css`\n    label: row;\n    align-items: baseline;\n  `,\n});\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { DataSourcePluginOptionsEditorProps, updateDatasourcePluginJsonDataOption } from '@grafana/data';\nimport { InlineField, InlineFieldRow, InlineSwitch, useStyles2 } from '@grafana/ui';\n\nimport { TempoJsonData } from '../types';\n\ninterface Props extends DataSourcePluginOptionsEditorProps<TempoJsonData> {}\n\nexport function SearchSettings({ options, onOptionsChange }: Props) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.container}>\n      <h3 className=\"page-heading\">Search</h3>\n      <InlineFieldRow className={styles.row}>\n        <InlineField tooltip=\"Removes the Search tab from the Tempo query editor.\" label=\"Hide search\" labelWidth={26}>\n          <InlineSwitch\n            id=\"hideSearch\"\n            value={options.jsonData.search?.hide}\n            onChange={(event: React.SyntheticEvent<HTMLInputElement>) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'search', {\n                ...options.jsonData.search,\n                hide: event.currentTarget.checked,\n              })\n            }\n          />\n        </InlineField>\n      </InlineFieldRow>\n    </div>\n  );\n}\n\nconst getStyles = () => ({\n  container: css`\n    label: container;\n    width: 100%;\n  `,\n  row: css`\n    label: row;\n    align-items: baseline;\n  `,\n});\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { DataSourcePluginOptionsEditorProps, GrafanaTheme2, updateDatasourcePluginJsonDataOption } from '@grafana/data';\nimport { DataSourcePicker } from '@grafana/runtime';\nimport { Button, InlineField, InlineFieldRow, useStyles2 } from '@grafana/ui';\n\nimport { TempoJsonData } from '../types';\n\ninterface Props extends DataSourcePluginOptionsEditorProps<TempoJsonData> {}\n\nexport function ServiceGraphSettings({ options, onOptionsChange }: Props) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={css({ width: '100%' })}>\n      <h3 className=\"page-heading\">Service Graph</h3>\n\n      <div className={styles.infoText}>\n        To allow querying service graph data you have to select a Prometheus instance where the data is stored.\n      </div>\n\n      <InlineFieldRow className={styles.row}>\n        <InlineField\n          tooltip=\"The Prometheus data source with the service graph data\"\n          label=\"Data source\"\n          labelWidth={26}\n        >\n          <DataSourcePicker\n            inputId=\"service-graph-data-source-picker\"\n            pluginId=\"prometheus\"\n            current={options.jsonData.serviceMap?.datasourceUid}\n            noDefault={true}\n            width={40}\n            onChange={(ds) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'serviceMap', {\n                datasourceUid: ds.uid,\n              })\n            }\n          />\n        </InlineField>\n        {options.jsonData.serviceMap?.datasourceUid ? (\n          <Button\n            type={'button'}\n            variant={'secondary'}\n            size={'sm'}\n            fill={'text'}\n            onClick={() => {\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'serviceMap', {\n                datasourceUid: undefined,\n              });\n            }}\n          >\n            Clear\n          </Button>\n        ) : null}\n      </InlineFieldRow>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  infoText: css`\n    label: infoText;\n    padding-bottom: ${theme.spacing(2)};\n    color: ${theme.colors.text.secondary};\n  `,\n\n  row: css`\n    label: row;\n    align-items: baseline;\n  `,\n});\n","import { DataSourcePlugin } from '@grafana/data';\n\nimport CheatSheet from './CheatSheet';\nimport { TempoQueryField } from './QueryEditor/QueryField';\nimport { ConfigEditor } from './configuration/ConfigEditor';\nimport { TempoDatasource } from './datasource';\n\nexport const plugin = new DataSourcePlugin(TempoDatasource)\n  .setQueryEditor(TempoQueryField)\n  .setConfigEditor(ConfigEditor)\n  .setQueryEditorHelp(CheatSheet);\n","import React from 'react';\n\nimport { DataSourcePluginOptionsEditorProps } from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport { DataSourceHttpSettings } from '@grafana/ui';\nimport { SpanBarSettings } from '@jaegertracing/jaeger-ui-components';\nimport { NodeGraphSettings } from 'app/core/components/NodeGraphSettings';\nimport { TraceToLogsSettings } from 'app/core/components/TraceToLogs/TraceToLogsSettings';\nimport { TraceToMetricsSettings } from 'app/core/components/TraceToMetrics/TraceToMetricsSettings';\n\nimport { LokiSearchSettings } from './LokiSearchSettings';\nimport { QuerySettings } from './QuerySettings';\nimport { SearchSettings } from './SearchSettings';\nimport { ServiceGraphSettings } from './ServiceGraphSettings';\n\nexport type Props = DataSourcePluginOptionsEditorProps;\n\nexport const ConfigEditor = ({ options, onOptionsChange }: Props) => {\n  return (\n    <>\n      <DataSourceHttpSettings\n        defaultUrl=\"http://tempo\"\n        dataSourceConfig={options}\n        showAccessOptions={false}\n        onChange={onOptionsChange}\n      />\n\n      <div className=\"gf-form-group\">\n        <TraceToLogsSettings options={options} onOptionsChange={onOptionsChange} />\n      </div>\n\n      {config.featureToggles.traceToMetrics ? (\n        <div className=\"gf-form-group\">\n          <TraceToMetricsSettings options={options} onOptionsChange={onOptionsChange} />\n        </div>\n      ) : null}\n\n      <div className=\"gf-form-group\">\n        <ServiceGraphSettings options={options} onOptionsChange={onOptionsChange} />\n      </div>\n\n      <div className=\"gf-form-group\">\n        <SearchSettings options={options} onOptionsChange={onOptionsChange} />\n      </div>\n\n      <div className=\"gf-form-group\">\n        <NodeGraphSettings options={options} onOptionsChange={onOptionsChange} />\n      </div>\n\n      <div className=\"gf-form-group\">\n        <LokiSearchSettings options={options} onOptionsChange={onOptionsChange} />\n      </div>\n\n      <div className=\"gf-form-group\">\n        <QuerySettings options={options} onOptionsChange={onOptionsChange} />\n      </div>\n\n      <div className=\"gf-form-group\">\n        <SpanBarSettings options={options} onOptionsChange={onOptionsChange} />\n      </div>\n    </>\n  );\n};\n","import React from 'react';\n\nexport default function CheatSheet() {\n  return (\n    <div>\n      <h2 id=\"tempo-cheat-sheet\">Tempo Cheat Sheet</h2>\n      <p>\n        Tempo is a trace id lookup store. Enter a trace id in the above field and hit Run Query to retrieve your\n        trace. Tempo is generally paired with other datasources such as Loki or Prometheus to find traces.\n      </p>\n      <p>\n        Here are some{' '}\n        <a href=\"https://grafana.com/docs/tempo/latest/guides/instrumentation/\" target=\"blank\">\n          instrumentation examples\n        </a>{' '}\n        to get you started with trace discovery through logs and metrics (exemplars).\n      </p>\n    </div>\n  );\n}\n"],"names":["QueryOptionGroup","title","children","collapsedInfo","isOpen","toggleOpen","useToggle","styles","useStyles2","getStyles","Stack","gap","direction","className","header","onClick","toggle","name","description","map","x","i","body","theme","switchLabel","css","color","colors","text","secondary","cursor","fontSize","typography","bodySmall","primary","display","alignItems","background","emphasize","flexGrow","overflow","fontWeight","fontWeightMedium","margin","paddingLeft","spacing","paddingTop","flexWrap","marginRight","defaultQuery","SpanKind","TempoLanguageProvider","LanguageProvider","constructor","datasource","initialValues","super","async","url","params","res","metadataRequest","data","this","startTask","fetchTags","then","tags","value","suggestions","query","endText","getText","indexOf","getTagValueCompletionItems","getTagsCompletionItems","length","push","label","items","tag","Object","assign","response","request","tagNames","split","tagName","tagValues","tagValue","insertText","options","v","TempoDatasource","DataSourceWithBackend","instanceSettings","templateSrv","getTemplateSrv","legacyLogsDatasourceUid","tracesToLogs","lokiSearch","undefined","datasourceUid","jsonData","serviceMap","search","nodeGraph","traceQuery","languageProvider","subQueries","filteredTargets","targets","filter","target","hide","groupBy","t","queryType","clear","of","state","LoadingState","logsDatasourceUid","getLokiSearchDS","reportInteraction","datasourceType","app","linkedQueryExpr","linkedQuery","expr","dsSrv","getDatasourceSrv","from","get","pipe","mergeMap","linkedDatasource","linkedRequest","traceLinkMatcher","derivedFields","field","uid","matcherRegex","error","transformTraceList","throwError","Error","nativeSearch","serviceName","spanName","resultLimit","limit","timeRange","startTime","range","unix","endTime","to","applyVariables","scopedVars","searchQuery","buildSearchQuery","_request","createTableFrameFromSearch","traces","catchError","message","traceql","q","start","end","createTableFrameFromTraceQlQuery","upload","uploadedJson","JSON","parse","isTraceData","batches","isServiceGraphData","Array","isArray","some","df","meta","preferredVisualisationType","transformFromOTEL","enabled","serviceMapQuery","dsId","tempoDsUid","config","concatMap","result","serviceMapResponse","serviceMapRequest","makePromServiceMapRequest","makeApmRequest","buildExpr","rateMetric","defaultTableFilter","queryPrometheus","toArray","responses","errorRes","find","rateQuery","rateResponse","tempoDatasourceUid","apmMetrics","errorRateBySpanName","durationsBySpanName","spanNames","fields","values","errorRateMetric","join","metric","durationMetric","errorAndDurationResponse","apmTable","secondResponse","rate","refId","errorRate","duration","includes","filterable","links","makePromLink","buildLinkExpr","decimals","labels","mode","custom","displayMode","errorRateNames","errorRateValues","errorRateObj","index","getRateAlignedValues","durationObj","d","delimiter","unit","type","FieldType","makeTempoLink","getApmTable","errorAndDurationQuery","traceId","handleTraceIdQuery","merge","applyTemplateVariables","interpolateVariablesInQueries","queries","getRef","expandedQuery","replace","minDuration","maxDuration","validTargets","trim","EMPTY","traceRequest","traceIdQueryRequest","transformTrace","timeShiftEnabled","subtract","rangeUtil","spanStartTimeShift","add","spanEndTimeShift","dateTime","raw","lastValueFrom","method","hideFromInspector","apiUrl","serializeParams","req","getBackendSrv","fetch","headers","ok","status","getQueryDisplayText","key","hasOwnProperty","startCase","tempoQuery","pick","pickBy","identity","isValidGoDuration","Number","isInteger","ds","nodes","edges","mapPromMetricsToServiceMap","getFieldConfig","instant","internal","exemplar","datasourceName","getDataSourceSettingsByUid","targetField","tempoField","sourceField","totalsMetric","histogramMetric","failedMetric","serviceMapMetrics","format","extraParams","metricParams","concat","item","rateResp","objToAlign","rateNames","keys","metrics","TempoQueryBuilderOptions","React","onChange","EditorRow","EditorField","tooltip","AutoSizeInput","placeholder","min","defaultValue","onCommitChange","e","parseInt","currentTarget","displayName","CompletionProvider","props","provideCompletionItems","model","position","monaco","editor","getModel","id","offset","word","getWordAtPosition","Range","lift","startLineNumber","lineNumber","endLineNumber","startColumn","endColumn","fromPositions","positionClone","column","getOffsetAt","getRangeAndOffset","situation","getSituation","getValue","getCompletions","maxIndexDigits","toString","suggestion","kind","getMonacoCompletionItemKind","sortText","padStart","itemType","match","substring","scope","fixSuggestion","setTags","forEach","Set","overrideTagName","cachedValues","getOptions","getScopesCompletions","getIntrinsicsCompletions","getTagsCompletions","operators","tagsNoQuotesAroundValue","getTagValues","getInsertionText","val","betweenQuotes","logicalOps","prepend","sort","a","b","localeCompare","sensitivity","intrinsics","scopes","getSituationInSpanSet","textUntilCaret","fullRegex","RegExp","source","matched","nameFull","groups","op","nameMatched","w","post_dot","space1","space3","open_quote","close_quote","reduce","lastIndexOf","languages","CompletionItemKind","Enum","Keyword","Operator","EnumMember","Class","languageDefinition","extensions","aliases","mimetypes","def","language","ignoreCase","defaultToken","tokenPostfix","keywords","symbols","escapes","digits","octaldigits","binarydigits","hexdigits","integersuffix","floatsuffix","tokenizer","root","cases","include","string_double","string_single","clauses","whitespace","languageConfiguration","wordPattern","brackets","autoClosingPairs","open","close","surroundingPairs","folding","TraceQLEditor","onRunQuery","setupAutocompleteFn","providerRef","useRef","useEffect","getTags","current","dispatch","notifyApp","createErrorNotification","autocompleteDisposeFun","dispose","registerCompletionItemProvider","langId","useAutocomplete","useTheme2","CodeEditor","onBlur","containerStyles","queryField","monacoOptions","lineNumbers","overviewRulerLanes","renderLineHighlight","scrollbar","vertical","verticalScrollbarSize","horizontal","horizontalScrollbarSize","scrollBeyondLastLine","wordWrap","onBeforeEditorMount","ensureTraceQL","onEditorDidMount","addAction","keybindings","KeyMod","Shift","KeyCode","Enter","contextMenuGroupId","contextMenuOrder","run","setupActions","placeholderDecorators","isWholeLine","decorators","checkDecorators","newDecorators","getValueLength","deltaDecorations","onDidChangeModelContent","setupPlaceholder","container","getDomNode","updateHeight","contentHeight","Math","getContentHeight","width","style","height","layout","onDidContentSizeChange","setupAutoSize","traceqlSetupDone","register","setMonarchTokensProvider","setLanguageConfiguration","shape","borderRadius","components","input","borderColor","fontFamilyMonospace","QueryEditor","defaults","InlineLabel","rel","href","optionsContainer","PRISM_LANGUAGE","durationPlaceholder","plugins","BracesPlugin","SlatePrism","onlyIn","node","object","getSyntax","Prism","pattern","alias","operator","useMemo","hasSyntaxLoaded","setHasSyntaxLoaded","useState","serviceOptions","setServiceOptions","spanOptions","setSpanOptions","setError","inputErrors","setInputErrors","isLoading","setIsLoading","loadOptions","useCallback","lpName","prevValue","fuzzyMatch","found","isFetchError","services","spans","Promise","all","containsTemplate","toOption","fetchOptions","onTypeahead","typeahead","cleanText","splittedText","onKeyDown","keyEvent","shiftKey","ctrlKey","handleOnChange","InlineFieldRow","InlineField","labelWidth","grow","Select","inputId","onOpenMenu","isClearable","allowCustomValue","QueryField","additionalPlugins","syntaxLoaded","portalOrigin","invalid","Input","I","templatedMinDuration","templatedMaxDuration","Alert","severity","alert","getDS","getDataSourceSrv","console","ServiceGraphSection","graphDatasourceUid","dsState","useAsync","hasKeys","setHasKeys","loading","getTagKeys","series","Boolean","fn","filters","re","exec","condition","queryToFilter","AdHocFilter","getTagKeysOptions","addFilter","filtersToQuery","removeFilter","newFilters","splice","changeFilter","f","TempoQueryFieldComponent","render","queryTypeOptions","unshift","RadioButtonGroup","newQueryType","previousQueryType","onClearResults","size","SearchSection","onRunLinkedQuery","onChangeLinkedQuery","padding","FileDropzone","multiple","onLoad","LokiQueryField","history","TempoQueryField","withTheme2","LokiSearchSettings","onOptionsChange","legacyDatasource","updateDatasourcePluginJsonDataOption","infoText","row","DataSourcePicker","pluginId","noDefault","Button","variant","fill","QuerySettings","event","checked","disabled","SearchSettings","ServiceGraphSettings","plugin","DataSourcePlugin","setQueryEditor","setConfigEditor","DataSourceHttpSettings","defaultUrl","dataSourceConfig","showAccessOptions","TraceToLogsSettings","TraceToMetricsSettings","NodeGraphSettings","setQueryEditorHelp"],"sourceRoot":""}