"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9704],{79220:(e,t,n)=>{n.r(t),n.d(t,{plugin:()=>se});var r,s=n(23214),o=n(68404),i=n(58582),a=n(65231),l=n(37722),c=n(45916);var u=n(82897),d=n(66015),p=n(54316),g=n(30477);const f={labelSelector:"{}",queryType:"both",groupBy:[]};var h=n(52423),m=n(16755);function b(e){const t=(0,m.wW)((0,o.useCallback)((t=>y(t,e)),[e]));return(0,c.jsx)("div",{className:t.root,children:e.children})}const y=(e,t)=>{var n,r,s;return{root:(0,h.css)({display:"flex",flexDirection:null!==(n=t.direction)&&void 0!==n?n:"row",flexWrap:null===(r=t.wrap)||void 0===r||r?"wrap":void 0,alignItems:t.alignItems,gap:e.spacing(null!==(s=t.gap)&&void 0!==s?s:2),flexGrow:t.flexGrow})}},x=e=>{let{children:t,stackProps:n}=e;const r=(0,m.wW)(v);return(0,c.jsx)("div",{className:r.root,children:(0,c.jsx)(b,Object.assign({gap:2},n,{children:t}))})},v=e=>({root:(0,h.css)({padding:e.spacing(1),backgroundColor:e.colors.background.secondary,borderRadius:e.shape.borderRadius(1)})}),w=e=>{let{children:t}=e;return(0,c.jsx)(b,{gap:.5,direction:"column",children:t})};var j=n(3088),C=n(31787);const N={id:"fireql",extensions:[".fireql"],aliases:["fire","fireql"],mimetypes:[],def:{language:{ignoreCase:!1,defaultToken:"",tokenPostfix:".fireql",keywords:[],operators:[],symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,integersuffix:/(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,floatsuffix:/[fFlL]?/,tokenizer:{root:[[/[a-z_]\w*(?=\s*(=|!=|=~|!~))/,"tag"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/\d+/,"number"],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],clauses:[[/[^(,)]/,"tag"],[/\)/,"identifier","@pop"]],whitespace:[[/[ \t\r\n]+/,"white"]]}},languageConfiguration:{wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"]],autoClosingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}}}};function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class S{constructor(){E(this,"triggerCharacters",["{",",","[","(","=","~"," ",'"']),E(this,"monaco",void 0),E(this,"editor",void 0),E(this,"labels",{})}provideCompletionItems(e,t){var n;if(!this.monaco||!this.editor)throw new Error("provideCompletionItems called before CompletionProvider was initialized");if((null===(n=this.editor.getModel())||void 0===n?void 0:n.id)!==e.id)return{suggestions:[]};const{range:r,offset:s}=function(e,t,n){const r=t.getWordAtPosition(n),s=null!=r?e.Range.lift({startLineNumber:n.lineNumber,endLineNumber:n.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):e.Range.fromPositions(n),o={column:n.column,lineNumber:n.lineNumber};return{offset:t.getOffsetAt(o),range:s}}(this.monaco,e,t),o=function(e,t){if(""===e)return{type:"EMPTY"};const n=e.matchAll(T),r=Array.from(n).reduce(((e,t)=>{const[n,r,s]=t[1];return e.push({name:r,value:s}),e}),[]),s=e.substring(0,t).match(_);if(s)return{type:"IN_LABEL_VALUE",labelName:s[1],betweenQuotes:!!s[2],otherLabels:r};if(e.substring(0,t).match(O))return{type:"IN_LABEL_NAME",otherLabels:r};return{type:"UNKNOWN"}}(e.getValue(),s),i=this.getCompletions(o),a=i.length.toString().length;return{suggestions:i.map(((e,t)=>({kind:L(e.type,this.monaco),label:e.label,insertText:e.insertText,sortText:t.toString().padStart(a,"0"),range:r})))}}setSeries(e){this.labels=e.reduce(((e,t)=>{const n=t.labels.reduce(((e,t)=>(e[t.name]=e[t.name]||new Set,e[t.name].add(t.value),e)),{});for(const t of Object.keys(n))e[t]=new Set([...e[t]||[],...n[t]]);return e}),{})}getCompletions(e){if(!Object.keys(this.labels).length)return[];switch(e.type){case"UNKNOWN":return[];case"EMPTY":return Object.keys(this.labels).map((e=>({label:e,insertText:`{${e}="`,type:"LABEL_NAME"})));case"IN_LABEL_NAME":return Object.keys(this.labels).map((e=>({label:e,insertText:e,type:"LABEL_NAME"})));case"IN_LABEL_VALUE":return Array.from(this.labels[e.labelName].values()).map((t=>({label:t,insertText:e.betweenQuotes?t:`"${t}"`,type:"LABEL_VALUE"})));default:throw new Error(`Unexpected situation ${e}`)}}}function L(e,t){switch(e){case"LABEL_NAME":return t.languages.CompletionItemKind.Enum;case"LABEL_VALUE":return t.languages.CompletionItemKind.EnumMember;default:throw new Error(`Unexpected CompletionType: ${e}`)}}const A=/[a-zA-Z_][a-zA-Z0-9_]*/,k=/[^"]*/,T=new RegExp(`(${A.source})="(${k.source})"`,"g"),_=new RegExp(`(${A.source})=("?)${k.source}$`),O=new RegExp(/[{,]\s*[a-zA-Z0-9_]*$/);function q(e){const t=function(e){const t=(0,o.useRef)(new S);(0,o.useEffect)((()=>{e&&t.current.setSeries(e)}),[e]);const n=(0,o.useRef)(null);return(0,o.useEffect)((()=>()=>{var e;null===(e=n.current)||void 0===e||e.call(n)}),[]),(e,r)=>{t.current.editor=e,t.current.monaco=r;const{dispose:s}=r.languages.registerCompletionItemProvider(B,t.current);n.current=s}}(e.series),n=(0,m.wW)(I),r=(0,j.Z)(e.onRunQuery),s=(0,o.useRef)(null);return(0,c.jsx)("div",{className:n.wrapper,ref:s,children:(0,c.jsx)(C.p,{value:e.value,language:B,onBlur:e.onChange,containerStyles:n.queryField,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on",padding:{top:5,bottom:6}},onBeforeEditorMount:R,onEditorDidMount:(e,n)=>{t(e,n);const o=()=>{const t=s.current;if(null!==t){const n=e.getContentHeight();t.style.height=`${n+z}px`,t.style.width="100%";const r=t.clientWidth;e.layout({width:r,height:n})}};e.onDidContentSizeChange(o),o(),e.addCommand(n.KeyMod.Shift|n.KeyCode.Enter,(()=>{r.current(e.getValue())}))}})})}const z=2;let M=!1;const B="fireql";function R(e){if(!1===M){M=!0;const{aliases:t,extensions:n,mimetypes:r,def:s}=N;e.languages.register({id:B,aliases:t,extensions:n,mimetypes:r}),e.languages.setMonarchTokensProvider(B,s.language),e.languages.setLanguageConfiguration(B,s.languageConfiguration)}}const I=e=>({queryField:h.css`
      flex: 1;
      // Not exactly sure but without this the editor doe not shrink after resizing (so you can make it bigger but not
      // smaller). At the same time this does not actually make the editor 100px because it has flex 1 so I assume
      // this should sort of act as a flex-basis (but flex-basis does not work for this). So yeah CSS magic.
      width: 100px;
    `,wrapper:h.css`
      display: flex;
      flex: 1;
      border: 1px solid rgba(36, 41, 46, 0.3);
      border-radius: 2px;
    `});var F=n(88102),P=n(99500),$=n(37625),W=n(70917),U=n(32714),D=n(21888),Q=n(65678),V=n(50191);const K=["label","optional","tooltip","children","width"];const Z=e=>{const{label:t,optional:n,tooltip:r,children:s,width:o}=e,i=function(e,t){if(null==e)return{};var n,r,s={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,K),a=(0,m.l4)(),l=G(a,o),u=(null==i?void 0:i.htmlFor)||(null==U?void 0:U.getChildId(s)),d=(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)("label",{className:l.label,htmlFor:u,children:[t,n&&(0,c.jsx)("span",{className:l.optional,children:" - optional"}),r&&(0,c.jsx)(D.u,{placement:"top",content:r,theme:"info",children:(0,c.jsx)(P.J,{name:"info-circle",size:"sm",className:l.icon})})]}),(0,c.jsx)("span",{className:l.space})]});return(0,c.jsx)("div",{className:l.root,children:(0,c.jsx)(Q.g,Object.assign({className:l.field,label:d},i,{children:s}))})},G=(0,V.B)(((e,t)=>({space:(0,h.css)({paddingRight:e.spacing(0),paddingBottom:e.spacing(.5)}),root:(0,h.css)({minWidth:e.spacing(null!=t?t:0)}),label:(0,h.css)({fontSize:12,fontWeight:e.typography.fontWeightMedium}),optional:(0,h.css)({fontStyle:"italic",color:e.colors.text.secondary}),field:(0,h.css)({marginBottom:0}),icon:(0,h.css)({color:e.colors.text.secondary,marginLeft:e.spacing(1),":hover":{color:e.colors.text.primary}})}))),J=[{value:"metrics",label:"Metric",description:"Return aggregated metrics"},{value:"profile",label:"Profile",description:"Return profile"},{value:"both",label:"Both",description:"Return both metric and profile data"}];function H(e){return e===p.zj.Explore?J:J.filter((e=>"both"!==e.value))}function Y(e){var t;let{query:n,onQueryChange:r,app:s,series:o}=e;const[i,a]=(0,F.Z)(!1),l=(0,m.wW)(X),u=H(s),d=function(e){let t=[];if(e){const n=e.flatMap((e=>e.labels.map((e=>e.name))));t=Array.from(new Set(n)).map((e=>({label:e,value:e})))}return t}(o);return(0,c.jsxs)(b,{gap:0,direction:"column",children:[(0,c.jsxs)("div",{className:l.header,onClick:a,title:"Click to edit options",children:[(0,c.jsx)("div",{className:l.toggle,children:(0,c.jsx)(P.J,{name:i?"angle-down":"angle-right"})}),(0,c.jsx)("h6",{className:l.title,children:"Options"}),!i&&(0,c.jsx)("div",{className:l.description,children:[`Type: ${n.queryType}`,null!==(t=n.groupBy)&&void 0!==t&&t.length?`Group by: ${n.groupBy.join(", ")}`:void 0].filter((e=>e)).map(((e,t)=>(0,c.jsx)("span",{children:e},t)))})]}),i&&(0,c.jsxs)("div",{className:l.body,children:[(0,c.jsx)(Z,{label:"Query Type",children:(0,c.jsx)($.S,{options:u,value:n.queryType,onChange:e=>r(Object.assign({},n,{queryType:e}))})}),(0,c.jsx)(Z,{label:"Group by",tooltip:(0,c.jsx)(c.Fragment,{children:"Used to group the metric result by a specific label or set of labels. Does not apply to profile query."}),children:(0,c.jsx)(W.NU,{placeholder:"Label",value:n.groupBy,allowCustomValue:!0,options:d,onChange:e=>{const t=e.map((e=>e.value));r(Object.assign({},n,{groupBy:t}))}})})]})]})}const X=e=>({switchLabel:(0,h.css)({color:e.colors.text.secondary,cursor:"pointer",fontSize:e.typography.bodySmall.fontSize,"&:hover":{color:e.colors.text.primary}}),header:(0,h.css)({display:"flex",cursor:"pointer",alignItems:"baseline",color:e.colors.text.primary,"&:hover":{background:e.colors.emphasize(e.colors.background.primary,.03)}}),title:(0,h.css)({flexGrow:1,overflow:"hidden",fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium,margin:0}),description:(0,h.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,paddingLeft:e.spacing(2),gap:e.spacing(2),display:"flex"}),body:(0,h.css)({display:"flex",paddingTop:e.spacing(2),gap:e.spacing(2),flexWrap:"wrap"}),toggle:(0,h.css)({color:e.colors.text.secondary,marginRight:`${e.spacing(1)}`})});function ee(e,t){let n=(0,u.defaults)(e,f);return t!==p.zj.Explore&&"both"===n.queryType&&(n.queryType="profile"),n}var te=n(53786),ne=n(18474);class re extends ne.CK{constructor(e){super(e)}query(e){const t=e.targets.filter((e=>e.profileTypeId)).map((t=>""===t.labelSelector?Object.assign({},t,{labelSelector:"{}"}):ee(t,e.app)));return t.length?super.query(Object.assign({},e,{targets:t})):(0,te.of)({data:[]})}async getProfileTypes(){return await super.getResource("profileTypes")}async getSeries(){return await super.getResource("series",{matchers:["{}"]})}async getLabelNames(){return await super.getResource("labelNames")}}const se=new s.hf(re).setConfigEditor((e=>{const{options:t,onOptionsChange:n}=e;return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(i.E,{defaultUrl:"http://localhost:4100",dataSourceConfig:t,showAccessOptions:!1,onChange:n}),r||(r=(0,c.jsx)("h3",{className:"page-heading",children:"Querying"})),(0,c.jsx)("div",{className:"gf-form-group",children:(0,c.jsx)("div",{className:"gf-form-inline",children:(0,c.jsx)("div",{className:"gf-form",children:(0,c.jsx)(a.vw6.FormField,{label:"Minimal step",labelWidth:13,inputEl:(0,c.jsx)(a.vw6.Input,{className:"width-6",value:t.jsonData.minStep,spellCheck:!1,placeholder:"15s",onChange:e=>{n(Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{minStep:e.currentTarget.value})}))},validationEvents:{[l.JU.onBlur]:[(0,l.FE)(/^$|^\d+(ms|[Mwdhmsy])$/,"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s")]}}),tooltip:"Minimal step used for metric query. Should be the same or higher as the scrape interval setting in the Fire database."})})})})]})})).setQueryEditor((function(e){const t=function(e){const[t,n]=(0,o.useState)([]);return(0,o.useEffect)((()=>{(async()=>{const t=await e.getProfileTypes();n(t)})()}),[e]),t}(e.datasource),n=(0,d.Z)((()=>e.datasource.getSeries()),[e.datasource]),r=function(e){return(0,o.useMemo)((()=>{let t=new Map;for(let s of e){var n,r;t.has(s.name)||t.set(s.name,{label:s.name,value:s.ID,children:[]}),null===(n=t.get(s.name))||void 0===n||null===(r=n.children)||void 0===r||r.push({label:s.sample_type,value:s.ID})}return Array.from(t.values())}),[e])}(t),s=function(e,t){return(0,o.useMemo)((()=>{if(!e)return"Loading";const n=e.find((e=>e.ID===t));return n?n.name+" - "+n.sample_type:"Select a profile type"}),[t,e])}(t,e.query.profileTypeId);let i=ee(e.query,e.app);return(0,c.jsxs)(w,{children:[(0,c.jsxs)(x,{stackProps:{wrap:!1,gap:1},children:[(0,c.jsx)(g.O,{onChange:function(t,n){if(0===n.length)return;const r=n[n.length-1].value;if("string"!=typeof r)throw new Error("id is not string");e.onChange(Object.assign({},e.query,{profileTypeId:r}))},options:r,buttonProps:{variant:"secondary"},children:s}),(0,c.jsx)(q,{value:i.labelSelector,onChange:function(t){e.onChange(Object.assign({},e.query,{labelSelector:t}))},onRunQuery:function(t){e.onChange(Object.assign({},e.query,{labelSelector:t})),e.onRunQuery()},series:n.value})]}),(0,c.jsx)(x,{children:(0,c.jsx)(Y,{query:i,onQueryChange:e.onChange,app:e.app,series:n.value})})]})}))},3088:(e,t,n)=>{n.d(t,{Z:()=>s});var r=n(68404);const s=function(e){var t=(0,r.useRef)(e);return t.current=e,t}}}]);
//# sourceMappingURL=phlarePlugin.10d60476a0926151b2a7.js.map