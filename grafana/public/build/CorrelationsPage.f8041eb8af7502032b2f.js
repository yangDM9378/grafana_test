"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[413],{2179:(e,r,t)=>{t.d(r,{f:()=>n});const n=e=>Boolean(e)},78653:(e,r,t)=>{t.r(r),t.d(r,{default:()=>xe});var n,a,s,o,i=t(52423),l=t(82897),c=t(68404),d=t(31181),u=t(93570),g=t(77772),h=t(54761),f=t(8006),p=t(38953),x=t(2843),m=t(16755),j=t(64313),v=t(37417),b=t(68374),y=t(40901),w=t(64850),O=t(59052),k=t(94570),I=t(91288),C=t(65678),D=t(26006),U=t(42833),S=t(66263),T=t(4645),$=t(93194),E=t(66015),N=t(8910),R=t(45916);const q=e=>{var r;let{dsUid:t,invalid:i,error:l,name:c}=e;const{value:d,loading:u,error:g}=(0,E.Z)((async()=>{if(t)return(0,N.F)().get(t)}),[t]),h=null==d||null===(r=d.components)||void 0===r?void 0:r.QueryEditor;return(0,R.jsx)(C.g,{label:"Query",invalid:i,error:l,children:(0,R.jsx)(O.Qr,{name:c,rules:{validate:{hasQueryEditor:()=>void 0!==h||"The selected target data source must export a query editor."}},render:e=>{let{field:{value:r,onChange:t}}=e;return u?n||(n=(0,R.jsx)(p.u,{text:"Loading query editor..."})):g?a||(a=(0,R.jsx)(x.b,{title:"Error loading data source",children:"The selected data source could not be loaded."})):d?h?(0,R.jsx)(h,{onRunQuery:()=>{},onChange:t,datasource:d,query:r}):o||(o=(0,R.jsx)(x.b,{title:"Data source does not export a query editor."})):s||(s=(0,R.jsx)(x.b,{title:"No data source selected",severity:"info",children:"Please select a target data source first."}))}})})},P=(e,r)=>r?`${e}_${r.sourceUID}-${r.uid}`:e,_=e=>({label:i.css`
    max-width: ${e.spacing(32)};
  `,description:i.css`
    max-width: ${e.spacing(80)};
  `});function L(e){var r,t,n,a,s,o;let{readOnly:l=!1,correlation:c}=e;const d=(0,m.wW)(_),{register:u,formState:{errors:g}}=(0,O.Gc)(),h=(0,O.qo)({name:"targetUID"})||(null==c?void 0:c.targetUID);return(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)("input",Object.assign({type:"hidden"},u("config.type"))),(0,R.jsx)(C.g,{label:"Label",className:d.label,children:(0,R.jsx)(T.I,Object.assign({id:P("label",c)},u("label"),{readOnly:l,placeholder:"i.e. Tempo traces"}))}),(0,R.jsx)(C.g,{label:"Description",className:(0,i.cx)(d.description),children:(0,R.jsx)($.K,Object.assign({id:P("description",c)},u("description"),{readOnly:l}))}),(0,R.jsx)(C.g,{label:"Target field",className:d.label,invalid:!(null==g||null===(r=g.config)||void 0===r||!r.field),error:null==g||null===(t=g.config)||void 0===t||null===(n=t.field)||void 0===n?void 0:n.message,children:(0,R.jsx)(T.I,Object.assign({id:P("field",c)},u("config.field",{required:"This field is required."}),{readOnly:l}))}),(0,R.jsx)(q,{name:"config.target",dsUid:h,invalid:!(null==g||null===(a=g.config)||void 0===a||!a.target),error:null==g||null===(s=g.config)||void 0===s||null===(o=s.target)||void 0===o?void 0:o.message})]})}var B;const F=e=>({panelContainer:i.css`
    position: relative;
    padding: ${e.spacing(1)};
    margin-bottom: ${e.spacing(2)};
  `,linksToContainer:i.css`
    flex-grow: 1;
    /* This is the width of the textarea minus the sum of the label&description fields,
     * so that this element takes exactly the remaining space and the inputs will be
     * nicely aligned with the textarea
    **/
    max-width: ${e.spacing(16)};
    margin-top: ${e.spacing(3)};
    text-align: right;
    padding-right: ${e.spacing(1)};
  `,horizontalGroup:i.css`
    display: flex;
  `}),Q=e=>r=>e(r.uid),W=e=>{let{onClose:r,onCreated:t}=e;const n=(0,m.wW)(F),{create:{execute:a,loading:s,error:o,value:i}}=(0,S.K)();(0,c.useEffect)((()=>{o||s||!i||t()}),[o,s,i,t]);const l=(0,O.cI)({defaultValues:{config:{type:"query",target:{}}}});return(0,R.jsxs)(I.l,{className:n.panelContainer,children:[(0,R.jsx)(D.P,{onClick:r}),(0,R.jsx)(O.RV,Object.assign({},l,{children:(0,R.jsxs)("form",{onSubmit:l.handleSubmit(a),children:[(0,R.jsxs)("div",{className:n.horizontalGroup,children:[(0,R.jsx)(O.Qr,{control:l.control,name:"sourceUID",rules:{required:{value:!0,message:"This field is required."},validate:{writable:e=>{var r;return!(null!==(r=(0,U.ak)().getInstanceSettings(e))&&void 0!==r&&r.readOnly)||"Source can't be a read-only data source."}}},render:e=>{var r;let{field:{onChange:t,value:n}}=e;return(0,R.jsx)(C.g,{label:"Source",htmlFor:"source",invalid:!!l.formState.errors.sourceUID,error:null===(r=l.formState.errors.sourceUID)||void 0===r?void 0:r.message,children:(0,R.jsx)(k.q,{onChange:Q(t),noDefault:!0,current:n,inputId:"source",width:32})})}}),(0,R.jsx)("div",{className:n.linksToContainer,children:"Links to"}),(0,R.jsx)(O.Qr,{control:l.control,name:"targetUID",rules:{required:{value:!0,message:"This field is required."}},render:e=>{var r;let{field:{onChange:t,value:n}}=e;return(0,R.jsx)(C.g,{label:"Target",htmlFor:"target",invalid:!!l.formState.errors.targetUID,error:null===(r=l.formState.errors.targetUID)||void 0===r?void 0:r.message,children:(0,R.jsx)(k.q,{onChange:Q(t),noDefault:!0,current:n,inputId:"target",width:32})})}})]}),B||(B=(0,R.jsx)(L,{})),(0,R.jsx)(h.Lh,{justify:"flex-end",children:(0,R.jsx)(f.zx,{variant:"primary",icon:s?"fa fa-spinner":"plus",type:"submit",disabled:s,children:"Add"})})]})}))]})},G=["uid","sourceUID","targetUID"];const Z=e=>{let{onUpdated:r,correlation:t,readOnly:n=!1}=e;const{update:{execute:a,loading:s,error:o,value:i}}=(0,S.K)();(0,c.useEffect)((()=>{o||s||!i||r()}),[o,s,i,r]);const l=function(e,r){if(null==e)return{};var t,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],r.indexOf(t)>=0||(a[t]=e[t]);return a}(t,G),d=(0,O.cI)({defaultValues:l});return(0,R.jsx)(O.RV,Object.assign({},d,{children:(0,R.jsxs)("form",{onSubmit:n?e=>e.preventDefault():d.handleSubmit((e=>a(Object.assign({},e,{sourceUID:t.sourceUID,uid:t.uid})))),children:[(0,R.jsx)(L,{readOnly:n,correlation:t}),!n&&(0,R.jsx)(h.Lh,{justify:"flex-end",children:(0,R.jsx)(f.zx,{variant:"primary",icon:s?"fa fa-spinner":"save",type:"submit",disabled:s,children:"Save"})})]})}))};var z=t(75442);const A=e=>{let{onClick:r}=e;return(0,R.jsx)(z.Z,{title:"You haven't defined any correlation yet.",buttonIcon:"gf-glue",onClick:r,buttonTitle:"Add correlation",proTip:"you can also define correlations via datasource provisioning"})};var K=t(91742),V=t(99500),H=t(2179),M=t(23734);const J=i.css`
  display: flex;
  align-items: center;
  height: 100%;
`;function Y(e){let{row:r}=e;return(0,R.jsx)("div",{className:J,children:(0,R.jsx)(M.h,Object.assign({name:r.isExpanded?"angle-down":"angle-right"},r.getToggleRowExpandedProps({})))})}const X="__expander";const ee=["key"],re=["key"],te=["key"],ne=["key"];function ae(e,r){if(null==e)return{};var t,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],r.indexOf(t)>=0||(a[t]=e[t]);return a}const se=e=>({table:i.css`
    border-radius: ${e.shape.borderRadius()};
    border: solid 1px ${e.colors.border.weak};
    background-color: ${e.colors.background.secondary};
    width: 100%;
    td,
    th {
      padding: ${e.spacing(1)};
      min-width: ${e.spacing(3)};
    }
  `,evenRow:i.css`
    background: ${e.colors.background.primary};
  `,shrink:i.css`
    width: 0%;
  `});function oe(e){let{data:r,className:t,columns:n,renderExpandedRow:a,getRowId:s}=e;const o=(0,m.wW)(se),d=(0,c.useMemo)((()=>{const e=function(e){return[{id:X,Cell:Y,disableSortBy:!0,width:0},...e.map((e=>Object.assign({Header:e.header||(()=>null),accessor:e.id||(0,l.uniqueId)(),sortType:e.sortType||"alphanumeric",disableSortBy:!Boolean(e.sortType),width:e.shrink?0:void 0,visible:e.visible},e.cell&&{Cell:e.cell})))]}(n);return e}),[n]),{getTableProps:u,getTableBodyProps:g,headerGroups:h,rows:f,prepareRow:p}=(0,K.useTable)({columns:d,data:r,autoResetExpanded:!1,autoResetSortBy:!1,getRowId:s,initialState:{hiddenColumns:[!a&&X,...d.filter((e=>{var t,n;return!(null===(t=null===(n=e.visible)||void 0===n?void 0:n.call(e,r))||void 0===t||t)})).map((e=>e.id)).filter(H.f)].filter(H.f)}},K.useSortBy,K.useExpanded);return f.forEach(p),(0,R.jsxs)("table",Object.assign({},u(),{className:(0,i.cx)(o.table,t),children:[(0,R.jsx)("thead",{children:h.map((e=>{const r=e.getHeaderGroupProps(),{key:t}=r,n=ae(r,ee);return(0,R.jsx)("tr",Object.assign({},n,{children:e.headers.map((e=>{const r=e.getHeaderProps(e.canSort?e.getSortByToggleProps():void 0),{key:t}=r,n=ae(r,re);return(0,R.jsxs)("th",Object.assign({className:(0,i.cx)(0===e.width&&o.shrink)},n,{children:[e.render("Header"),e.isSorted&&(0,R.jsx)(V.J,{name:e.isSortedDesc?"angle-down":"angle-up"})]}),t)}))}),t)}))}),(0,R.jsx)("tbody",Object.assign({},g(),{children:f.map(((e,r)=>{const t=(0,i.cx)(r%2==0&&o.evenRow),n=e.getRowProps(),{key:s}=n,l=ae(n,te);return(0,R.jsxs)(c.Fragment,{children:[(0,R.jsx)("tr",Object.assign({className:t},l,{children:e.cells.map((e=>{const r=e.getCellProps(),{key:t}=r,n=ae(r,ne);return(0,R.jsx)("td",Object.assign({},n,{children:e.render("Cell")}),t)}))})),e.isExpanded&&a&&(0,R.jsx)("tr",Object.assign({className:t},l,{children:(0,R.jsx)("td",{colSpan:e.cells.length,children:a(e.original)})}))]},s)}))}))]}))}var ie,le,ce;const de=["execute"],ue=["source","target"];function ge(e,r){if(null==e)return{};var t,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],r.indexOf(t)>=0||(a[t]=e[t]);return a}const he=(e,r,t)=>e.values[t].name.localeCompare(r.values[t].name),fe=e=>{let{source:r}=e;return r.readOnly},pe=i.css`
  display: flex;
  justify-content: center;
`;function xe(){var e;const r=(0,y.q)("correlations"),[t,n]=(0,c.useState)(!1),a=(0,S.K)(),{remove:s,get:{execute:o}}=a,i=ge(a.get,de);(0,c.useEffect)((()=>{o()}),[]);const m=b.Vt.hasPermission(w.bW.DataSourcesWrite),j=(0,c.useCallback)((()=>{(0,d.ff)("grafana_correlations_added"),o(),n(!1)}),[o]),O=(0,c.useCallback)((()=>{(0,d.ff)("grafana_correlations_edited"),o()}),[o]),k=(0,c.useCallback)((e=>{s.execute(e)}),[s]);(0,c.useEffect)((()=>{s.value&&(0,d.ff)("grafana_correlations_deleted")}),[s.value]),(0,c.useEffect)((()=>{s.error||s.loading||!s.value||o()}),[s.error,s.loading,s.value,o]);const I=(0,c.useCallback)((e=>{let{row:{original:{source:{uid:r,readOnly:t},uid:n}}}=e;return!t&&(0,R.jsx)(g.m,{"aria-label":"delete correlation",onConfirm:()=>k({sourceUID:r,uid:n}),closeOnConfirm:!0})}),[k]),C=(0,c.useMemo)((()=>[{cell:ye,shrink:!0,visible:e=>e.some(fe)},{id:"source",header:"Source",cell:ve,sortType:he},{id:"target",header:"Target",cell:ve,sortType:he},{id:"label",header:"Label",sortType:"alphanumeric"},{cell:I,shrink:!0,visible:e=>m&&e.some((0,l.negate)(fe))}]),[I,m]),D=(0,c.useMemo)((()=>i.value),[i.value]),U=0===(null==D?void 0:D.length)&&!t&&!i.error;return(0,R.jsx)(v.T,{navModel:r,children:(0,R.jsxs)(v.T.Contents,{children:[(0,R.jsx)("div",{children:(0,R.jsxs)(h.Lh,{justify:"space-between",children:[ie||(ie=(0,R.jsxs)("div",{children:[(0,R.jsx)("h4",{children:"Correlations"}),(0,R.jsx)("p",{children:"Define how data living in different data sources relates to each other."})]})),m&&0!==(null==D?void 0:D.length)&&void 0!==D&&!t&&(0,R.jsx)(f.zx,{icon:"plus",onClick:()=>n(!0),children:"Add new"})]})}),(0,R.jsxs)("div",{children:[!D&&i.loading&&(le||(le=(0,R.jsx)("div",{className:pe,children:(0,R.jsx)(p.u,{text:"loading..."})}))),U&&(0,R.jsx)(A,{onClick:()=>n(!0)}),i.error&&(0,R.jsx)(x.b,{severity:"error",title:"Error fetching correlation data",topSpacing:2,children:(0,u.kW)(i.error)&&(null===(e=i.error.data)||void 0===e?void 0:e.message)||"An unknown error occurred while fetching correlation data. Please try again."}),t&&(0,R.jsx)(W,{onClose:()=>n(!1),onCreated:j}),D&&D.length>=1&&(0,R.jsx)(oe,{renderExpandedRow:e=>(0,R.jsx)(me,{correlation:e,onUpdated:O,readOnly:fe({source:e.source})||!m}),columns:C,data:D,getRowId:e=>`${e.source.uid}-${e.uid}`})]})]})})}function me(e){let{correlation:{source:r,target:t},readOnly:n,onUpdated:a}=e,s=ge(e.correlation,ue);return(0,c.useEffect)((()=>(0,d.ff)("grafana_correlations_details_expanded")),[]),(0,R.jsx)(Z,{correlation:Object.assign({},s,{sourceUID:r.uid,targetUID:t.uid}),onUpdated:a,readOnly:n})}const je=e=>({root:i.css`
    display: flex;
    align-items: center;
  `,dsLogo:i.css`
    margin-right: ${e.spacing()};
    height: 16px;
    width: 16px;
  `}),ve=(0,c.memo)((function(e){let{cell:{value:r}}=e;const t=(0,m.wW)(je);return(0,R.jsxs)("span",{className:t.root,children:[(0,R.jsx)("img",{src:r.meta.info.logos.small,alt:"",className:t.dsLogo}),r.name]})}),((e,r)=>{let{cell:{value:t}}=e,{cell:{value:n}}=r;return t.type===n.type&&t.name===n.name})),be=i.css`
  white-space: nowrap;
`,ye=(0,c.memo)((function(e){return Object.assign({},(function(e){if(null==e)throw new TypeError("Cannot destructure "+e)}(e),e)).row.original.source.readOnly?ce||(ce=(0,R.jsx)(j.C,{text:"Read only",color:"purple",className:be})):null}),((e,r)=>e.row.original.source.readOnly===r.row.original.source.readOnly))},66263:(e,r,t)=>{t.d(r,{K:()=>f});var n=t(7197),a=t(3363),s=t(8910),o=t(39321);const i=["sourceUID","targetUID"],l=["sourceUID"],c=["sourceUID","uid"];function d(e,r){if(null==e)return{};var t,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],r.indexOf(t)>=0||(a[t]=e[t]);return a}const u=e=>{let{sourceUID:r,targetUID:t}=e,n=d(e,i);return Object.assign({},n,{source:(0,s.F)().getInstanceSettings(r),target:(0,s.F)().getInstanceSettings(t)})},g=e=>e.map(u);function h(e){return e.data}const f=()=>{const{backend:e}=(0,o.p)(),[r,t]=(0,n.Z)((()=>(0,a.n)(e.fetch({url:"/api/datasources/correlations",method:"GET",showErrorAlert:!1})).then(h).then(g)),[e]),[s,i]=(0,n.Z)((r=>{let{sourceUID:t}=r,n=d(r,l);return e.post(`/api/datasources/uid/${t}/correlations`,n).then(u)}),[e]),[f,p]=(0,n.Z)((r=>{let{sourceUID:t,uid:n}=r;return e.delete(`/api/datasources/uid/${t}/correlations/${n}`)}),[e]),[x,m]=(0,n.Z)((r=>{let{sourceUID:t,uid:n}=r,a=d(r,c);return e.patch(`/api/datasources/uid/${t}/correlations/${n}`,a).then(u)}),[e]);return{create:Object.assign({execute:i},s),update:Object.assign({execute:m},x),get:Object.assign({execute:t},r),remove:Object.assign({execute:p},f)}}}}]);
//# sourceMappingURL=CorrelationsPage.f8041eb8af7502032b2f.js.map