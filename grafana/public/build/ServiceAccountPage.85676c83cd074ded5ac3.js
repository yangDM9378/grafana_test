"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[687],{30935:(e,n,t)=>{t.r(n),t.d(n,{ServiceAccountPageUnconnected:()=>te,default:()=>se});var s=t(68404),i=t(36635),c=t(97254),o=t(54761),a=t(8006),r=t(2024),l=t(37417),d=t(68374),u=t(64850),h=t(58117),x=t(59196),p=t(45916);const v=e=>{const n=x.Vt.hasPermissionInMetadata(u.bW.ServiceAccountsPermissionsWrite,e.serviceAccount);return(0,p.jsx)(h.P,{title:"Permissions",addPermissionTitle:"Add permission",buttonLabel:"Add permission",resource:"serviceaccounts",resourceId:e.serviceAccount.id,canSetPermissions:n})};var m=t(27862),b=t(52423),j=t(6432),g=t(16755),f=t(86354),y=t(83744),k=t(4645),A=t(54241);const C=e=>{let{label:n,value:t,inputType:i,disabled:c,onChange:o}=e;const a=(0,s.useRef)(null),[r,l]=(0,s.useState)(t),[d,u]=(0,s.useState)(!1),h=(0,g.wW)(w),x=`${n}-input`;(0,s.useEffect)((()=>{d&&v()}),[d]);const v=()=>{var e;null==a||null===(e=a.current)||void 0===e||e.focus()};return(0,p.jsxs)("tr",{children:[(0,p.jsx)("td",{children:(0,p.jsx)(y._,{htmlFor:x,children:n})}),(0,p.jsx)("td",{className:"width-25",colSpan:2,children:!c&&d?(0,p.jsx)(k.I,{id:x,type:i,defaultValue:t,onBlur:(e,n)=>{n!==f.G.Invalid&&l(e.target.value)},onChange:(e,n)=>{n!==f.G.Invalid&&l(e.target.value)},ref:a,width:30}):(0,p.jsx)("span",{className:(0,b.cx)({[h.disabled]:c}),children:t})}),(0,p.jsx)("td",{children:o&&(0,p.jsx)(A.p,{closeOnConfirm:!0,confirmText:"Save",onConfirm:()=>{u(!1),o&&o(r)},onClick:()=>{u(!0)},onCancel:()=>{u(!1),l(t||"")},disabled:c,children:"Edit"})})]})},w=e=>({disabled:b.css`
      color: ${e.colors.text.secondary};
    `});var S,$=t(41455),T=t(74408);const D=e=>{let{label:n,serviceAccount:t,roleOptions:s,onRoleChange:i}=e;const c=`${n}-input`,o=d.Vt.hasPermissionInMetadata(u.bW.ServiceAccountsWrite,t);return(0,p.jsxs)("tr",{children:[(0,p.jsx)("td",{children:(0,p.jsx)(y._,{htmlFor:c,children:n})}),d.Vt.licensedAccessControlEnabled()?(0,p.jsx)("td",{colSpan:3,children:(0,p.jsx)($.R,{userId:t.id,orgId:t.orgId,basicRole:t.role,onBasicRoleChange:i,roleOptions:s,basicRoleDisabled:!o,disabled:t.isDisabled})}):(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("td",{children:(0,p.jsx)(T.A,{width:24,inputId:c,"aria-label":"Role",value:t.role,disabled:t.isDisabled,onChange:i})}),S||(S=(0,p.jsx)("td",{colSpan:2}))]})]})};var N;function E(e){let{serviceAccount:n,timeZone:t,roleOptions:s,onChange:i}=e;const c=(0,g.wW)(I),o=d.Vt.hasPermission(u.bW.ServiceAccountsWrite);return(0,p.jsxs)("div",{className:c.section,children:[N||(N=(0,p.jsx)("h3",{children:"Information"})),(0,p.jsx)("table",{className:"filter-table",children:(0,p.jsxs)("tbody",{children:[(0,p.jsx)(C,{label:"Name",value:n.name,onChange:e=>{i(Object.assign({},n,{name:e}))},disabled:!o||n.isDisabled}),(0,p.jsx)(C,{label:"ID",value:n.login,disabled:n.isDisabled}),(0,p.jsx)(D,{label:"Roles",serviceAccount:n,onRoleChange:e=>{i(Object.assign({},n,{role:e}))},roleOptions:s}),(0,p.jsx)(C,{label:"Creation date",value:(0,j.dq)(n.createdAt,{timeZone:t}),disabled:n.isDisabled})]})})]})}const I=e=>({section:b.css`
    margin-bottom: ${e.spacing(4)};
  `});var R,W,P=t(77772),O=t(21888),L=t(99500);const V=e=>{let{tokens:n,timeZone:t,tokenActionsDisabled:s,onDelete:i}=e;const c=(0,g.l4)(),o=q(c);return(0,p.jsxs)("table",{className:(0,b.cx)(o.section,"filter-table"),children:[R||(R=(0,p.jsx)("thead",{children:(0,p.jsxs)("tr",{children:[(0,p.jsx)("th",{children:"Name"}),(0,p.jsx)("th",{children:"Expires"}),(0,p.jsx)("th",{children:"Created"}),(0,p.jsx)("th",{children:"Last used at"}),(0,p.jsx)("th",{}),(0,p.jsx)("th",{})]})})),(0,p.jsx)("tbody",{children:n.map((e=>(0,p.jsxs)("tr",{className:o.tableRow(e.hasExpired||e.isRevoked),children:[(0,p.jsx)("td",{children:e.name}),(0,p.jsx)("td",{children:(0,p.jsx)(U,{timeZone:t,token:e})}),(0,p.jsx)("td",{children:z(t,e.created)}),(0,p.jsx)("td",{children:Z(t,e.lastUsedAt)}),(0,p.jsx)("td",{className:"width-1 text-center",children:e.isRevoked&&(W||(W=(0,p.jsx)(M,{})))}),(0,p.jsx)("td",{children:(0,p.jsx)(P.m,{"aria-label":`Delete service account token ${e.name}`,size:"sm",onConfirm:()=>i(e),disabled:s})})]},e.id)))})]})};function Z(e,n){return n?(0,j.dq)(n,{timeZone:e}):"Never"}function z(e,n){return n?(0,j.dq)(n,{timeZone:e}):"No expiration date"}function B(e){const n=Math.ceil(e/86400);return`Expires in ${n>1?`${n} days`:`${n} day`}`}const M=()=>{const e=(0,g.wW)(q);return(0,p.jsxs)("span",{className:e.hasExpired,children:["Revoked",(0,p.jsx)("span",{className:e.tooltipContainer,children:(0,p.jsx)(O.u,{content:"This token has been publicly exposed. Please rotate this token",children:(0,p.jsx)(L.J,{name:"exclamation-triangle",className:e.toolTipIcon})})})]})},U=e=>{let{timeZone:n,token:t}=e;const s=(0,g.wW)(q);return t.expiration?t.secondsUntilExpiration?(0,p.jsx)("span",{className:s.secondsUntilExpiration,children:B(t.secondsUntilExpiration)}):t.hasExpired?(0,p.jsxs)("span",{className:s.hasExpired,children:["Expired",(0,p.jsx)("span",{className:s.tooltipContainer,children:(0,p.jsx)(O.u,{content:"This token has expired",children:(0,p.jsx)(L.J,{name:"exclamation-triangle",className:s.toolTipIcon})})})]}):(0,p.jsx)("span",{children:z(n,t.expiration)}):(0,p.jsx)("span",{className:s.neverExpire,children:"Never"})},q=e=>({tableRow:n=>b.css`
    color: ${n?e.colors.text.secondary:e.colors.text.primary};
  `,tooltipContainer:b.css`
    margin-left: ${e.spacing(1)};
  `,toolTipIcon:b.css`
    color: ${e.colors.error.text};
  `,secondsUntilExpiration:b.css`
    color: ${e.colors.warning.text};
  `,hasExpired:b.css`
    color: ${e.colors.error.text};
  `,neverExpire:b.css`
    color: ${e.colors.text.secondary};
  `,section:b.css`
    margin-bottom: ${e.spacing(4)};
  `});var F=t(84665),X=t(93570),G=t(80795),J=t(83997),_=t(98669);const K="/api/serviceaccounts";function H(e){return async n=>{n((0,_.s3)());try{const t=await(0,X.i)().get(`${K}/${e}`,(0,J.y)());n((0,_.P4)(t))}catch(e){console.error(e)}finally{n((0,_.LA)())}}}function Q(e){return async n=>{try{const t=await(0,X.i)().get(`${K}/${e}/tokens`);n((0,_.e7)(t))}catch(e){console.error(e)}}}var Y;const ee={createServiceAccountToken:function(e,n,t){return async s=>{const i=await(0,X.i)().post(`${K}/${e}/tokens`,n);t(i.key),s(Q(e))}},deleteServiceAccount:function(e){return async()=>{await(0,X.i)().delete(`${K}/${e}`),G.E1.push("/org/serviceaccounts")}},deleteServiceAccountToken:function(e,n){return async t=>{await(0,X.i)().delete(`${K}/${e}/tokens/${n}`),t(Q(e))}},loadServiceAccount:H,loadServiceAccountTokens:Q,updateServiceAccount:function(e){return async n=>{await(0,X.i)().patch(`${K}/${e.id}?accesscontrol=true`,Object.assign({},e)),n(H(e.id))}}},ne=(0,i.connect)((function(e){return{serviceAccount:e.serviceAccountProfile.serviceAccount,tokens:e.serviceAccountProfile.tokens,isLoading:e.serviceAccountProfile.isLoading,roleOptions:e.serviceAccounts.roleOptions,timezone:(0,c.Z)(e.user)}}),ee),te=e=>{let{match:n,serviceAccount:t,tokens:i,timezone:c,isLoading:h,roleOptions:x,createServiceAccountToken:b,deleteServiceAccount:j,deleteServiceAccountToken:g,loadServiceAccount:f,loadServiceAccountTokens:y,updateServiceAccount:k}=e;const[A,C]=(0,s.useState)(""),[w,S]=(0,s.useState)(!1),[$,T]=(0,s.useState)(!1),[D,N]=(0,s.useState)(!1),I=parseInt(n.params.id,10),R=!d.Vt.hasPermission(u.bW.ServiceAccountsWrite)||t.isDisabled,W=d.Vt.hasPermission(u.bW.ServiceAccountsWrite),P=d.Vt.hasAccessInMetadata(u.bW.ServiceAccountsPermissionsRead,t,!1),O={text:t.name,img:t.avatarUrl,breadcrumbs:[{title:"Service accounts",url:"org/serviceaccounts"}],subTitle:"Manage settings for an individual service account."};(0,s.useEffect)((()=>{f(I),y(I),d.Vt.licensedAccessControlEnabled()&&(0,F.bX)()}),[f,y,I]);const L=e=>()=>{T(e)},Z=e=>()=>{N(e)};return(0,p.jsx)(l.T,{navId:"serviceaccounts",pageNav:O,children:(0,p.jsxs)(l.T.Contents,{isLoading:h,children:[(0,p.jsxs)("div",{children:[t&&(0,p.jsxs)(o.Lh,{spacing:"md",height:"auto",justify:"flex-end",children:[(0,p.jsx)(a.zx,{type:"button",variant:"destructive",onClick:L(!0),disabled:!d.Vt.hasPermission(u.bW.ServiceAccountsDelete),children:"Delete service account"}),t.isDisabled?(0,p.jsx)(a.zx,{type:"button",variant:"secondary",onClick:()=>{k(Object.assign({},t,{isDisabled:!1}))},disabled:!W,children:"Enable service account"}):(0,p.jsx)(a.zx,{type:"button",variant:"secondary",onClick:Z(!0),disabled:!W,children:"Disable service account"})]}),t&&(0,p.jsx)(E,{serviceAccount:t,timeZone:c,roleOptions:x,onChange:e=>{k(e)}}),(0,p.jsxs)(o.Lh,{justify:"space-between",height:"auto",children:[Y||(Y=(0,p.jsx)("h3",{children:"Tokens"})),(0,p.jsx)(a.zx,{onClick:()=>S(!0),disabled:R,children:"Add service account token"})]}),i&&(0,p.jsx)(V,{tokens:i,timeZone:c,onDelete:e=>{g(null==t?void 0:t.id,e.id)},tokenActionsDisabled:R}),P&&(0,p.jsx)(v,{serviceAccount:t})]}),(0,p.jsx)(r.s,{isOpen:$,title:"Delete service account",body:"Are you sure you want to delete this service account?",confirmText:"Delete service account",onConfirm:()=>{j(t.id)},onDismiss:L(!1)}),(0,p.jsx)(r.s,{isOpen:D,title:"Disable service account",body:"Are you sure you want to disable this service account?",confirmText:"Disable service account",onConfirm:()=>{k(Object.assign({},t,{isDisabled:!0})),N(!1)},onDismiss:Z(!1)}),(0,p.jsx)(m.m,{isOpen:w,token:A,serviceAccountLogin:t.login,onCreateToken:e=>{b(null==t?void 0:t.id,e,C)},onClose:()=>{S(!1),C("")}})]})})},se=ne(te)},27862:(e,n,t)=>{t.d(n,{m:()=>m});var s=t(52423),i=t(68404),c=t(44288),o=t(16755),a=t(78941),r=t(65678),l=t(4645),d=t(37625),u=t(65932),h=t(8006),x=t(11818),p=t(45916);const v=[{label:"No expiration",value:!1},{label:"Set expiration date",value:!0}],m=e=>{let{isOpen:n,token:t,serviceAccountLogin:s,onCreateToken:m,onClose:g}=e,f=new Date;f.setDate(f.getDate()+1);const[y,k]=(0,i.useState)(""),[A,C]=(0,i.useState)(""),[w,S]=(0,i.useState)(!1),[$,T]=(0,i.useState)(f),[D,N]=(0,i.useState)(""!==$),E=(0,o.wW)(j);(0,i.useEffect)((()=>{n&&k(`${s}-${(0,c.Z)()}`)}),[s,n]);const I=()=>{C(""),k(""),S(!1),T(f),N(""!==$),g()},R=t?"Service account token created":"Add service account token";return(0,p.jsx)(a.u,{isOpen:n,title:R,onDismiss:I,className:E.modal,contentClassName:E.modalContent,children:t?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(r.g,{label:"Token",description:"Copy the token now as you will not be able to see it again. Loosing a token requires creating a new one.",children:(0,p.jsxs)("div",{className:E.modalTokenRow,children:[(0,p.jsx)(l.I,{name:"tokenValue",value:t,readOnly:!0}),(0,p.jsx)(x.m,{className:E.modalCopyToClipboardButton,variant:"primary",size:"md",icon:"copy",getText:()=>t,children:"Copy clipboard"})]})}),(0,p.jsxs)(a.u.ButtonRow,{children:[(0,p.jsx)(x.m,{variant:"primary",getText:()=>t,onClipboardCopy:I,children:"Copy to clipboard and close"}),(0,p.jsx)(h.zx,{variant:"secondary",onClick:I,children:"Close"})]})]}):(0,p.jsxs)("div",{children:[(0,p.jsx)(r.g,{label:"Display name",description:"Name to easily identify the token",required:!0,children:(0,p.jsx)(l.I,{name:"tokenName",value:A,placeholder:y,onChange:e=>{C(e.currentTarget.value)}})}),(0,p.jsx)(r.g,{label:"Expiration",children:(0,p.jsx)(d.S,{options:v,value:w,onChange:S,size:"md"})}),w&&(0,p.jsx)(r.g,{label:"Expiration date",children:(0,p.jsx)(u.d,{onChange:e=>{N(""!==e),T(e)},value:$,placeholder:"",minDate:f})}),(0,p.jsx)(a.u.ButtonRow,{children:(0,p.jsx)(h.zx,{onClick:()=>{m({name:A||y,secondsToLive:w?b($):void 0})},disabled:w&&!D,children:"Generate token"})})]})})},b=e=>{const n=new Date(e),t=new Date;return Math.ceil((n.getTime()-t.getTime())/1e3)},j=e=>({modal:s.css`
      width: 550px;
    `,modalContent:s.css`
      overflow: visible;
    `,modalTokenRow:s.css`
      display: flex;
    `,modalCopyToClipboardButton:s.css`
      margin-left: ${e.spacing(.5)};
    `})},39670:(e,n,t)=>{t.d(n,{t:()=>s});const s="grafana.serviceaccounts.showApiKeysMigrationInfo"},84665:(e,n,t)=>{t.d(n,{R5:()=>f,TL:()=>m,XE:()=>y,Xd:()=>p,bX:()=>h,f3:()=>A,fT:()=>j,hv:()=>x,xi:()=>k,yN:()=>b});var s=t(82897),i=t(93570),c=t(97928),o=t(59196),a=t(78130),r=t(64850),l=t(39670),d=t(98669);const u="/api/serviceaccounts";function h(){return async e=>{try{if(o.Vt.licensedAccessControlEnabled()&&o.Vt.hasPermission(r.bW.ActionRolesList)){const n=await(0,c.ul)();e((0,d.Dn)(n))}}catch(e){console.error(e)}}}function x(){return async e=>{if(o.Vt.hasPermission(r.bW.ServiceAccountsRead)){const n=await(0,i.i)().get("/api/serviceaccounts/migrationstatus");e((0,d.cB)(!(null==n||!n.migrated)))}}}function p(){let{withLoadingIndicator:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{withLoadingIndicator:!1};return async(n,t)=>{try{if(o.Vt.hasPermission(r.bW.ServiceAccountsRead)){e&&n((0,d.pN)());const{perPage:s,page:c,query:o,serviceAccountStateFilter:a}=t().serviceAccounts,r=await(0,i.i)().get(`/api/serviceaccounts/search?perpage=${s}&page=${c}&query=${o}${g(a)}&accesscontrol=true`);n((0,d.Ub)(r))}}catch(e){console.error(e)}finally{n((0,d.dt)())}}}const v=(0,s.debounce)((e=>e(p())),500,{leading:!0});function m(e){return async n=>{await(0,i.i)().patch(`${u}/${e.id}?accesscontrol=true`,Object.assign({},e)),n(p())}}function b(e){return async n=>{await(0,i.i)().delete(`${u}/${e}`),n(p())}}function j(e,n,t){return async s=>{const c=await(0,i.i)().post(`${u}/${e}/tokens`,n);t(c.key),s(p())}}const g=e=>{switch(e){case r.Wc.WithExpiredTokens:return"&expiredTokens=true";case r.Wc.Disabled:return"&disabled=true";default:return""}};function f(e){return async n=>{n((0,d.aj)(e)),v(n)}}function y(e){return async n=>{n((0,d.M4)(e)),n(p())}}function k(){return async e=>{const n=a.Z.getBool(l.t,!1);e((0,d.gl)(n))}}function A(){return async e=>{a.Z.set(l.t,!1),e(k())}}}}]);
//# sourceMappingURL=ServiceAccountPage.85676c83cd074ded5ac3.js.map