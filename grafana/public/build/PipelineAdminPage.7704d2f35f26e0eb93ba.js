"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2651],{98619:(e,t,n)=>{n.r(t),n.d(t,{default:()=>U});var a=n(68404),l=n(93570),s=n(4645),r=n(37417),i=n(40901),o=n(22543),c=n(94570),u=n(54761),d=n(65678),h=n(8006),p=n(15013),v=n(47900),g=n(45916);const x=[{label:"Data source",description:"Configure a channel scoped to a data source instance",value:"ds"},{label:"Any",description:"Enter an arbitray channel pattern",value:"any"}];function j(e){let{onRuleAdded:t}=e;const[n,r]=(0,a.useState)(),[i,j]=(0,a.useState)(),[m,f]=(0,a.useState)(""),[y,C]=(0,a.useState)(),b=(0,v.iG)(),S=()=>{i?"ds"!==n||m.length?(0,l.i)().post("api/live/channel-rules",{pattern:m+i,settings:{converter:{type:"jsonAuto"},frameOutputs:[{type:"managedStream"}]}}).then((e=>{console.log("ADDED",e),j(void 0),r(void 0),t(e.rule)})).catch((e=>{b.error("Error adding rule",e),e.isHandled=!0})):b.error("Select datasource"):b.error("Enter path")};return n?(0,g.jsx)("div",{children:(0,g.jsxs)(u.Lh,{children:["any"===n&&(0,g.jsx)(d.g,{label:"Pattern",children:(0,g.jsx)(s.I,{value:null!=i?i:"",onChange:e=>j(e.currentTarget.value),placeholder:"scope/namespace/path"})}),"ds"===n&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(d.g,{label:"Data source",children:(0,g.jsx)(c.q,{current:y,onChange:e=>{C(e),f(`${o.z.DataSource}/${e.uid}/`)}})}),(0,g.jsx)(d.g,{label:"Path",children:(0,g.jsx)(s.I,{value:null!=i?i:"",onChange:e=>j(e.currentTarget.value),placeholder:"path"})})]}),(0,g.jsx)(d.g,{label:"",children:(0,g.jsx)(h.zx,{onClick:S,variant:null!=i&&i.length?"primary":"secondary",children:"Add"})}),(0,g.jsx)(d.g,{label:"",children:(0,g.jsx)(h.zx,{variant:"secondary",onClick:()=>r(void 0),children:"Cancel"})})]})}):(0,g.jsx)("div",{children:(0,g.jsx)(p.b,{label:"Add channel rule",variant:"secondary",size:"md",icon:"plus",menuPlacement:"auto",isFullWidth:!1,options:x,onChange:e=>r(e.value)})})}var m=n(52423),f=n(51028),y=n(23734),C=n(42833),b=n(78941),S=n(10453),O=n(87152),T=n(71873),w=n(70917),k=n(31787);const N=e=>{var t;let{onChange:n,value:a,ruleType:l,entitiesInfo:s}=e;return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(w.Ph,{options:s[l],placeholder:"Select an option",value:null!==(t=null==a?void 0:a.type)&&void 0!==t?t:"",onChange:e=>{const t=e.value;n({type:t,[t]:s.getExample(l,t)})}},l),(0,g.jsx)(k.p,{height:"50vh",value:a?JSON.stringify(a[a.type],null,"\t"):"",showLineNumbers:!0,readOnly:!1,language:"json",showMiniMap:!1,onBlur:e=>{const t=JSON.parse(e);n({type:a.type,[a.type]:t})}})]})},P=e=>{let{onChange:t,value:n,ruleType:l,entitiesInfo:s}=e;const[r,i]=(0,a.useState)(0),o=null!=n?n:[];let c=[];for(let e=0;e<=o.length;e++)c.push({label:`${l}: ${e}`,value:e});return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(w.Ph,{placeholder:"Select an index",options:c,value:r,onChange:e=>{i(e.value)}}),(0,g.jsx)(N,{onChange:e=>{if(n){const a=[...n];a[r]=e,t(a)}else t([e])},value:o[r],ruleType:l,entitiesInfo:s})]})};var I=n(99511),A=n(43917),E=n(65737),R=n(41345);const D=e=>{const[t,n]=(0,a.useState)(),[s,r]=(0,a.useState)();return(0,g.jsxs)("div",{children:[(0,g.jsx)(k.p,{height:100,value:"",showLineNumbers:!0,readOnly:!1,language:"json",showMiniMap:!1,onBlur:e=>{r(e)}}),(0,g.jsx)(h.zx,{onClick:()=>{(0,l.i)().post("api/live/pipeline-convert-test",{channelRules:[e.rule],channel:e.rule.pattern,data:s}).then((e=>{const t=e.channelFrames;t&&n(t.map((e=>{const t=(0,I.vP)(e.frame);for(const e of t.fields)e.display=(0,A.U)({field:e,theme:E.v.theme2});return{channel:e.channel,frame:t}})))})).catch((e=>{n(e)}))},className:M.margin,children:"Test"}),(null==t?void 0:t.length)&&t.map((e=>(0,g.jsx)(d.g,{label:e.channel,children:(0,g.jsx)(R.i,{data:e.frame,width:700,height:Math.min(10*e.frame.length+10,150),showTypeIcons:!0})},e.channel)))]})},M={margin:m.css`
    margin-bottom: 15px;
  `};function z(e,t){return Array.isArray(e)?e.map((e=>({label:e[t],value:e[t]}))):e[t].map((e=>({label:e.type,value:e.type})))}const F=[{label:"Converter",type:"converter",isConverter:!0},{label:"Processors",type:"frameProcessors"},{label:"Outputs",type:"frameOutputs"},{label:"Test",isTest:!0,icon:"flask"}],J=e=>{var t;const{isOpen:n,onClose:s,clickColumn:r}=e,[i,o]=(0,a.useState)(e.rule),[c,u]=(0,a.useState)(F.find((e=>e.type===r))),[d,p]=(0,a.useState)(!1),[v,x]=(0,a.useState)(null!=c&&c.type?null==i||null===(t=i.settings)||void 0===t?void 0:t[c.type]:void 0),[j,m]=(0,a.useState)(),f=e=>{p(!0),null!=c&&c.type&&o(Object.assign({},i,{settings:Object.assign({},i.settings,{[null==c?void 0:c.type]:e})})),x(e)};(0,a.useMemo)((()=>{(async function(){return await(0,l.i)().get("api/live/pipeline-entities").then((e=>({converter:z(e,"converters"),frameProcessors:z(e,"frameProcessors"),frameOutputs:z(e,"frameOutputs"),getExample:(t,n)=>{var a,l,s;return null===(a=e[`${t}s`])||void 0===a||null===(l=a.filter((e=>e.type===n)))||void 0===l||null===(s=l[0])||void 0===s?void 0:s.example}})))})().then((e=>{m(e)}))}),[]);return(0,g.jsxs)(b.u,{isOpen:n,title:i.pattern,onDismiss:s,closeOnEscape:!0,children:[(0,g.jsx)(S.J,{children:F.map(((e,t)=>(0,g.jsx)(O.O,{label:e.label,active:e===c,icon:e.icon,onChangeTab:()=>{var t;(u(e),e.type)&&x(null==i||null===(t=i.settings)||void 0===t?void 0:t[e.type])}},t)))}),(0,g.jsxs)(T.I,{children:[j&&i&&c&&(0,g.jsxs)(g.Fragment,{children:[(null==c?void 0:c.isTest)&&(0,g.jsx)(D,{rule:i}),c.isConverter&&(0,g.jsx)(N,{onChange:f,value:v,ruleType:"converter",entitiesInfo:j}),!c.isConverter&&c.type&&(0,g.jsx)(P,{onChange:f,value:v,ruleType:c.type,entitiesInfo:j})]}),(0,g.jsx)(h.zx,{onClick:()=>{(0,l.i)().put("api/live/channel-rules",i).then((()=>{p(!1),s()})).catch((e=>console.error(e)))},className:L.save,variant:d?"primary":"secondary",children:"Save"})]})]})},L={save:m.css`
    margin-top: 5px;
  `};var $,q,B,G;function V(e,t){return null!=t&&t.type?(0,g.jsx)(f.V,{name:t.type},e):null}const W=e=>{const{rules:t}=e,[n,s]=(0,a.useState)(!1),[r,i]=(0,a.useState)(),[o,c]=(0,a.useState)("converter"),u=(e,t)=>{var n;if(!e)return;let a=null==t||null===(n=t.target)||void 0===n?void 0:n.getAttribute("data-column");a&&"pattern"!==a||(a="converter"),c(a),i(e),s(!0)};(0,a.useEffect)((()=>{e.selectRule&&u(e.selectRule)}),[e.selectRule]);const d=e=>{if(e.startsWith("ds/")){const t=e.indexOf("/",4);if(t>3){const n=e.substring(3,t),a=(0,C.ak)().getInstanceSettings(n);if(a)return(0,g.jsxs)("div",{children:[(0,g.jsx)(f.V,{name:a.name,colorIndex:1}),"  ",(0,g.jsx)("span",{children:e.substring(t+1)})]})}}return e};return(0,g.jsxs)("div",{children:[(0,g.jsx)("div",{className:"admin-list-table",children:(0,g.jsxs)("table",{className:"filter-table filter-table--hover form-inline",children:[(0,g.jsx)("thead",{children:(0,g.jsxs)("tr",{children:[$||($=(0,g.jsx)("th",{children:"Channel"})),q||(q=(0,g.jsx)("th",{children:"Converter"})),B||(B=(0,g.jsx)("th",{children:"Processor"})),G||(G=(0,g.jsx)("th",{children:"Output"})),(0,g.jsx)("th",{style:{width:10},children:" "})]})}),(0,g.jsx)("tbody",{children:t.map((t=>{var n,a,s,r,i,o;return(0,g.jsxs)("tr",{onClick:e=>u(t,e),className:H.row,children:[(0,g.jsx)("td",{"data-pattern":t.pattern,"data-column":"pattern",children:d(t.pattern)}),(0,g.jsx)("td",{"data-pattern":t.pattern,"data-column":"converter",children:null===(n=t.settings)||void 0===n||null===(a=n.converter)||void 0===a?void 0:a.type}),(0,g.jsx)("td",{"data-pattern":t.pattern,"data-column":"processor",children:null===(s=t.settings)||void 0===s||null===(r=s.frameProcessors)||void 0===r?void 0:r.map((e=>(0,g.jsx)("span",{children:e.type},t.pattern+e.type)))}),(0,g.jsx)("td",{"data-pattern":t.pattern,"data-column":"output",children:null===(i=t.settings)||void 0===i||null===(o=i.frameOutputs)||void 0===o?void 0:o.map((e=>(0,g.jsx)("span",{children:V("out",e)},t.pattern+e.type)))}),(0,g.jsx)("td",{children:(0,g.jsx)(y.h,{name:"trash-alt",onClick:n=>{var a;n.stopPropagation(),a=t.pattern,(0,l.i)().delete("api/live/channel-rules",JSON.stringify({pattern:a})).catch((e=>console.error(e))).finally((()=>{e.onRuleChanged()}))}})})]},t.pattern)}))})]})}),n&&r&&(0,g.jsx)(J,{rule:r,isOpen:n,onClose:()=>{s(!1)},clickColumn:o})]})},H={row:m.css`
    cursor: pointer;
  `};function U(){const[e,t]=(0,a.useState)([]),[n,o]=(0,a.useState)([]),[c,u]=(0,a.useState)(),d=(0,i.q)("live-pipeline"),[h,p]=(0,a.useState)(),v=()=>{(0,l.i)().get("api/live/channel-rules").then((e=>{var n,a;t(null!==(n=e.rules)&&void 0!==n?n:[]),o(null!==(a=e.rules)&&void 0!==a?a:[])})).catch((e=>{e.data&&p(JSON.stringify(e.data,null,2))}))};(0,a.useEffect)((()=>{v()}),[]);return(0,g.jsx)(r.T,{navModel:d,children:(0,g.jsxs)(r.T.Contents,{children:[h&&(0,g.jsx)("pre",{children:h}),(0,g.jsx)("div",{className:"page-action-bar",children:(0,g.jsx)("div",{className:"gf-form gf-form--grow",children:(0,g.jsx)(s.I,{placeholder:"Search pattern...",onChange:a=>{a.target.value?t(e.filter((e=>e.pattern.toLowerCase().includes(a.target.value.toLowerCase())))):t(n)}})})}),(0,g.jsx)(W,{rules:e,onRuleChanged:v,selectRule:c}),(0,g.jsx)(j,{onRuleAdded:t=>{console.log("GOT",t,"vs",e[0]),u(t),v()}})]})})}}}]);
//# sourceMappingURL=PipelineAdminPage.7704d2f35f26e0eb93ba.js.map