"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4679],{13163:(e,t,r)=>{r.r(t),r.d(t,{RuleViewer:()=>oe,default:()=>de});var s=r(52423),n=r(68404),a=r(60532),i=r(28173),l=r(16755),o=r(2843),c=r(38953),u=r(54761),d=r(8006),h=r(99500),f=r(21144),g=r(72767),p=r(42949),m=r(90062),x=r(95018),j=r(47628),v=r(79129),b=r(89050),y=r(88246),w=r(274),S=r(8910),C=r(76308),R=r(65737),$=r(31787),q=r(73334),I=r(38252),N=r(64850),O=r(74846),k=r(60277),T=r(50848),M=r(45916);const U=["refId"];var Q;function z(e){var t;const r=(0,l.l4)(),s=(0,l.wW)(F),{data:a,query:i,onChangeQuery:c}=e,u=(0,I.j)(i.model)?O.Fe:O.GC,[h,f]=(0,n.useState)(u);let g=i.datasourceUid;var p,m;(0,I.j)(i.model)&&(g=null!==(p=null===(m=i.model.datasource)||void 0===m?void 0:m.type)&&void 0!==p?p:i.datasourceUid);const x=(0,S.F)().getInstanceSettings(g),j=i.relativeTimeRange,[v,w]=(0,n.useState)({frameIndex:0,showHeader:!0}),R=(0,n.useCallback)((e=>{const t=(0,y.CQ)().unix()-e.unix();if(j){const e=j.from-j.to;c(Object.assign({},i,{relativeTimeRange:{from:t+e,to:t}}))}}),[c,i,j]),U=(0,n.useCallback)((e=>0===e?(0,y.CQ)():(0,y.CQ)().subtract(e,"seconds")),[]);return a?x?(0,M.jsx)("div",{className:s.content,children:(0,M.jsx)(b.Z,{children:e=>{let{width:n,height:l}=e;return(0,M.jsxs)("div",{style:{width:n,height:l},children:[(0,M.jsxs)("div",{className:s.header,children:[(0,M.jsxs)("div",{children:[`Query ${i.refId}`,(0,M.jsxs)("span",{className:s.dataSource,children:["(",x.name,")"]})]}),(0,M.jsxs)("div",{className:s.actions,children:[!(0,I.j)(i.model)&&j?(0,M.jsx)(q.x,{date:U(j.to),onChange:R,maxDate:new Date}):null,t||(t=(0,M.jsx)(T.j,{onChange:f,value:h,size:"md"})),(0,M.jsx)(k.q,{actions:[N.bW.DataSourcesExplore],children:!(0,I.j)(i.model)&&(0,M.jsxs)(M.Fragment,{children:[(0,M.jsx)("div",{className:s.spacing}),(0,M.jsx)(d.Qj,{size:"md",variant:"secondary",icon:"compass",target:"_blank",href:D(x,i),children:"View in Explore"})]})})]})]}),(0,M.jsx)(C.$,{height:l-4*r.spacing.gridSize,width:n,data:a,pluginId:h,title:"",onOptionsChange:w,options:v})]})}})}):(0,M.jsxs)("div",{className:s.content,children:[Q||(Q=(0,M.jsx)(o.b,{title:"Could not find datasource for query"})),(0,M.jsx)($.p,{width:"100%",height:"250px",language:"json",showLineNumbers:!1,showMiniMap:!1,value:JSON.stringify(i,null,"\t"),readOnly:!0})]}):null}function D(e,t){const{name:r}=e,s=function(e,t){if(null==e)return{};var r,s,n={},a=Object.keys(e);for(s=0;s<a.length;s++)r=a[s],t.indexOf(r)>=0||(n[r]=e[r]);return n}(t.model,U),n=Object.assign({},s,{datasource:r});return w.Cj.renderUrl(`${R.v.appSubUrl}/explore`,{left:JSON.stringify(["now-1h","now",r,n])})}const F=e=>({content:s.css`
      width: 100%;
      height: 250px;
    `,header:s.css`
      height: ${e.spacing(4)};
      display: flex;
      align-items: center;
      justify-content: space-between;
      white-space: nowrap;
    `,refId:s.css`
      font-weight: ${e.typography.fontWeightMedium};
      color: ${e.colors.text.link};
      overflow: hidden;
    `,dataSource:s.css`
      margin-left: ${e.spacing(1)};
      font-style: italic;
      color: ${e.colors.text.secondary};
    `,actions:s.css`
      display: flex;
      align-items: center;
    `,spacing:s.css`
      padding: ${e.spacing(0,1,0,0)};
    `,errorMessage:s.css`
      white-space: pre-wrap;
    `});var G=r(57306),P=r(81887),W=r(93991),A=r(47286);const E=e=>{var t;let{group:r}=e;const s=null!==(t=r.source_tenants)&&void 0!==t?t:[];return(0,M.jsx)(x.C,{label:"Tenant sources",children:(0,M.jsx)(M.Fragment,{children:s.map((e=>(0,M.jsx)("div",{children:e},e)))})})};var L=r(39778),V=r(84438),_=r(31244),J=r(85976),Z=r(76159),H=r(28774),B=r(43271),K=r(80458);function X(e){if(!e)return[];const{namespace:t,rulerRule:r}=e,{rulesSource:s}=t;if((0,B.HY)(s)&&(0,K.Pc)(r))return r.grafana_alert.data;if((0,B.jq)(s)){const t=function(e,t){const r="A";switch(e.type){case"prometheus":return{refId:r,expr:t.query};case"loki":return{refId:r,expr:t.query};default:throw new Error(`Query for datasource type ${e.type} is currently not supported by cloud alert rules.`)}}(s,e);return[(n=t,a=s.uid,{refId:n.refId,datasourceUid:a,queryType:"",model:n,relativeTimeRange:{from:360,to:0}})]}var n,a;return[]}var Y,ee,te,re,se,ne=r(55357);const ae="Could not find data source for rule",ie="Could not view rule",le="View rule";function oe(e){let{match:t}=e;const r=(0,l.wW)(ue),{id:s}=t.params,i=ne.OA(s,!0),{loading:g,error:b,result:y}=(0,Z.H)(i,null==i?void 0:i.ruleSourceName),w=(0,n.useMemo)((()=>new H.v),[]),S=(0,a.Z)(w.get()),C=(0,n.useMemo)((()=>X(y)),[y]),[R,$]=(0,n.useState)([]),{allDataSourcesAvailable:q}=(0,J.S)(C),I=(0,n.useCallback)((()=>{R.length>0&&q&&w.run(R)}),[R,w,q]);(0,n.useEffect)((()=>{$(C)}),[C]),(0,n.useEffect)((()=>{q&&I()}),[I,q]),(0,n.useEffect)((()=>()=>w.destroy()),[w]);const N=(0,n.useCallback)((e=>{$((t=>t.map((t=>t.refId===e.refId?e:t))))}),[]);if(null==i||!i.ruleSourceName)return(0,M.jsx)(v.$,{title:le,children:(0,M.jsx)(o.b,{title:ie,children:(0,M.jsx)("details",{className:r.errorMessage,children:ae})})});const O=(0,B.o_)(i.ruleSourceName);if(g)return Y||(Y=(0,M.jsx)(v.$,{title:le,children:(0,M.jsx)(c.u,{text:"Loading rule..."})}));var k;if(b||!O)return(0,M.jsx)(v.$,{title:le,children:(0,M.jsx)(o.b,{title:ie,children:(0,M.jsxs)("details",{className:r.errorMessage,children:[null!==(k=null==b?void 0:b.message)&&void 0!==k?k:ae,ee||(ee=(0,M.jsx)("br",{})),!(null==b||!b.stack)&&b.stack]})})});if(!y)return te||(te=(0,M.jsx)(v.$,{title:le,children:(0,M.jsx)("span",{children:"Rule could not be found."})}));const T=Object.entries(y.annotations).filter((e=>{let[t,r]=e;return!!r.trim()})),U=(0,K.Jq)(y.group),Q=(0,K.Pc)(y.rulerRule)&&Boolean(y.rulerRule.grafana_alert.provenance);return(0,M.jsxs)(v.$,{wrapInContent:!1,title:le,children:[U&&(re||(re=(0,M.jsx)(o.b,{severity:"info",title:"This rule is part of a federated rule group.",children:(0,M.jsxs)(u.wc,{children:["Federated rule groups are currently an experimental feature.",(0,M.jsx)(d.zx,{fill:"text",icon:"book",children:(0,M.jsx)("a",{href:"https://grafana.com/docs/metrics-enterprise/latest/tenant-management/tenant-federation/#cross-tenant-alerting-and-recording-rule-federation",children:"Read documentation"})})]})}))),Q&&(0,M.jsx)(j.Xq,{resource:j.Uv.AlertRule}),(0,M.jsxs)(v.l,{children:[(0,M.jsxs)("div",{children:[(0,M.jsxs)("h4",{children:[se||(se=(0,M.jsx)(h.J,{name:"bell",size:"lg"}))," ",y.name]}),(0,M.jsx)(_.p,{rule:y,isCreating:!1,isDeleting:!1}),(0,M.jsx)(G.f,{rule:y,rulesSource:O,isViewMode:!0})]}),(0,M.jsxs)("div",{className:r.details,children:[(0,M.jsxs)("div",{className:r.leftSide,children:[y.promRule&&(0,M.jsx)(x.C,{label:"Health",horizontal:!0,children:(0,M.jsx)(V.V,{rule:y.promRule})}),!!y.labels&&!!Object.keys(y.labels).length&&(0,M.jsx)(x.C,{label:"Labels",horizontal:!0,children:(0,M.jsx)(m.s,{labels:y.labels})}),(0,M.jsx)(A.C,{rulesSource:O,rule:y,annotations:T}),(0,M.jsx)(P.J,{annotations:T})]}),(0,M.jsxs)("div",{className:r.rightSide,children:[(0,M.jsx)(W.C,{rule:y,rulesSource:O}),U&&(0,M.jsx)(E,{group:y.group}),(0,M.jsx)(x.C,{label:"Namespace / Group",children:`${y.namespace.name} / ${y.group.name}`})]})]}),(0,M.jsx)("div",{children:(0,M.jsx)(L.M,{rule:y,pagination:{itemsPerPage:p.gN}})})]}),!U&&S&&Object.keys(S).length>0&&(0,M.jsxs)(M.Fragment,{children:[(0,M.jsxs)("div",{className:r.queriesTitle,children:["Query results ",(0,M.jsx)(f.T,{loading:ce(S),onCancel:()=>w.cancel()})]}),(0,M.jsx)(v.l,{padding:0,children:(0,M.jsx)("div",{className:r.queries,children:R.map((e=>(0,M.jsx)("div",{className:r.query,children:(0,M.jsx)(z,{query:e,data:S&&S[e.refId],onChangeQuery:N})},e.refId)))})})]}),!U&&!q&&(0,M.jsx)(o.b,{title:"Query not available",severity:"warning",className:r.queryWarning,children:"Cannot display the query preview. Some of the data sources used in the queries are not available."})]})}function ce(e){return!!Object.values(e).find((e=>e.state===i.Gu.Loading))}const ue=e=>({errorMessage:s.css`
      white-space: pre-wrap;
    `,queries:s.css`
      height: 100%;
      width: 100%;
    `,queriesTitle:s.css`
      padding: ${e.spacing(2,.5)};
      font-size: ${e.typography.h5.fontSize};
      font-weight: ${e.typography.fontWeightBold};
      font-family: ${e.typography.h5.fontFamily};
    `,query:s.css`
      border-bottom: 1px solid ${e.colors.border.medium};
      padding: ${e.spacing(2)};
    `,queryWarning:s.css`
      margin: ${e.spacing(4,0)};
    `,details:s.css`
      display: flex;
      flex-direction: row;
    `,leftSide:s.css`
      flex: 1;
    `,rightSide:s.css`
      padding-left: 90px;
      width: 300px;
    `}),de=(0,g.Pf)(oe,{style:"page"})},60277:(e,t,r)=>{r.d(t,{q:()=>a});r(68404);var s=r(59196),n=r(45916);const a=e=>{let{actions:t,children:r,fallback:a=!0}=e;return t.some((e=>s.Vt.hasAccess(e,a)))?(0,n.jsx)(n.Fragment,{children:r}):null}},50848:(e,t,r)=>{r.d(t,{j:()=>o});var s=r(68404),n=r(65737),a=r(37625),i=r(74846),l=r(45916);function o(e){const{value:t,onChange:r,size:o="md"}=e,c=(0,s.useMemo)((()=>Object.values(n.v.panels).reduce(((e,t)=>(function(e){switch(e){case i.GC:case i.Fe:case i.Kd:return!0;default:return!1}}(t.id)&&e.push({value:t.id,label:t.name,imgUrl:t.info.logos.small}),e)),[])),[]);return(0,l.jsx)(a.S,{options:c,value:t,onChange:r,size:o})}},79129:(e,t,r)=>{r.d(t,{$:()=>o,l:()=>c});var s=r(52423),n=(r(68404),r(16755)),a=r(37417),i=r(45916);const l={icon:"bell",id:"alert-rule-view",breadcrumbs:[{title:"Alert rules",url:"alerting/list"}]};function o(e){const{wrapInContent:t=!0,children:r,title:s}=e,o=(0,n.wW)(u);return(0,i.jsx)(a.T,{pageNav:Object.assign({},l,{text:s}),navId:"alert-list",children:(0,i.jsx)(a.T.Contents,{children:(0,i.jsx)("div",{className:o.content,children:t?(0,i.jsx)(c,Object.assign({},e)):r})})})}function c(e){let{children:t,padding:r=2}=e;const s=(0,n.wW)(d(r));return(0,i.jsx)("div",{className:s.wrapper,children:t})}const u=e=>({content:s.css`
      max-width: ${e.breakpoints.values.xxl}px;
    `}),d=e=>t=>({wrapper:s.css`
      background: ${t.colors.background.primary};
      border: 1px solid ${t.colors.border.weak};
      border-radius: ${t.shape.borderRadius()};
      padding: ${t.spacing(e)};
    `})},85976:(e,t,r)=>{r.d(t,{S:()=>i});var s=r(68404),n=r(8910),a=r(18474);function i(e){return{allDataSourcesAvailable:(0,s.useMemo)((()=>e.filter((e=>!(0,a.Pr)(e.datasourceUid))).every((e=>{const t=(0,n.F)().getInstanceSettings(e.datasourceUid);return Boolean(t)}))),[e])}}},76159:(e,t,r)=>{r.d(t,{H:()=>h,X:()=>f});var s=r(68404),n=r(66015),a=r(64850),i=r(64834),l=r(5302),o=r(55357),c=r(80458),u=r(36521),d=r(76938);function h(e,t){const r=g(t),n=(0,u.Zo)(t),a=(0,s.useMemo)((()=>{if(e&&t&&0!==n.length)for(const r of n)for(const s of r.groups)for(const r of s.rules){const s=o.Yd(t,r);if(o.Dg(s,e))return r}}),[e,t,n]);return Object.assign({},r,{result:a})}function f(e,t){const r=g(t),n=(0,u.Zo)(t),a=(0,s.useMemo)((()=>{if(!e||!t||0===n.length)return[];const r=[];for(const t of n)for(const s of t.groups)for(const t of s.rules)t.name===e&&r.push(t);return r}),[e,t,n]);return Object.assign({},r,{result:a})}function g(e){var t;const r=(0,a.I0)(),s=(0,d._)((e=>e.promRules)),l=p(e,s),o=(0,d._)((e=>e.rulerRules)),u=p(e,o),{loading:h}=(0,n.Z)((async()=>{e&&await r((0,i.dn)({rulesSourceName:e}))}),[r,e]);return{loading:h,error:(null!==(t=l.error)&&void 0!==t?t:(0,c.m$)(u))?void 0:u.error,dispatched:l.dispatched&&u.dispatched}}function p(e,t){if(!e)return l.oq;const r=t[e];return r||l.oq}},28774:(e,t,r)=>{r.d(t,{v:()=>N});var s=r(16527),n=r(53786),a=r(94514),i=r(44962),l=r(2101),o=r(44288),c=r(28173),u=r(6003),d=r(85699),h=r(12717),f=r(99511),g=r(8910),p=r(75386),m=r(42200),x=r(38252),j=r(95160),v=r(15203),b=r(8343),y=r(52394);const w={from:21600,to:0},S=(e,t)=>{switch(e.type){case y.Us.classic:return C(e);case y.Us.math:return $(e,t);case y.Us.resample:case y.Us.reduce:case y.Us.threshold:return q(e)}},C=e=>{var t;return null===(t=e.conditions)||void 0===t?void 0:t.map((e=>e.query.params[0]))},R=(e,t)=>{let r=[],s=[w.to];for(const n of e){const e=t.find((e=>e.refId===n));e&&e.relativeTimeRange&&(r.push(e.relativeTimeRange.from),s.push(e.relativeTimeRange.to))}return{from:r,to:s}},$=(e,t)=>t.filter((t=>{var r;return"query"===t.queryType&&(null===(r=e.expression)||void 0===r?void 0:r.includes(t.refId))})).map((e=>e.refId)),q=e=>e.expression?[e.expression]:void 0;function I(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class N{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,m.i)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,g.F)();I(this,"subject",void 0),I(this,"subscription",void 0),I(this,"lastResult",void 0),this.backendSrv=e,this.dataSourceSrv=t,this.subject=new s.t(1),this.lastResult={}}get(){return this.subject.asObservable()}async run(e){if(0===e.length){const t=k(e,c.Gu.Done);return this.subject.next(t)}for(const t of e)if(!(0,x.j)(t.model)){const r=await this.dataSourceSrv.get(t.datasourceUid);if(r.filterQuery&&!r.filterQuery(t.model)){const t=k(e,c.Gu.Done);return this.subject.next(t)}}this.subscription=O(this.backendSrv,e).subscribe({next:e=>{const t=Q(e,((e,t)=>{const r=this.lastResult[e],s=(0,b.zR)(t,r);return(0,v.C)(s,r)}));this.lastResult=t,this.subject.next(this.lastResult)},error:e=>{this.lastResult=U(this.lastResult,e),this.subject.next(this.lastResult)}})}cancel(){if(!this.subscription)return;this.subscription.unsubscribe();let e=!1;const t=Q(this.lastResult,((t,r)=>(r.state===c.Gu.Loading&&(e=!0),Object.assign({},r,{state:c.Gu.Done}))));e&&this.subject.next(t)}destroy(){this.subject&&this.subject.complete(),this.cancel()}}const O=(e,t)=>{const r=k(t,c.Gu.Loading),s={data:{data:t},url:"/api/v1/eval",method:"POST",requestId:(0,o.Z)()};return(0,u.x)({whileLoading:r,source:e.fetch(s).pipe(M(r),(0,a.K)((e=>(0,n.of)(U(r,e)))),(0,j.V)(e,s.requestId),(0,i.B)())})},k=(e,t)=>e.reduce(((r,s)=>(r[s.refId]={state:t,series:[],timeRange:T(s,e)},r)),{}),T=(e,t)=>{if((0,x.j)(e.model)){const r=((e,t)=>{const r=S(e,t);if(!r)return w;const{from:s,to:n}=R(r,t);return s.length||n.length?{from:Math.max(...s),to:Math.min(...n)}:w})(e.model,t);return d.relativeToTimeRange(r)}return e.relativeTimeRange?d.relativeToTimeRange(e.relativeTimeRange):(console.warn(`Query with refId: ${e.refId} did not have any relative time range, using default.`),(0,h.JK)())},M=e=>(0,l.U)((t=>{const{data:r}=t,s={};for(const[t,n]of Object.entries(r.results))s[t]={timeRange:e[t].timeRange,state:c.Gu.Done,series:n.frames.map(f.vP)};return s})),U=(e,t)=>{const r=(0,p.P)(t);return Q(e,((e,t)=>Object.assign({},t,{state:c.Gu.Error,error:r})))},Q=(e,t)=>{const r={};for(const[s,n]of Object.entries(e))r[s]=t(s,n);return r}},38252:(e,t,r)=>{r.d(t,{j:()=>a});var s=r(18474),n=r(52394);const a=e=>{if(!e)return!1;if((0,s.Pr)(e.datasource))return!0;const t=e;return"string"==typeof t.type&&Object.values(n.Us).includes(t.type)}}}]);
//# sourceMappingURL=AlertingRule.ae1834d0aa280e984ee8.js.map