"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7680],{45199:(e,a,n)=>{n.r(a),n.d(a,{default:()=>X});var r,t=n(68404),s=n(73615),i=n(52423),l=n(16755),o=n(2843),c=n(3218),g=n(65678),d=n(93194),u=n(54761),m=n(8006),f=n(2024),h=n(64850),x=n(69066),v=n(46150),p=n(76938),j=n(64834),y=n(43271),A=n(5302),b=n(39833),C=n(45916);function S(){var e;const a=(0,h.I0)(),n=(0,v.k)("notification"),[s,i]=(0,x.k)(n),[S,N]=(0,t.useState)(!1),{loading:w}=(0,p._)((e=>e.deleteAMConfig)),{loading:G}=(0,p._)((e=>e.saveAMConfig)),T=!!s&&(0,y.RY)(s),I=(0,l.wW)(E),$=(0,p._)((e=>e.amConfigs)),{result:k,loading:O,error:J}=s&&$[s]||A.oq;(0,t.useEffect)((()=>{s&&a((0,j.Yh)(s))}),[s,a]);const M=()=>{s&&a((0,j.Nc)(s)),N(!1)},q=(0,t.useMemo)((()=>({configJSON:k?JSON.stringify(k,null,2):""})),[k]),R=w||O||G;return(0,C.jsxs)("div",{className:I.container,children:[(0,C.jsx)(b.P,{current:s,onChange:i,dataSources:n}),J&&!R&&(0,C.jsx)(o.b,{severity:"error",title:"Error loading Alertmanager configuration",children:J.message||"Unknown error."}),w&&s!==y.GC&&(r||(r=(0,C.jsx)(o.b,{severity:"info",title:"Resetting Alertmanager configuration",children:"It might take a while..."}))),s&&k&&(0,C.jsx)(c.l,{defaultValues:q,onSubmit:e=>{s&&k&&a((0,j.mM)({newConfig:JSON.parse(e.configJSON),oldConfig:k,alertManagerSourceName:s,successMessage:"Alertmanager configuration updated.",refetch:!0}))},children:a=>{var n;let{register:r,errors:t}=a;return(0,C.jsxs)(C.Fragment,{children:[!T&&(0,C.jsx)(g.g,{disabled:R,label:"Configuration",invalid:!!t.configJSON,error:null===(n=t.configJSON)||void 0===n?void 0:n.message,children:(0,C.jsx)(d.K,Object.assign({},r("configJSON",{required:{value:!0,message:"Required."},validate:e=>{try{return JSON.parse(e),!0}catch(e){return e instanceof Error?e.message:"Invalid JSON."}}}),{id:"configuration",rows:25}))}),T&&(0,C.jsx)(g.g,{label:"Configuration",children:(0,C.jsx)("pre",{"data-testid":"readonly-config",children:q.configJSON})}),!T&&(0,C.jsxs)(u.Lh,{children:[e||(e=(0,C.jsx)(m.zx,{type:"submit",variant:"primary",disabled:R,children:"Save"})),(0,C.jsx)(m.zx,{type:"button",disabled:R,variant:"destructive",onClick:()=>N(!0),children:"Reset configuration"})]}),!!S&&(0,C.jsx)(f.s,{isOpen:!0,title:"Reset Alertmanager configuration",body:`Are you sure you want to reset configuration ${s===y.GC?"for the Grafana Alertmanager":`for "${s}"`}? Contact points and notification policies will be reset to their defaults.`,confirmText:"Yes, reset configuration",onConfirm:M,onDismiss:()=>N(!1)})]})}},q.configJSON)]})}const E=e=>({container:i.css`
    margin-bottom: ${e.spacing(4)};
  `});var N=n(37625),w=n(5316),G=n(8157),T=n(23559),I=n(82897);function $(){const{useGetExternalAlertmanagersQuery:e}=T.h,{currentData:a}=e(),n=(0,y.aM)().filter((e=>e.jsonData.handleGrafanaManagedAlerts)),r=(0,h.v9)((e=>(0,I.keyBy)(e.dataSources.dataSources.filter((e=>"alertmanager"===e.type)),(e=>e.uid)))),t=(0,I.countBy)(null==a?void 0:a.droppedAlertManagers,(e=>e.url)),s=(0,I.countBy)(null==a?void 0:a.activeAlertManagers,(e=>e.url));return n.map((e=>{var a,n;const i=r[e.uid];if(!i)return{dataSource:e,status:"pending"};const l=function(e){if(!new RegExp("^[^:]*://").test(e.url))return`http://${e.url}`;return e.url}(i),o=`${l}/api/v2/alerts`,c=null!==(a=t[o])&&void 0!==a?a:0,g=null!==(n=s[o])&&void 0!==n?n:0,d=c+g>1,u=c>0?"dropped":g>0?"active":"pending";return{dataSource:e,url:i.url,status:u,statusInconclusive:d}}))}var k,O,J,M,q,R=n(334),Z=n(1129),D=n(21888),_=n(99500),z=n(64313),W=n(23691);function B(e){let{alertmanagers:a,inactive:n}=e;const r=(0,l.wW)(L);return(0,C.jsxs)(C.Fragment,{children:[k||(k=(0,C.jsx)("h5",{children:"Alertmanagers Receiving Grafana-managed alerts"})),(0,C.jsxs)("div",{className:r.muted,children:["Alertmanager data sources support a configuration setting that allows you to choose to send Grafana-managed alerts to that Alertmanager. ",O||(O=(0,C.jsx)("br",{})),"Below, you can see the list of all Alertmanager data sources that have this setting enabled."]}),0===a.length&&(0,C.jsx)(R._,{message:J||(J=(0,C.jsxs)("div",{children:["There are no Alertmanager data sources configured to receive Grafana-managed alerts. ",(0,C.jsx)("br",{}),"You can change this by selecting Receive Grafana Alerts in a data source configuration."]})),callToActionElement:M||(M=(0,C.jsx)(m.Qj,{href:"/datasources",children:"Go to data sources"})),className:r.externalDsCTA}),a.length>0&&(0,C.jsx)("div",{className:r.externalDs,children:a.map((e=>(0,C.jsx)(F,{alertmanager:e,inactive:n},e.dataSource.uid)))})]})}function F(e){let{alertmanager:a,inactive:n}=e;const r=(0,l.wW)(L),{dataSource:t,status:s,statusInconclusive:i,url:o}=a;return(0,C.jsxs)(Z.Z,{children:[(0,C.jsxs)(Z.Z.Heading,{className:r.externalHeading,children:[t.name," ",i&&(0,C.jsx)(D.u,{content:"Multiple Alertmangers have the same URL configured. The state might be inconclusive.",children:(0,C.jsx)(_.J,{name:"exclamation-triangle",size:"md",className:r.externalWarningIcon})})]}),(0,C.jsx)(Z.Z.Figure,{children:(0,C.jsx)("img",{src:"public/app/plugins/datasource/alertmanager/img/logo.svg",alt:"",height:"40px",width:"40px",style:{objectFit:"contain"}})}),(0,C.jsx)(Z.Z.Tags,{children:n?q||(q=(0,C.jsx)(z.C,{text:"Inactive",color:"red",tooltip:"Grafana is configured to send alerts to the built-in internal Alertmanager only. External Alertmanagers do not receive any alerts."})):(0,C.jsx)(z.C,{text:(0,I.capitalize)(s),color:"dropped"===s?"red":"active"===s?"green":"orange"})}),(0,C.jsx)(Z.Z.Meta,{children:o}),(0,C.jsx)(Z.Z.Actions,{children:(0,C.jsx)(m.Qj,{href:(0,W.__)(t),size:"sm",variant:"secondary",children:"Go to datasource"})})]})}const L=e=>({muted:i.css`
    font-size: ${e.typography.bodySmall.fontSize};
    line-height: ${e.typography.bodySmall.lineHeight};
    color: ${e.colors.text.secondary};
  `,externalHeading:i.css`
    justify-content: flex-start;
  `,externalWarningIcon:i.css`
    margin: ${e.spacing(0,1)};
    fill: ${e.colors.warning.main};
  `,externalDs:i.css`
    display: grid;
    gap: ${e.spacing(1)};
    padding: ${e.spacing(2,0)};
  `,externalDsCTA:i.css`
    margin: ${e.spacing(2,0)};
  `});var Q,Y;const H=[{value:G.TE.Internal,label:"Only Internal"},{value:G.TE.External,label:"Only External"},{value:G.TE.All,label:"Both internal and external"}],K=()=>{const e=(0,l.wW)(P),a=(0,h.I0)(),n=$(),{useSaveExternalAlertmanagersConfigMutation:r,useGetExternalAlertmanagerConfigQuery:s,useGetExternalAlertmanagersQuery:i}=T.h,[c]=r(),{currentData:d}=s();i(void 0,{pollingInterval:5e3});const u=null==d?void 0:d.alertmanagersChoice;(0,t.useEffect)((()=>{a((0,w.bZ)())}),[a]);return(0,C.jsxs)("div",{children:[Q||(Q=(0,C.jsx)("h4",{children:"External Alertmanagers"})),Y||(Y=(0,C.jsxs)(o.b,{title:"External Alertmanager changes",severity:"info",children:["The way you configure external Alertmanagers has changed.",(0,C.jsx)("br",{}),"You can now use configured Alertmanager data sources as receivers of your Grafana-managed alerts.",(0,C.jsx)("br",{}),"For more information, refer to our documentation."]})),(0,C.jsx)("div",{className:e.amChoice,children:(0,C.jsx)(g.g,{label:"Send alerts to",description:"Configures how the Grafana alert rule evaluation engine Alertmanager handles your alerts. Internal (Grafana built-in Alertmanager), External (All Alertmanagers configured below), or both.",children:(0,C.jsx)(N.S,{options:H,value:u,onChange:e=>(e=>{c({alertmanagersChoice:e})})(e)})})}),(0,C.jsx)(B,{alertmanagers:n,inactive:u===G.TE.Internal})]})},P=e=>({url:i.css`
    margin-right: ${e.spacing(1)};
  `,actions:i.css`
    margin-top: ${e.spacing(2)};
    display: flex;
    justify-content: flex-end;
  `,table:i.css`
    margin-bottom: ${e.spacing(2)};
  `,amChoice:i.css`
    margin-bottom: ${e.spacing(4)};
  `});var U,V;function X(){const e=(0,v.k)("notification"),[a]=(0,x.k)(e),n=a===y.GC;return(0,C.jsxs)(s.J,{pageId:"alerting-admin",children:[U||(U=(0,C.jsx)(S,{"test-id":"admin-alertmanagerconfig"})),n&&(V||(V=(0,C.jsx)(K,{"test-id":"admin-externalalertmanagers"})))]})}},23559:(e,a,n)=>{n.d(a,{h:()=>r});const r=n(47175).C.injectEndpoints({endpoints:e=>({getAlertmanagerChoiceStatus:e.query({query:()=>({url:"/api/v1/ngalert"}),providesTags:["AlertmanagerChoice"]}),getExternalAlertmanagerConfig:e.query({query:()=>({url:"/api/v1/ngalert/admin_config"}),providesTags:["AlertmanagerChoice"]}),getExternalAlertmanagers:e.query({query:()=>({url:"/api/v1/ngalert/alertmanagers"}),transformResponse:e=>e.data}),saveExternalAlertmanagersConfig:e.mutation({query:e=>({url:"/api/v1/ngalert/admin_config",method:"POST",data:e}),invalidatesTags:["AlertmanagerChoice"]})})})},73615:(e,a,n)=>{n.d(a,{J:()=>s});n(68404);var r=n(37417),t=n(45916);const s=e=>{let{children:a,pageId:n,pageNav:s,isLoading:i}=e;return(0,t.jsx)(r.T,{pageNav:s,navId:n,children:(0,t.jsx)(r.T.Contents,{isLoading:i,children:a})})}},69066:(e,a,n)=>{n.d(a,{k:()=>o});var r=n(68404),t=n(19512),s=n(78130),i=n(74846),l=n(43271);function o(e){const[a,n]=(0,t.K)(),o=function(e){return(0,r.useCallback)((a=>e.map((e=>e.name)).includes(a)),[e])}(e),c=(0,r.useCallback)((e=>{o(e)&&(e===l.GC?(s.Z.delete(i.de),n({[i.c4]:null})):(s.Z.set(i.de,e),n({[i.c4]:e})))}),[n,o]),g=a[i.c4];if(g&&"string"==typeof g)return o(g)?[g,c]:[void 0,c];const d=s.Z.get(i.de);return d&&"string"==typeof d&&o(d)?(c(d),[d,c]):o(l.GC)?[l.GC,c]:[void 0,c]}},46150:(e,a,n)=>{n.d(a,{k:()=>s});var r=n(68404),t=n(43271);function s(e){return(0,r.useMemo)((()=>(0,t.LE)(e)),[e])}}}]);
//# sourceMappingURL=AlertingAdmin.e58d56682a63daad108d.js.map