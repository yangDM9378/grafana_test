"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[533],{90533:(e,t,s)=>{s.d(t,{n:()=>A});var a,l,i,n,r=s(57706),o=s(68404),c=s(54316),u=s(31181),d=s(65737),h=s(11839),g=s(51320),p=s(55128),b=s(99500),f=s(22995),v=s(66803),m=s(87953),x=s(52423),y=s(82897),w=s(75478),j=s(38953),C=s(25285),S=s(83744),k=s(58765),L=s(4645),$=s(54761),_=s(8006),B=s(16755),O=s(45916);function P(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const T=1e3,V=1e4,N=4,Q="{}";function R(e){const t=[];for(const s of e)if(s.selected&&s.values&&s.values.length>0){const e=s.values.filter((e=>e.selected)).map((e=>e.name));e.length>1?t.push(`${s.name}=~"${e.map(m.tU).join("|")}"`):1===e.length&&t.push(`${s.name}="${(0,m.U9)(e[0])}"`)}return["{",t.join(","),"}"].join("")}class U extends o.Component{constructor(){super(...arguments),P(this,"state",{labels:[],searchTerm:"",status:"Ready",error:"",validationStatus:""}),P(this,"onChangeSearch",(e=>{this.setState({searchTerm:e.target.value})})),P(this,"onClickRunLogsQuery",(()=>{(0,u.ff)("grafana_loki_log_browser_closed",{app:this.props.app,closeType:"showLogsButton"});const e=R(this.state.labels);this.props.onChange(e)})),P(this,"onClickRunMetricsQuery",(()=>{(0,u.ff)("grafana_loki_log_browser_closed",{app:this.props.app,closeType:"showLogsRateButton"});const e=`rate(${R(this.state.labels)}[$__interval])`;this.props.onChange(e)})),P(this,"onClickClear",(()=>{(0,u.ff)("grafana_loki_log_browser_closed",{app:this.props.app,closeType:"clearButton"}),this.setState((e=>({labels:e.labels.map((e=>Object.assign({},e,{values:void 0,selected:!1,loading:!1,hidden:!1,facets:void 0}))),searchTerm:"",status:"",error:"",validationStatus:""}))),this.props.deleteLastUsedLabels()})),P(this,"onClickLabel",((e,t,s)=>{const a=this.state.labels.find((t=>t.name===e));if(!a)return;const l=!a.selected;let i={selected:l};if(a.values&&!l){const e=a.values.map((e=>Object.assign({},e,{selected:!1})));i=Object.assign({},i,{facets:0,values:e})}this.setState({searchTerm:""}),this.updateLabelState(e,i,"",(()=>this.doFacettingForLabel(e)))})),P(this,"onClickValue",((e,t,s)=>{const a=this.state.labels.find((t=>t.name===e));if(!a||!a.values)return;this.setState({searchTerm:""});const l=a.values.map((e=>Object.assign({},e,{selected:e.name===t?!e.selected:e.selected})));this.updateLabelState(e,{values:l},"",(()=>this.doFacetting(e)))})),P(this,"onClickValidate",(()=>{const e=R(this.state.labels);this.validateSelector(e)})),P(this,"doFacetting",(e=>{const t=R(this.state.labels);if(t===Q){const e=this.state.labels.map((e=>Object.assign({},e,{facets:0,values:void 0,hidden:!1})));this.setState({labels:e},(()=>{this.state.labels.forEach((e=>e.selected&&this.fetchValues(e.name,t)))}))}else this.fetchSeries(t,e)}))}updateLabelState(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",a=arguments.length>3?arguments[3]:void 0;this.setState((a=>{const l=a.labels.map((s=>s.name===e?Object.assign({},s,t):s)),i=s?"":a.error;return{labels:l,status:s,error:i,validationStatus:""}}),a)}componentDidMount(){const{languageProvider:e,autoSelect:t=N,lastUsedLabels:s}=this.props;if(e){const a=s;e.start().then((()=>{let s=e.getLabelKeys();if(s.length>T){const e=`Too many labels found (showing only 1000 of ${s.length})`;s=s.slice(0,T),this.setState({error:e})}const l=s.map(((e,s,l)=>({name:e,selected:l.length<=t&&0===a.length||a.includes(e),loading:!1})));this.setState({labels:l},(()=>{this.state.labels.forEach((e=>{e.selected&&this.fetchValues(e.name,Q)}))}))}))}}doFacettingForLabel(e){const t=this.state.labels.find((t=>t.name===e));if(!t)return;const s=this.state.labels.filter((e=>e.selected)).map((e=>e.name));this.props.storeLastUsedLabels(s),t.selected?t.values||this.fetchValues(e,R(this.state.labels)):this.doFacetting()}async fetchValues(e,t){const{languageProvider:s}=this.props;this.updateLabelState(e,{loading:!0},`Fetching values for ${e}`);try{let a=await s.getLabelValues(e);if(t!==R(this.state.labels))return void this.updateLabelState(e,{loading:!1},"");if(a.length>V){const t=`Too many values for ${e} (showing only 10000 of ${a.length})`;a=a.slice(0,V),this.setState({error:t})}const l=a.map((e=>({name:e})));this.updateLabelState(e,{values:l,loading:!1})}catch(e){console.error(e)}}async fetchSeries(e,t){const{languageProvider:s}=this.props;t&&this.updateLabelState(t,{loading:!0},`Facetting labels for ${e}`);try{const a=await s.fetchSeriesLabels(e,!0);if(e!==R(this.state.labels))return void(t&&this.updateLabelState(t,{loading:!1}));if(0===Object.keys(a).length)return void this.setState({error:`Empty results, no matching label for ${e}`});const l=function(e,t,s){return e.map((e=>{const a=t[e.name];if(a){let t;if(e.name===s&&e.values)t=e.values;else{var l;const s=new Set((null===(l=e.values)||void 0===l?void 0:l.filter((e=>e.selected)).map((e=>e.name)))||[]);t=a.map((e=>({name:e,selected:s.has(e)})))}return Object.assign({},e,{loading:!1,values:t,facets:t.length})}return Object.assign({},e,{loading:!1,hidden:!a,values:void 0,facets:0})}))}(this.state.labels,a,t);this.setState({labels:l,error:""}),t&&this.updateLabelState(t,{loading:!1})}catch(e){console.error(e)}}async validateSelector(e){const{languageProvider:t}=this.props;this.setState({validationStatus:`Validating selector ${e}`,error:""});const s=await t.fetchSeries(e);this.setState({validationStatus:`Selector is valid (${s.length} streams found)`})}render(){const{theme:e}=this.props,{labels:t,searchTerm:s,status:r,error:o,validationStatus:c}=this.state;if(0===t.length)return a||(a=(0,O.jsx)(j.u,{text:"Loading labels..."}));const u=(e=>({wrapper:x.css`
    background-color: ${e.colors.background.secondary};
    padding: ${e.spacing(2)};
    width: 100%;
  `,list:x.css`
    margin-top: ${e.spacing(1)};
    display: flex;
    flex-wrap: wrap;
    max-height: 200px;
    overflow: auto;
  `,section:x.css`
    & + & {
      margin: ${e.spacing(2,0)};
    }
    position: relative;
  `,selector:x.css`
    font-family: ${e.typography.fontFamilyMonospace};
    margin-bottom: ${e.spacing(1)};
  `,status:x.css`
    padding: ${e.spacing(.5)};
    color: ${e.colors.text.secondary};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* using absolute positioning because flex interferes with ellipsis */
    position: absolute;
    width: 50%;
    right: 0;
    text-align: right;
    transition: opacity 100ms linear;
    opacity: 0;
  `,statusShowing:x.css`
    opacity: 1;
  `,error:x.css`
    color: ${e.colors.error.main};
  `,valueList:x.css`
    margin-right: ${e.spacing(1)};
    resize: horizontal;
  `,valueListWrapper:x.css`
    border-left: 1px solid ${e.colors.border.medium};
    margin: ${e.spacing(1,0)};
    padding: ${e.spacing(1,0,1,1)};
  `,valueListArea:x.css`
    display: flex;
    flex-wrap: wrap;
    margin-top: ${e.spacing(1)};
  `,valueTitle:x.css`
    margin-left: -${e.spacing(.5)};
    margin-bottom: ${e.spacing(1)};
  `,validationStatus:x.css`
    padding: ${e.spacing(.5)};
    margin-bottom: ${e.spacing(1)};
    color: ${e.colors.text.maxContrast};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  `}))(e),d=R(this.state.labels),h=d===Q;let g=t.filter((e=>e.selected&&e.values));return g=s?g.map((e=>{const t=e.values.filter((e=>{if(e.selected)return e.highlightParts=void 0,!0;const t=(0,C.C)(e.name.toLowerCase(),s.toLowerCase());return!!t.found&&(e.highlightParts=t.ranges,e.order=t.distance,!0)}));return Object.assign({},e,{values:(0,y.sortBy)(t,(e=>e.selected?-1/0:e.order))})})):this.state.labels.filter((e=>e.selected&&e.values)).map((e=>Object.assign({},e,{values:null!=e&&e.values?e.values.map((e=>Object.assign({},e,{highlightParts:void 0}))):[]}))),(0,O.jsxs)("div",{className:u.wrapper,children:[(0,O.jsxs)("div",{className:u.section,children:[l||(l=(0,O.jsx)(S._,{description:"Which labels would you like to consider for your search?",children:"1. Select labels to search in"})),(0,O.jsx)("div",{className:u.list,children:t.map((e=>(0,O.jsx)(k._,{name:e.name,loading:e.loading,active:e.selected,hidden:e.hidden,facets:e.facets,onClick:this.onClickLabel},e.name)))})]}),(0,O.jsxs)("div",{className:u.section,children:[i||(i=(0,O.jsx)(S._,{description:"Choose the label values that you would like to use for the query. Use the search field to find values across selected labels.",children:"2. Find values for the selected labels"})),(0,O.jsx)("div",{children:(0,O.jsx)(L.I,{onChange:this.onChangeSearch,"aria-label":"Filter expression for values",value:s})}),(0,O.jsx)("div",{className:u.valueListArea,children:g.map((e=>{var t,a;return(0,O.jsxs)("div",{role:"list",className:u.valueListWrapper,children:[(0,O.jsx)("div",{className:u.valueTitle,"aria-label":`Values for ${e.name}`,children:(0,O.jsx)(k._,{name:e.name,loading:e.loading,active:e.selected,hidden:e.hidden,facets:e.facets||(null===(t=e.values)||void 0===t?void 0:t.length),onClick:this.onClickLabel})}),(0,O.jsx)(w.t7,{height:200,itemCount:(null===(a=e.values)||void 0===a?void 0:a.length)||0,itemSize:28,itemKey:t=>e.values[t].name,width:200,className:u.valueList,children:t=>{var a;let{index:l,style:i}=t;const n=null===(a=e.values)||void 0===a?void 0:a[l];return n?(0,O.jsx)("div",{style:i,children:(0,O.jsx)(k._,{name:e.name,value:null==n?void 0:n.name,active:null==n?void 0:n.selected,highlightParts:null==n?void 0:n.highlightParts,onClick:this.onClickValue,searchTerm:s})}):null}})]},e.name)}))})]}),(0,O.jsxs)("div",{className:u.section,children:[n||(n=(0,O.jsx)(S._,{children:"3. Resulting selector"})),(0,O.jsx)("div",{"aria-label":"selector",className:u.selector,children:d}),c&&(0,O.jsx)("div",{className:u.validationStatus,children:c}),(0,O.jsxs)($.Lh,{children:[(0,O.jsx)(_.zx,{"aria-label":"Use selector as logs button",disabled:h,onClick:this.onClickRunLogsQuery,children:"Show logs"}),(0,O.jsx)(_.zx,{"aria-label":"Use selector as metrics button",variant:"secondary",disabled:h,onClick:this.onClickRunMetricsQuery,children:"Show logs rate"}),(0,O.jsx)(_.zx,{"aria-label":"Validate submit button",variant:"secondary",disabled:h,onClick:this.onClickValidate,children:"Validate selector"}),(0,O.jsx)(_.zx,{"aria-label":"Selector clear button",variant:"secondary",onClick:this.onClickClear,children:"Clear"}),(0,O.jsx)("div",{className:(0,x.cx)(u.status,(r||o)&&u.statusShowing),children:(0,O.jsx)("span",{className:o?u.error:"",children:o||r})})]})]})]})}}const F=(0,B.HE)(U),E=o.lazy((()=>Promise.all([s.e(8935),s.e(7813),s.e(5135),s.e(7142)]).then(s.bind(s,21815)))),M=e=>(0,O.jsx)(o.Suspense,{fallback:null,children:(0,O.jsx)(E,Object.assign({},e))}),z=["runQueryOnBlur","onRunQuery","onChange"];const q=e=>{const t=(0,o.useRef)(null),{runQueryOnBlur:s,onRunQuery:a,onChange:l}=e,i=function(e,t){if(null==e)return{};var s,a,l={},i=Object.keys(e);for(a=0;a<i.length;a++)s=i[a],t.indexOf(s)>=0||(l[s]=e[s]);return l}(e,z),n=e=>{t.current=e,l(e),a()};return(0,O.jsx)(M,Object.assign({onRunQuery:n,onBlur:e=>{s?e!==t.current&&n(e):l(e)}},i))};function K(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function W(e,t){let{typeaheadContext:s,typeaheadText:a}=t;switch(s){case"context-labels":{const t=h.getNextCharacter();t&&"}"!==t&&","!==t||(e+="=");break}case"context-label-values":{let t="";a.match(/^(!?=~?"|")/)||(t='"'),t+=(0,m.Hk)(e,a),'"'!==h.getNextCharacter()&&(t+='"'),e=t;break}}return e}class A extends o.PureComponent{constructor(e){super(e),K(this,"plugins",void 0),K(this,"_isMounted",!1),K(this,"onChangeLabelBrowser",(e=>{this.onChangeQuery(e,!0),this.setState({labelBrowserVisible:!1})})),K(this,"onChangeQuery",((e,t)=>{const{query:s,onChange:a,onRunQuery:l}=this.props;if(a){a(Object.assign({},s,{expr:e})),t&&l&&l()}})),K(this,"onClickChooserButton",(()=>{this.state.labelBrowserVisible?(0,u.ff)("grafana_loki_log_browser_closed",{app:this.props.app,closeType:"logBrowserButton"}):(0,u.ff)("grafana_loki_log_browser_opened",{app:this.props.app}),this.setState((e=>({labelBrowserVisible:!e.labelBrowserVisible})))})),K(this,"onTypeahead",(async e=>{const{datasource:t}=this.props;if(!t.languageProvider)return{suggestions:[]};const s=t.languageProvider,{history:a}=this.props,{prefix:l,text:i,value:n,wrapperClasses:r,labelKey:o}=e;return await s.provideCompletionItems({text:i,value:n,prefix:l,wrapperClasses:r,labelKey:o},{history:a})})),this.state={labelsLoaded:!1,labelBrowserVisible:!1},this.plugins=[(0,g.h)(),(0,p.Z)({onlyIn:e=>"block"===e.object&&"code_block"===e.type,getSyntax:e=>"logql"},Object.assign({},r.languages,{logql:this.props.datasource.languageProvider.getSyntax()}))]}async componentDidMount(){this._isMounted=!0,await this.props.datasource.languageProvider.start(),this._isMounted&&this.setState({labelsLoaded:!0})}componentWillUnmount(){this._isMounted=!1}componentDidUpdate(e){const{range:t,datasource:{languageProvider:s}}=this.props;(0,m.rf)(t,e.range)&&s.fetchLabels()}render(){const{ExtraFieldElement:e,query:t,app:s,datasource:a,placeholder:l="Enter a Loki query (run with Shift+Enter)",history:i,onRunQuery:n,onBlur:r}=this.props,{labelsLoaded:o,labelBrowserVisible:u}=this.state,h=a.languageProvider.getLabelKeys().length>0,g=function(e,t){return e?t?"Label browser":"(No labels found)":"Loading labels..."}(o,h),p=!(o&&h);return(0,O.jsx)(v.G,{storageKey:"grafana.datasources.loki.browser.labels",defaultValue:[],children:(o,h,v)=>{var m;return(0,O.jsxs)(O.Fragment,{children:[(0,O.jsxs)("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"],children:[(0,O.jsxs)("button",{className:"gf-form-label query-keyword pointer",onClick:this.onClickChooserButton,disabled:p,children:[g,(0,O.jsx)(b.J,{name:u?"angle-down":"angle-right"})]}),(0,O.jsx)("div",{className:"gf-form gf-form--grow flex-shrink-1 min-width-15",children:d.v.featureToggles.lokiMonacoEditor?(0,O.jsx)(q,{runQueryOnBlur:s!==c.zj.Explore,languageProvider:a.languageProvider,history:null!=i?i:[],onChange:this.onChangeQuery,onRunQuery:n,initialValue:null!==(m=t.expr)&&void 0!==m?m:""}):(0,O.jsx)(f.q,{additionalPlugins:this.plugins,cleanText:a.languageProvider.cleanText,query:t.expr,onTypeahead:this.onTypeahead,onWillApplySuggestion:W,onChange:this.onChangeQuery,onBlur:r,onRunQuery:n,placeholder:l,portalOrigin:"loki"})})]}),u&&(0,O.jsx)("div",{className:"gf-form",children:(0,O.jsx)(F,{languageProvider:a.languageProvider,onChange:this.onChangeLabelBrowser,lastUsedLabels:o||[],storeLastUsedLabels:h,deleteLastUsedLabels:v,app:s})}),e]})}})}}},87953:(e,t,s)=>{function a(e){return t=e/1e3,Math.floor(t/60);var t}function l(e,t){if(e&&t){const s=a(e.from.valueOf())===a(t.from.valueOf()),l=a(e.to.valueOf())===a(t.to.valueOf());return!(s&&l)}return!1}s.d(t,{Hk:()=>c,U9:()=>n,_z:()=>u,aC:()=>d,iS:()=>r,rf:()=>l,tU:()=>o});const i=/[*+?()|\\.\[\]{}^$]/g;function n(e){return e.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"')}function r(e){return e.replace(/\\n/g,"\n").replace(/\\"/g,'"').replace(/\\\\/g,"\\")}function o(e){return n(e.replace(i,"\\$&"))}function c(e,t){return u(t)?o(e):n(e)}function u(e){return!(!e||!e.includes("=~")&&!e.includes("!~"))}function d(e){const t=new RegExp(`^(?:-?\\d+(?:\\.\\d+)?)(?:${["b","kib","Kib","kb","KB","mib","Mib","mb","MB","gib","Gib","gb","GB","tib","Tib","tb","TB","pib","Pib","pb","PB","eib","Eib","eb","EB"].join("|")})$`);return!!e.match(t)}}}]);
//# sourceMappingURL=533.5b7cfcdd6354de126e80.js.map