(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[534],{74564:(e,t,a)=>{"use strict";a.d(t,{d:()=>u});a(68404);var i,r,s,n=a(70332),l=a(46889),o=a(47398),c=a(45916);const u=e=>{const{labelWidth:t,editorProps:a,showCACert:u,showKeyPair:d=!0}=e,{secureJsonFields:h}=a.options;return(0,c.jsxs)(c.Fragment,{children:[d?(0,c.jsx)(l._,{tooltip:i||(i=(0,c.jsx)("span",{children:"To authenticate with an TLS/SSL client certificate, provide the client certificate here."})),labelWidth:t,label:"TLS/SSL Client Certificate",children:(0,c.jsx)(o.Zk,{placeholder:"Begins with -----BEGIN CERTIFICATE-----",cols:45,rows:7,isConfigured:h&&h.tlsClientCert,onChange:(0,n.fi)(a,"tlsClientCert"),onReset:()=>{(0,n.Mf)(a,"tlsClientCert")}})}):null,u?(0,c.jsx)(l._,{tooltip:r||(r=(0,c.jsx)("span",{children:"If the selected TLS/SSL mode requires a server root certificate, provide it here."})),labelWidth:t,label:"TLS/SSL Root Certificate",children:(0,c.jsx)(o.Zk,{placeholder:"Begins with -----BEGIN CERTIFICATE-----",cols:45,rows:7,isConfigured:h&&h.tlsCACert,onChange:(0,n.fi)(a,"tlsCACert"),onReset:()=>{(0,n.Mf)(a,"tlsCACert")}})}):null,d?(0,c.jsx)(l._,{tooltip:s||(s=(0,c.jsx)("span",{children:"To authenticate with a client TLS/SSL certificate, provide the key here."})),labelWidth:t,label:"TLS/SSL Client Key",children:(0,c.jsx)(o.Zk,{placeholder:"Begins with -----BEGIN RSA PRIVATE KEY-----",cols:45,rows:7,isConfigured:h&&h.tlsClientKey,onChange:(0,n.fi)(a,"tlsClientKey"),onReset:()=>{(0,n.Mf)(a,"tlsClientKey")}})}):null]})}},72727:(e,t,a)=>{"use strict";a.r(t),a.d(t,{plugin:()=>N});var i=a(23214),r=a(68404),s=a(75957),n=a(45916);const l={isDatasetSelectorHidden:!0};var o=a(70332),c=a(71980),u=a(46889),d=a(4645),h=a(34117),p=a(85558),f=a(70917),b=a(70800),g=a(2843),m=a(32889),v=a(27650),y=a(74564);let S,C;!function(e){e.disable="disable",e.require="require",e.verifyCA="verify-ca",e.verifyFull="verify-full"}(S||(S={})),function(e){e.filePath="file-path",e.fileContent="file-content"}(C||(C={}));var j=a(56491),x=a(93570),w=a(42833),_=a(55618),L=a(40436),T=a(5739),q=a(9483);function E(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class D{constructor(e,t,a){E(this,"target",void 0),E(this,"templateSrv",void 0),E(this,"scopedVars",void 0),this.target=(0,T.Y)(e||{refId:"A"}),this.templateSrv=t,this.scopedVars=a}interpolate(){var e;return(null===(e=this.templateSrv)||void 0===e?void 0:e.replace(this.target.rawSql,this.scopedVars,q.QC.sqlString))||""}quoteLiteral(e){return"'"+e.replace(/'/g,"''")+"'"}}var F=a(68522);const I=e=>{let{getColumns:t,getTables:a}=e;return(e,i)=>Object.assign({},i&&(0,F.getStandardSQLCompletionProvider)(e,i),{tables:{resolve:async()=>await a.current()},columns:{resolve:async e=>await t.current({table:null==e?void 0:e.table,refId:"A"})}})};var P=a(82897);function O(e){switch(e){case"boolean":return{raqbFieldType:"boolean",icon:"toggle-off"};case"bit":case"bit varying":case"character":case"character varying":case"text":default:return{raqbFieldType:"text",icon:"text"};case"smallint":case"integer":case"bigint":case"decimal":case"numeric":case"real":case"double precision":case"serial":case"bigserial":case"smallserial":return{raqbFieldType:"number",icon:"calculator-alt"};case"date":return{raqbFieldType:"date",icon:"clock-nine"};case"time":case"time with time zone":case"time without time zone":case"interval":return{raqbFieldType:"time",icon:"clock-nine"};case"timestamp":case"timestamp with time zone":case"timestamp without time zone":return{raqbFieldType:"datetime",icon:"clock-nine"}}}function R(e){var t,a,i,r;let{sql:s,table:n}=e,l="";if(!s||!B(s.columns))return l;if(l+=`SELECT ${s.columns.map((e=>{let t="";var a;if(e.name&&e.alias)t+=`${e.name}(${null===(a=e.parameters)||void 0===a?void 0:a.map((e=>`${e.name}`))}) AS ${e.alias}`;else if(e.name){var i;t+=`${e.name}(${null===(i=e.parameters)||void 0===i?void 0:i.map((e=>`${e.name}`))})`}else if(e.alias){var r;t+=`${null===(r=e.parameters)||void 0===r?void 0:r.map((e=>`${e.name}`))} AS ${e.alias}`}else{var s;t+=`${null===(s=e.parameters)||void 0===s?void 0:s.map((e=>`${e.name}`))}`}return t})).join(", ")} `,n&&(l+=`FROM ${n} `),s.whereString&&(l+=`WHERE ${s.whereString} `),null!==(t=s.groupBy)&&void 0!==t&&null!==(a=t[0])&&void 0!==a&&a.property.name){l+=`GROUP BY ${s.groupBy.map((e=>e.property.name)).filter((e=>!(0,P.isEmpty)(e))).join(", ")} `}return null!==(i=s.orderBy)&&void 0!==i&&i.property.name&&(l+=`ORDER BY ${s.orderBy.property.name} `),null!==(r=s.orderBy)&&void 0!==r&&r.property.name&&s.orderByDirection&&(l+=`${s.orderByDirection} `),void 0!==s.limit&&s.limit>=0&&(l+=`LIMIT ${s.limit} `),l}const B=e=>{if(!e)return!1;const t=e.some((e=>{var t,a;return(null===(t=e.parameters)||void 0===t?void 0:t.length)||(null===(a=e.parameters)||void 0===a?void 0:a.some((e=>e.name)))})),a=e.some((e=>e.name));return t||a};class A extends _.D{constructor(e){var t,a,i;super(e),i=void 0,(a="sqlLanguageDefinition")in(t=this)?Object.defineProperty(t,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[a]=i}getQueryModel(e,t,a){return new D(e,t,a)}async getVersion(){return(await this.runSql("SELECT current_setting('server_version_num')::int/100 as version")).fields.version.values.toArray()[0].toString()}async getTimescaleDBVersion(){return(await this.runSql("SELECT extversion FROM pg_extension WHERE extname = 'timescaledb'")).fields.extversion.values.toArray()[0]}async fetchTables(){return(await this.runSql("select quote_ident(table_name) as \"table\" from information_schema.tables\n    where quote_ident(table_schema) not in ('information_schema',\n                             'pg_catalog',\n                             '_timescaledb_cache',\n                             '_timescaledb_catalog',\n                             '_timescaledb_internal',\n                             '_timescaledb_config',\n                             'timescaledb_information',\n                             'timescaledb_experimental')\n      and table_type = 'BASE TABLE' and \n          quote_ident(table_schema) IN (\n          SELECT\n            CASE WHEN trim(s[i]) = '\"$user\"' THEN user ELSE trim(s[i]) END\n          FROM\n            generate_series(\n              array_lower(string_to_array(current_setting('search_path'),','),1),\n              array_upper(string_to_array(current_setting('search_path'),','),1)\n            ) as i,\n            string_to_array(current_setting('search_path'),',') s\n          )",{refId:"tables"})).fields.table.values.toArray().flat()}getSqlLanguageDefinition(e){if(void 0!==this.sqlLanguageDefinition)return this.sqlLanguageDefinition;const t={getColumns:{current:t=>async function(e,t){const a=await e.fields(t);return a.length>0?a.map((e=>({name:e.value,type:e.value,description:e.value}))):[]}(e,t)},getTables:{current:()=>async function(e){var t;return await(null===(t=e.lookup)||void 0===t?void 0:t.call(e))||[]}(e)}};return this.sqlLanguageDefinition={id:"pgsql",completionProvider:I(t),formatter:L._},this.sqlLanguageDefinition}async fetchFields(e){const t=await this.runSql((a=e.table,`select quote_ident(column_name) as "column", data_type as "type"\n    from information_schema.columns\n    where quote_ident(table_name) = '${a}'`),{refId:"columns"});var a;const i=[];for(let e=0;e<t.length;e++){const a=t.fields.column.values.get(e),r=t.fields.type.values.get(e);i.push(Object.assign({label:a,value:a,type:r},O(r)))}return i}getDB(){return void 0!==this.db?this.db:{init:()=>Promise.resolve(!0),datasets:()=>Promise.resolve([]),tables:()=>this.fetchTables(),getEditorLanguageDefinition:()=>this.getSqlLanguageDefinition(this.db),fields:async e=>null!=e&&e.table?this.fetchFields(e):[],validateQuery:e=>Promise.resolve({isError:!1,isValid:!0,query:e,error:"",rawSql:e.rawSql}),dsID:()=>this.id,toRawSql:R,lookup:async()=>(await this.fetchTables()).map((e=>({name:e,completion:e})))}}}function $(e){let{props:t,setVersionOptions:a}=e;const[i,s]=(0,r.useState)(!1),{options:n,onOptionsChange:l}=t;(0,j.Z)((()=>{(function(e){var t,a;return e.url&&e.database&&e.user&&((null===(t=e.secureJsonData)||void 0===t?void 0:t.password)||(null===(a=e.secureJsonFields)||void 0===a?void 0:a.password))&&(e.jsonData.sslmode===S.disable||e.jsonData.sslCertFile&&e.jsonData.sslKeyFile&&e.jsonData.sslRootCertFile)&&!e.jsonData.postgresVersion&&!e.readOnly})(n)&&(async()=>{if(i){const e=await(0,w.ak)().loadDatasource(n.name);if(e instanceof A){const t=await e.getVersion(),i=parseInt(t,10);i>=906&&!n.jsonData.timescaledb&&await e.getTimescaleDBVersion()&&(0,o.tp)({options:n,onOptionsChange:l},"timescaledb",!0);const r=Math.trunc(i/100),s=i%100;let c=String(r);i<1e3&&(c=String(r)+"."+String(s)),H.find((e=>e.value===i))||a((e=>[...e,{label:c,value:i}])),void 0!==n.jsonData.postgresVersion&&n.jsonData.postgresVersion===i||(0,o.tp)({options:n,onOptionsChange:l},"postgresVersion",i)}}else{const e=await(0,x.i)().put(`/api/datasources/${n.id}`,n);s(!0),(0,o.fd)({options:n,onOptionsChange:l},"version",e.datasource.version)}})()}),[n,i,a])}var k,M,W,V,Q,G,K;const H=[{label:"9.0",value:900},{label:"9.1",value:901},{label:"9.2",value:902},{label:"9.3",value:903},{label:"9.4",value:904},{label:"9.5",value:905},{label:"9.6",value:906},{label:"10",value:1e3},{label:"11",value:1100},{label:"12",value:1200},{label:"13",value:1300},{label:"14",value:1400},{label:"15",value:1500}],N=new i.hf(A).setQueryEditor((function(e){return(0,n.jsx)(s.M,Object.assign({},e,{queryHeaderProps:l}))})).setConfigEditor((e=>{var t;const[a,i]=(0,r.useState)(H);$({props:e,setVersionOptions:i});const{options:s,onOptionsChange:l}=e,j=s.jsonData,x=[{value:S.disable,label:"disable"},{value:S.require,label:"require"},{value:S.verifyCA,label:"verify-ca"},{value:S.verifyFull,label:"verify-full"}],w=[{value:C.filePath,label:"File system path"},{value:C.fileContent,label:"Certificate content"}],_=t=>a=>{(0,o.tp)(e,t,a.value)},L=e=>t=>{l(Object.assign({},s,{[e]:t.currentTarget.value}))};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(c.C,{label:"PostgreSQL Connection",width:400,children:[(0,n.jsx)(u._,{labelWidth:20,label:"Host",children:(0,n.jsx)(d.I,{width:40,name:"host",type:"text",value:s.url||"",placeholder:"localhost:5432",onChange:L("url")})}),(0,n.jsx)(u._,{labelWidth:20,label:"Database",children:(0,n.jsx)(d.I,{width:40,name:"database",value:s.database||"",placeholder:"database name",onChange:L("database")})}),(0,n.jsxs)(h.Z,{children:[(0,n.jsx)(u._,{labelWidth:20,label:"User",children:(0,n.jsx)(d.I,{value:s.user||"",placeholder:"user",onChange:L("user")})}),(0,n.jsx)(u._,{label:"Password",children:(0,n.jsx)(p.m4,{placeholder:"Password",isConfigured:null===(t=s.secureJsonFields)||void 0===t?void 0:t.password,onReset:()=>{(0,o.Mf)(e,"password")},onBlur:(0,o.fi)(e,"password")})})]}),(0,n.jsx)(u._,{labelWidth:20,label:"TLS/SSL Mode",htmlFor:"tlsMode",tooltip:"This option determines whether or with what priority a secure TLS/SSL TCP/IP connection will be negotiated with the server.",children:(0,n.jsx)(f.Ph,{options:x,inputId:"tlsMode",value:j.sslmode||S.verifyFull,onChange:_("sslmode")})}),s.jsonData.sslmode!==S.disable?(0,n.jsx)(u._,{labelWidth:20,label:"TLS/SSL Method",htmlFor:"tlsMethod",tooltip:k||(k=(0,n.jsxs)("span",{children:["This option determines how TLS/SSL certifications are configured. Selecting ",(0,n.jsx)("i",{children:"File system path"})," will allow you to configure certificates by specifying paths to existing certificates on the local file system where Grafana is running. Be sure that the file is readable by the user executing the Grafana process.",(0,n.jsx)("br",{}),(0,n.jsx)("br",{}),"Selecting ",(0,n.jsx)("i",{children:"Certificate content"})," will allow you to configure certificates by specifying its content. The content will be stored encrypted in Grafana's database. When connecting to the database the certificates will be written as files to Grafana's configured data path on the local file system."]})),children:(0,n.jsx)(f.Ph,{options:w,inputId:"tlsMethod",value:j.tlsConfigurationMethod||C.filePath,onChange:_("tlsConfigurationMethod")})}):null]}),j.sslmode!==S.disable?(0,n.jsx)(c.C,{label:"TLS/SSL Auth Details",children:j.tlsConfigurationMethod===C.fileContent?(0,n.jsx)(y.d,{showCACert:j.sslmode===S.verifyCA||j.sslmode===S.verifyFull,editorProps:e,labelWidth:25}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(u._,{tooltip:M||(M=(0,n.jsx)("span",{children:"If the selected TLS/SSL mode requires a server root certificate, provide the path to the file here."})),labelWidth:25,label:"TLS/SSL Root Certificate",children:(0,n.jsx)(d.I,{value:j.sslRootCertFile||"",onChange:(0,o._R)(e,"sslRootCertFile"),placeholder:"TLS/SSL root cert file"})}),(0,n.jsx)(u._,{tooltip:W||(W=(0,n.jsx)("span",{children:"To authenticate with an TLS/SSL client certificate, provide the path to the file here. Be sure that the file is readable by the user executing the grafana process."})),labelWidth:25,label:"TLS/SSL Client Certificate",children:(0,n.jsx)(d.I,{value:j.sslCertFile||"",onChange:(0,o._R)(e,"sslCertFile"),placeholder:"TLS/SSL client cert file"})}),(0,n.jsx)(u._,{tooltip:V||(V=(0,n.jsxs)("span",{children:["To authenticate with a client TLS/SSL certificate, provide the path to the corresponding key file here. Be sure that the file is ",(0,n.jsx)("i",{children:"only"})," readable by the user executing the grafana process."]})),labelWidth:25,label:"TLS/SSL Client Key",children:(0,n.jsx)(d.I,{value:j.sslKeyFile||"",onChange:(0,o._R)(e,"sslKeyFile"),placeholder:"TLS/SSL client key file"})})]})}):null,(0,n.jsx)(v.K,{labelWidth:20,jsonData:j,onPropertyChanged:(t,a)=>{(0,o.tp)(e,t,a)}}),(0,n.jsxs)(c.C,{label:"PostgreSQL details",children:[(0,n.jsx)(u._,{tooltip:"This option controls what functions are available in the PostgreSQL query builder",labelWidth:20,htmlFor:"postgresVersion",label:"Version",children:(0,n.jsx)(f.Ph,{value:j.postgresVersion||903,inputId:"postgresVersion",onChange:_("postgresVersion"),options:a})}),(0,n.jsx)(u._,{tooltip:Q||(Q=(0,n.jsxs)("span",{children:["TimescaleDB is a time-series database built as a PostgreSQL extension. If enabled, Grafana will use",(0,n.jsx)("code",{children:"time_bucket"})," in the ",(0,n.jsx)("code",{children:"$__timeGroup"})," macro and display TimescaleDB specific aggregate functions in the query builder."]})),labelWidth:20,label:"TimescaleDB",htmlFor:"timescaledb",children:(0,n.jsx)(b.x,{id:"timescaledb",value:j.timescaledb||!1,onChange:t=>{(0,o.tp)(e,"timescaledb",t.currentTarget.checked)}})}),(0,n.jsx)(u._,{tooltip:G||(G=(0,n.jsxs)("span",{children:["A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example",(0,n.jsx)("code",{children:"1m"})," if your data is written every minute."]})),labelWidth:20,label:"Min time interval",children:(0,n.jsx)(d.I,{placeholder:"1m",value:j.timeInterval||"",onChange:(0,o._R)(e,"timeInterval")})})]}),K||(K=(0,n.jsxs)(g.b,{title:"User Permission",severity:"info",children:["The database user should only be granted SELECT permissions on the specified database & tables you want to query. Grafana does not validate that queries are safe so queries can contain any SQL statement. For example, statements like ",(0,n.jsx)("code",{children:"DELETE FROM user;"})," and ",(0,n.jsx)("code",{children:"DROP TABLE user;"})," would be executed. To protect against this we ",(0,n.jsx)("strong",{children:"Highly"})," recommend you create a specific PostgreSQL user with restricted permissions. Check out the"," ",(0,n.jsx)(m.r,{rel:"noreferrer",target:"_blank",href:"http://docs.grafana.org/features/datasources/postgres/",children:"PostgreSQL Data Source Docs"})," ","for more information."]}))]})}))},56491:(e,t,a)=>{"use strict";a.d(t,{Z:()=>l});var i=a(68404);const r=function(e,t,a){var r=(0,i.useRef)(void 0);r.current&&a(t,r.current)||(r.current=t),(0,i.useEffect)(e,r.current)};var s=a(48322);const n=a.n(s)();const l=function(e,t){r(e,t,n)}},48322:e=>{"use strict";e.exports=function e(t,a){if(t===a)return!0;if(t&&a&&"object"==typeof t&&"object"==typeof a){if(t.constructor!==a.constructor)return!1;var i,r,s;if(Array.isArray(t)){if((i=t.length)!=a.length)return!1;for(r=i;0!=r--;)if(!e(t[r],a[r]))return!1;return!0}if(t.constructor===RegExp)return t.source===a.source&&t.flags===a.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===a.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===a.toString();if((i=(s=Object.keys(t)).length)!==Object.keys(a).length)return!1;for(r=i;0!=r--;)if(!Object.prototype.hasOwnProperty.call(a,s[r]))return!1;for(r=i;0!=r--;){var n=s[r];if(("_owner"!==n||!t.$$typeof)&&!e(t[n],a[n]))return!1}return!0}return t!=t&&a!=a}},76345:()=>{},56834:()=>{}}]);
//# sourceMappingURL=postgresPlugin.0821689f280b14010c04.js.map